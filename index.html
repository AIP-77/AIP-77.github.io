<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å</title>
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f2f5;
      color: #1c1e21;
      min-height: 100vh;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin: 0 0 8px 0;
      font-size: 1.5rem;
      color: #1a8cd8;
    }
    h2 {
      margin: 0 0 12px 0;
      font-size: 1.2rem;
      color: #333;
    }
    p {
      margin: 8px 0;
      font-size: 15px;
    }
    .label {
      font-weight: 600;
      color: #444;
    }
    .value {
      color: #1a8cd8;
    }
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      margin: 8px 0;
      overflow-x: auto;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 16px;
    }
    .error {
      color: #e53935;
      text-align: center;
      padding: 20px;
    }
    .btn {
      background: #1a8cd8;
      color: white;
      border: none;
      padding: 14px;
      border-radius: 12px;
      font-size: 16px;
      width: 100%;
      margin-top: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .footer {
      text-align: center;
      margin-top: 30px;
      color: #888;
      font-size: 13px;
    }
    .date-control {
      display: flex;
      gap: 10px;
      align-items: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>

    <div class="card">
      <div class="date-control">
        <label for="report-date-select">–î–∞—Ç–∞:</label>
        <input type="date" id="report-date-select">
        <button class="btn" onclick="loadReportForDate()" style="font-size: 14px; padding: 8px 12px;">–ü–æ–∫–∞–∑–∞—Ç—å</button>
      </div>
    </div>

    <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    <div id="error" class="error" style="display: none;"></div>

    <div id="content" style="display: none;">
      <div class="card">
        <h2>üìå –í–∞—à –æ—Ç—á—ë—Ç –∑–∞ <span id="report-date">‚Äî</span></h2>
        <p><span class="label">–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ:</span> <span class="value" id="worked">‚Äî</span></p>
        <p><span class="label">–ò—Ç–æ–≥–æ –ø–æ —Ç–∞–±–µ–ª—é:</span> <span class="value" id="planned">‚Äî</span></p>
        <p><span class="label">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</span> <span class="value" id="efficiency">‚Äî</span></p>
        <p><span class="label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ –¥–µ–Ω—å:</span> <span class="value" id="pay-day">‚Äî</span></p>
        <p><span class="label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ –º–µ—Å—è—Ü:</span> <span class="value" id="pay-month">‚Äî</span></p>
      </div>

      <div class="card">
        <h2>üìã –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á</h2>
        <pre id="details">–ó–∞–≥—Ä—É–∑–∫–∞...</pre>
      </div>

      <div class="card">
        <h2>üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Ä–∞–±–æ—á–∏–µ –¥–Ω–∏)</h2>
        <pre id="chart">–ó–∞–≥—Ä—É–∑–∫–∞...</pre>
      </div>

      <button class="btn" onclick="downloadPDF()" disabled>–°–∫–∞—á–∞—Ç—å PDF</button>
    </div>

    <div class="footer">
      –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ AIP ‚Ä¢ ¬© 2025
    </div>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    const user = Telegram.WebApp.initDataUnsafe.user;
    const chatId = user?.id;

    if (!chatId) {
      document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').textContent = '–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
      throw new Error('No user data');
    }

    // ‚úÖ –¢–≤–æ–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–π URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbxiAvEbEPIQ5F8GydJ34ZuUErqY8kHiymaokR60I7qbmzmjXzLRp9zYN5MO-Mq1-Qp-/exec';

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º "–≤—á–µ—Ä–∞" –∫–∞–∫ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    document.getElementById('report-date-select').valueAsDate = yesterday;

    // –§—É–Ω–∫—Ü–∏—è: –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á—ë—Ç –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É
    function loadReportForDate() {
      const dateInput = document.getElementById('report-date-select').value;
      if (!dateInput) {
        Telegram.WebApp.showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
        return;
      }

      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ dd.MM.yyyy
      const [year, month, day] = dateInput.split('-');
      const formattedDate = `${day}.${month}.${year}`;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      document.getElementById('loading').style.display = 'block';
      document.getElementById('content').style.display = 'none';
      document.getElementById('error').style.display = 'none';

      // –ó–∞–ø—Ä–æ—Å –∫ Google Apps Script
      fetch(`${API_URL}?chat_id=${chatId}&date=${formattedDate}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.error) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').textContent = '–û—à–∏–±–∫–∞: ' + data.error;
            document.getElementById('error').style.display = 'block';
            return;
          }

          document.getElementById('loading').style.display = 'none';
          document.getElementById('content').style.display = 'block';

          // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          const set = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
            else console.error(`‚ùå –≠–ª–µ–º–µ–Ω—Ç #${id} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
          };

          set('report-date', data.date);
          set('worked', data.worked || '‚Äî');
          set('planned', data.planned || '‚Äî');
          set('efficiency', data.efficiency || '‚Äî');
          set('pay-day', data.payDay || '‚Äî');
          set('pay-month', data.payMonth || '‚Äî');
          document.getElementById('details').textContent = data.details?.join('\n') || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
          document.getElementById('chart').textContent = data.chart || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';

          // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É PDF
          const btn = document.querySelector('.btn[onclick="downloadPDF()"]');
          btn.disabled = false;
          btn.textContent = '–°–∫–∞—á–∞—Ç—å PDF';
        })
        .catch(err => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', err);
          document.getElementById('loading').style.display = 'none';
          document.getElementById('error').textContent = '–û—à–∏–±–∫–∞: ' + err.message;
          document.getElementById('error').style.display = 'block';
        });
    }

    // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    window.onload = loadReportForDate;

    // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è PDF
    function downloadPDF() {
      Telegram.WebApp.showAlert('–§—É–Ω–∫—Ü–∏—è PDF —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞!');
    }
  </script>
</body>
</html>
