<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Персональная панель</title>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f2f5;
      color: #1c1e21;
      min-height: 100vh;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    h1, h2 {
      margin: 0 0 8px 0;
      color: #1c1e21;
    }
    .loading {
      text-align: center;
      padding: 40px;
      font-size: 16px;
      color: #666;
    }
    .error {
      color: #d32f2f;
      padding: 16px;
      background: #ffebee;
      border-radius: 8px;
      margin: 16px 0;
      display: none;
    }
    .tabs {
      display: flex;
      margin-bottom: 16px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 12px;
      background: #eee;
      border-bottom: 3px solid transparent;
      cursor: pointer;
    }
    .tab.active {
      background: white;
      border-bottom: 3px solid #1a8cd8;
      font-weight: bold;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e0e0e0;
      border-top: 4px solid #1a8cd8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loading" class="loading">
      <div class="spinner"></div>
      Загрузка данных...
    </div>
    <div id="error" class="error"></div>

    <div class="tabs">
      <div id="tab-employee" class="tab active">Мой отчёт</div>
      <div id="tab-manager" class="tab" style="display: none;">Команда</div>
    </div>

    <div id="employee-view">
      <!-- ... (ваш текущий контент) ... -->
    </div>

    <div id="manager-view" style="display: none;">
      <!-- ... (панель руководителя) ... -->
    </div>
  </div>

  <script>
    // === Настройки ===
    const API_URL_MAIN = 'https://script.google.com/macros/s/AKfycbyl_7_he7JK5IE-lbQzIGLahxH3thDWH_rlYcwBjfqNfMkdaCqRxMVOJPmGxEKG77UN/exec'; // ← Замени на свой
    let chatId = null;
    let isManager = false;

    // === Инициализация Telegram WebApp ===
    function initTelegram() {
      // Проверка, загружен ли WebApp
      if (!window.Telegram || !Telegram.WebApp) {
        return showError('❌ WebApp не загружен. Откройте через Telegram.');
      }

      // Готовим WebApp
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();

      // Получаем пользователя
      const user = Telegram.WebApp.initDataUnsafe.user;
      if (!user || !user.id) {
        return showError('❌ Не удалось получить пользователя');
      }

      chatId = user.id.toString();
      console.log('✅ Telegram WebApp готов. chat_id:', chatId);

      // Убираем загрузку и определяем роль
      document.getElementById('loading').style.display = 'none';
      detectUserRole(chatId);
    }

    // === Определение роли ===
    function detectUserRole(chatId) {
      fetch(`${API_URL_MAIN}?chat_id=${chatId}&check_role=true`)
        .then(r => r.json())
        .then(data => {
          if (data.error) {
            return showError(data.error);
          }

          isManager = data.isManager;

          // Показываем нужную вкладку
          if (isManager) {
            document.getElementById('tab-manager').style.display = 'block';
            loadManagerDashboard(chatId);
          } else {
            loadEmployeeReport(chatId, getYesterdayFormatted());
          }
        })
        .catch(err => {
          showError('Ошибка определения роли: ' + err.message);
        });
    }

    // === Загрузка отчёта сотрудника ===
    function loadEmployeeReport(chatId, date) {
      fetch(`${API_URL_MAIN}?chat_id=${chatId}&date=${date}`)
        .then(r => r.json())
        .then(data => {
          if (data.error) return showError(data.error);
          // Здесь заполняешь данные (уже есть в твоём коде)
          console.log('✅ Данные сотрудника:', data);
        })
        .catch(err => showError('Ошибка: ' + err.message));
    }

    // === Загрузка панели руководителя ===
    function loadManagerDashboard(chatId) {
      fetch(`${API_URL_MAIN}?chat_id=${chatId}&manager=true`)
        .then(r => r.json())
        .then(data => {
          if (data.error) return showError(data.error);
          // Здесь заполняешь данные руководителя
          console.log('✅ Данные руководителя:', data);
        })
        .catch(err => showError('Ошибка: ' + err.message));
    }

    // === Вспомогательные функции ===
    function showError(msg) {
      document.getElementById('loading').style.display = 'none';
      const errorEl = document.getElementById('error');
      errorEl.textContent = msg;
      errorEl.style.display = 'block';
      console.error('Ошибка:', msg);
    }

    function getYesterdayFormatted() {
      const d = new Date();
      d.setDate(d.getDate() - 1);
      const dd = d.getDate().toString().padStart(2, '0');
      const mm = (d.getMonth() + 1).toString().padStart(2, '0');
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    }

    // === Запуск ===
    initTelegram();
  </script>
</body>
</html>
