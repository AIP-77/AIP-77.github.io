<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      background: #f9f9f9;
      color: #333;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 10px;
    }
    .version {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }
    .last-updated {
      text-align: center;
      font-size: 13px;
      color: #555;
      margin-bottom: 15px;
      font-style: italic;
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
    }
    select, button, input {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .calendar-container {
      margin: 15px 0;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .calendar-title {
      font-size: 18px;
      font-weight: bold;
      margin: 0 10px;
      text-align: center;
    }
    .calendar-nav-btn {
      background: #2196f3;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      min-width: 100px;
      text-align: center;
      font-weight: bold;
    }
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .calendar-day-header {
      text-align: center;
      font-weight: bold;
      padding: 8px;
      background: #f0f0f0;
      border-radius: 4px;
    }
    .calendar-day {
      text-align: center;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .calendar-day.has-data {
      background: #2196f3;
      color: white;
    }
    .calendar-day.disabled {
      color: #aaa;
      cursor: not-allowed;
    }
    .report {
      margin-top: 20px;
      padding: 15px;
      background: #f0f8ff;
      border-radius: 6px;
    }
    .report h3 {
      margin-top: 0;
    }
    .report-item {
      margin: 8px 0;
    }
    .day-group, .worktype-group, .hour-group {
      margin: 12px 0;
      padding: 10px;
      background: #e3f2fd;
      border-radius: 4px;
      cursor: pointer;
    }
    .worktype-group {
      background: #bbdefb;
      margin-left: 10px;
    }
    .hour-group {
      background: #90caf9;
      margin-left: 20px;
    }
    .detail-group {
      margin-left: 30px;
      padding: 10px;
      background: #e1f5fe;
      border-radius: 4px;
      margin-top: 8px;
    }
    .brigade-group {
      margin-left: 40px;
      padding: 10px;
      background: #f3e5f5;
      border-radius: 4px;
      margin-top: 8px;
    }
    .toggle-icon {
      display: inline-block;
      width: 16px;
      text-align: center;
      margin-right: 6px;
    }
    .hidden {
      display: none;
    }
    .loading {
      text-align: center;
      color: #666;
      padding: 20px;
    }
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .action-buttons button {
      flex: 1;
      padding: 10px;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #clear-cache-btn {
      background: #d32f2f;
      color: white;
    }
    #toggle-auto-reload {
      background: #1976d2;
      color: white;
    }
    #export-excel {
      background: #388e3c;
      color: white;
    }
    #toggle-auto-reload.disabled {
      background: #9e9e9e;
    }
    .plan-comparison {
      background: #e8f5e8;
      padding: 8px;
      border-radius: 4px;
      margin-top: 6px;
      font-weight: bold;
      color: #2e7d32;
    }
    .night-interval {
      background: #5c6bc0 !important;
      color: white;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ò–ù–î–ò–ö–ê–¢–û–†–ê –ó–ê–ì–†–£–ó–ö–ò */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2196f3;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-progress {
      background: linear-gradient(90deg, #2196f3, #1976d2);
      height: 3px;
      width: 0%;
      transition: width 0.3s ease;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
    }
    
    .loading-dots:after {
      content: '';
      animation: dots 1.5s steps(5, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò */
    .analytics-section {
      margin-top: 30px;
      padding: 20px;
      background: #fff3e0;
      border-radius: 8px;
      border-left: 4px solid #ff9800;
    }
    
    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .analytics-title {
      font-size: 18px;
      font-weight: bold;
      color: #e65100;
      margin: 0;
    }
    
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .analytics-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 3px solid #2196f3;
    }
    
    .analytics-card h4 {
      margin: 0 0 10px 0;
      color: #1976d2;
      font-size: 14px;
    }
    
    .analytics-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin: 5px 0;
    }
    
    .analytics-label {
      font-size: 12px;
      color: #666;
      margin: 0;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò –ü–û –í–ò–î–ê–ú –†–ê–ë–û–¢ */
    .work-types-analytics {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #17a2b8;
    }
    
    .work-types-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .work-types-title {
      font-size: 18px;
      font-weight: bold;
      color: #0c5460;
      margin: 0;
    }
    
    .work-types-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .work-type-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-left: 4px solid #17a2b8;
      transition: transform 0.2s;
    }
    
    .work-type-card:hover {
      transform: translateY(-2px);
    }
    
    .work-type-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .work-type-name {
      font-size: 16px;
      font-weight: bold;
      color: #495057;
      margin: 0;
    }
    
    .work-type-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }
    
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    .stat-label {
      font-size: 11px;
      color: #666;
      text-align: center;
    }
    
    .performance-indicator {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
      font-size: 12px;
    }
    
    .performance-good {
      background: #d4edda;
      color: #155724;
    }
    
    .performance-average {
      background: #fff3cd;
      color: #856404;
    }
    
    .performance-poor {
      background: #f8d7da;
      color: #721c24;
    }
    
    .comparison-chart {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-bar {
      display: flex;
      align-items: center;
      margin: 10px 0;
      height: 30px;
    }
    
    .chart-label {
      width: 150px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .chart-bar-inner {
      flex: 1;
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }
    
    .chart-bar-fill {
      height: 100%;
      border-radius: 10px;
      transition: width 0.5s ease;
    }
    
    .chart-value {
      width: 80px;
      text-align: right;
      font-size: 12px;
      font-weight: bold;
    }

    .plan-status {
      margin-top: 15px;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      font-weight: bold;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –°–†–ê–í–ù–ï–ù–ò–Ø –° –ü–†–ï–î–´–î–£–©–ò–ú–ò –î–ù–Ø–ú–ò */
    .comparison-section {
      margin-top: 30px;
      padding: 20px;
      background: #e8f5e9;
      border-radius: 8px;
      border-left: 4px solid #4caf50;
    }
    
    .comparison-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .comparison-title {
      font-size: 18px;
      font-weight: bold;
      color: #2e7d32;
      margin: 0;
    }
    
    .comparison-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .comparison-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .comparison-card h4 {
      margin: 0 0 10px 0;
      color: #388e3c;
      font-size: 14px;
    }
    
    .trend-up {
      color: #4caf50;
    }
    
    .trend-down {
      color: #f44336;
    }
    
    .trend-neutral {
      color: #ff9800;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ü–û –í–†–ï–ú–ï–ù–ò –°–£–¢–û–ö */
    .time-statistics {
      margin-top: 30px;
      padding: 20px;
      background: #f3e5f5;
      border-radius: 8px;
      border-left: 4px solid #9c27b0;
    }
    
    .time-statistics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .time-statistics-title {
      font-size: 18px;
      font-weight: bold;
      color: #7b1fa2;
      margin: 0;
    }
    
    .time-chart {
      margin-top: 15px;
    }
    
    .time-bar {
      display: flex;
      align-items: center;
      margin: 8px 0;
      height: 25px;
    }
    
    .time-label {
      width: 100px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .time-bar-inner {
      flex: 1;
      height: 15px;
      background: #e1bee7;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .time-bar-fill {
      height: 100%;
      border-radius: 8px;
      background: linear-gradient(90deg, #ab47bc, #8e24aa);
    }
    
    .time-value {
      width: 100px;
      text-align: right;
      font-size: 12px;
      font-weight: bold;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ì–†–£–ü–ü–ò–†–û–í–û–ö –ü–û –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø–ú –ò –û–¢–î–ï–õ–ê–ú */
    .grouping-section {
      margin-top: 30px;
      padding: 20px;
      background: #e3f2fd;
      border-radius: 8px;
      border-left: 4px solid #1976d2;
    }
    
    .grouping-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .grouping-title {
      font-size: 18px;
      font-weight: bold;
      color: #0d47a1;
      margin: 0;
    }
    
    .grouping-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .group-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-left: 4px solid #2196f3;
    }
    
    .group-card h4 {
      margin: 0 0 10px 0;
      color: #1976d2;
      font-size: 14px;
    }
    
    .group-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }
    
    .group-stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 6px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    
    .group-stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    
    .group-stat-label {
      font-size: 10px;
      color: #666;
      text-align: center;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –í–ö–õ–ê–î–û–ö –ì–†–£–ü–ü–ò–†–û–í–û–ö */
    .grouping-tabs {
      display: flex;
      margin-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .grouping-tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
    }
    
    .grouping-tab.active {
      border-bottom-color: #1976d2;
      color: #1976d2;
      font-weight: bold;
    }
    
    .grouping-content {
      display: none;
    }
    
    .grouping-content.active {
      display: block;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ò–ï–†–ê–†–•–ò–ß–ï–°–ö–û–ô –°–¢–†–£–ö–¢–£–†–´ */
    .hierarchy-level {
      margin-left: 20px;
      margin-top: 10px;
    }
    
    .level-0 { margin-left: 0; }
    .level-1 { margin-left: 20px; }
    .level-2 { margin-left: 40px; }
    .level-3 { margin-left: 60px; }
    
    .hierarchy-card {
      background: white;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 8px;
      border-left: 3px solid #2196f3;
    }
    
    .hierarchy-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    
    .hierarchy-name {
      font-weight: bold;
      color: #333;
    }
    
    .hierarchy-stats {
      display: flex;
      gap: 15px;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
  <div id="loading-progress" class="loading-progress"></div>

  <div class="container">
    <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç</h2>
    <div class="version">v 11.01-2303 <span>üïí</span></div>
    <div class="last-updated" id="last-updated">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ‚Äî</div>

    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö<span class="loading-dots"></span></span>
    </div>
    <div id="error" class="error hidden"></div>

    <div id="controls" class="hidden">
      <!-- –ö–ê–õ–ï–ù–î–ê–†–¨ -->
      <div class="calendar-container">
        <div class="calendar-header">
          <button class="calendar-nav-btn" id="prev-month">‚óÄ –ù–∞–∑–∞–¥</button>
          <div class="calendar-title" id="calendar-title">–û–∫—Ç—è–±—Ä—å 2025</div>
          <button class="calendar-nav-btn" id="next-month">–í–ø–µ—Ä—ë–¥ ‚ñ∂</button>
        </div>
        <div class="calendar-days" id="calendar-days">
          <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
        </div>
      </div>

      <div id="report" class="report hidden"></div>

      <!-- –°–ï–ö–¶–ò–Ø –û–ë–©–ï–ô –ê–ù–ê–õ–ò–¢–ò–ö–ò -->
      <div id="analytics" class="analytics-section hidden">
        <div class="analytics-header" id="analytics-toggle">
          <h3 class="analytics-title">üìä –û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å</h3>
          <span class="toggle-icon">‚ñº</span>
        </div>
        
        <div id="analytics-content" class="hidden">
          <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è JavaScript -->
        </div>
      </div>

      <!-- –°–ï–ö–¶–ò–Ø –°–†–ê–í–ù–ï–ù–ò–Ø –° –ü–†–ï–î–´–î–£–©–ò–ú–ò –î–ù–Ø–ú–ò -->
      <div id="comparison" class="comparison-section hidden">
        <div class="comparison-header" id="comparison-toggle">
          <h3 class="comparison-title">üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –¥–Ω—è–º–∏</h3>
          <span class="toggle-icon">‚ñº</span>
        </div>
        
        <div id="comparison-content" class="hidden">
          <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è -->
        </div>
      </div>

      <!-- –°–ï–ö–¶–ò–Ø –ì–†–£–ü–ü–ò–†–û–í–û–ö –ü–û –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø–ú –ò –û–¢–î–ï–õ–ê–ú -->
      <div id="grouping-analytics" class="grouping-section hidden">
        <div class="grouping-header" id="grouping-toggle">
          <h3 class="grouping-title">üè¢ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º –∏ –æ—Ç–¥–µ–ª–∞–º</h3>
          <span class="toggle-icon">‚ñº</span>
        </div>
        
        <div id="grouping-content" class="hidden">
          <div class="grouping-tabs">
            <div class="grouping-tab active" data-tab="direction">üìä –ü–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º</div>
            <div class="grouping-tab" data-tab="department">üèõÔ∏è –ü–æ –æ—Ç–¥–µ–ª–∞–º</div>
            <div class="grouping-tab" data-tab="hierarchy">üå≥ –ò–µ—Ä–∞—Ä—Ö–∏—è</div>
          </div>
          
          <div id="direction-content" class="grouping-content active">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º -->
          </div>
          
          <div id="department-content" class="grouping-content">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ –æ—Ç–¥–µ–ª–∞–º -->
          </div>
          
          <div id="hierarchy-content" class="grouping-content">
            <!-- –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ -->
          </div>
        </div>
      </div>

      <!-- –°–ï–ö–¶–ò–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ü–û –í–†–ï–ú–ï–ù–ò –°–£–¢–û–ö -->
      <div id="time-statistics" class="time-statistics hidden">
        <div class="time-statistics-header" id="time-statistics-toggle">
          <h3 class="time-statistics-title">‚è∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫</h3>
          <span class="toggle-icon">‚ñº</span>
        </div>
        
        <div id="time-statistics-content" class="hidden">
          <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ -->
        </div>
      </div>

      <!-- –°–ï–ö–¶–ò–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò –ü–û –í–ò–î–ê–ú –†–ê–ë–û–¢ -->
      <div id="work-types-analytics" class="work-types-analytics hidden">
        <div class="work-types-header" id="work-types-toggle">
          <h3 class="work-types-title">üîç –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç</h3>
          <span class="toggle-icon">‚ñº</span>
        </div>
        
        <div id="work-types-content" class="hidden">
          <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç -->
        </div>
      </div>

      <!-- –ö–ù–û–ü–ö–ò –í–ù–ò–ó–£ -->
      <button id="export-excel">üìä –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
      <div class="action-buttons">
        <button id="clear-cache-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</button>
        <button id="toggle-auto-reload">üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –í–ö–õ</button>
      </div>
    </div>
  </div>

  <script>
    // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    function parseTime(timeStr) {
      if (!timeStr) return 0;
      const parts = timeStr.split(':').map(Number);
      if (parts.length !== 3) return 0;
      const [h, m, s] = parts;
      return (h || 0) * 3600 + (m || 0) * 60 + (s || 0);
    }

    function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    function parseCurrency(str) {
      if (!str || typeof str !== 'string') return 0;
      let clean = str.trim().replace(/^—Ä\.\s*/i, '');
      clean = clean.replace(',', '.');
      const num = parseFloat(clean);
      return isNaN(num) ? 0 : num;
    }

    function getHourFromTime(timeStr) {
      if (!timeStr) return null;
      const [h] = timeStr.split(':');
      return parseInt(h) || 0;
    }

    function isResponsible(position) {
      return position === '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π' || position === '–û—Ç–≤–µ—Ç—Å–≤–µ–Ω–Ω—ã–π';
    }

    function formatDateTime(date) {
      return new Intl.DateTimeFormat('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      }).format(date);
    }

    function calculateNormative(units, seconds) {
      if (seconds <= 0) return 0;
      const hours = seconds / 3600;
      return units / hours;
    }

    function parseDate(dateStr) {
      const [day, month, year] = dateStr.split('.').map(Number);
      return new Date(year, month - 1, day);
    }

    function formatDate(date) {
      return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
    }

    // === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ê–†–•–ò–í–û–í ===
    function getArchiveNameForDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      return `${year}-${month}`;
    }

    function getArchiveUrl(archiveName) {
      const encodedName = encodeURIComponent(`${archiveName} fullData.json`);
      return `${window.location.origin}/archive/${encodedName}`;
    }

    // === –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ß–ê–°–û–í–´–• –ò–ù–¢–ï–†–í–ê–õ–û–í ===
    function getHourIntervalForWorkDay(timeStr, workDate) {
      if (!timeStr) return null;
      
      const hour = getHourFromTime(timeStr);
      if (hour === null) return null;
      
      if (hour < 9) {
        const nightHour = hour + 24;
        const endHour = nightHour + 1;
        return {
          key: `${String(hour).padStart(2, '0')}-${String(endHour - 24).padStart(2, '0')}`,
          display: `${String(hour).padStart(2, '0')}-${String(endHour - 24).padStart(2, '0')} (–Ω–æ—á—å)`,
          isNight: true,
          sortKey: nightHour
        };
      } else {
        const endHour = hour + 1;
        return {
          key: `${String(hour).padStart(2, '0')}-${String(endHour).padStart(2, '0')}`,
          display: `${String(hour).padStart(2, '0')}-${String(endHour).padStart(2, '0')}`,
          isNight: false,
          sortKey: hour
        };
      }
    }

    // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
    let records = [];
    let standards = [];
    let selectedDate = '';
    let allWorkTypes = [];
    let currentMonth = new Date();
    currentMonth.setDate(1);

    let autoReloadTimer = null;
    let autoReloadEnabled = true;
    let currentArchive = null;
    let uiInitialized = false;

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const controlsDiv = document.getElementById('controls');
    const reportDiv = document.getElementById('report');
    const lastUpdatedDiv = document.getElementById('last-updated');
    const clearCacheBtn = document.getElementById('clear-cache-btn');
    const toggleAutoReloadBtn = document.getElementById('toggle-auto-reload');
    const exportExcelBtn = document.getElementById('export-excel');
    const calendarTitle = document.getElementById('calendar-title');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const calendarDaysContainer = document.getElementById('calendar-days');
    const loadingProgress = document.getElementById('loading-progress');
    const analyticsSection = document.getElementById('analytics');
    const analyticsContent = document.getElementById('analytics-content');
    const workTypesAnalyticsSection = document.getElementById('work-types-analytics');
    const workTypesContent = document.getElementById('work-types-content');
    const comparisonSection = document.getElementById('comparison');
    const comparisonContent = document.getElementById('comparison-content');
    const timeStatisticsSection = document.getElementById('time-statistics');
    const timeStatisticsContent = document.getElementById('time-statistics-content');
    const groupingSection = document.getElementById('grouping-analytics');
    const groupingContent = document.getElementById('grouping-content');

    // === –§–£–ù–ö–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò ===
    function updateProgress(percent) {
      if (loadingProgress) {
        loadingProgress.style.width = percent + '%';
      }
    }

    async function loadStandards() {
      const standardsUrl = `${window.location.origin}/archive/standard%20fullData.json`;
      
      try {
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ –∏–∑:', standardsUrl);
        const response = await fetch(`${standardsUrl}?t=${Date.now()}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status} - ${response.statusText}`);
        }
        
        const data = await response.json();
        if (Array.isArray(data.records)) {
          standards = data.records.filter(record => 
            isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å']) && record['–ù–æ—Ä–º–∞—Ç–∏–≤ 1']
          );
          console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤:', standards.length);
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤:', err);
        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã
        standards = [
          {
            "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–í—Ö–æ–¥—è—â–∏–µ",
            "–û—Ç–¥–µ–ª": "–ü—Ä–∏–µ–º–∫–∞",
            "–í–∏–¥ —Ä–∞–±–æ—Ç": "–†–∞–∑–≥—Ä—É–∑–∫–∞",
            "–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞": "–í—Å–µ",
            "–ù–æ—Ä–º–∞—Ç–∏–≤ 1": "120"
          },
          {
            "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–í—Ö–æ–¥—è—â–∏–µ",
            "–û—Ç–¥–µ–ª": "–ü—Ä–∏–µ–º–∫–∞", 
            "–í–∏–¥ —Ä–∞–±–æ—Ç": "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞",
            "–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞": "–í—Å–µ",
            "–ù–æ—Ä–º–∞—Ç–∏–≤ 1": "80"
          },
          {
            "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–ò—Å—Ö–æ–¥—è—â–∏–µ",
            "–û—Ç–¥–µ–ª": "–û—Ç–≥—Ä—É–∑–∫–∞",
            "–í–∏–¥ —Ä–∞–±–æ—Ç": "–ü–æ–≥—Ä—É–∑–∫–∞",
            "–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞": "–í—Å–µ",
            "–ù–æ—Ä–º–∞—Ç–∏–≤ 1": "100"
          },
          {
            "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–°–∫–ª–∞–¥",
            "–û—Ç–¥–µ–ª": "–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è",
            "–í–∏–¥ —Ä–∞–±–æ—Ç": "–ö–æ–º–ø–ª–µ–∫—Ç–æ–≤–∫–∞",
            "–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞": "–í—Å–µ",
            "–ù–æ—Ä–º–∞—Ç–∏–≤ 1": "90"
          }
        ];
      }
    }

    function getStandardForWork(workType, productGroup = null) {
      // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ –≤–∏–¥—É —Ä–∞–±–æ—Ç –∏ –≥—Ä—É–ø–ø–µ —Ç–æ–≤–∞—Ä–∞
      if (productGroup) {
        const specificStandard = standards.find(standard =>
          standard['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType &&
          standard['–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞'] === productGroup
        );
        if (specificStandard) return parseFloat(specificStandard['–ù–æ—Ä–º–∞—Ç–∏–≤ 1']);
      }
      
      // –ó–∞—Ç–µ–º –∏—â–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –≤–∏–¥—É —Ä–∞–±–æ—Ç
      const generalStandard = standards.find(standard =>
        standard['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType
      );
      
      return generalStandard ? parseFloat(generalStandard['–ù–æ—Ä–º–∞—Ç–∏–≤ 1']) : 0;
    }

    function getDirectionAndDepartment(workType) {
      const standard = standards.find(s => s['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType);
      return {
        direction: standard?.['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
        department: standard?.['–û—Ç–¥–µ–ª'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
      };
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    function createTestData() {
      console.log('–°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...');
      const testRecords = [];
      const workTypes = ['–ü–æ–≥—Ä—É–∑–∫–∞', '–†–∞–∑–≥—Ä—É–∑–∫–∞', '–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞', '–£–ø–∞–∫–æ–≤–∫–∞', '–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞', '–ö–æ–º–ø–ª–µ–∫—Ç–æ–≤–∫–∞'];
      const employees = ['–ò–≤–∞–Ω–æ–≤ –ò.–ò.', '–ü–µ—Ç—Ä–æ–≤ –ü.–ü.', '–°–∏–¥–æ—Ä–æ–≤ –°.–°.', '–ö—É–∑–Ω–µ—Ü–æ–≤ –ê.–í.', '–°–º–∏—Ä–Ω–æ–≤ –î.–ö.'];
      const productGroups = ['–î–∏—Å–∫–∏', '–®–∏–Ω—ã', '–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã', '–ú–∞—Å–ª–∞', '–§–∏–ª—å—Ç—Ä—ã'];
      
      const today = new Date();
      
      // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
      for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
        const date = new Date(today);
        date.setDate(today.getDate() - dayOffset);
        const dateStr = formatDate(date);
        
        for (let i = 0; i < 15; i++) {
          const workType = workTypes[i % workTypes.length];
          const { direction, department } = getDirectionAndDepartment(workType);
          
          testRecords.push({
            '–†–∞–±–æ—á–∏–π –¥–µ–Ω—å': dateStr,
            '–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏': `${8 + (i % 10)}:${String(i % 60).padStart(2, '0')}:00`,
            '–í–∏–¥ —Ä–∞–±–æ—Ç': workType,
            '–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞': productGroups[i % productGroups.length],
            '–î–æ–ª–∂–Ω–æ—Å—Ç—å': i % 3 === 0 ? '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π' : '–ü–æ–º–æ—â–Ω–∏–∫',
            '–°–æ—Ç—Ä—É–¥–Ω–∏–∫': employees[i % employees.length],
            '–ü–æ—Å—Ç–∞–≤–∫–∞': `–ü–æ—Å—Ç–∞–≤–∫–∞ ${Math.floor(i / 3) + 1}`,
            '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü': (Math.random() * 100 + 50).toFixed(0),
            '–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è': '01:00:00',
            '–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞': `—Ä.${(Math.random() * 1000 + 500).toFixed(2)}`,
            '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': direction,
            '–û—Ç–¥–µ–ª': department
          });
        }
      }
      
      return testRecords;
    }

    async function loadData() {
      if (!currentArchive) {
        currentArchive = getArchiveNameForDate(new Date());
      }

      const url = getArchiveUrl(currentArchive);
      
      try {
        loadingDiv.classList.remove('hidden');
        errorDiv.classList.add('hidden');
        controlsDiv.classList.add('hidden');
        updateProgress(10);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ—Ä–º–∞—Ç–∏–≤—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        await Promise.all([loadStandards()]);

        loadingDiv.innerHTML = `
          <div class="loading-spinner"></div>
          <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞—Ä—Ö–∏–≤–∞ ${currentArchive}<span class="loading-dots"></span></span>
        `;

        console.log('–ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑:', url);
        const urlWithCacheBust = `${url}?t=${Date.now()}`;
        updateProgress(30);
        
        const response = await fetch(urlWithCacheBust);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status} - ${response.statusText}`);
        }
        
        updateProgress(60);
        const data = await response.json();
        
        if (!Array.isArray(data.records)) {
          throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
        }
        
        updateProgress(80);
        records = data.records;
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –æ—Ç–¥–µ–ª—ã –∫ –∑–∞–ø–∏—Å—è–º
        records.forEach(record => {
          const { direction, department } = getDirectionAndDepartment(record['–í–∏–¥ —Ä–∞–±–æ—Ç']);
          record['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] = direction;
          record['–û—Ç–¥–µ–ª'] = department;
        });
        
        allWorkTypes = [...new Set(records.map(r => r['–í–∏–¥ —Ä–∞–±–æ—Ç']).filter(Boolean))].sort();
        lastUpdatedDiv.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${formatDateTime(new Date())} | –ê—Ä—Ö–∏–≤: ${currentArchive} | –ù–æ—Ä–º–∞—Ç–∏–≤–æ–≤: ${standards.length}`;
        
        updateProgress(100);
        setTimeout(() => {
          initUI();
          updateProgress(0);
        }, 500);
        
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:', err);
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        records = createTestData();
        allWorkTypes = [...new Set(records.map(r => r['–í–∏–¥ —Ä–∞–±–æ—Ç']).filter(Boolean))].sort();
        lastUpdatedDiv.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${formatDateTime(new Date())} | –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï | –ù–æ—Ä–º–∞—Ç–∏–≤–æ–≤: ${standards.length}`;
        
        errorDiv.textContent = `‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ${err.message}. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.`;
        errorDiv.classList.remove('hidden');
        
        updateProgress(100);
        setTimeout(() => {
          initUI();
          updateProgress(0);
        }, 500);
      }
    }

    // === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    function initUI() {
      loadingDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');
      controlsDiv.classList.remove('hidden');

      renderCalendar();

      if (!uiInitialized) {
        setupEventListeners();
        uiInitialized = true;
      }

      const uniqueDates = [...new Set(records.map(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å']))].filter(Boolean).sort();
      if (uniqueDates.length > 0 && !selectedDate) {
        selectedDate = uniqueDates[0];
      }
      renderReport();
    }

    function setupEventListeners() {
      clearCacheBtn.addEventListener('click', () => {
        localStorage.clear();
        window.location.reload();
      });

      toggleAutoReloadBtn.addEventListener('click', () => {
        autoReloadEnabled = !autoReloadEnabled;
        if (autoReloadEnabled) {
          startAutoReload();
          toggleAutoReloadBtn.textContent = 'üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –í–ö–õ';
        } else {
          if (autoReloadTimer) clearInterval(autoReloadTimer);
          toggleAutoReloadBtn.textContent = 'üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –í–´–ö–õ';
        }
      });

      exportExcelBtn.addEventListener('click', exportToExcel);

      prevMonthBtn.addEventListener('click', () => {
        currentMonth.setMonth(currentMonth.getMonth() - 1);
        const targetArchive = getArchiveNameForDate(currentMonth);
        if (currentArchive !== targetArchive) {
          currentArchive = targetArchive;
          selectedDate = '';
          loadData();
        } else {
          renderCalendar();
        }
      });

      nextMonthBtn.addEventListener('click', () => {
        currentMonth.setMonth(currentMonth.getMonth() + 1);
        const targetArchive = getArchiveNameForDate(currentMonth);
        if (currentArchive !== targetArchive) {
          currentArchive = targetArchive;
          selectedDate = '';
          loadData();
        } else {
          renderCalendar();
        }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Å–µ–∫—Ü–∏–π
      setupToggleHandler('analytics-toggle', 'analytics-content');
      setupToggleHandler('work-types-toggle', 'work-types-content');
      setupToggleHandler('comparison-toggle', 'comparison-content');
      setupToggleHandler('time-statistics-toggle', 'time-statistics-content');
      setupToggleHandler('grouping-toggle', 'grouping-content');

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–æ–∫
      setupGroupingTabs();
    }

    function setupToggleHandler(toggleId, contentId) {
      const toggle = document.getElementById(toggleId);
      const content = document.getElementById(contentId);
      if (toggle && content) {
        toggle.addEventListener('click', function() {
          const icon = this.querySelector('.toggle-icon');
          if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            icon.textContent = '‚ñº';
          } else {
            content.classList.add('hidden');
            icon.textContent = '‚ñ∂';
          }
        });
      }
    }

    function setupGroupingTabs() {
      const tabs = document.querySelectorAll('.grouping-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.getAttribute('data-tab');
          
          // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
          tabs.forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.grouping-content').forEach(c => c.classList.remove('active'));
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç—É
          this.classList.add('active');
          document.getElementById(`${tabName}-content`).classList.add('active');
        });
      });
    }

    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      const monthNames = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
      calendarTitle.textContent = `${monthNames[month]} ${year}`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const firstDayOfWeek = firstDay.getDay();

      calendarDaysContainer.innerHTML = '';
      const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
      dayNames.forEach(name => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = name;
        calendarDaysContainer.appendChild(header);
      });

      for (let i = 0; i < (firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1); i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day disabled';
        calendarDaysContainer.appendChild(empty);
      }

      const availableDates = new Set(records.map(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å']));
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${String(day).padStart(2, '0')}.${String(month + 1).padStart(2, '0')}.${year}`;
        const hasData = availableDates.has(dateStr);
        const dayEl = document.createElement('div');
        dayEl.className = `calendar-day${hasData ? ' has-data' : ''}`;
        dayEl.textContent = day;
        if (hasData) {
          dayEl.addEventListener('click', () => {
            selectedDate = dateStr;
            renderReport();
          });
        } else {
          dayEl.classList.add('disabled');
        }
        calendarDaysContainer.appendChild(dayEl);
      }

      const lastDayOfWeek = lastDay.getDay();
      const remaining = 6 - (lastDayOfWeek === 0 ? 6 : lastDayOfWeek - 1);
      for (let i = 0; i < remaining; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day disabled';
        calendarDaysContainer.appendChild(empty);
      }
    }

    function renderReport() {
      if (!selectedDate) {
        reportDiv.classList.add('hidden');
        analyticsSection.classList.add('hidden');
        workTypesAnalyticsSection.classList.add('hidden');
        comparisonSection.classList.add('hidden');
        timeStatisticsSection.classList.add('hidden');
        groupingSection.classList.add('hidden');
        return;
      }

      const allRecords = records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === selectedDate);
      const responsibleRecords = allRecords.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));

      if (allRecords.length === 0) {
        reportDiv.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç–µ.</p>';
        reportDiv.classList.remove('hidden');
        analyticsSection.classList.add('hidden');
        workTypesAnalyticsSection.classList.add('hidden');
        comparisonSection.classList.add('hidden');
        timeStatisticsSection.classList.add('hidden');
        groupingSection.classList.add('hidden');
        return;
      }

      // –û—Å–Ω–æ–≤–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
      renderSimpleAnalytics(allRecords, responsibleRecords);
      
      // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –¥–Ω—è–º–∏
      renderComparisonAnalytics(selectedDate);
      
      // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º –∏ –æ—Ç–¥–µ–ª–∞–º
      renderGroupingAnalytics(allRecords);
      
      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
      renderTimeStatistics(allRecords);
      
      // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç
      renderWorkTypesAnalytics(allRecords, selectedDate);

      reportDiv.classList.remove('hidden');
    }

    function renderSimpleAnalytics(allRecords, responsibleRecords) {
      let totalUnits = 0, totalTimeSec = 0, totalTasks = 0, totalAmount = 0;
      const uniqueResponsibles = [...new Set(responsibleRecords.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))];

      responsibleRecords.forEach(r => {
        totalUnits += parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        totalTimeSec += parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        totalTasks++;
      });

      allRecords.forEach(r => {
        totalAmount += parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });

      const factNormative = calculateNormative(totalUnits, totalTimeSec);
      
      analyticsSection.classList.remove('hidden');
      
      const totalHours = totalTimeSec / 3600;
      const avgRevenuePerHour = totalHours > 0 ? totalAmount / totalHours : 0;
      const uniqueWorkTypes = [...new Set(allRecords.map(r => r['–í–∏–¥ —Ä–∞–±–æ—Ç']))].filter(Boolean);
      const uniqueBrigades = [...new Set(responsibleRecords.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))];
      const uniqueDirections = [...new Set(allRecords.map(r => r['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']))].filter(Boolean);
      const uniqueDepartments = [...new Set(allRecords.map(r => r['–û—Ç–¥–µ–ª']))].filter(Boolean);
      
      let html = `
        <div class="analytics-grid">
          <div class="analytics-card">
            <h4>üìà –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h4>
            <div class="analytics-value">${totalUnits}</div>
            <p class="analytics-label">–í—Å–µ–≥–æ –µ–¥–∏–Ω–∏—Ü</p>
            
            <div class="analytics-value">${formatTime(totalTimeSec)}</div>
            <p class="analytics-label">–û–±—â–µ–µ –≤—Ä–µ–º—è</p>
            
            <div class="analytics-value">—Ä.${totalAmount.toFixed(0)}</div>
            <p class="analytics-label">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</p>
          </div>

          <div class="analytics-card">
            <h4>‚ö° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h4>
            <div class="analytics-value">${factNormative.toFixed(1)}</div>
            <p class="analytics-label">–ù–æ—Ä–º–∞—Ç–∏–≤ (—à—Ç/—á–∞—Å)</p>
            
            <div class="analytics-value">—Ä.${avgRevenuePerHour.toFixed(2)}</div>
            <p class="analytics-label">–í—ã—Ä—É—á–∫–∞ –≤ —á–∞—Å</p>
            
            <div class="analytics-value">${responsibleRecords.length}</div>
            <p class="analytics-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</p>
          </div>

          <div class="analytics-card">
            <h4>üë• –°—Ç—Ä—É–∫—Ç—É—Ä–∞</h4>
            <div class="analytics-value">${uniqueWorkTypes.length}</div>
            <p class="analytics-label">–í–∏–¥–æ–≤ —Ä–∞–±–æ—Ç</p>
            
            <div class="analytics-value">${uniqueBrigades.length}</div>
            <p class="analytics-label">–ë—Ä–∏–≥–∞–¥</p>
            
            <div class="analytics-value">${allRecords.length}</div>
            <p class="analytics-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</p>
          </div>

          <div class="analytics-card">
            <h4>üè¢ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</h4>
            <div class="analytics-value">${uniqueDirections.length}</div>
            <p class="analytics-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π</p>
            
            <div class="analytics-value">${uniqueDepartments.length}</div>
            <p class="analytics-label">–û—Ç–¥–µ–ª–æ–≤</p>
            
            <div class="analytics-value">-</div>
            <p class="analytics-label">–ì—Ä—É–ø–ø–∏—Ä–æ–≤–æ–∫</p>
          </div>
        </div>
      `;
      
      analyticsContent.innerHTML = html;
    }

    function renderComparisonAnalytics(currentDate) {
      const currentDateObj = parseDate(currentDate);
      const previousDates = [];
      
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
      for (let i = 1; i <= 7; i++) {
        const date = new Date(currentDateObj);
        date.setDate(currentDateObj.getDate() - i);
        const dateStr = formatDate(date);
        previousDates.push({ date: dateStr, records: records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === dateStr) });
      }

      const currentDayRecords = records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === currentDate);
      const currentResponsibleRecords = currentDayRecords.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
      
      let currentUnits = 0, currentTime = 0, currentAmount = 0;
      currentResponsibleRecords.forEach(r => {
        currentUnits += parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        currentTime += parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
      });
      currentDayRecords.forEach(r => {
        currentAmount += parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });

      const currentNormative = calculateNormative(currentUnits, currentTime);

      let html = '<div class="comparison-grid">';
      
      // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –µ–¥–∏–Ω–∏—Ü–∞–º
      const previousUnits = previousDates.map(d => {
        const respRecords = d.records.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
        return respRecords.reduce((sum, r) => sum + (parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0), 0);
      }).filter(val => val > 0);
      
      const avgUnits = previousUnits.length > 0 ? previousUnits.reduce((a, b) => a + b) / previousUnits.length : 0;
      const unitsTrend = currentUnits - avgUnits;
      const unitsPercent = avgUnits > 0 ? ((unitsTrend / avgUnits) * 100).toFixed(1) : 0;
      
      html += `
        <div class="comparison-card">
          <h4>üì¶ –ï–¥–∏–Ω–∏—Ü—ã</h4>
          <div class="analytics-value">${currentUnits}</div>
          <p class="analytics-label">–°–µ–≥–æ–¥–Ω—è</p>
          <div class="analytics-value ${unitsTrend >= 0 ? 'trend-up' : 'trend-down'}">
            ${unitsTrend >= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(unitsPercent)}%
          </div>
          <p class="analytics-label">–°—Ä–µ–¥–Ω–µ–µ: ${avgUnits.toFixed(0)}</p>
        </div>
      `;

      // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –Ω–æ—Ä–º–∞—Ç–∏–≤—É
      const previousNorms = previousDates.map(d => {
        const respRecords = d.records.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
        const units = respRecords.reduce((sum, r) => sum + (parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0), 0);
        const time = respRecords.reduce((sum, r) => sum + parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']), 0);
        return calculateNormative(units, time);
      }).filter(val => val > 0);
      
      const avgNorm = previousNorms.length > 0 ? previousNorms.reduce((a, b) => a + b) / previousNorms.length : 0;
      const normTrend = currentNormative - avgNorm;
      const normPercent = avgNorm > 0 ? ((normTrend / avgNorm) * 100).toFixed(1) : 0;
      
      html += `
        <div class="comparison-card">
          <h4>‚ö° –ù–æ—Ä–º–∞—Ç–∏–≤</h4>
          <div class="analytics-value">${currentNormative.toFixed(1)}</div>
          <p class="analytics-label">–°–µ–≥–æ–¥–Ω—è (—à—Ç/—á–∞—Å)</p>
          <div class="analytics-value ${normTrend >= 0 ? 'trend-up' : 'trend-down'}">
            ${normTrend >= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(normPercent)}%
          </div>
          <p class="analytics-label">–°—Ä–µ–¥–Ω–µ–µ: ${avgNorm.toFixed(1)}</p>
        </div>
      `;

      // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –≤—ã—Ä—É—á–∫–µ
      const previousAmounts = previousDates.map(d => 
        d.records.reduce((sum, r) => sum + parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']), 0)
      ).filter(val => val > 0);
      
      const avgAmount = previousAmounts.length > 0 ? previousAmounts.reduce((a, b) => a + b) / previousAmounts.length : 0;
      const amountTrend = currentAmount - avgAmount;
      const amountPercent = avgAmount > 0 ? ((amountTrend / avgAmount) * 100).toFixed(1) : 0;
      
      html += `
        <div class="comparison-card">
          <h4>üí∞ –í—ã—Ä—É—á–∫–∞</h4>
          <div class="analytics-value">—Ä.${currentAmount.toFixed(0)}</div>
          <p class="analytics-label">–°–µ–≥–æ–¥–Ω—è</p>
          <div class="analytics-value ${amountTrend >= 0 ? 'trend-up' : 'trend-down'}">
            ${amountTrend >= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(amountPercent)}%
          </div>
          <p class="analytics-label">–°—Ä–µ–¥–Ω–µ–µ: —Ä.${avgAmount.toFixed(0)}</p>
        </div>
      `;

      html += '</div>';
      comparisonContent.innerHTML = html;
      comparisonSection.classList.remove('hidden');
    }

    function renderGroupingAnalytics(allRecords) {
      groupingSection.classList.remove('hidden');
      
      // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º
      renderDirectionAnalytics(allRecords);
      
      // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º
      renderDepartmentAnalytics(allRecords);
      
      // –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
      renderHierarchyAnalytics(allRecords);
    }

    function renderDirectionAnalytics(allRecords) {
      const directionStats = {};
      
      allRecords.forEach(record => {
        const direction = record['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        if (!directionStats[direction]) {
          directionStats[direction] = {
            totalUnits: 0,
            totalTime: 0,
            totalAmount: 0,
            tasks: 0,
            workTypes: new Set(),
            departments: new Set(),
            brigades: new Set()
          };
        }
        
        const stats = directionStats[direction];
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          stats.totalUnits += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          stats.totalTime += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        }
        stats.totalAmount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        stats.tasks++;
        stats.workTypes.add(record['–í–∏–¥ —Ä–∞–±–æ—Ç']);
        stats.departments.add(record['–û—Ç–¥–µ–ª']);
        if (record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']) {
          stats.brigades.add(record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']);
        }
      });

      let html = '<div class="grouping-grid">';
      
      Object.entries(directionStats).forEach(([direction, stats]) => {
        const totalHours = stats.totalTime / 3600;
        const normative = totalHours > 0 ? stats.totalUnits / totalHours : 0;
        const revenuePerHour = totalHours > 0 ? stats.totalAmount / totalHours : 0;
        
        html += `
          <div class="group-card">
            <h4>${direction}</h4>
            <div class="group-stats">
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.totalUnits}</div>
                <div class="group-stat-label">–ï–¥–∏–Ω–∏—Ü</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.tasks}</div>
                <div class="group-stat-label">–ó–∞–¥–∞—á</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.workTypes.size}</div>
                <div class="group-stat-label">–í–∏–¥–æ–≤ —Ä–∞–±–æ—Ç</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.departments.size}</div>
                <div class="group-stat-label">–û—Ç–¥–µ–ª–æ–≤</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.brigades.size}</div>
                <div class="group-stat-label">–ë—Ä–∏–≥–∞–¥</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${normative.toFixed(1)}</div>
                <div class="group-stat-label">–ù–æ—Ä–º–∞—Ç–∏–≤</div>
              </div>
            </div>
            <div style="margin-top: 8px; font-size: 11px; color: #666;">
              –í—ã—Ä—É—á–∫–∞: —Ä.${stats.totalAmount.toFixed(0)} | –í—ã—Ä—É—á–∫–∞/—á–∞—Å: —Ä.${revenuePerHour.toFixed(2)}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      document.getElementById('direction-content').innerHTML = html;
    }

    function renderDepartmentAnalytics(allRecords) {
      const departmentStats = {};
      
      allRecords.forEach(record => {
        const department = record['–û—Ç–¥–µ–ª'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        if (!departmentStats[department]) {
          departmentStats[department] = {
            totalUnits: 0,
            totalTime: 0,
            totalAmount: 0,
            tasks: 0,
            workTypes: new Set(),
            directions: new Set(),
            brigades: new Set()
          };
        }
        
        const stats = departmentStats[department];
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          stats.totalUnits += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          stats.totalTime += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        }
        stats.totalAmount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        stats.tasks++;
        stats.workTypes.add(record['–í–∏–¥ —Ä–∞–±–æ—Ç']);
        stats.directions.add(record['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']);
        if (record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']) {
          stats.brigades.add(record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']);
        }
      });

      let html = '<div class="grouping-grid">';
      
      Object.entries(departmentStats).forEach(([department, stats]) => {
        const totalHours = stats.totalTime / 3600;
        const normative = totalHours > 0 ? stats.totalUnits / totalHours : 0;
        const revenuePerHour = totalHours > 0 ? stats.totalAmount / totalHours : 0;
        
        html += `
          <div class="group-card">
            <h4>${department}</h4>
            <div class="group-stats">
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.totalUnits}</div>
                <div class="group-stat-label">–ï–¥–∏–Ω–∏—Ü</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.tasks}</div>
                <div class="group-stat-label">–ó–∞–¥–∞—á</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.workTypes.size}</div>
                <div class="group-stat-label">–í–∏–¥–æ–≤ —Ä–∞–±–æ—Ç</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.directions.size}</div>
                <div class="group-stat-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.brigades.size}</div>
                <div class="group-stat-label">–ë—Ä–∏–≥–∞–¥</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${normative.toFixed(1)}</div>
                <div class="group-stat-label">–ù–æ—Ä–º–∞—Ç–∏–≤</div>
              </div>
            </div>
            <div style="margin-top: 8px; font-size: 11px; color: #666;">
              –í—ã—Ä—É—á–∫–∞: —Ä.${stats.totalAmount.toFixed(0)} | –í—ã—Ä—É—á–∫–∞/—á–∞—Å: —Ä.${revenuePerHour.toFixed(2)}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      document.getElementById('department-content').innerHTML = html;
    }

    function renderHierarchyAnalytics(allRecords) {
      const hierarchy = {};
      
      // –°—Ç—Ä–æ–∏–º –∏–µ—Ä–∞—Ä—Ö–∏—é: –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -> –û—Ç–¥–µ–ª -> –í–∏–¥ —Ä–∞–±–æ—Ç
      allRecords.forEach(record => {
        const direction = record['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        const department = record['–û—Ç–¥–µ–ª'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        const workType = record['–í–∏–¥ —Ä–∞–±–æ—Ç'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        
        if (!hierarchy[direction]) {
          hierarchy[direction] = {
            totalUnits: 0, totalTime: 0, totalAmount: 0, tasks: 0,
            departments: {}
          };
        }
        
        if (!hierarchy[direction].departments[department]) {
          hierarchy[direction].departments[department] = {
            totalUnits: 0, totalTime: 0, totalAmount: 0, tasks: 0,
            workTypes: {}
          };
        }
        
        if (!hierarchy[direction].departments[department].workTypes[workType]) {
          hierarchy[direction].departments[department].workTypes[workType] = {
            totalUnits: 0, totalTime: 0, totalAmount: 0, tasks: 0
          };
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        const dirStats = hierarchy[direction];
        const deptStats = hierarchy[direction].departments[department];
        const workStats = hierarchy[direction].departments[department].workTypes[workType];
        
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          const units = parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          const time = parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
          dirStats.totalUnits += units;
          dirStats.totalTime += time;
          deptStats.totalUnits += units;
          deptStats.totalTime += time;
          workStats.totalUnits += units;
          workStats.totalTime += time;
        }
        
        const amount = parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        dirStats.totalAmount += amount;
        deptStats.totalAmount += amount;
        workStats.totalAmount += amount;
        
        dirStats.tasks++;
        deptStats.tasks++;
        workStats.tasks++;
      });

      let html = '';
      
      Object.entries(hierarchy).forEach(([direction, dirStats]) => {
        const dirNormative = dirStats.totalTime > 0 ? calculateNormative(dirStats.totalUnits, dirStats.totalTime) : 0;
        
        html += `
          <div class="hierarchy-card level-0">
            <div class="hierarchy-header">
              <div class="hierarchy-name">üìä ${direction}</div>
              <div class="hierarchy-stats">
                <span>${dirStats.tasks} –∑–∞–¥–∞—á</span>
                <span>${dirStats.totalUnits} –µ–¥.</span>
                <span>${dirNormative.toFixed(1)} —à—Ç/—á–∞—Å</span>
                <span>—Ä.${dirStats.totalAmount.toFixed(0)}</span>
              </div>
            </div>
        `;
        
        Object.entries(dirStats.departments).forEach(([department, deptStats]) => {
          const deptNormative = deptStats.totalTime > 0 ? calculateNormative(deptStats.totalUnits, deptStats.totalTime) : 0;
          
          html += `
            <div class="hierarchy-card level-1">
              <div class="hierarchy-header">
                <div class="hierarchy-name">üèõÔ∏è ${department}</div>
                <div class="hierarchy-stats">
                  <span>${deptStats.tasks} –∑–∞–¥–∞—á</span>
                  <span>${deptStats.totalUnits} –µ–¥.</span>
                  <span>${deptNormative.toFixed(1)} —à—Ç/—á–∞—Å</span>
                  <span>—Ä.${deptStats.totalAmount.toFixed(0)}</span>
                </div>
              </div>
          `;
          
          Object.entries(deptStats.workTypes).forEach(([workType, workStats]) => {
            const workNormative = workStats.totalTime > 0 ? calculateNormative(workStats.totalUnits, workStats.totalTime) : 0;
            const standard = getStandardForWork(workType);
            const performanceClass = standard > 0 ? 
              (workNormative >= standard * 0.9 ? 'performance-good' : 
               workNormative >= standard * 0.7 ? 'performance-average' : 'performance-poor') : '';
            
            html += `
              <div class="hierarchy-card level-2 ${performanceClass}">
                <div class="hierarchy-header">
                  <div class="hierarchy-name">üîß ${workType}</div>
                  <div class="hierarchy-stats">
                    <span>${workStats.tasks} –∑–∞–¥–∞—á</span>
                    <span>${workStats.totalUnits} –µ–¥.</span>
                    <span>${workNormative.toFixed(1)} —à—Ç/—á–∞—Å</span>
                    <span>—Ä.${workStats.totalAmount.toFixed(0)}</span>
                  </div>
                </div>
              </div>
            `;
          });
          
          html += `</div>`;
        });
        
        html += `</div>`;
      });
      
      document.getElementById('hierarchy-content').innerHTML = html;
    }

    function renderTimeStatistics(allRecords) {
      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ –¥–ª—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π
      renderOverallTimeStatistics(allRecords);
      renderDirectionTimeStatistics(allRecords);
      renderDepartmentTimeStatistics(allRecords);
      
      timeStatisticsSection.classList.remove('hidden');
    }

    function renderOverallTimeStatistics(allRecords) {
      const timeStats = {};
      
      allRecords.forEach(record => {
        const interval = getHourIntervalForWorkDay(record['–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏'], selectedDate);
        if (!interval) return;
        
        if (!timeStats[interval.key]) {
          timeStats[interval.key] = {
            interval: interval,
            units: 0,
            amount: 0,
            tasks: 0,
            time: 0
          };
        }
        
        const stats = timeStats[interval.key];
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          stats.units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          stats.time += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        }
        stats.amount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        stats.tasks++;
      });

      let html = '<h4>üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h4><div class="time-chart">';
      
      const sortedIntervals = Object.values(timeStats).sort((a, b) => a.interval.sortKey - b.interval.sortKey);
      const maxUnits = Math.max(...sortedIntervals.map(s => s.units));
      
      sortedIntervals.forEach(stats => {
        const unitsPercent = maxUnits > 0 ? (stats.units / maxUnits) * 100 : 0;
        const normative = stats.time > 0 ? calculateNormative(stats.units, stats.time) : 0;
        
        html += `
          <div class="time-bar">
            <div class="time-label">${stats.interval.display}</div>
            <div class="time-bar-inner">
              <div class="time-bar-fill" style="width: ${unitsPercent}%"></div>
            </div>
            <div class="time-value">
              ${stats.units} –µ–¥. | —Ä.${stats.amount.toFixed(0)}
            </div>
          </div>
          <div style="font-size: 11px; color: #666; margin-left: 100px;">
            –ó–∞–¥–∞—á: ${stats.tasks} | –ù–æ—Ä–º–∞—Ç–∏–≤: ${normative.toFixed(1)} —à—Ç/—á–∞—Å
          </div>
        `;
      });
      
      html += '</div>';
      timeStatisticsContent.innerHTML = html;
    }

    function renderDirectionTimeStatistics(allRecords) {
      const directionTimeStats = {};
      const directions = [...new Set(allRecords.map(r => r['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']))].filter(Boolean);
      
      directions.forEach(direction => {
        directionTimeStats[direction] = {};
        const directionRecords = allRecords.filter(r => r['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === direction);
        
        directionRecords.forEach(record => {
          const interval = getHourIntervalForWorkDay(record['–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏'], selectedDate);
          if (!interval) return;
          
          if (!directionTimeStats[direction][interval.key]) {
            directionTimeStats[direction][interval.key] = {
              interval: interval,
              units: 0,
              amount: 0,
              tasks: 0
            };
          }
          
          const stats = directionTimeStats[direction][interval.key];
          if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
            stats.units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          }
          stats.amount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
          stats.tasks++;
        });
      });

      let html = '<h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º</h4>';
      
      Object.entries(directionTimeStats).forEach(([direction, timeStats]) => {
        html += `<h5 style="margin: 15px 0 8px 0; color: #333;">${direction}</h5><div class="time-chart">`;
        
        const sortedIntervals = Object.values(timeStats).sort((a, b) => a.interval.sortKey - b.interval.sortKey);
        const maxUnits = Math.max(...sortedIntervals.map(s => s.units));
        
        sortedIntervals.forEach(stats => {
          const unitsPercent = maxUnits > 0 ? (stats.units / maxUnits) * 100 : 0;
          
          html += `
            <div class="time-bar">
              <div class="time-label">${stats.interval.display}</div>
              <div class="time-bar-inner">
                <div class="time-bar-fill" style="width: ${unitsPercent}%"></div>
              </div>
              <div class="time-value">
                ${stats.units} –µ–¥. | ${stats.tasks} –∑–∞–¥–∞—á
              </div>
            </div>
          `;
        });
        
        html += '</div>';
      });
      
      timeStatisticsContent.innerHTML += html;
    }

    function renderDepartmentTimeStatistics(allRecords) {
      const departmentTimeStats = {};
      const departments = [...new Set(allRecords.map(r => r['–û—Ç–¥–µ–ª']))].filter(Boolean);
      
      departments.forEach(department => {
        departmentTimeStats[department] = {};
        const departmentRecords = allRecords.filter(r => r['–û—Ç–¥–µ–ª'] === department);
        
        departmentRecords.forEach(record => {
          const interval = getHourIntervalForWorkDay(record['–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏'], selectedDate);
          if (!interval) return;
          
          if (!departmentTimeStats[department][interval.key]) {
            departmentTimeStats[department][interval.key] = {
              interval: interval,
              units: 0,
              amount: 0,
              tasks: 0
            };
          }
          
          const stats = departmentTimeStats[department][interval.key];
          if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
            stats.units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          }
          stats.amount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
          stats.tasks++;
        });
      });

      let html = '<h4>üèõÔ∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º</h4>';
      
      Object.entries(departmentTimeStats).forEach(([department, timeStats]) => {
        html += `<h5 style="margin: 15px 0 8px 0; color: #333;">${department}</h5><div class="time-chart">`;
        
        const sortedIntervals = Object.values(timeStats).sort((a, b) => a.interval.sortKey - b.interval.sortKey);
        const maxUnits = Math.max(...sortedIntervals.map(s => s.units));
        
        sortedIntervals.forEach(stats => {
          const unitsPercent = maxUnits > 0 ? (stats.units / maxUnits) * 100 : 0;
          
          html += `
            <div class="time-bar">
              <div class="time-label">${stats.interval.display}</div>
              <div class="time-bar-inner">
                <div class="time-bar-fill" style="width: ${unitsPercent}%"></div>
              </div>
              <div class="time-value">
                ${stats.units} –µ–¥. | ${stats.tasks} –∑–∞–¥–∞—á
              </div>
            </div>
          `;
        });
        
        html += '</div>';
      });
      
      timeStatisticsContent.innerHTML += html;
    }

    function renderWorkTypesAnalytics(allRecords, selectedDate) {
      const workTypesSection = document.getElementById('work-types-analytics');
      const workTypesContent = document.getElementById('work-types-content');
      
      if (!allRecords.length) {
        workTypesSection.classList.add('hidden');
        return;
      }

      // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç
      const workTypeStats = {};
      
      allRecords.forEach(record => {
        const workType = record['–í–∏–¥ —Ä–∞–±–æ—Ç'] || '–ë–µ–∑ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç';
        const productGroup = record['–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞'] || '–í—Å–µ';
        
        if (!workTypeStats[workType]) {
          workTypeStats[workType] = {
            totalUnits: 0,
            totalTime: 0,
            totalAmount: 0,
            tasks: 0,
            responsibleTasks: 0,
            brigades: new Set(),
            productGroups: new Set(),
            standard: getStandardForWork(workType, productGroup),
            records: []
          };
        }
        
        const stats = workTypeStats[workType];
        stats.records.push(record);
        
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          stats.totalUnits += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          stats.totalTime += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
          stats.responsibleTasks++;
          if (record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']) {
            stats.brigades.add(record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']);
          }
        }
        
        stats.totalAmount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        stats.tasks++;
        if (productGroup && productGroup !== '–í—Å–µ') {
          stats.productGroups.add(productGroup);
        }
      });

      let html = '';
      
      // –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç
      html += '<div class="work-types-grid">';
      
      Object.entries(workTypeStats).forEach(([workType, stats]) => {
        const totalHours = stats.totalTime / 3600;
        const normative = totalHours > 0 ? stats.totalUnits / totalHours : 0;
        const revenuePerHour = totalHours > 0 ? stats.totalAmount / totalHours : 0;
        const avgRevenuePerTask = stats.tasks > 0 ? stats.totalAmount / stats.tasks : 0;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–æ—Ä–º–∞—Ç–∏–≤–∞
        let performanceClass = 'performance-poor';
        let performanceText = '–ù–∏–∑–∫–∞—è';
        if (stats.standard > 0) {
          const percentage = (normative / stats.standard) * 100;
          if (percentage >= 90) {
            performanceClass = 'performance-good';
            performanceText = '–í—ã—Å–æ–∫–∞—è';
          } else if (percentage >= 70) {
            performanceClass = 'performance-average';
            performanceText = '–°—Ä–µ–¥–Ω—è—è';
          }
          performanceText += ` (${percentage.toFixed(0)}%)`;
        } else {
          // –ï—Å–ª–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–∞ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
          if (normative >= 100) {
            performanceClass = 'performance-good';
            performanceText = '–í—ã—Å–æ–∫–∞—è';
          } else if (normative >= 60) {
            performanceClass = 'performance-average';
            performanceText = '–°—Ä–µ–¥–Ω—è—è';
          }
        }

        html += `
          <div class="work-type-card">
            <div class="work-type-header">
              <h4 class="work-type-name">${workType}</h4>
              <div class="${performanceClass} performance-indicator">
                ${performanceText}
              </div>
            </div>
            
            <div class="work-type-stats">
              <div class="stat-item">
                <div class="stat-value">${stats.totalUnits}</div>
                <div class="stat-label">–ï–¥–∏–Ω–∏—Ü</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${stats.tasks}</div>
                <div class="stat-label">–ó–∞–¥–∞—á</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${stats.brigades.size}</div>
                <div class="stat-label">–ë—Ä–∏–≥–∞–¥</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${formatTime(stats.totalTime)}</div>
                <div class="stat-label">–í—Ä–µ–º—è</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${normative.toFixed(1)}</div>
                <div class="stat-label">–ù–æ—Ä–º–∞—Ç–∏–≤</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">—Ä.${stats.totalAmount.toFixed(0)}</div>
                <div class="stat-label">–°—É–º–º–∞</div>
              </div>
            </div>
            
            <div style="margin-top: 10px; font-size: 11px; color: #666;">
              ${stats.standard > 0 ? `–ü–ª–∞–Ω: ${stats.standard} —à—Ç/—á–∞—Å | ` : ''}
              –í—ã—Ä—É—á–∫–∞/—á–∞—Å: —Ä.${revenuePerHour.toFixed(2)} | 
              –ì—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤: ${stats.productGroups.size}
            </div>
          </div>
        `;
      });
      
      html += '</div>';

      // –ì—Ä–∞—Ñ–∏–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤
      if (Object.values(workTypeStats).some(stats => stats.standard > 0)) {
        html += renderComparisonChart(workTypeStats);
      }

      workTypesContent.innerHTML = html;
      workTypesSection.classList.remove('hidden');
    }

    function renderComparisonChart(workTypeStats) {
      let html = `<div class="comparison-chart">
        <h4>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ —Å –ø–ª–∞–Ω–æ–º</h4>`;
      
      Object.entries(workTypeStats)
        .filter(([, stats]) => stats.standard > 0)
        .sort(([,a], [,b]) => {
          const normA = a.totalTime > 0 ? a.totalUnits / (a.totalTime / 3600) : 0;
          const normB = b.totalTime > 0 ? b.totalUnits / (b.totalTime / 3600) : 0;
          return normB - normA;
        })
        .forEach(([workType, stats]) => {
          const normative = stats.totalTime > 0 ? stats.totalUnits / (stats.totalTime / 3600) : 0;
          const percentage = stats.standard > 0 ? Math.min((normative / stats.standard) * 100, 100) : 0;
          const barColor = normative >= stats.standard ? '#28a745' : 
                          normative >= stats.standard * 0.7 ? '#ffc107' : '#dc3545';
          
          html += `
            <div class="chart-bar">
              <div class="chart-label">${workType}</div>
              <div class="chart-bar-inner">
                <div class="chart-bar-fill" style="width: ${percentage}%; background: ${barColor};"></div>
              </div>
              <div class="chart-value">${normative.toFixed(1)}/${stats.standard}</div>
            </div>
          `;
        });
      
      html += `</div>`;
      return html;
    }

    function exportToExcel() {
      alert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ');
    }

    function startAutoReload() {
      if (autoReloadTimer) clearInterval(autoReloadTimer);
      if (!autoReloadEnabled) return;
      autoReloadTimer = setInterval(() => loadData(), 5 * 60 * 1000);
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    document.addEventListener('DOMContentLoaded', function() {
      currentArchive = getArchiveNameForDate(new Date());
      loadData();
      startAutoReload();
    });

    window.addEventListener('beforeunload', () => {
      if (autoReloadTimer) clearInterval(autoReloadTimer);
    });
  </script>
</body>
</html>
