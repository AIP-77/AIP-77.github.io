<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç 2</title>
  <style>
    /* –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ */
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      background: #f9f9f9;
      color: #333;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 10px;
    }
    .version {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }
    .last-updated {
      text-align: center;
      font-size: 13px;
      color: #555;
      margin-bottom: 15px;
      font-style: italic;
    }
    .selected-date {
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      color: #1976d2;
      margin: 15px 0;
      padding: 10px;
      background: #e3f2fd;
      border-radius: 6px;
    }
    .calendar-container {
      margin: 15px 0;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .calendar-title {
      font-size: 18px;
      font-weight: bold;
      margin: 0 10px;
      text-align: center;
    }
    .calendar-nav-btn {
      background: #2196f3;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      min-width: 100px;
      text-align: center;
      font-weight: bold;
    }
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .calendar-day-header {
      text-align: center;
      font-weight: bold;
      padding: 8px;
      background: #f0f0f0;
      border-radius: 4px;
    }
    .calendar-day {
      text-align: center;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .calendar-day.has-data {
      background: #2196f3;
      color: white;
    }
    .calendar-day.selected {
      background: #ff9800;
      color: white;
      font-weight: bold;
    }
    .calendar-day.disabled {
      color: #aaa;
      cursor: not-allowed;
    }
    .toggle-icon {
      display: inline-block;
      width: 16px;
      text-align: center;
      margin-right: 6px;
    }
    .hidden {
      display: none;
    }
    .loading {
      text-align: center;
      color: #666;
      padding: 20px;
    }
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ò–ù–î–ò–ö–ê–¢–û–†–ê –ó–ê–ì–†–£–ó–ö–ò */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2196f3;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-progress {
      background: linear-gradient(90deg, #2196f3, #1976d2);
      height: 3px;
      width: 0%;
      transition: width 0.3s ease;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
    }
    
    .loading-dots:after {
      content: '';
      animation: dots 1.5s steps(5, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –û–ë–™–ï–î–ò–ù–ï–ù–ù–û–ô –ê–ù–ê–õ–ò–¢–ò–ö–ò */
    .combined-analytics {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #fff3e0, #e8f5e9);
      border-radius: 8px;
      border-left: 4px solid #ff9800;
    }
    
    .combined-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .combined-title {
      font-size: 18px;
      font-weight: bold;
      color: #e65100;
      margin: 0;
    }
    
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .analytics-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 3px solid #2196f3;
    }
    
    .analytics-card h4 {
      margin: 0 0 10px 0;
      color: #1976d2;
      font-size: 14px;
    }
    
    .analytics-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin: 5px 0;
    }
    
    .analytics-label {
      font-size: 12px;
      color: #666;
      margin: 0;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –°–†–ê–í–ù–ï–ù–ò–Ø –° –ü–†–ï–î–´–î–£–©–ò–ú–ò –î–ù–Ø–ú–ò */
    .comparison-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .comparison-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .comparison-card h4 {
      margin: 0 0 10px 0;
      color: #388e3c;
      font-size: 14px;
    }
    
    .trend-up {
      color: #4caf50;
    }
    
    .trend-down {
      color: #f44336;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ü–û –í–†–ï–ú–ï–ù–ò –°–£–¢–û–ö */
    .time-statistics {
      margin-top: 20px;
      padding: 20px;
      background: #f3e5f5;
      border-radius: 8px;
      border-left: 4px solid #9c27b0;
    }
    
    .time-statistics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .time-statistics-title {
      font-size: 18px;
      font-weight: bold;
      color: #7b1fa2;
      margin: 0;
    }
    
    .time-chart {
      margin-top: 15px;
    }
    
    .time-bar {
      display: flex;
      align-items: center;
      margin: 8px 0;
      height: 25px;
    }
    
    .time-label {
      width: 100px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .time-bar-inner {
      flex: 1;
      height: 15px;
      background: #e1bee7;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .time-bar-fill {
      height: 100%;
      border-radius: 8px;
      background: linear-gradient(90deg, #ab47bc, #8e24aa);
    }
    
    .time-value {
      width: 100px;
      text-align: right;
      font-size: 12px;
      font-weight: bold;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ì–†–£–ü–ü–ò–†–û–í–û–ö */
    .grouping-section {
      margin-top: 20px;
      padding: 20px;
      background: #e3f2fd;
      border-radius: 8px;
      border-left: 4px solid #1976d2;
    }
    
    .grouping-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .grouping-title {
      font-size: 18px;
      font-weight: bold;
      color: #0d47a1;
      margin: 0;
    }
    
    .grouping-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .group-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-left: 4px solid #2196f3;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .group-card:hover {
      transform: translateY(-2px);
    }
    
    .group-card h4 {
      margin: 0 0 10px 0;
      color: #1976d2;
      font-size: 14px;
    }
    
    .group-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }
    
    .group-stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 6px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    
    .group-stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    
    .group-stat-label {
      font-size: 10px;
      color: #666;
      text-align: center;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò –ü–û –í–ò–î–ê–ú –†–ê–ë–û–¢ */
    .work-types-analytics {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #17a2b8;
    }
    
    .work-types-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .work-types-title {
      font-size: 18px;
      font-weight: bold;
      color: #0c5460;
      margin: 0;
    }
    
    .work-types-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .work-type-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-left: 4px solid #17a2b8;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .work-type-card:hover {
      transform: translateY(-2px);
    }
    
    .work-type-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .work-type-name {
      font-size: 16px;
      font-weight: bold;
      color: #495057;
      margin: 0;
    }
    
    .work-type-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }
    
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    .stat-label {
      font-size: 11px;
      color: #666;
      text-align: center;
    }
    
    .performance-indicator {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
      font-size: 12px;
    }
    
    .performance-good {
      background: #d4edda;
      color: #155724;
    }
    
    .performance-average {
      background: #fff3cd;
      color: #856404;
    }
    
    .performance-poor {
      background: #f8d7da;
      color: #721c24;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–ò */
    .detail-section {
      margin: 10px 0;
      padding: 15px;
      background: #f1f8e9;
      border-radius: 6px;
      border-left: 3px solid #7cb342;
    }
    
    .hour-group, .brigade-group {
      margin: 10px 0;
      padding: 10px;
      background: #e8f5e8;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .brigade-group {
      background: #f3e5f5;
      margin-left: 20px;
    }
    
    .supply-details {
      margin-left: 40px;
      padding: 8px;
      background: #fff3e0;
      border-radius: 4px;
      margin-top: 5px;
    }

    .night-interval {
      background: #5c6bc0 !important;
      color: white;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: black;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ü–†–û–¶–ï–ù–¢–ù–û–ô –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ü–û –í–†–ï–ú–ï–ù–ò */
    .percentage-time-statistics {
      margin-top: 20px;
      padding: 20px;
      background: #e0f2f1;
      border-radius: 8px;
      border-left: 4px solid #00695c;
    }
    
    .percentage-time-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .percentage-time-title {
      font-size: 18px;
      font-weight: bold;
      color: #004d40;
      margin: 0;
    }

    .work-type-time-chart {
      margin: 15px 0;
      padding: 15px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –í–´–ë–û–†–ê –û–¢–î–ï–õ–û–í */
    .department-selector {
      margin: 15px 0;
      padding: 15px;
      background: #fff3cd;
      border-radius: 6px;
      border-left: 3px solid #ffc107;
    }
    
    .department-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    
    .department-btn {
      padding: 8px 16px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .department-btn:hover {
      background: #e3f2fd;
      border-color: #2196f3;
    }
    
    .department-btn.active {
      background: #2196f3;
      color: white;
      border-color: #2196f3;
    }

    /* –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ü–ï–†–°–û–ù–ê–õ–ê (–ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å —Ñ–æ—Ç–æ) */
    .staff-section {
      margin-top: 20px;
      padding: 20px;
      background: #fff8e1;
      border-radius: 8px;
      border-left: 4px solid #ffa000;
    }
    
    .staff-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .staff-title {
      font-size: 18px;
      font-weight: bold;
      color: #ff6f00;
      margin: 0;
    }
    
    .staff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .staff-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-left: 4px solid #ffa000;
    }
    
    .staff-card h4 {
      margin: 0 0 15px 0;
      color: #ff6f00;
      font-size: 16px;
      text-align: center;
    }
    
    .staff-overview {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .staff-total {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
    }
    
    .staff-active {
      background: #e8f5e9;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
    }
    
    .staff-total-value, .staff-active-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    
    .staff-total-label, .staff-active-label {
      font-size: 12px;
      color: #666;
    }
    
    .staff-status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .staff-status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    
    .staff-status-name {
      font-size: 12px;
      color: #666;
    }
    
    .staff-status-count {
      font-size: 14px;
      font-weight: bold;
      color: #333;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –°–í–û–†–ê–ß–ò–í–ê–ù–ò–Ø –†–ê–ë–û–¢ */
    .work-distribution {
      margin: 10px 0;
    }
    
    .work-distribution-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #e3f2fd;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 5px;
    }
    
    .work-distribution-title {
      font-weight: bold;
      color: #1976d2;
    }
    
    .work-distribution-content {
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    
    .collapsed .work-distribution-content {
      display: none;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –¶–í–ï–¢–ù–´–• –í–ò–î–û–í –†–ê–ë–û–¢ –í–û –í–†–ï–ú–ï–ù–ù–û–ô –®–ö–ê–õ–ï */
    .work-type-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
    }
    
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }
    
    .time-bar-with-works {
      position: relative;
      margin: 8px 0;
    }
    
    .work-type-segments {
      display: flex;
      height: 15px;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .work-type-segment {
      height: 100%;
      transition: opacity 0.2s;
    }
    
    .work-type-segment:hover {
      opacity: 0.8;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–ò –ü–û–°–¢–ê–í–û–ö */
    .supply-details-expanded {
      margin-left: 20px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      margin-top: 8px;
    }
    
    .supply-header {
      font-weight: bold;
      margin-bottom: 5px;
      color: #666;
    }
    
    .helper-list {
      margin-left: 15px;
      font-size: 12px;
    }
    
    .helper-item {
      display: flex;
      justify-content: space-between;
      padding: 2px 0;
    }
    
    .helper-name {
      color: #666;
    }
    
    .helper-role {
      color: #999;
      font-style: italic;
    }
  </style>
</head>
<body>
  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
  <div id="loading-progress" class="loading-progress"></div>

  <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ -->
  <div id="direction-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('direction-modal')">&times;</span>
      <div id="direction-modal-content"></div>
    </div>
  </div>

  <div id="department-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('department-modal')">&times;</span>
      <div id="department-modal-content"></div>
    </div>
  </div>

  <div id="worktype-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('worktype-modal')">&times;</span>
      <div id="worktype-modal-content"></div>
    </div>
  </div>

  <div class="container">
    <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç</h2>
    <div class="version">v2-11.01-2303 <span>üïí</span></div>
    <div class="last-updated" id="last-updated">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ‚Äî</div>

    <div id="selected-date" class="selected-date hidden">
      üìÖ –î–∞–Ω–Ω—ã–µ –∑–∞: <span id="current-date"></span>
    </div>

    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö<span class="loading-dots"></span></span>
    </div>
    <div id="error" class="error hidden"></div>

    <div id="controls" class="hidden">
      <!-- –ö–ê–õ–ï–ù–î–ê–†–¨ -->
      <div class="calendar-container">
        <div class="calendar-header">
          <button class="calendar-nav-btn" id="prev-month">‚óÄ –ù–∞–∑–∞–¥</button>
          <div class="calendar-title" id="calendar-title">–û–∫—Ç—è–±—Ä—å 2025</div>
          <button class="calendar-nav-btn" id="next-month">–í–ø–µ—Ä—ë–¥ ‚ñ∂</button>
        </div>
        <div class="calendar-days" id="calendar-days">
          <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
        </div>
      </div>

      <!-- –£–†–û–í–ï–ù–¨ 1: –†–£–ö–û–í–û–î–ò–¢–ï–õ–¨ –ü–†–ï–î–ü–†–ò–Ø–¢–ò–Ø -->
      <div id="level-1" class="hidden">
        <!-- üë• –ë–õ–û–ö –ü–ï–†–°–û–ù–ê–õ–ê -->
        <div id="staff-analytics" class="staff-section">
          <div class="staff-header" id="staff-toggle">
            <h3 class="staff-title">üë• –ü–µ—Ä—Å–æ–Ω–∞–ª</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div id="staff-content" class="hidden">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ -->
          </div>
        </div>

        <!-- üìä –û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å + üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –¥–Ω—è–º–∏ -->
        <div id="combined-analytics" class="combined-analytics">
          <div class="combined-header" id="combined-toggle">
            <h3 class="combined-title">üìä –û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div id="combined-content" class="hidden">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
          </div>
        </div>

        <!-- ‚è∞ –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ -->
        <div id="time-statistics" class="time-statistics">
          <div class="time-statistics-header" id="time-statistics-toggle">
            <h3 class="time-statistics-title">‚è∞ –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div id="time-statistics-content" class="hidden">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ -->
          </div>
        </div>

        <!-- üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º -->
        <div id="directions-analytics" class="grouping-section">
          <div class="grouping-header" id="directions-toggle">
            <h3 class="grouping-title">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div id="directions-content" class="hidden">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º -->
          </div>
        </div>

        <!-- üìà –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ -->
        <div id="percentage-time-statistics" class="percentage-time-statistics">
          <div class="percentage-time-header" id="percentage-time-toggle">
            <h3 class="percentage-time-title">üìà –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div id="percentage-time-content" class="hidden">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
          </div>
        </div>
      </div>

      <!-- –£–†–û–í–ï–ù–¨ 2: –ù–ê–ß–ê–õ–¨–ù–ò–ö –°–ú–ï–ù–´ -->
      <div id="level-2" class="hidden">
        <!-- üë• –ë–õ–û–ö –ü–ï–†–°–û–ù–ê–õ–ê -->
        <div id="staff-analytics-level2" class="staff-section">
          <div class="staff-header" id="staff-toggle-level2">
            <h3 class="staff-title">üë• –ü–µ—Ä—Å–æ–Ω–∞–ª –ø–æ –æ—Ç–¥–µ–ª–∞–º</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div id="staff-content-level2" class="hidden">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º -->
          </div>
        </div>

        <div id="departments-analytics" class="grouping-section">
          <div class="grouping-header" id="departments-toggle">
            <h3 class="grouping-title">üèõÔ∏è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div id="departments-content" class="hidden">
            <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º -->
          </div>
        </div>
      </div>

      <!-- –£–†–û–í–ï–ù–¨ 3: –ë–†–ò–ì–ê–î–ò–† -->
      <div id="level-3" class="hidden">
        <!-- üë• –ë–õ–û–ö –ü–ï–†–°–û–ù–ê–õ–ê -->
        <div id="staff-analytics-level3" class="staff-section">
          <div class="staff-header" id="staff-toggle-level3">
            <h3 class="staff-title">üë• –ü–µ—Ä—Å–æ–Ω–∞–ª –ø–æ –±—Ä–∏–≥–∞–¥–∞–º</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div id="staff-content-level3" class="hidden">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –ø–æ –±—Ä–∏–≥–∞–¥–∞–º -->
          </div>
        </div>

        <div id="work-types-analytics" class="work-types-analytics">
          <div class="work-types-header" id="work-types-toggle">
            <h3 class="work-types-title">üîç –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div id="work-types-content" class="hidden">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç -->
          </div>
        </div>
      </div>

      <!-- –ö–ù–û–ü–ö–ê –≠–ö–°–ü–û–†–¢–ê -->
      <button id="export-excel" style="margin-top: 20px;">üìä –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
    </div>
  </div>

  <script>
    // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    function parseTime(timeStr) {
      if (!timeStr) return 0;
      const parts = timeStr.split(':').map(Number);
      if (parts.length !== 3) return 0;
      const [h, m, s] = parts;
      return (h || 0) * 3600 + (m || 0) * 60 + (s || 0);
    }

    function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    function parseCurrency(str) {
      if (!str || typeof str !== 'string') return 0;
      let clean = str.trim().replace(/^—Ä\.\s*/i, '');
      clean = clean.replace(',', '.');
      const num = parseFloat(clean);
      return isNaN(num) ? 0 : num;
    }

    function getHourFromTime(timeStr) {
      if (!timeStr) return null;
      const [h] = timeStr.split(':');
      return parseInt(h) || 0;
    }

    function isResponsible(position) {
      return position === '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π' || position === '–û—Ç–≤–µ—Ç—Å–≤–µ–Ω–Ω—ã–π';
    }

    function formatDateTime(date) {
      return new Intl.DateTimeFormat('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      }).format(date);
    }

    function calculateNormative(units, seconds) {
      if (seconds <= 0) return 0;
      const hours = seconds / 3600;
      return units / hours;
    }

    function parseDate(dateStr) {
      const [day, month, year] = dateStr.split('.').map(Number);
      return new Date(year, month - 1, day);
    }

    function formatDate(date) {
      return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
    }

    // === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ê–†–•–ò–í–û–í ===
    function getArchiveNameForDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      return `${year}-${month}`;
    }

    function getArchiveUrl(archiveName) {
      const encodedName = encodeURIComponent(`${archiveName} fullData.json`);
      return `${window.location.origin}/archive/${encodedName}`;
    }

    // === –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ß–ê–°–û–í–´–• –ò–ù–¢–ï–†–í–ê–õ–û–í ===
    function getHourIntervalForWorkDay(timeStr, workDate) {
      if (!timeStr) return null;
      
      const hour = getHourFromTime(timeStr);
      if (hour === null) return null;
      
      if (hour < 9) {
        const nightHour = hour + 24;
        const endHour = nightHour + 1;
        return {
          key: `${String(hour).padStart(2, '0')}-${String(endHour - 24).padStart(2, '0')}`,
          display: `${String(hour).padStart(2, '0')}-${String(endHour - 24).padStart(2, '0')} (–Ω–æ—á—å)`,
          isNight: true,
          sortKey: nightHour
        };
      } else {
        const endHour = hour + 1;
        return {
          key: `${String(hour).padStart(2, '0')}-${String(endHour).padStart(2, '0')}`,
          display: `${String(hour).padStart(2, '0')}-${String(endHour).padStart(2, '0')}`,
          isNight: false,
          sortKey: hour
        };
      }
    }

    // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
    let records = [];
    let standards = [];
    let staffData = [];
    let selectedDate = '';
    let allWorkTypes = [];
    let currentMonth = new Date();
    currentMonth.setDate(1);

    let currentArchive = null;
    let uiInitialized = false;
    let selectedDepartment = '';

    // –¶–≤–µ—Ç–∞ –¥–ª—è –≤–∏–¥–æ–≤ —Ä–∞–±–æ—Ç
    const workTypeColors = {
      '–ü–æ–≥—Ä—É–∑–∫–∞': '#FF6B6B',
      '–†–∞–∑–≥—Ä—É–∑–∫–∞': '#4ECDC4',
      '–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞': '#45B7D1',
      '–£–ø–∞–∫–æ–≤–∫–∞': '#96CEB4',
      '–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è': '#FFEAA7',
      '–ü—Ä–æ–≤–µ—Ä–∫–∞': '#DDA0DD',
      '–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞': '#98D8C8',
      '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ': '#F7DC6F',
      '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é': '#BBBBBB'
    };

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const controlsDiv = document.getElementById('controls');
    const selectedDateDiv = document.getElementById('selected-date');
    const currentDateSpan = document.getElementById('current-date');
    const lastUpdatedDiv = document.getElementById('last-updated');
    const exportExcelBtn = document.getElementById('export-excel');
    const calendarTitle = document.getElementById('calendar-title');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const calendarDaysContainer = document.getElementById('calendar-days');
    const loadingProgress = document.getElementById('loading-progress');

    // === –§–£–ù–ö–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò ===
    function updateProgress(percent) {
      if (loadingProgress) {
        loadingProgress.style.width = percent + '%';
      }
    }

    async function loadStandards() {
      const standardsUrl = `${window.location.origin}/archive/standard%20fullData.json`;
      
      try {
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ –∏–∑:', standardsUrl);
        const response = await fetch(`${standardsUrl}?t=${Date.now()}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status} - ${response.statusText}`);
        }
        
        const data = await response.json();
        if (Array.isArray(data.records)) {
          standards = data.records.filter(record => 
            isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å']) && record['–ù–æ—Ä–º–∞—Ç–∏–≤ 1']
          );
          console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤:', standards.length);
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤:', err);
        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã
        standards = [
          {
            "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–í—Ö–æ–¥—è—â–∏–µ",
            "–û—Ç–¥–µ–ª": "–ü—Ä–∏–µ–º–∫–∞",
            "–í–∏–¥ —Ä–∞–±–æ—Ç": "–†–∞–∑–≥—Ä—É–∑–∫–∞",
            "–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞": "–í—Å–µ",
            "–ù–æ—Ä–º–∞—Ç–∏–≤ 1": "120"
          },
          {
            "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–í—Ö–æ–¥—è—â–∏–µ",
            "–û—Ç–¥–µ–ª": "–ü—Ä–∏–µ–º–∫–∞", 
            "–í–∏–¥ —Ä–∞–±–æ—Ç": "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞",
            "–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞": "–í—Å–µ",
            "–ù–æ—Ä–º–∞—Ç–∏–≤ 1": "80"
          },
          {
            "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–ò—Å—Ö–æ–¥—è—â–∏–µ",
            "–û—Ç–¥–µ–ª": "–û—Ç–≥—Ä—É–∑–∫–∞",
            "–í–∏–¥ —Ä–∞–±–æ—Ç": "–ü–æ–≥—Ä—É–∑–∫–∞",
            "–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞": "–í—Å–µ",
            "–ù–æ—Ä–º–∞—Ç–∏–≤ 1": "100"
          }
        ];
      }
    }

    async function loadStaffData() {
      const staffUrl = `${window.location.origin}/archive/staff%20fullData.json`;
      
      try {
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –∏–∑:', staffUrl);
        const response = await fetch(`${staffUrl}?t=${Date.now()}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status} - ${response.statusText}`);
        }
        
        const data = await response.json();
        if (Array.isArray(data.records)) {
          staffData = data.records;
          console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:', staffData.length);
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:', err);
        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞
        staffData = [
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–ò–≤–∞–Ω–æ–≤ –ò.–ò.", "–°—Ç–∞—Ç—É—Å": "–ê–∫—Ç–∏–≤–Ω—ã–π", "–û—Ç–¥–µ–ª": "–ü—Ä–∏–µ–º–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–ü–µ—Ç—Ä–æ–≤ –ü.–ü.", "–°—Ç–∞—Ç—É—Å": "–ê–∫—Ç–∏–≤–Ω—ã–π", "–û—Ç–¥–µ–ª": "–ü—Ä–∏–µ–º–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–°–∏–¥–æ—Ä–æ–≤ –°.–°.", "–°—Ç–∞—Ç—É—Å": "–ë–æ–ª—å–Ω–∏—á–Ω—ã–π", "–û—Ç–¥–µ–ª": "–ü—Ä–∏–µ–º–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–ö—É–∑–Ω–µ—Ü–æ–≤ –ö.–ö.", "–°—Ç–∞—Ç—É—Å": "–û—Ç–ø—É—Å–∫", "–û—Ç–¥–µ–ª": "–û—Ç–≥—Ä—É–∑–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–ù–∏–∫–æ–ª–∞–µ–≤ –ù.–ù.", "–°—Ç–∞—Ç—É—Å": "–ê–∫—Ç–∏–≤–Ω—ã–π", "–û—Ç–¥–µ–ª": "–û—Ç–≥—Ä—É–∑–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–í–∞—Å–∏–ª—å–µ–≤ –í.–í.", "–°—Ç–∞—Ç—É—Å": "–ê–∫—Ç–∏–≤–Ω—ã–π", "–û—Ç–¥–µ–ª": "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–ê–ª–µ–∫—Å–µ–µ–≤ –ê.–ê.", "–°—Ç–∞—Ç—É—Å": "–ö–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞", "–û—Ç–¥–µ–ª": "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–ì—Ä–∏–≥–æ—Ä—å–µ–≤ –ì.–ì.", "–°—Ç–∞—Ç—É—Å": "–ê–∫—Ç–∏–≤–Ω—ã–π", "–û—Ç–¥–µ–ª": "–£–ø–∞–∫–æ–≤–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–î–º–∏—Ç—Ä–∏–µ–≤ –î.–î.", "–°—Ç–∞—Ç—É—Å": "–ê–∫—Ç–∏–≤–Ω—ã–π", "–û—Ç–¥–µ–ª": "–£–ø–∞–∫–æ–≤–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–ï–≥–æ—Ä–æ–≤ –ï.–ï.", "–°—Ç–∞—Ç—É—Å": "–û—Ç–ø—É—Å–∫", "–û—Ç–¥–µ–ª": "–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è"}
        ];
      }
    }

    function getStandardForWork(workType, productGroup = null) {
      if (productGroup) {
        const specificStandard = standards.find(standard =>
          standard['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType &&
          standard['–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞'] === productGroup
        );
        if (specificStandard) return parseFloat(specificStandard['–ù–æ—Ä–º–∞—Ç–∏–≤ 1']);
      }
      
      const generalStandard = standards.find(standard =>
        standard['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType
      );
      
      return generalStandard ? parseFloat(generalStandard['–ù–æ—Ä–º–∞—Ç–∏–≤ 1']) : 0;
    }

    function getDirectionAndDepartment(workType) {
      const standard = standards.find(s => s['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType);
      return {
        direction: standard?.['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
        department: standard?.['–û—Ç–¥–µ–ª'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
      };
    }

    function getWorkTypeColor(workType) {
      return workTypeColors[workType] || workTypeColors['–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é'];
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    function createTestData() {
      console.log('–°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...');
      const testRecords = [];
      const workTypes = ['–ü–æ–≥—Ä—É–∑–∫–∞', '–†–∞–∑–≥—Ä—É–∑–∫–∞', '–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞', '–£–ø–∞–∫–æ–≤–∫–∞'];
      const employees = ['–ò–≤–∞–Ω–æ–≤ –ò.–ò.', '–ü–µ—Ç—Ä–æ–≤ –ü.–ü.', '–°–∏–¥–æ—Ä–æ–≤ –°.–°.'];
      const productGroups = ['–î–∏—Å–∫–∏', '–®–∏–Ω—ã', '–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã'];
      
      const today = new Date();
      
      for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
        const date = new Date(today);
        date.setDate(today.getDate() - dayOffset);
        const dateStr = formatDate(date);
        
        for (let i = 0; i < 20; i++) {
          const workType = workTypes[i % workTypes.length];
          const { direction, department } = getDirectionAndDepartment(workType);
          
          testRecords.push({
            '–†–∞–±–æ—á–∏–π –¥–µ–Ω—å': dateStr,
            '–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏': `${8 + (i % 10)}:${String(i % 60).padStart(2, '0')}:00`,
            '–í–∏–¥ —Ä–∞–±–æ—Ç': workType,
            '–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞': productGroups[i % productGroups.length],
            '–î–æ–ª–∂–Ω–æ—Å—Ç—å': i % 3 === 0 ? '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π' : '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
            '–°–æ—Ç—Ä—É–¥–Ω–∏–∫': employees[i % employees.length],
            '–ü–æ—Å—Ç–∞–≤–∫–∞': `–ü–æ—Å—Ç–∞–≤–∫–∞ ${Math.floor(i / 3) + 1}`,
            '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü': (Math.random() * 100 + 50).toFixed(0),
            '–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è': '01:00:00',
            '–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞': `—Ä.${(Math.random() * 1000 + 500).toFixed(2)}`,
            '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': direction,
            '–û—Ç–¥–µ–ª': department
          });
        }
      }
      
      return testRecords;
    }

    async function loadData() {
      if (!currentArchive) {
        currentArchive = getArchiveNameForDate(new Date());
      }

      const url = getArchiveUrl(currentArchive);
      
      try {
        loadingDiv.classList.remove('hidden');
        errorDiv.classList.add('hidden');
        controlsDiv.classList.add('hidden');
        updateProgress(10);

        await Promise.all([loadStandards(), loadStaffData()]);

        loadingDiv.innerHTML = `
          <div class="loading-spinner"></div>
          <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞—Ä—Ö–∏–≤–∞ ${currentArchive}<span class="loading-dots"></span></span>
        `;

        console.log('–ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑:', url);
        const urlWithCacheBust = `${url}?t=${Date.now()}`;
        updateProgress(30);
        
        const response = await fetch(urlWithCacheBust);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status} - ${response.statusText}`);
        }
        
        updateProgress(60);
        const data = await response.json();
        
        if (!Array.isArray(data.records)) {
          throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
        }
        
        updateProgress(80);
        records = data.records;
        records.forEach(record => {
          const { direction, department } = getDirectionAndDepartment(record['–í–∏–¥ —Ä–∞–±–æ—Ç']);
          record['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] = direction;
          record['–û—Ç–¥–µ–ª'] = department;
        });
        
        allWorkTypes = [...new Set(records.map(r => r['–í–∏–¥ —Ä–∞–±–æ—Ç']).filter(Boolean))].sort();
        lastUpdatedDiv.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${formatDateTime(new Date())} | –ê—Ä—Ö–∏–≤: ${currentArchive} | –ù–æ—Ä–º–∞—Ç–∏–≤–æ–≤: ${standards.length} | –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${staffData.length}`;
        
        updateProgress(100);
        setTimeout(() => {
          initUI();
          updateProgress(0);
        }, 500);
        
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:', err);
        
        records = createTestData();
        allWorkTypes = [...new Set(records.map(r => r['–í–∏–¥ —Ä–∞–±–æ—Ç']).filter(Boolean))].sort();
        lastUpdatedDiv.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${formatDateTime(new Date())} | –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï | –ù–æ—Ä–º–∞—Ç–∏–≤–æ–≤: ${standards.length} | –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${staffData.length}`;
        
        errorDiv.textContent = `‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ${err.message}. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.`;
        errorDiv.classList.remove('hidden');
        
        updateProgress(100);
        setTimeout(() => {
          initUI();
          updateProgress(0);
        }, 500);
      }
    }

    // === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    function initUI() {
      loadingDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');
      controlsDiv.classList.remove('hidden');

      renderCalendar();

      if (!uiInitialized) {
        setupEventListeners();
        uiInitialized = true;
      }

      const uniqueDates = [...new Set(records.map(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å']))].filter(Boolean).sort();
      if (uniqueDates.length > 0 && !selectedDate) {
        selectedDate = uniqueDates[0];
        renderReport();
      }
    }

    function setupEventListeners() {
      exportExcelBtn.addEventListener('click', exportToExcel);

      prevMonthBtn.addEventListener('click', () => {
        currentMonth.setMonth(currentMonth.getMonth() - 1);
        const targetArchive = getArchiveNameForDate(currentMonth);
        if (currentArchive !== targetArchive) {
          currentArchive = targetArchive;
          selectedDate = '';
          loadData();
        } else {
          renderCalendar();
        }
      });

      nextMonthBtn.addEventListener('click', () => {
        currentMonth.setMonth(currentMonth.getMonth() + 1);
        const targetArchive = getArchiveNameForDate(currentMonth);
        if (currentArchive !== targetArchive) {
          currentArchive = targetArchive;
          selectedDate = '';
          loadData();
        } else {
          renderCalendar();
        }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Å–µ–∫—Ü–∏–π
      setupToggleHandler('combined-toggle', 'combined-content');
      setupToggleHandler('time-statistics-toggle', 'time-statistics-content');
      setupToggleHandler('directions-toggle', 'directions-content');
      setupToggleHandler('departments-toggle', 'departments-content');
      setupToggleHandler('work-types-toggle', 'work-types-content');
      setupToggleHandler('percentage-time-toggle', 'percentage-time-content');
      setupToggleHandler('staff-toggle', 'staff-content');
      setupToggleHandler('staff-toggle-level2', 'staff-content-level2');
      setupToggleHandler('staff-toggle-level3', 'staff-content-level3');

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      window.addEventListener('click', function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      });
    }

    function setupToggleHandler(toggleId, contentId) {
      const toggle = document.getElementById(toggleId);
      const content = document.getElementById(contentId);
      if (toggle && content) {
        toggle.addEventListener('click', function() {
          const icon = this.querySelector('.toggle-icon');
          if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            icon.textContent = '‚ñº';
          } else {
            content.classList.add('hidden');
            icon.textContent = '‚ñ∂';
          }
        });
      }
    }

    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      const monthNames = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
      calendarTitle.textContent = `${monthNames[month]} ${year}`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const firstDayOfWeek = firstDay.getDay();

      calendarDaysContainer.innerHTML = '';
      const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
      dayNames.forEach(name => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = name;
        calendarDaysContainer.appendChild(header);
      });

      for (let i = 0; i < (firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1); i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day disabled';
        calendarDaysContainer.appendChild(empty);
      }

      const availableDates = new Set(records.map(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å']));
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${String(day).padStart(2, '0')}.${String(month + 1).padStart(2, '0')}.${year}`;
        const hasData = availableDates.has(dateStr);
        const dayEl = document.createElement('div');
        dayEl.className = `calendar-day${hasData ? ' has-data' : ''}${dateStr === selectedDate ? ' selected' : ''}`;
        dayEl.textContent = day;
        if (hasData) {
          dayEl.addEventListener('click', () => {
            selectedDate = dateStr;
            renderReport();
          });
        } else {
          dayEl.classList.add('disabled');
        }
        calendarDaysContainer.appendChild(dayEl);
      }

      const lastDayOfWeek = lastDay.getDay();
      const remaining = 6 - (lastDayOfWeek === 0 ? 6 : lastDayOfWeek - 1);
      for (let i = 0; i < remaining; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day disabled';
        calendarDaysContainer.appendChild(empty);
      }
    }

    function renderReport() {
      if (!selectedDate) {
        selectedDateDiv.classList.add('hidden');
        hideAllLevels();
        return;
      }

      const allRecords = records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === selectedDate);
      
      if (allRecords.length === 0) {
        selectedDateDiv.classList.add('hidden');
        hideAllLevels();
        return;
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É
      selectedDateDiv.classList.remove('hidden');
      currentDateSpan.textContent = selectedDate;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —É—Ä–æ–≤–Ω–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
      showAllLevels();

      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –¥–ª—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π
      renderLevel1Analytics(allRecords);
      renderLevel2Analytics(allRecords);
      renderLevel3Analytics(allRecords);
    }

    function hideAllLevels() {
      document.getElementById('level-1').classList.add('hidden');
      document.getElementById('level-2').classList.add('hidden');
      document.getElementById('level-3').classList.add('hidden');
    }

    function showAllLevels() {
      document.getElementById('level-1').classList.remove('hidden');
      document.getElementById('level-2').classList.remove('hidden');
      document.getElementById('level-3').classList.remove('hidden');
    }

    // === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–ï–†–°–û–ù–ê–õ–ê (–ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å —Ñ–æ—Ç–æ) ===
    function renderStaffAnalytics() {
      const totalStaff = staffData.length;
      const activeStaff = staffData.filter(staff => staff['–°—Ç–∞—Ç—É—Å'] === '–ê–∫—Ç–∏–≤–Ω—ã–π').length;
      const statusCounts = {};
      
      staffData.forEach(staff => {
        const status = staff['–°—Ç–∞—Ç—É—Å'] || '–ù–µ —É–∫–∞–∑–∞–Ω';
        statusCounts[status] = (statusCounts[status] || 0) + 1;
      });

      let html = `
        <div class="staff-grid">
          <div class="staff-card">
            <h4>üë• –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
            <div class="staff-overview">
              <div class="staff-total">
                <div class="staff-total-value">${totalStaff}</div>
                <div class="staff-total-label">–í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
              </div>
              <div class="staff-active">
                <div class="staff-active-value">${activeStaff}</div>
                <div class="staff-active-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
              </div>
            </div>
            <div class="staff-status-grid">
              ${Object.entries(statusCounts).map(([status, count]) => `
                <div class="staff-status-item">
                  <span class="staff-status-name">${status}</span>
                  <span class="staff-status-count">${count}</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;

      return html;
    }

    function renderStaffByDepartments() {
      const departmentStats = {};
      
      staffData.forEach(staff => {
        const department = staff['–û—Ç–¥–µ–ª'] || '–ù–µ —É–∫–∞–∑–∞–Ω';
        const status = staff['–°—Ç–∞—Ç—É—Å'] || '–ù–µ —É–∫–∞–∑–∞–Ω';
        
        if (!departmentStats[department]) {
          departmentStats[department] = {
            total: 0,
            active: 0,
            statuses: {}
          };
        }
        
        departmentStats[department].total++;
        if (status === '–ê–∫—Ç–∏–≤–Ω—ã–π') {
          departmentStats[department].active++;
        }
        departmentStats[department].statuses[status] = (departmentStats[department].statuses[status] || 0) + 1;
      });

      let html = '<div class="staff-grid">';
      
      Object.entries(departmentStats).forEach(([department, stats]) => {
        html += `
          <div class="staff-card">
            <h4>${department}</h4>
            <div class="staff-overview">
              <div class="staff-total">
                <div class="staff-total-value">${stats.total}</div>
                <div class="staff-total-label">–í—Å–µ–≥–æ</div>
              </div>
              <div class="staff-active">
                <div class="staff-active-value">${stats.active}</div>
                <div class="staff-active-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
              </div>
            </div>
            <div class="staff-status-grid">
              ${Object.entries(stats.statuses).map(([status, count]) => `
                <div class="staff-status-item">
                  <span class="staff-status-name">${status}</span>
                  <span class="staff-status-count">${count}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      return html;
    }

    function renderStaffByBrigades(allRecords) {
      const brigadeStats = {};
      const responsibleRecords = allRecords.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
      const uniqueBrigades = [...new Set(responsibleRecords.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))];
      
      uniqueBrigades.forEach(brigade => {
        const staffMember = staffData.find(s => s['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'] === brigade);
        brigadeStats[brigade] = {
          status: staffMember?.['–°—Ç–∞—Ç—É—Å'] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
          department: staffMember?.['–û—Ç–¥–µ–ª'] || '–ù–µ —É–∫–∞–∑–∞–Ω',
          isActive: staffMember?.['–°—Ç–∞—Ç—É—Å'] === '–ê–∫—Ç–∏–≤–Ω—ã–π'
        };
      });

      let html = '<div class="staff-grid">';
      
      Object.entries(brigadeStats).forEach(([brigade, info]) => {
        const statusClass = info.isActive ? 'performance-good' : 'performance-poor';
        
        html += `
          <div class="staff-card">
            <h4>${brigade}</h4>
            <div class="staff-overview">
              <div class="staff-total">
                <div class="staff-total-value ${statusClass}">${info.status}</div>
                <div class="staff-total-label">–°—Ç–∞—Ç—É—Å</div>
              </div>
              <div class="staff-active">
                <div class="staff-active-value">${info.department}</div>
                <div class="staff-active-label">–û—Ç–¥–µ–ª</div>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      return html;
    }

    function renderLevel1Analytics(allRecords) {
      const responsibleRecords = allRecords.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
      
      // üë• –ë–ª–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞
      document.getElementById('staff-content').innerHTML = renderStaffAnalytics();
      
      // üìä –û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å + üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –¥–Ω—è–º–∏
      renderCombinedAnalytics(allRecords, responsibleRecords);
      
      // ‚è∞ –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π)
      renderOverallTimeStatistics(allRecords);
      
      // üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º
      renderDirectionsAnalytics(allRecords);

      // üìà –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
      renderPercentageTimeStatistics(allRecords);
    }

    function renderLevel2Analytics(allRecords) {
      // üë• –ë–ª–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º
      document.getElementById('staff-content-level2').innerHTML = renderStaffByDepartments();

      // –û—Å—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —É—Ä–æ–≤–Ω—è 2
      const allDepartments = [...new Set(allRecords.map(r => r['–û—Ç–¥–µ–ª']))].filter(Boolean);
      
      let html = '';
      
      // –ï—Å–ª–∏ –æ—Ç–¥–µ–ª –Ω–µ –≤—ã–±—Ä–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä
      if (!selectedDepartment) {
        html = `
          <div class="department-selector">
            <h4>üèõÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</h4>
            <div class="department-buttons">
              ${allDepartments.map(dept => `
                <button class="department-btn" onclick="selectDepartment('${dept}')">${dept}</button>
              `).join('')}
            </div>
          </div>
        `;
      } else {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –æ—Ç–¥–µ–ª—É
        const departmentRecords = allRecords.filter(r => r['–û—Ç–¥–µ–ª'] === selectedDepartment);
        const responsibleRecords = departmentRecords.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
        
        let totalUnits = 0, totalTime = 0, totalAmount = 0, totalTasks = 0;
        responsibleRecords.forEach(r => {
          totalUnits += parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          totalTime += parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
          totalTasks++;
        });
        departmentRecords.forEach(r => {
          totalAmount += parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        });

        const normative = calculateNormative(totalUnits, totalTime);
        const costPerUnit = totalUnits > 0 ? totalAmount / totalUnits : 0;
        const totalHours = totalTime / 3600;
        const revenuePerHour = totalHours > 0 ? totalAmount / totalHours : 0;
        
        const workTypes = [...new Set(departmentRecords.map(r => r['–í–∏–¥ —Ä–∞–±–æ—Ç']))];
        const brigades = [...new Set(responsibleRecords.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))];
        const directions = [...new Set(departmentRecords.map(r => r['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']))];

        html = `
          <div style="margin-bottom: 15px;">
            <button class="department-btn active" style="margin-right: 10px;">${selectedDepartment}</button>
            <button class="department-btn" onclick="selectDepartment('')">‚Üê –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –æ—Ç–¥–µ–ª–∞</button>
          </div>
          
          <div class="analytics-grid">
            <div class="analytics-card">
              <h4>üìä –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h4>
              <div class="analytics-value">${totalUnits}</div>
              <p class="analytics-label">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –µ–¥–∏–Ω–∏—Ü</p>
              <div class="analytics-value">${totalTasks}</div>
              <p class="analytics-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á</p>
              <div class="analytics-value">${brigades.length}</div>
              <p class="analytics-label">–†–∞–±–æ—Ç–∞–ª–æ –±—Ä–∏–≥–∞–¥</p>
            </div>

            <div class="analytics-card">
              <h4>‚ö° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h4>
              <div class="analytics-value">${normative.toFixed(1)}</div>
              <p class="analytics-label">–ù–æ—Ä–º–∞—Ç–∏–≤ (—à—Ç/—á–∞—Å)</p>
              <div class="analytics-value">${formatTime(totalTime)}</div>
              <p class="analytics-label">–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</p>
              <div class="analytics-value">${totalHours.toFixed(1)}</div>
              <p class="analytics-label">–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ —á–∞—Å–æ–≤</p>
            </div>

            <div class="analytics-card">
              <h4>üí∞ –§–∏–Ω–∞–Ω—Å—ã</h4>
              <div class="analytics-value">—Ä.${totalAmount.toFixed(0)}</div>
              <p class="analytics-label">–û–±—â–∞—è –†–∞—Å—Ö–æ–¥—ã</p>
              <div class="analytics-value">—Ä.${costPerUnit.toFixed(2)}</div>
              <p class="analytics-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ 1 –µ–¥.</p>
              <div class="analytics-value">—Ä.${revenuePerHour.toFixed(2)}</div>
              <p class="analytics-label">–†–∞—Å—Ö–æ–¥—ã –≤ —á–∞—Å</p>
            </div>

            <div class="analytics-card">
              <h4>üè¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∞</h4>
              <div class="analytics-value">${workTypes.length}</div>
              <p class="analytics-label">–í–∏–¥–æ–≤ —Ä–∞–±–æ—Ç</p>
              <div class="analytics-value">${directions.length}</div>
              <p class="analytics-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π</p>
              <div class="analytics-value">${departmentRecords.length}</div>
              <p class="analytics-label">–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π</p>
            </div>
          </div>
        `;
      }
      
      document.getElementById('departments-content').innerHTML = html;
    }

    function renderLevel3Analytics(allRecords) {
      // üë• –ë–ª–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –ø–æ –±—Ä–∏–≥–∞–¥–∞–º
      document.getElementById('staff-content-level3').innerHTML = renderStaffByBrigades(allRecords);

      // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç
      const workTypeStats = {};
      
      allRecords.forEach(record => {
        const workType = record['–í–∏–¥ —Ä–∞–±–æ—Ç'] || '–ë–µ–∑ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç';
        const productGroup = record['–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞'] || '–í—Å–µ';
        
        if (!workTypeStats[workType]) {
          const { direction, department } = getDirectionAndDepartment(workType);
          workTypeStats[workType] = {
            totalUnits: 0,
            totalTime: 0,
            totalAmount: 0,
            tasks: 0,
            responsibleTasks: 0,
            brigades: new Set(),
            productGroups: new Set(),
            direction: direction,
            department: department,
            standard: getStandardForWork(workType, productGroup),
            records: []
          };
        }
        
        const stats = workTypeStats[workType];
        stats.records.push(record);
        
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          stats.totalUnits += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          stats.totalTime += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
          stats.responsibleTasks++;
          if (record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']) {
            stats.brigades.add(record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']);
          }
        }
        
        stats.totalAmount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        stats.tasks++;
        if (productGroup && productGroup !== '–í—Å–µ') {
          stats.productGroups.add(productGroup);
        }
      });

      let html = '';
      
      html += '<div class="work-types-grid">';
      
      Object.entries(workTypeStats).forEach(([workType, stats]) => {
        const totalHours = stats.totalTime / 3600;
        const normative = totalHours > 0 ? stats.totalUnits / totalHours : 0;
        const revenuePerHour = totalHours > 0 ? stats.totalAmount / totalHours : 0;
        const costPerUnit = stats.totalUnits > 0 ? stats.totalAmount / stats.totalUnits : 0;
        const avgRevenuePerTask = stats.tasks > 0 ? stats.totalAmount / stats.tasks : 0;
        
        let performanceClass = 'performance-poor';
        let performanceText = '–ù–∏–∑–∫–∞—è';
        if (stats.standard > 0) {
          const percentage = (normative / stats.standard) * 100;
          if (percentage >= 90) {
            performanceClass = 'performance-good';
            performanceText = '–í—ã—Å–æ–∫–∞—è';
          } else if (percentage >= 70) {
            performanceClass = 'performance-average';
            performanceText = '–°—Ä–µ–¥–Ω—è—è';
          }
          performanceText += ` (${percentage.toFixed(0)}%)`;
        }

        html += `
          <div class="work-type-card" onclick="showWorkTypeDetails('${workType}', '${selectedDate}')">
            <div class="work-type-header">
              <h4 class="work-type-name">${workType}</h4>
              <div class="${performanceClass} performance-indicator">
                ${performanceText}
              </div>
            </div>
            
            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
              <strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> ${stats.direction} | <strong>–û—Ç–¥–µ–ª:</strong> ${stats.department}
            </div>
            
            <div class="work-type-stats">
              <div class="stat-item">
                <div class="stat-value">${stats.totalUnits}</div>
                <div class="stat-label">–ï–¥–∏–Ω–∏—Ü</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${stats.tasks}</div>
                <div class="stat-label">–ó–∞–¥–∞—á</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${stats.brigades.size}</div>
                <div class="stat-label">–ë—Ä–∏–≥–∞–¥</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${formatTime(stats.totalTime)}</div>
                <div class="stat-label">–í—Ä–µ–º—è</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${normative.toFixed(1)}</div>
                <div class="stat-label">–ù–æ—Ä–º–∞—Ç–∏–≤</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">—Ä.${stats.totalAmount.toFixed(0)}</div>
                <div class="stat-label">–°—É–º–º–∞</div>
              </div>
            </div>
            
            <div style="margin-top: 10px; font-size: 11px; color: #666;">
              ${stats.standard > 0 ? `–ü–ª–∞–Ω: ${stats.standard} —à—Ç/—á–∞—Å | ` : ''}
              –°—Ç–æ–∏–º–æ—Å—Ç—å –µ–¥.: —Ä.${costPerUnit.toFixed(2)} | 
              –†–∞—Å—Ö–æ–¥—ã/—á–∞—Å: —Ä.${revenuePerHour.toFixed(2)} | 
              –ì—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤: ${stats.productGroups.size}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      document.getElementById('work-types-content').innerHTML = html;
    }

    function renderCombinedAnalytics(allRecords, responsibleRecords) {
      let totalUnits = 0, totalTimeSec = 0, totalTasks = 0, totalAmount = 0;
      const uniqueResponsibles = [...new Set(responsibleRecords.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))];

      responsibleRecords.forEach(r => {
        totalUnits += parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        totalTimeSec += parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        totalTasks++;
      });

      allRecords.forEach(r => {
        totalAmount += parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });

      const factNormative = calculateNormative(totalUnits, totalTimeSec);
      const totalHours = totalTimeSec / 3600;
      const avgRevenuePerHour = totalHours > 0 ? totalAmount / totalHours : 0;
      const costPerUnit = totalUnits > 0 ? totalAmount / totalUnits : 0;
      const uniqueWorkTypes = [...new Set(allRecords.map(r => r['–í–∏–¥ —Ä–∞–±–æ—Ç']))].filter(Boolean);
      const uniqueBrigades = [...new Set(responsibleRecords.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))];
      const uniqueDirections = [...new Set(allRecords.map(r => r['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']))].filter(Boolean);
      const uniqueDepartments = [...new Set(allRecords.map(r => r['–û—Ç–¥–µ–ª']))].filter(Boolean);
      
      let html = `
        <div class="analytics-grid">
          <div class="analytics-card">
            <h4>üì¶ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</h4>
            <div class="analytics-value">${totalUnits}</div>
            <p class="analytics-label">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –µ–¥–∏–Ω–∏—Ü</p>
            
            <div class="analytics-value">${totalTasks}</div>
            <p class="analytics-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á</p>
            
            <div class="analytics-value">${uniqueBrigades.length}</div>
            <p class="analytics-label">–†–∞–±–æ—Ç–∞–ª–æ –±—Ä–∏–≥–∞–¥</p>
          </div>

          <div class="analytics-card">
            <h4>‚ö° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h4>
            <div class="analytics-value">${factNormative.toFixed(1)}</div>
            <p class="analytics-label">–ù–æ—Ä–º–∞—Ç–∏–≤ (—à—Ç/—á–∞—Å)</p>
            
            <div class="analytics-value">${formatTime(totalTimeSec)}</div>
            <p class="analytics-label">–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</p>
            
            <div class="analytics-value">${totalHours.toFixed(1)}</div>
            <p class="analytics-label">–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ —á–∞—Å–æ–≤</p>
          </div>

          <div class="analytics-card">
            <h4>üí∞ –§–∏–Ω–∞–Ω—Å—ã</h4>
            <div class="analytics-value">—Ä.${totalAmount.toFixed(0)}</div>
            <p class="analytics-label">–û–±—â–∞—è –†–∞—Å—Ö–æ–¥—ã</p>
            
            <div class="analytics-value">—Ä.${costPerUnit.toFixed(2)}</div>
            <p class="analytics-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ 1 –µ–¥.</p>
            
            <div class="analytics-value">—Ä.${avgRevenuePerHour.toFixed(2)}</div>
            <p class="analytics-label">–†–∞—Å—Ö–æ–¥—ã –≤ —á–∞—Å</p>
          </div>

          <div class="analytics-card">
            <h4>üè¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∞</h4>
            <div class="analytics-value">${uniqueDirections.length}</div>
            <p class="analytics-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π</p>
            
            <div class="analytics-value">${uniqueDepartments.length}</div>
            <p class="analytics-label">–û—Ç–¥–µ–ª–æ–≤</p>
            
            <div class="analytics-value">${uniqueWorkTypes.length}</div>
            <p class="analytics-label">–í–∏–¥–æ–≤ —Ä–∞–±–æ—Ç</p>
          </div>
        </div>
      `;

      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –¥–Ω—è–º–∏
      html += renderComparisonAnalytics(selectedDate);
      
      document.getElementById('combined-content').innerHTML = html;
    }

    function renderComparisonAnalytics(currentDate) {
      const currentDateObj = parseDate(currentDate);
      const previousDates = [];
      
      for (let i = 1; i <= 7; i++) {
        const date = new Date(currentDateObj);
        date.setDate(currentDateObj.getDate() - i);
        const dateStr = formatDate(date);
        previousDates.push({ date: dateStr, records: records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === dateStr) });
      }

      const currentDayRecords = records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === currentDate);
      const currentResponsibleRecords = currentDayRecords.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
      
      let currentUnits = 0, currentTime = 0, currentAmount = 0;
      currentResponsibleRecords.forEach(r => {
        currentUnits += parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        currentTime += parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
      });
      currentDayRecords.forEach(r => {
        currentAmount += parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });

      const currentNormative = calculateNormative(currentUnits, currentTime);
      const currentCostPerUnit = currentUnits > 0 ? currentAmount / currentUnits : 0;

      let html = '<h4 style="margin: 20px 0 15px 0; color: #333;">üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –¥–Ω—è–º–∏</h4><div class="comparison-grid">';
      
      const previousUnits = previousDates.map(d => {
        const respRecords = d.records.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
        return respRecords.reduce((sum, r) => sum + (parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0), 0);
      }).filter(val => val > 0);
      
      const avgUnits = previousUnits.length > 0 ? previousUnits.reduce((a, b) => a + b) / previousUnits.length : 0;
      const unitsTrend = currentUnits - avgUnits;
      const unitsPercent = avgUnits > 0 ? ((unitsTrend / avgUnits) * 100).toFixed(1) : 0;
      
      html += `
        <div class="comparison-card">
          <h4>üì¶ –ï–¥–∏–Ω–∏—Ü—ã</h4>
          <div class="analytics-value">${currentUnits}</div>
          <p class="analytics-label">–°–µ–≥–æ–¥–Ω—è</p>
          <div class="analytics-value ${unitsTrend >= 0 ? 'trend-up' : 'trend-down'}">
            ${unitsTrend >= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(unitsPercent)}%
          </div>
          <p class="analytics-label">–°—Ä–µ–¥–Ω–µ–µ: ${avgUnits.toFixed(0)}</p>
        </div>
      `;

      const previousNorms = previousDates.map(d => {
        const respRecords = d.records.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
        const units = respRecords.reduce((sum, r) => sum + (parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0), 0);
        const time = respRecords.reduce((sum, r) => sum + parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']), 0);
        return calculateNormative(units, time);
      }).filter(val => val > 0);
      
      const avgNorm = previousNorms.length > 0 ? previousNorms.reduce((a, b) => a + b) / previousNorms.length : 0;
      const normTrend = currentNormative - avgNorm;
      const normPercent = avgNorm > 0 ? ((normTrend / avgNorm) * 100).toFixed(1) : 0;
      
      html += `
        <div class="comparison-card">
          <h4>‚ö° –ù–æ—Ä–º–∞—Ç–∏–≤</h4>
          <div class="analytics-value">${currentNormative.toFixed(1)}</div>
          <p class="analytics-label">–°–µ–≥–æ–¥–Ω—è (—à—Ç/—á–∞—Å)</p>
          <div class="analytics-value ${normTrend >= 0 ? 'trend-up' : 'trend-down'}">
            ${normTrend >= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(normPercent)}%
          </div>
          <p class="analytics-label">–°—Ä–µ–¥–Ω–µ–µ: ${avgNorm.toFixed(1)}</p>
        </div>
      `;

      const previousAmounts = previousDates.map(d => 
        d.records.reduce((sum, r) => sum + parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']), 0)
      ).filter(val => val > 0);
      
      const avgAmount = previousAmounts.length > 0 ? previousAmounts.reduce((a, b) => a + b) / previousAmounts.length : 0;
      const amountTrend = currentAmount - avgAmount;
      const amountPercent = avgAmount > 0 ? ((amountTrend / avgAmount) * 100).toFixed(1) : 0;

      const previousCosts = previousDates.map(d => {
        const respRecords = d.records.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
        const units = respRecords.reduce((sum, r) => sum + (parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0), 0);
        const amount = d.records.reduce((sum, r) => sum + parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']), 0);
        return units > 0 ? amount / units : 0;
      }).filter(val => val > 0);
      
      const avgCost = previousCosts.length > 0 ? previousCosts.reduce((a, b) => a + b) / previousCosts.length : 0;
      const costTrend = currentCostPerUnit - avgCost;
      const costPercent = avgCost > 0 ? ((costTrend / avgCost) * 100).toFixed(1) : 0;
      
      html += `
        <div class="comparison-card">
          <h4>üí∞ –†–∞—Å—Ö–æ–¥—ã</h4>
          <div class="analytics-value">—Ä.${currentAmount.toFixed(0)}</div>
          <p class="analytics-label">–°–µ–≥–æ–¥–Ω—è</p>
          <div class="analytics-value ${amountTrend >= 0 ? 'trend-up' : 'trend-down'}">
            ${amountTrend >= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(amountPercent)}%
          </div>
          <p class="analytics-label">–°—Ä–µ–¥–Ω–µ–µ: —Ä.${avgAmount.toFixed(0)}</p>
        </div>

        <div class="comparison-card">
          <h4>üíµ –°—Ç–æ–∏–º–æ—Å—Ç—å –µ–¥.</h4>
          <div class="analytics-value">—Ä.${currentCostPerUnit.toFixed(2)}</div>
          <p class="analytics-label">–°–µ–≥–æ–¥–Ω—è</p>
          <div class="analytics-value ${costTrend <= 0 ? 'trend-up' : 'trend-down'}">
            ${costTrend <= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(costPercent)}%
          </div>
          <p class="analytics-label">–°—Ä–µ–¥–Ω–µ–µ: —Ä.${avgCost.toFixed(2)}</p>
        </div>
      `;

      html += '</div>';
      return html;
    }

    function renderOverallTimeStatistics(allRecords) {
      const timeStats = {};
      const workTypeDistribution = {};
      
      // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–ø–∏—Å–∏: —Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –µ–¥–∏–Ω–∏—Ü > 0
      const filteredRecords = allRecords.filter(record => 
        isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å']) && 
        (parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0) > 0
      );
      
      filteredRecords.forEach(record => {
        const interval = getHourIntervalForWorkDay(record['–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏'], selectedDate);
        if (!interval) return;
        
        if (!timeStats[interval.key]) {
          timeStats[interval.key] = {
            interval: interval,
            units: 0,
            amount: 0,
            tasks: 0,
            time: 0,
            workTypes: {}
          };
        }
        
        const stats = timeStats[interval.key];
        stats.units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        stats.time += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        stats.amount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        stats.tasks++;

        // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–∞—Ö —Ä–∞–±–æ—Ç –≤ —ç—Ç–æ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ
        const workType = record['–í–∏–¥ —Ä–∞–±–æ—Ç'] || '–ë–µ–∑ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç';
        if (!stats.workTypes[workType]) {
          stats.workTypes[workType] = {
            units: 0,
            tasks: 0
          };
        }
        stats.workTypes[workType].units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        stats.workTypes[workType].tasks++;
      });

      let html = '<div class="time-chart">';
      
      const sortedIntervals = Object.values(timeStats).sort((a, b) => a.interval.sortKey - b.interval.sortKey);
      const maxUnits = Math.max(...sortedIntervals.map(s => s.units));
      
      // –õ–µ–≥–µ–Ω–¥–∞ —Ü–≤–µ—Ç–æ–≤
      const usedWorkTypes = new Set();
      sortedIntervals.forEach(stats => {
        Object.keys(stats.workTypes).forEach(workType => usedWorkTypes.add(workType));
      });

      if (usedWorkTypes.size > 0) {
        html += '<div class="work-type-legend">';
        Array.from(usedWorkTypes).forEach(workType => {
          html += `
            <div class="legend-item">
              <div class="legend-color" style="background-color: ${getWorkTypeColor(workType)}"></div>
              <span>${workType}</span>
            </div>
          `;
        });
        html += '</div>';
      }
      
      sortedIntervals.forEach(stats => {
        const unitsPercent = maxUnits > 0 ? (stats.units / maxUnits) * 100 : 0;
        const normative = stats.time > 0 ? calculateNormative(stats.units, stats.time) : 0;
        
        // –°–æ–∑–¥–∞–µ–º —Å–µ–≥–º–µ–Ω—Ç—ã –¥–ª—è –≤–∏–¥–æ–≤ —Ä–∞–±–æ—Ç
        let segmentsHtml = '';
        const totalUnitsInInterval = stats.units;
        
        if (totalUnitsInInterval > 0) {
          Object.entries(stats.workTypes).forEach(([workType, workStats]) => {
            const segmentPercent = (workStats.units / totalUnitsInInterval) * 100;
            if (segmentPercent > 0) {
              segmentsHtml += `
                <div class="work-type-segment" 
                     style="width: ${segmentPercent}%; background-color: ${getWorkTypeColor(workType)}"
                     title="${workType}: ${workStats.units} –µ–¥. (${segmentPercent.toFixed(1)}%)">
                </div>
              `;
            }
          });
        }

        html += `
          <div class="time-bar-with-works">
            <div class="time-bar">
              <div class="time-label ${stats.interval.isNight ? 'night-interval' : ''}">${stats.interval.display}</div>
              <div class="time-bar-inner">
                ${segmentsHtml ? `
                  <div class="work-type-segments">
                    ${segmentsHtml}
                  </div>
                ` : `
                  <div class="time-bar-fill" style="width: ${unitsPercent}%"></div>
                `}
              </div>
              <div class="time-value">
                ${stats.units} –µ–¥.
              </div>
            </div>
            <div style="font-size: 11px; color: #666; margin-left: 100px;">
              –ó–∞–¥–∞—á: ${stats.tasks} | –†–∞—Å—Ö–æ–¥—ã: —Ä.${stats.amount.toFixed(0)} | –ù–æ—Ä–º–∞—Ç–∏–≤: ${normative.toFixed(1)} —à—Ç/—á–∞—Å
              ${Object.keys(stats.workTypes).length > 0 ? `| –í–∏–¥—ã —Ä–∞–±–æ—Ç: ${Object.keys(stats.workTypes).join(', ')}` : ''}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      document.getElementById('time-statistics-content').innerHTML = html;
    }

    function renderPercentageTimeStatistics(allRecords) {
      const workTypeTimeStats = {};
      
      // –°–æ–±–∏—Ä–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü –ø–æ –∫–∞–∂–¥–æ–º—É –≤–∏–¥—É —Ä–∞–±–æ—Ç (—Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ)
      allRecords.forEach(record => {
        if (!isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) return;
        
        const workType = record['–í–∏–¥ —Ä–∞–±–æ—Ç'] || '–ë–µ–∑ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç';
        if (!workTypeTimeStats[workType]) {
          workTypeTimeStats[workType] = {
            totalUnits: 0,
            timeIntervals: {}
          };
        }
        
        workTypeTimeStats[workType].totalUnits += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
      });

      // –°–æ–±–∏—Ä–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç (—Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ)
      allRecords.forEach(record => {
        if (!isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) return;
        
        const workType = record['–í–∏–¥ —Ä–∞–±–æ—Ç'] || '–ë–µ–∑ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç';
        const interval = getHourIntervalForWorkDay(record['–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏'], selectedDate);
        if (!interval) return;
        
        if (!workTypeTimeStats[workType].timeIntervals[interval.key]) {
          workTypeTimeStats[workType].timeIntervals[interval.key] = {
            interval: interval,
            units: 0
          };
        }
        
        workTypeTimeStats[workType].timeIntervals[interval.key].units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
      });

      let html = '';
      
      Object.entries(workTypeTimeStats).forEach(([workType, stats]) => {
        if (stats.totalUnits === 0) return;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç
        const workTypeId = workType.replace(/\s+/g, '-');
        html += `
          <div class="work-distribution" id="distribution-${workTypeId}">
            <div class="work-distribution-header" onclick="toggleWorkDistribution('${workTypeId}')">
              <div class="work-distribution-title">
                <span class="toggle-icon">‚ñ∂</span> ${workType} (–≤—Å–µ–≥–æ: ${stats.totalUnits} –µ–¥.)
              </div>
            </div>
            <div class="work-distribution-content">
        `;
        
        const sortedIntervals = Object.values(stats.timeIntervals).sort((a, b) => a.interval.sortKey - b.interval.sortKey);
        
        sortedIntervals.forEach(timeStat => {
          const percentage = (timeStat.units / stats.totalUnits) * 100;
          
          html += `
            <div class="time-bar">
              <div class="time-label">${timeStat.interval.display}</div>
              <div class="time-bar-inner">
                <div class="time-bar-fill" style="width: ${percentage}%"></div>
              </div>
              <div class="time-value">
                ${percentage.toFixed(1)}%
              </div>
            </div>
            <div style="font-size: 11px; color: #666; margin-left: 100px;">
              ${timeStat.units} –µ–¥. –∏–∑ ${stats.totalUnits} (${percentage.toFixed(1)}% –æ—Ç –æ–±—â–µ–≥–æ –æ–±—ä–µ–º–∞)
            </div>
          `;
        });
        
        html += `</div></div>`;
      });

      document.getElementById('percentage-time-content').innerHTML = html;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç
    function toggleWorkDistribution(workTypeId) {
      const distribution = document.getElementById(`distribution-${workTypeId}`);
      const content = distribution.querySelector('.work-distribution-content');
      const icon = distribution.querySelector('.toggle-icon');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '‚ñº';
        distribution.classList.remove('collapsed');
      } else {
        content.style.display = 'none';
        icon.textContent = '‚ñ∂';
        distribution.classList.add('collapsed');
      }
    }

    function renderDirectionsAnalytics(allRecords) {
      const directionStats = {};
      
      allRecords.forEach(record => {
        const direction = record['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        if (!directionStats[direction]) {
          directionStats[direction] = {
            totalUnits: 0,
            totalTime: 0,
            totalAmount: 0,
            tasks: 0,
            workTypes: new Set(),
            departments: new Set(),
            brigades: new Set(),
            records: []
          };
        }
        
        const stats = directionStats[direction];
        stats.records.push(record);
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          stats.totalUnits += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          stats.totalTime += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        }
        stats.totalAmount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        stats.tasks++;
        stats.workTypes.add(record['–í–∏–¥ —Ä–∞–±–æ—Ç']);
        stats.departments.add(record['–û—Ç–¥–µ–ª']);
        if (record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']) {
          stats.brigades.add(record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']);
        }
      });

      let html = '<div class="grouping-grid">';
      
      Object.entries(directionStats).forEach(([direction, stats]) => {
        const totalHours = stats.totalTime / 3600;
        const normative = totalHours > 0 ? stats.totalUnits / totalHours : 0;
        const revenuePerHour = totalHours > 0 ? stats.totalAmount / totalHours : 0;
        const costPerUnit = stats.totalUnits > 0 ? stats.totalAmount / stats.totalUnits : 0;
        
        html += `
          <div class="group-card" onclick="showDirectionDetails('${direction}', '${selectedDate}')">
            <h4>${direction}</h4>
            <div class="group-stats">
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.totalUnits}</div>
                <div class="group-stat-label">–ï–¥–∏–Ω–∏—Ü</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.tasks}</div>
                <div class="group-stat-label">–ó–∞–¥–∞—á</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.workTypes.size}</div>
                <div class="group-stat-label">–í–∏–¥–æ–≤ —Ä–∞–±–æ—Ç</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.departments.size}</div>
                <div class="group-stat-label">–û—Ç–¥–µ–ª–æ–≤</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.brigades.size}</div>
                <div class="group-stat-label">–ë—Ä–∏–≥–∞–¥</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${normative.toFixed(1)}</div>
                <div class="group-stat-label">–ù–æ—Ä–º–∞—Ç–∏–≤</div>
              </div>
            </div>
            <div style="margin-top: 8px; font-size: 11px; color: #666;">
              –†–∞—Å—Ö–æ–¥—ã: —Ä.${stats.totalAmount.toFixed(0)} | –°—Ç–æ–∏–º–æ—Å—Ç—å –µ–¥.: —Ä.${costPerUnit.toFixed(2)} | –†–∞—Å—Ö–æ–¥—ã/—á–∞—Å: —Ä.${revenuePerHour.toFixed(2)}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      document.getElementById('directions-content').innerHTML = html;
    }

    function selectDepartment(department) {
      selectedDepartment = department;
      const allRecords = records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === selectedDate);
      renderLevel2Analytics(allRecords);
    }

    // === –§–£–ù–ö–¶–ò–ò –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–ò ===
    function showDirectionDetails(direction, date) {
      const allRecords = records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === date && r['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] === direction);
      const responsibleRecords = allRecords.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
      
      let totalUnits = 0, totalTime = 0, totalAmount = 0, totalTasks = 0;
      responsibleRecords.forEach(r => {
        totalUnits += parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        totalTime += parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        totalTasks++;
      });
      allRecords.forEach(r => {
        totalAmount += parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });

      const normative = calculateNormative(totalUnits, totalTime);
      const costPerUnit = totalUnits > 0 ? totalAmount / totalUnits : 0;
      
      const departments = [...new Set(allRecords.map(r => r['–û—Ç–¥–µ–ª']))];
      const workTypes = [...new Set(allRecords.map(r => r['–í–∏–¥ —Ä–∞–±–æ—Ç']))];
      const brigades = [...new Set(responsibleRecords.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))];

      let html = `
        <h3>üéØ –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é: ${direction}</h3>
        <p><strong>–î–∞—Ç–∞:</strong> ${date}</p>
        
        <div class="analytics-grid" style="margin: 15px 0;">
          <div class="analytics-card">
            <h4>üìä –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h4>
            <div class="analytics-value">${totalUnits}</div>
            <p class="analytics-label">–í—Å–µ–≥–æ –µ–¥–∏–Ω–∏—Ü</p>
            <div class="analytics-value">${totalTasks}</div>
            <p class="analytics-label">–ó–∞–¥–∞—á</p>
            <div class="analytics-value">${brigades.length}</div>
            <p class="analytics-label">–ë—Ä–∏–≥–∞–¥</p>
          </div>
          
          <div class="analytics-card">
            <h4>‚ö° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h4>
            <div class="analytics-value">${normative.toFixed(1)}</div>
            <p class="analytics-label">–ù–æ—Ä–º–∞—Ç–∏–≤ (—à—Ç/—á–∞—Å)</p>
            <div class="analytics-value">${formatTime(totalTime)}</div>
            <p class="analytics-label">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</p>
            <div class="analytics-value">${(totalTime / 3600).toFixed(1)}</div>
            <p class="analytics-label">–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ —á–∞—Å–æ–≤</p>
          </div>
          
          <div class="analytics-card">
            <h4>üí∞ –§–∏–Ω–∞–Ω—Å—ã</h4>
            <div class="analytics-value">—Ä.${totalAmount.toFixed(0)}</div>
            <p class="analytics-label">–û–±—â–∞—è –†–∞—Å—Ö–æ–¥—ã</p>
            <div class="analytics-value">—Ä.${costPerUnit.toFixed(2)}</div>
            <p class="analytics-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –µ–¥.</p>
            <div class="analytics-value">—Ä.${(totalAmount / (totalTime / 3600)).toFixed(2)}</div>
            <p class="analytics-label">–†–∞—Å—Ö–æ–¥—ã –≤ —á–∞—Å</p>
          </div>
        </div>

        <h4>üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h4>
        <div class="grouping-grid">
          <div class="group-card">
            <h4>üèõÔ∏è –û—Ç–¥–µ–ª—ã (${departments.length})</h4>
            <div style="font-size: 14px;">
              ${departments.map(dept => `<div>‚Ä¢ ${dept}</div>`).join('')}
            </div>
          </div>
          
          <div class="group-card">
            <h4>üîß –í–∏–¥—ã —Ä–∞–±–æ—Ç (${workTypes.length})</h4>
            <div style="font-size: 14px;">
              ${workTypes.map(work => `<div>‚Ä¢ ${work}</div>`).join('')}
            </div>
          </div>
          
          <div class="group-card">
            <h4>üë• –ë—Ä–∏–≥–∞–¥—ã (${brigades.length})</h4>
            <div style="font-size: 14px;">
              ${brigades.map(brigade => `<div>‚Ä¢ ${brigade}</div>`).join('')}
            </div>
          </div>
        </div>

        <h4>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º</h4>
        <div class="grouping-grid">
      `;

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º –≤–Ω—É—Ç—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      const departmentStats = {};
      allRecords.forEach(record => {
        const department = record['–û—Ç–¥–µ–ª'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        if (!departmentStats[department]) {
          departmentStats[department] = {
            units: 0,
            amount: 0,
            tasks: 0,
            time: 0
          };
        }
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          departmentStats[department].units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          departmentStats[department].time += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
          departmentStats[department].tasks++;
        }
        departmentStats[department].amount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });

      Object.entries(departmentStats).forEach(([dept, stats]) => {
        const deptCostPerUnit = stats.units > 0 ? stats.amount / stats.units : 0;
        const deptNormative = stats.time > 0 ? calculateNormative(stats.units, stats.time) : 0;
        html += `
          <div class="group-card">
            <h5>${dept}</h5>
            <div class="group-stats">
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.units}</div>
                <div class="group-stat-label">–ï–¥–∏–Ω–∏—Ü</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.tasks}</div>
                <div class="group-stat-label">–ó–∞–¥–∞—á</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${deptNormative.toFixed(1)}</div>
                <div class="group-stat-label">–ù–æ—Ä–º–∞—Ç–∏–≤</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">—Ä.${stats.amount.toFixed(0)}</div>
                <div class="group-stat-label">–†–∞—Å—Ö–æ–¥—ã</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">—Ä.${deptCostPerUnit.toFixed(2)}</div>
                <div class="group-stat-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –µ–¥.</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${formatTime(stats.time)}</div>
                <div class="group-stat-label">–í—Ä–µ–º—è</div>
              </div>
            </div>
          </div>
        `;
      });

      html += `</div>`;
      
      document.getElementById('direction-modal-content').innerHTML = html;
      document.getElementById('direction-modal').style.display = 'block';
    }

    function showWorkTypeDetails(workType, date) {
      const allRecords = records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === date && r['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType);
      const responsibleRecords = allRecords.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
      
      let totalUnits = 0, totalTime = 0, totalAmount = 0, totalTasks = 0;
      responsibleRecords.forEach(r => {
        totalUnits += parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        totalTime += parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        totalTasks++;
      });
      allRecords.forEach(r => {
        totalAmount += parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });

      const normative = calculateNormative(totalUnits, totalTime);
      const costPerUnit = totalUnits > 0 ? totalAmount / totalUnits : 0;
      const standard = getStandardForWork(workType);
      const { direction, department } = getDirectionAndDepartment(workType);
      
      const brigades = [...new Set(responsibleRecords.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))];
      const productGroups = [...new Set(allRecords.map(r => r['–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞']))];
      const supplies = [...new Set(allRecords.map(r => r['–ü–æ—Å—Ç–∞–≤–∫–∞']))];

      let html = `
        <h3>üîç –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –≤–∏–¥—É —Ä–∞–±–æ—Ç: ${workType}</h3>
        <p><strong>–î–∞—Ç–∞:</strong> ${date}</p>
        <p><strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> ${direction} | <strong>–û—Ç–¥–µ–ª:</strong> ${department}</p>
        
        <div class="analytics-grid" style="margin: 15px 0;">
          <div class="analytics-card">
            <h4>üìä –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h4>
            <div class="analytics-value">${totalUnits}</div>
            <p class="analytics-label">–í—Å–µ–≥–æ –µ–¥–∏–Ω–∏—Ü</p>
            <div class="analytics-value">${totalTasks}</div>
            <p class="analytics-label">–ó–∞–¥–∞—á</p>
            <div class="analytics-value">${brigades.length}</div>
            <p class="analytics-label">–ë—Ä–∏–≥–∞–¥</p>
          </div>
          
          <div class="analytics-card">
            <h4>‚ö° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h4>
            <div class="analytics-value">${normative.toFixed(1)}</div>
            <p class="analytics-label">–ù–æ—Ä–º–∞—Ç–∏–≤ (—à—Ç/—á–∞—Å)</p>
            <div class="analytics-value">${formatTime(totalTime)}</div>
            <p class="analytics-label">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</p>
            <div class="analytics-value">${(totalTime / 3600).toFixed(1)}</div>
            <p class="analytics-label">–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ —á–∞—Å–æ–≤</p>
          </div>
          
          <div class="analytics-card">
            <h4>üí∞ –§–∏–Ω–∞–Ω—Å—ã</h4>
            <div class="analytics-value">—Ä.${totalAmount.toFixed(0)}</div>
            <p class="analytics-label">–û–±—â–∞—è –†–∞—Å—Ö–æ–¥—ã</p>
            <div class="analytics-value">—Ä.${costPerUnit.toFixed(2)}</div>
            <p class="analytics-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –µ–¥.</p>
            <div class="analytics-value">—Ä.${(totalAmount / (totalTime / 3600)).toFixed(2)}</div>
            <p class="analytics-label">–†–∞—Å—Ö–æ–¥—ã –≤ —á–∞—Å</p>
          </div>
        </div>

        ${standard > 0 ? `
        <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; margin: 15px 0;">
          <h4>üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞</h4>
          <div style="display: flex; align-items: center; gap: 15px;">
            <div style="flex: 1; background: #e0e0e0; border-radius: 10px; height: 20px;">
              <div style="background: #4caf50; height: 100%; border-radius: 10px; width: ${Math.min((normative / standard) * 100, 100)}%;"></div>
            </div>
            <div style="font-weight: bold;">
              ${((normative / standard) * 100).toFixed(1)}%
            </div>
          </div>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            –§–∞–∫—Ç: ${normative.toFixed(1)} —à—Ç/—á–∞—Å | –ü–ª–∞–Ω: ${standard} —à—Ç/—á–∞—Å
          </div>
        </div>
        ` : ''}

        <h4>üë• –†–∞–±–æ—Ç–∞ –±—Ä–∏–≥–∞–¥</h4>
        <div class="grouping-grid">
      `;

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±—Ä–∏–≥–∞–¥–∞–º —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º
      const brigadeStats = {};
      responsibleRecords.forEach(record => {
        const brigade = record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        const supply = record['–ü–æ—Å—Ç–∞–≤–∫–∞'] || '–ë–µ–∑ –ø–æ—Å—Ç–∞–≤–∫–∏';
        
        if (!brigadeStats[brigade]) {
          brigadeStats[brigade] = {
            units: 0,
            time: 0,
            tasks: 0,
            amount: 0,
            supplies: {}
          };
        }
        brigadeStats[brigade].units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        brigadeStats[brigade].time += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        brigadeStats[brigade].tasks++;
        brigadeStats[brigade].amount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        
        // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º
        if (!brigadeStats[brigade].supplies[supply]) {
          brigadeStats[brigade].supplies[supply] = {
            units: 0,
            helpers: []
          };
        }
        brigadeStats[brigade].supplies[supply].units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        
        // –ù–∞—Ö–æ–¥–∏–º –ø–æ–º–æ—â–Ω–∏–∫–æ–≤ –¥–ª—è —ç—Ç–æ–π –ø–æ—Å—Ç–∞–≤–∫–∏
        const supplyRecords = allRecords.filter(r => 
          r['–ü–æ—Å—Ç–∞–≤–∫–∞'] === supply && 
          r['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType &&
          !isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']) // —Ç–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (–ø–æ–º–æ—â–Ω–∏–∫–∏)
        );
        
        supplyRecords.forEach(helperRecord => {
          if (!brigadeStats[brigade].supplies[supply].helpers.find(h => h.name === helperRecord['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'])) {
            brigadeStats[brigade].supplies[supply].helpers.push({
              name: helperRecord['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'],
              role: helperRecord['–î–æ–ª–∂–Ω–æ—Å—Ç—å'] || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'
            });
          }
        });
      });

      Object.entries(brigadeStats).forEach(([brigade, stats]) => {
        const brigadeNormative = stats.time > 0 ? calculateNormative(stats.units, stats.time) : 0;
        const brigadeCostPerUnit = stats.units > 0 ? stats.amount / stats.units : 0;
        
        html += `
          <div class="group-card">
            <h5>${brigade}</h5>
            <div class="group-stats">
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.units}</div>
                <div class="group-stat-label">–ï–¥–∏–Ω–∏—Ü</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.tasks}</div>
                <div class="group-stat-label">–ó–∞–¥–∞—á</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${brigadeNormative.toFixed(1)}</div>
                <div class="group-stat-label">–ù–æ—Ä–º–∞—Ç–∏–≤</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">—Ä.${brigadeCostPerUnit.toFixed(2)}</div>
                <div class="group-stat-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –µ–¥.</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${formatTime(stats.time)}</div>
                <div class="group-stat-label">–í—Ä–µ–º—è</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">—Ä.${stats.amount.toFixed(0)}</div>
                <div class="group-stat-label">–†–∞—Å—Ö–æ–¥—ã</div>
              </div>
            </div>
            
            <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º -->
            <div style="margin-top: 10px;">
              <h6>–ü–æ—Å—Ç–∞–≤–∫–∏:</h6>
              ${Object.entries(stats.supplies).map(([supply, supplyData]) => `
                <div class="supply-details-expanded">
                  <div class="supply-header">${supply} (${supplyData.units} –µ–¥.)</div>
                  ${supplyData.helpers.length > 0 ? `
                    <div class="helper-list">
                      <strong>–ü–æ–º–æ—â–Ω–∏–∫–∏:</strong>
                      ${supplyData.helpers.map(helper => `
                        <div class="helper-item">
                          <span class="helper-name">${helper.name}</span>
                          <span class="helper-role">${helper.role}</span>
                        </div>
                      `).join('')}
                    </div>
                  ` : '<div style="font-size: 11px; color: #999;">–ù–µ—Ç –ø–æ–º–æ—â–Ω–∏–∫–æ–≤</div>'}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });

      html += `</div>`;
      
      document.getElementById('worktype-modal-content').innerHTML = html;
      document.getElementById('worktype-modal').style.display = 'block';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function exportToExcel() {
      alert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ');
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    document.addEventListener('DOMContentLoaded', function() {
      currentArchive = getArchiveNameForDate(new Date());
      loadData();
    });
  </script>
</body>
</html>
