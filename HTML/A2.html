<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç 3</title>
  <style>
    /* ... (–≤–µ—Å—å CSS –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
    /* –û—Å—Ç–∞–ª—å–Ω–æ–π CSS –æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      padding: 8px;
      background: #f9f9f9;
      color: #333;
      margin: 0;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 1.5rem;
    }
    .version {
      text-align: center;
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }
    .last-updated {
      text-align: center;
      font-size: 11px;
      color: #555;
      margin-bottom: 10px;
      font-style: italic;
    }
    .selected-date {
      text-align: center;
      font-size: 14px;
      font-weight: bold;
      color: #1976d2;
      margin: 10px 0;
      padding: 8px;
      background: #e3f2fd;
      border-radius: 6px;
    }
    @media (max-width: 768px) {
      body {
        padding: 4px;
      }
      .container {
        padding: 10px;
      }
      h2 {
        font-size: 1.3rem;
      }
      .calendar-nav-btn {
        padding: 6px 12px;
        min-width: 80px;
        font-size: 12px;
      }
      .calendar-title {
        font-size: 16px;
      }
      .analytics-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .work-types-grid {
        grid-template-columns: 1fr;
      }
      .grouping-grid {
        grid-template-columns: 1fr;
      }
      .comparison-grid {
        grid-template-columns: 1fr;
      }
      .time-bar {
        flex-direction: column;
        height: auto;
        align-items: flex-start;
      }
      .time-label {
        width: 100%;
        margin-bottom: 5px;
        font-size: 11px;
      }
      .time-bar-inner {
        width: 100%;
        margin-bottom: 5px;
        height: 12px;
      }
      .time-value {
        width: 100%;
        text-align: left;
        font-size: 11px;
      }
      .work-type-legend {
        flex-direction: column;
        gap: 5px;
      }
      .modal-content {
        width: 95%;
        margin: 2% auto;
        padding: 15px;
      }
      .work-type-segments {
        height: 12px;
      }
      .time-bar-fill {
        height: 100%;
      }
    }
    @media (max-width: 480px) {
      .calendar-day {
        padding: 6px;
        font-size: 12px;
      }
      .analytics-card, .staff-card, .group-card, .work-type-card {
        padding: 10px;
      }
      .analytics-value {
        font-size: 20px;
      }
      .combined-analytics,
      .time-statistics,
      .percentage-time-statistics,
      .grouping-section,
      .work-types-analytics {
        padding: 15px;
        margin-top: 15px;
      }
      .time-label {
        font-size: 10px;
      }
      .time-value {
        font-size: 10px;
      }
    }
    .calendar-container {
      margin: 15px 0;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .calendar-title {
      font-size: 18px;
      font-weight: bold;
      margin: 0 10px;
      text-align: center;
    }
    .calendar-nav-btn {
      background: #2196f3;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      min-width: 100px;
      text-align: center;
      font-weight: bold;
    }
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .calendar-day-header {
      text-align: center;
      font-weight: bold;
      padding: 8px;
      background: #f0f0f0;
      border-radius: 4px;
      font-size: 12px;
    }
    .calendar-day {
      text-align: center;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
    }
    .calendar-day.has-data {
      background: #2196f3;
      color: white;
    }
    .calendar-day.selected {
      background: #ff9800;
      color: white;
      font-weight: bold;
    }
    .calendar-day.disabled {
      color: #aaa;
      cursor: not-allowed;
    }
    .toggle-icon {
      display: inline-block;
      width: 16px;
      text-align: center;
      margin-right: 6px;
    }
    .hidden {
      display: none;
    }
    .loading {
      text-align: center;
      color: #666;
      padding: 20px;
    }
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2196f3;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-progress {
      background: linear-gradient(90deg, #2196f3, #1976d2);
      height: 3px;
      width: 0%;
      transition: width 0.3s ease;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
    }
    .loading-dots:after {
      content: '';
      animation: dots 1.5s steps(5, end) infinite;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    .combined-analytics {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #fff3e0, #e8f5e9);
      border-radius: 8px;
      border-left: 4px solid #ff9800;
    }
    .combined-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    .combined-title {
      font-size: 18px;
      font-weight: bold;
      color: #e65100;
      margin: 0;
    }
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .analytics-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 3px solid #2196f3;
    }
    .analytics-card h4 {
      margin: 0 0 10px 0;
      color: #1976d2;
      font-size: 14px;
    }
    .analytics-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin: 5px 0;
    }
    .analytics-label {
      font-size: 12px;
      color: #666;
      margin: 0;
    }
    .staff-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 3px solid #ff9800;
    }
    .staff-card h4 {
      margin: 0 0 10px 0;
      color: #ff6f00;
      font-size: 14px;
    }
    .staff-overview {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .staff-total {
      background: #e3f2fd;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    .staff-permanent {
      background: #e8f5e9;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    .staff-hired {
      background: #fff3e0;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    .staff-total-value, .staff-permanent-value, .staff-hired-value {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    .staff-total-label, .staff-permanent-label, .staff-hired-label {
      font-size: 11px;
      color: #666;
    }
    .comparison-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .comparison-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .comparison-card h4 {
      margin: 0 0 10px 0;
      color: #388e3c;
      font-size: 14px;
    }
    .trend-up {
      color: #4caf50;
    }
    .trend-down {
      color: #f44336;
    }
    .grouping-section {
      margin-top: 20px;
      padding: 20px;
      background: #e3f2fd;
      border-radius: 8px;
      border-left: 4px solid #1976d2;
    }
    .grouping-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    .grouping-title {
      font-size: 18px;
      font-weight: bold;
      color: #0d47a1;
      margin: 0;
    }
    .grouping-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .group-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-left: 4px solid #2196f3;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .group-card:hover {
      transform: translateY(-2px);
    }
    .group-card h4 {
      margin: 0 0 10px 0;
      color: #1976d2;
      font-size: 14px;
    }
    .group-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }
    .group-stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 6px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .group-stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    .group-stat-label {
      font-size: 10px;
      color: #666;
      text-align: center;
    }
    .work-types-analytics {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #17a2b8;
    }
    .work-types-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    .work-types-title {
      font-size: 18px;
      font-weight: bold;
      color: #0c5460;
      margin: 0;
    }
    .work-types-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .work-type-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-left: 4px solid #17a2b8;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .work-type-card:hover {
      transform: translateY(-2px);
    }
    .work-type-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e9ecef;
    }
    .work-type-name {
      font-size: 16px;
      font-weight: bold;
      color: #495057;
      margin: 0;
    }
    .work-type-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    .stat-label {
      font-size: 11px;
      color: #666;
      text-align: center;
    }
    .performance-indicator {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
      font-size: 12px;
    }
    .performance-good {
      background: #d4edda;
      color: #155724;
    }
    .performance-average {
      background: #fff3cd;
      color: #856404;
    }
    .performance-poor {
      background: #f8d7da;
      color: #721c24;
    }
    .detail-section {
      margin: 10px 0;
      padding: 15px;
      background: #f1f8e9;
      border-radius: 6px;
      border-left: 3px solid #7cb342;
    }
    .hour-group, .brigade-group {
      margin: 10px 0;
      padding: 10px;
      background: #e8f5e8;
      border-radius: 4px;
      cursor: pointer;
    }
    .brigade-group {
      background: #f3e5f5;
      margin-left: 20px;
    }
    .supply-details {
      margin-left: 40px;
      padding: 8px;
      background: #fff3e0;
      border-radius: 4px;
      margin-top: 5px;
    }
    .night-interval {
      background: #5c6bc0 !important;
      color: white;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    .department-selector {
      margin: 15px 0;
      padding: 15px;
      background: #fff3cd;
      border-radius: 6px;
      border-left: 3px solid #ffc107;
    }
    .department-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .department-btn {
      padding: 8px 16px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .department-btn:hover {
      background: #e3f2fd;
      border-color: #2196f3;
    }
    .department-btn.active {
      background: #2196f3;
      color: white;
      border-color: #2196f3;
    }
    .work-distribution {
      margin: 10px 0;
    }
    .work-distribution-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #e3f2fd;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 5px;
    }
    .work-distribution-title {
      font-weight: bold;
      color: #1976d2;
    }
    .work-distribution-content {
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .collapsed .work-distribution-content {
      display: none;
    }
    .work-type-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }
    .time-bar-with-works {
      position: relative;
      margin: 8px 0;
    }
    .work-type-segments {
      display: flex;
      height: 15px;
      border-radius: 8px;
      overflow: hidden;
    }
    .work-type-segment {
      height: 100%;
      transition: opacity 0.2s;
    }
    .work-type-segment:hover {
      opacity: 0.8;
    }
    .supply-details-expanded {
      margin-left: 20px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      margin-top: 8px;
    }
    .supply-header {
      font-weight: bold;
      margin-bottom: 5px;
      color: #666;
    }
    .helper-list {
      margin-left: 15px;
      font-size: 12px;
    }
    .helper-item {
      display: flex;
      justify-content: space-between;
      padding: 2px 0;
    }
    .helper-name {
      color: #666;
    }
    .helper-role {
      color: #999;
      font-style: italic;
    }
    .direction-group {
      margin: 20px 0;
      padding: 15px;
      background: #f0f4ff;
      border-radius: 8px;
      border-left: 4px solid #4a6bff;
    }
    .direction-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    .direction-title {
      font-size: 16px;
      font-weight: bold;
      color: #2c3e8f;
      margin: 0;
    }
    .department-group {
      margin: 15px 0;
      padding: 12px;
      background: #e8f0ff;
      border-radius: 6px;
      border-left: 3px solid #6c8eff;
    }
    .department-subheader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      cursor: pointer;
    }
    .department-subtitle {
      font-size: 14px;
      font-weight: bold;
      color: #3a4f9e;
      margin: 0;
    }
    .charts-section {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
      border-radius: 8px;
      border-left: 4px solid #2196f3;
    }
    .charts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    .charts-title {
      font-size: 18px;
      font-weight: bold;
      color: #1976d2;
      margin: 0;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }
    .chart-container {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .chart-title {
      font-size: 14px;
      font-weight: bold;
      color: #333;
      margin: 0 0 10px 0;
      text-align: center;
    }
    .chart-placeholder {
      height: 250px;
      background: #f8f9fa;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 14px;
      text-align: center;
      padding: 20px;
    }
    .warning-note {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 6px;
      padding: 12px;
      margin: 15px 0;
      font-size: 14px;
      color: #856404;
    }
    .warning-note strong {
      color: #e65100;
    }
    .chart-real {
      height: 250px;
      position: relative;
    }
    .chart-bar {
      display: flex;
      align-items: flex-end;
      height: 200px;
      gap: 4px;
      margin-bottom: 10px;
    }
    .chart-bar-item {
      flex: 1;
      background: #2196f3;
      border-radius: 4px 4px 0 0;
      position: relative;
      transition: opacity 0.2s;
    }
    .chart-bar-item:hover {
      opacity: 0.8;
    }
    .chart-bar-label {
      text-align: center;
      font-size: 10px;
      color: #666;
      margin-top: 5px;
    }
    .chart-pie {
      height: 200px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 10px;
    }
    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
    }
    .work-type-charts-section {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #e8f5e9, #f3e5f5);
      border-radius: 8px;
      border-left: 4px solid #4caf50;
    }
    .work-type-charts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    .work-type-charts-title {
      font-size: 18px;
      font-weight: bold;
      color: #2e7d32;
      margin: 0;
    }
  </style>
</head>
<body>
  <div id="loading-progress" class="loading-progress"></div>
  <div id="department-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('department-modal')">&times;</span>
      <div id="department-modal-content"></div>
    </div>
  </div>
  <div id="worktype-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('worktype-modal')">&times;</span>
      <div id="worktype-modal-content"></div>
    </div>
  </div>
  <div class="container">
    <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç</h2>
    <div class="version">v3-11.08.0214 <span>üïí</span></div>
    <div class="last-updated" id="last-updated">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ‚Äî</div>
    <div id="controls" class="hidden">
      <div class="calendar-container">
        <div class="calendar-header">
          <button class="calendar-nav-btn" id="prev-month">‚óÄ –ù–∞–∑–∞–¥</button>
          <div class="calendar-title" id="calendar-title">–û–∫—Ç—è–±—Ä—å 2025</div>
          <button class="calendar-nav-btn" id="next-month">–í–ø–µ—Ä—ë–¥ ‚ñ∂</button>
        </div>
        <div class="calendar-days" id="calendar-days"></div>
      </div>
      <div id="selected-date" class="selected-date hidden">
        üìÖ –î–∞–Ω–Ω—ã–µ –∑–∞: <span id="current-date"></span>
      </div>
      <div id="level-1" class="hidden">
        <div id="combined-analytics" class="combined-analytics">
          <div class="combined-header" id="combined-toggle">
            <h3 class="combined-title">üìä –û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div id="combined-content" class="hidden"></div>
        </div>
        <div id="charts-section" class="charts-section">
          <div class="charts-header" id="charts-toggle">
            <h3 class="charts-title">üìà –î–µ—Ç–∞–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –¥–∏–∞–≥—Ä–∞–º–º—ã</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div id="charts-content" class="hidden"></div>
        </div>
        <div id="work-type-charts-section" class="work-type-charts-section">
          <div class="work-type-charts-header" id="work-type-charts-toggle">
            <h3 class="work-type-charts-title">üìä –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div id="work-type-charts-content" class="hidden"></div>
        </div>
      </div>
      <div id="level-2" class="hidden">
        <div id="departments-analytics" class="grouping-section">
          <div class="grouping-header" id="departments-toggle">
            <h3 class="grouping-title">üèõÔ∏è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div id="departments-content" class="hidden"></div>
        </div>
      </div>
      <div id="level-3" class="hidden">
        <div id="work-types-analytics" class="work-types-analytics">
          <div class="work-types-header" id="work-types-toggle">
            <h3 class="work-types-title">üîç –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç</h3>
            <span class="toggle-icon">‚ñ∂</span>
          </div>
          <div id="work-types-content" class="hidden"></div>
        </div>
      </div>
      <button id="export-excel" style="margin-top: 20px;">üìä –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
    </div>
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö<span class="loading-dots"></span></span>
    </div>
    <div id="error" class="error hidden"></div>
  </div>
  <script>
    // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    function parseTime(timeStr) {
      if (!timeStr) return 0;
      const parts = timeStr.split(':').map(Number);
      if (parts.length !== 3) return 0;
      const [h, m, s] = parts;
      return (h || 0) * 3600 + (m || 0) * 60 + (s || 0);
    }
    function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }
    function formatTimeHours(seconds) {
      const hours = seconds / 3600;
      return hours.toFixed(1);
    }
    function parseCurrency(str) {
      if (!str || typeof str !== 'string') return 0;
      let clean = str.trim().replace(/^—Ä\.\s*/i, '');
      clean = clean.replace(',', '.');
      const num = parseFloat(clean);
      return isNaN(num) ? 0 : num;
    }
    function formatCurrency(amount) {
      return `—Ä.${amount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')}`;
    }
    function getHourFromTime(timeStr) {
      if (!timeStr) return null;
      const [h] = timeStr.split(':');
      return parseInt(h) || 0;
    }
    function isResponsible(position) {
      return position === '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π' || position === '–û—Ç–≤–µ—Ç—Å–≤–µ–Ω–Ω—ã–π';
    }
    function formatDateTime(date) {
      return new Intl.DateTimeFormat('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      }).format(date);
    }
    function calculateNormative(units, seconds) {
      if (seconds <= 0) return 0;
      const hours = seconds / 3600;
      return units / hours;
    }
    function parseDate(dateStr) {
      const [day, month, year] = dateStr.split('.').map(Number);
      return new Date(year, month - 1, day);
    }
    function formatDate(date) {
      return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
    }
    // === –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ß–ê–°–û–í–´–• –ò–ù–¢–ï–†–í–ê–õ–û–í ===
    function getHourIntervalForWorkDay(timeStr, workDate) {
      if (!timeStr) return null;
      const hour = getHourFromTime(timeStr);
      if (hour === null) return null;
      if (hour < 9) {
        const displayStart = String(hour).padStart(2, '0');
        const displayEnd = String((hour + 1) % 24).padStart(2, '0');
        return {
          key: `${displayStart}-${displayEnd}`,
          display: `${displayStart}-${displayEnd} (–Ω–æ—á—å)`,
          shortDisplay: `${displayStart}‚Äì${displayEnd}`,
          isNight: true,
          sortKey: hour + 24
        };
      } else {
        const displayStart = String(hour).padStart(2, '0');
        const displayEnd = String(hour + 1).padStart(2, '0');
        return {
          key: `${displayStart}-${displayEnd}`,
          display: `${displayStart}-${displayEnd}`,
          shortDisplay: `${displayStart}‚Äì${displayEnd}`,
          isNight: false,
          sortKey: hour
        };
      }
    }
    // === –û–°–¢–ê–õ–¨–ù–û–ô JS –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô, –ö–†–û–ú–ï –ú–ï–°–¢ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø shortDisplay ===
    let records = [];
    let standards = [];
    let staffData = [];
    let selectedDate = '';
    let allWorkTypes = [];
    let currentMonth = new Date();
    currentMonth.setDate(1);
    let currentArchive = null;
    let uiInitialized = false;
    let selectedDepartment = '';
    const workTypeColors = {
      '–ü–æ–≥—Ä—É–∑–∫–∞': '#FF6B6B',
      '–†–∞–∑–≥—Ä—É–∑–∫–∞': '#4ECDC4', 
      '–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞': '#45B7D1',
      '–£–ø–∞–∫–æ–≤–∫–∞': '#96CEB4',
      '–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è': '#FFEAA7',
      '–ü—Ä–æ–≤–µ—Ä–∫–∞': '#DDA0DD',
      '–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞': '#98D8C8',
      '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ': '#F7DC6F',
      '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞': '#FFA726',
      '–°–±–æ—Ä–∫–∞': '#AB47BC',
      '–†–∞—Å–ø–∞–∫–æ–≤–∫–∞': '#26C6DA',
      '–£—á–µ—Ç': '#66BB6A',
      '–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è': '#FFCA28',
      '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞': '#78909C',
      '–û–±—Ä–∞–±–æ—Ç–∫–∞': '#EC407A',
      '–§–∞—Å–æ–≤–∫–∞': '#8D6E63',
      '–ö–æ–Ω—Ç—Ä–æ–ª—å': '#42A5F5',
      '–û—Ç–±–æ—Ä': '#7E57C2',
      '–°—Ç–µ–ª–ª–∞–∂–∏—Ä–æ–≤–∞–Ω–∏–µ': '#9CCC65',
      '–ü–∞–ª–µ—Ç–∏–∑–∞—Ü–∏—è': '#FF7043',
      '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ': '#26A69A',
      '–°—Ç–∏–∫–µ—Ä–æ–≤–∫–∞': '#5D4037',
      '–ü–µ—Ä–µ—É–ø–∞–∫–æ–≤–∫–∞': '#00897B',
      '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é': '#BBBBBB'
    };
    const chartLabels = {
      workTypes: {
        '–ü–æ–≥—Ä—É–∑–∫–∞': '–û—Ç–≥—Ä—É–∑–∫–∞',
        '–†–∞–∑–≥—Ä—É–∑–∫–∞': '–ì–ª–∞–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞',
        '–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞': '–£–ø–∞–∫–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏',
        '–£–ø–∞–∫–æ–≤–∫–∞': '–°—Ç–∏–∫–µ—Ä–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏',
        '–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è': '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞',
        '–ü—Ä–æ–≤–µ—Ä–∫–∞': '–†–∞–±–æ—Ç–∞ —Å —Ä–µ–∫–ª–∞–º–∞—Ü–∏—è–º–∏',
        '–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞': '–î—Ä—É–≥–∏–µ –≤–∏–¥—ã —Ä–∞–±–æ—Ç'
      },
      departments: {
        '–ü—Ä–∏–µ–º–∫–∞': '–û—Ç–≥—Ä—É–∑–∫–∞',
        '–û—Ç–≥—Ä—É–∑–∫–∞': '–ú–ü',
        '–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞': '–°–±–æ—Ä–∫–∞',
        '–£–ø–∞–∫–æ–≤–∫–∞': '–ü–æ–∫—É–ø–∫–∞'
      },
      timeIntervals: [
        '09:10', '10:11', '11:12', '12:13', '13:14', '14:15',
        '16:17', '17:18', '18:19'
      ],
      costDistribution: {
        '–ü–æ–≥—Ä—É–∑–∫–∞': '–ì–ª–∞–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (23.2%)',
        '–†–∞–∑–≥—Ä—É–∑–∫–∞': '–°—Ç–∏–∫–µ—Ä–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ (22.7%)',
        '–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞': '–î—Ä—É–≥–∏–µ –≤–∏–¥—ã —Ä–∞–±–æ—Ç (22.3%)',
        '–£–ø–∞–∫–æ–≤–∫–∞': '–£–ø–∞–∫–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ (13.6%)',
        '–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è': '–†–∞–±–æ—Ç–∞ —Å —Ä–µ–∫–ª–∞–º–∞—Ü–∏—è–º–∏ (10.9%)',
        '–ü—Ä–æ–≤–µ—Ä–∫–∞': '–û—Ç–≥—Ä—É–∑–∫–∞ (7.9%)'
      }
    };
    function getWorkTypeColor(workType) {
      if (workTypeColors[workType]) {
        return workTypeColors[workType];
      }
      let hash = 0;
      for (let i = 0; i < workType.length; i++) {
        hash = workType.charCodeAt(i) + ((hash << 5) - hash);
      }
      hash = Math.abs(hash);
      const colors = [
        '#FF9800', '#9C27B0', '#3F51B5', '#009688', '#795548',
        '#607D8B', '#E91E63', '#2196F3', '#4CAF50', '#FFC107',
        '#673AB7', '#00BCD4', '#8BC34A', '#FF5722', '#CDDC39',
        '#FFEB3B', '#03A9F4', '#8BC34A', '#FF9800', '#9C27B0'
      ];
      const color = colors[hash % colors.length];
      workTypeColors[workType] = color;
      return color;
    }
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const controlsDiv = document.getElementById('controls');
    const selectedDateDiv = document.getElementById('selected-date');
    const currentDateSpan = document.getElementById('current-date');
    const lastUpdatedDiv = document.getElementById('last-updated');
    const exportExcelBtn = document.getElementById('export-excel');
    const calendarTitle = document.getElementById('calendar-title');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const calendarDaysContainer = document.getElementById('calendar-days');
    const loadingProgress = document.getElementById('loading-progress');
    function updateProgress(percent) {
      if (loadingProgress) {
        loadingProgress.style.width = percent + '%';
      }
    }
    async function loadStandards() {
      const standardsUrl = `${window.location.origin}/archive/standard%20fullData.json`;
      try {
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ –∏–∑:', standardsUrl);
        const response = await fetch(`${standardsUrl}?t=${Date.now()}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status} - ${response.statusText}`);
        }
        const data = await response.json();
        if (Array.isArray(data.records)) {
          standards = data.records.filter(record => 
            isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å']) && record['–ù–æ—Ä–º–∞—Ç–∏–≤ 1']
          );
          console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤:', standards.length);
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤:', err);
        standards = [
          {
            "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–í—Ö–æ–¥—è—â–∏–µ",
            "–û—Ç–¥–µ–ª": "–ü—Ä–∏–µ–º–∫–∞",
            "–í–∏–¥ —Ä–∞–±–æ—Ç": "–†–∞–∑–≥—Ä—É–∑–∫–∞",
            "–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞": "–í—Å–µ",
            "–ù–æ—Ä–º–∞—Ç–∏–≤ 1": "120"
          },
          {
            "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–í—Ö–æ–¥—è—â–∏–µ",
            "–û—Ç–¥–µ–ª": "–ü—Ä–∏–µ–º–∫–∞", 
            "–í–∏–¥ —Ä–∞–±–æ—Ç": "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞",
            "–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞": "–í—Å–µ",
            "–ù–æ—Ä–º–∞—Ç–∏–≤ 1": "80"
          },
          {
            "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–ò—Å—Ö–æ–¥—è—â–∏–µ",
            "–û—Ç–¥–µ–ª": "–û—Ç–≥—Ä—É–∑–∫–∞",
            "–í–∏–¥ —Ä–∞–±–æ—Ç": "–ü–æ–≥—Ä—É–∑–∫–∞",
            "–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞": "–í—Å–µ",
            "–ù–æ—Ä–º–∞—Ç–∏–≤ 1": "100"
          }
        ];
      }
    }
    async function loadStaffData() {
      const staffUrl = `${window.location.origin}/archive/staff%20fullData.json`;
      try {
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –∏–∑:', staffUrl);
        const response = await fetch(`${staffUrl}?t=${Date.now()}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status} - ${response.statusText}`);
        }
        const data = await response.json();
        if (Array.isArray(data.records)) {
          staffData = data.records;
          console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:', staffData.length);
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:', err);
        staffData = [
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–ò–≤–∞–Ω–æ–≤ –ò.–ò.", "–°—Ç–∞—Ç—É—Å": "–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π", "–û—Ç–¥–µ–ª": "–ü—Ä–∏–µ–º–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–ü–µ—Ç—Ä–æ–≤ –ü.–ü.", "–°—Ç–∞—Ç—É—Å": "–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π", "–û—Ç–¥–µ–ª": "–ü—Ä–∏–µ–º–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–°–∏–¥–æ—Ä–æ–≤ –°.–°.", "–°—Ç–∞—Ç—É—Å": "–ù–∞–µ–º–Ω—ã–π", "–û—Ç–¥–µ–ª": "–ü—Ä–∏–µ–º–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–ö—É–∑–Ω–µ—Ü–æ–≤ –ö.–ö.", "–°—Ç–∞—Ç—É—Å": "–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π", "–û—Ç–¥–µ–ª": "–û—Ç–≥—Ä—É–∑–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–ù–∏–∫–æ–ª–∞–µ–≤ –ù.–ù.", "–°—Ç–∞—Ç—É—Å": "–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π", "–û—Ç–¥–µ–ª": "–û—Ç–≥—Ä—É–∑–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–í–∞—Å–∏–ª—å–µ–≤ –í.–í.", "–°—Ç–∞—Ç—É—Å": "–ù–∞–µ–º–Ω—ã–π", "–û—Ç–¥–µ–ª": "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–ê–ª–µ–∫—Å–µ–µ–≤ –ê.–ê.", "–°—Ç–∞—Ç—É—Å": "–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π", "–û—Ç–¥–µ–ª": "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–ì—Ä–∏–≥–æ—Ä—å–µ–≤ –ì.–ì.", "–°—Ç–∞—Ç—É—Å": "–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π", "–û—Ç–¥–µ–ª": "–£–ø–∞–∫–æ–≤–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–î–º–∏—Ç—Ä–∏–µ–≤ –î.–î.", "–°—Ç–∞—Ç—É—Å": "–ù–∞–µ–º–Ω—ã–π", "–û—Ç–¥–µ–ª": "–£–ø–∞–∫–æ–≤–∫–∞"},
          {"–°–æ—Ç—Ä—É–¥–Ω–∏–∫": "–ï–≥–æ—Ä–æ–≤ –ï.–ï.", "–°—Ç–∞—Ç—É—Å": "–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π", "–û—Ç–¥–µ–ª": "–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è"}
        ];
      }
    }
    function getStandardForWork(workType, productGroup = null) {
      if (productGroup) {
        const specificStandard = standards.find(standard =>
          standard['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType &&
          standard['–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞'] === productGroup
        );
        if (specificStandard) return parseFloat(specificStandard['–ù–æ—Ä–º–∞—Ç–∏–≤ 1']);
      }
      const generalStandard = standards.find(standard =>
        standard['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType
      );
      return generalStandard ? parseFloat(generalStandard['–ù–æ—Ä–º–∞—Ç–∏–≤ 1']) : 0;
    }
    function getDirectionAndDepartment(workType) {
      const standard = standards.find(s => s['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType);
      return {
        direction: standard?.['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
        department: standard?.['–û—Ç–¥–µ–ª'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
      };
    }
    function analyzeStaffForRecords(records) {
      const uniqueEmployees = [...new Set(records.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))].filter(Boolean);
      let totalStaff = 0;
      let permanentStaff = 0;
      let hiredStaff = 0;
      let totalWorkTime = 0;
      let permanentWorkTime = 0;
      let hiredWorkTime = 0;
      const validRecords = records.filter(r => (parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0) > 0);
      uniqueEmployees.forEach(employee => {
        const employeeRecords = validRecords.filter(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'] === employee);
        const employeeWorkTime = employeeRecords.reduce((sum, r) => sum + parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']), 0);
        const staffInfo = staffData.find(s => s['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'] === employee);
        if (staffInfo) {
          totalStaff++;
          totalWorkTime += employeeWorkTime;
          if (staffInfo['–°—Ç–∞—Ç—É—Å'] === '–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π') {
            permanentStaff++;
            permanentWorkTime += employeeWorkTime;
          } else {
            hiredStaff++;
            hiredWorkTime += employeeWorkTime;
          }
        } else {
          totalStaff++;
          hiredStaff++;
          totalWorkTime += employeeWorkTime;
          hiredWorkTime += employeeWorkTime;
        }
      });
      return {
        total: totalStaff,
        permanent: permanentStaff,
        hired: hiredStaff,
        totalWorkTime: totalWorkTime,
        permanentWorkTime: permanentWorkTime,
        hiredWorkTime: hiredWorkTime
      };
    }
    function calculateTimesheetTime(records) {
      const uniqueEmployees = [...new Set(records.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))].filter(Boolean);
      let totalTimesheetTime = 0;
      uniqueEmployees.forEach(employee => {
        const employeeRecords = records.filter(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'] === employee);
        const employeeTime = employeeRecords.reduce((sum, r) => sum + parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']), 0);
        totalTimesheetTime += employeeTime;
      });
      return totalTimesheetTime;
    }
    function createTestData() {
      console.log('–°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...');
      const testRecords = [];
      const workTypesFromStandards = [...new Set(standards.map(s => s['–í–∏–¥ —Ä–∞–±–æ—Ç']))];
      const workTypes = workTypesFromStandards.length > 0 ? workTypesFromStandards : 
        ['–ü–æ–≥—Ä—É–∑–∫–∞', '–†–∞–∑–≥—Ä—É–∑–∫–∞', '–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞', '–£–ø–∞–∫–æ–≤–∫–∞', '–°—Ç–∏–∫–µ—Ä–æ–≤–∫–∞', '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ'];
      const employees = ['–ò–≤–∞–Ω–æ–≤ –ò.–ò.', '–ü–µ—Ç—Ä–æ–≤ –ü.–ü.', '–°–∏–¥–æ—Ä–æ–≤ –°.–°.', '–ö—É–∑–Ω–µ—Ü–æ–≤ –ö.–ö.', '–ù–∏–∫–æ–ª–∞–µ–≤ –ù.–ù.'];
      const productGroups = ['–î–∏—Å–∫–∏', '–®–∏–Ω—ã', '–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã', '–ú–∞—Å–ª–∞', '–§–∏–ª—å—Ç—Ä—ã'];
      const today = new Date();
      for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
        const date = new Date(today);
        date.setDate(today.getDate() - dayOffset);
        const dateStr = formatDate(date);
        for (let i = 0; i < 25; i++) {
          const workType = workTypes[i % workTypes.length];
          const { direction, department } = getDirectionAndDepartment(workType);
          const productGroup = productGroups[i % productGroups.length];
          testRecords.push({
            '–†–∞–±–æ—á–∏–π –¥–µ–Ω—å': dateStr,
            '–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏': `${8 + (i % 10)}:${String(i % 60).padStart(2, '0')}:00`,
            '–í–∏–¥ —Ä–∞–±–æ—Ç': workType,
            '–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞': productGroup,
            '–î–æ–ª–∂–Ω–æ—Å—Ç—å': i % 3 === 0 ? '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π' : '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
            '–°–æ—Ç—Ä—É–¥–Ω–∏–∫': employees[i % employees.length],
            '–ü–æ—Å—Ç–∞–≤–∫–∞': `–ü–æ—Å—Ç–∞–≤–∫–∞ ${Math.floor(i / 3) + 1}`,
            '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü': (Math.random() * 100 + 50).toFixed(0),
            '–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è': '01:00:00',
            '–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞': `—Ä.${(Math.random() * 1000 + 500).toFixed(2)}`,
            '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': direction,
            '–û—Ç–¥–µ–ª': department
          });
        }
      }
      return testRecords;
    }
    async function loadData() {
      if (!currentArchive) {
        currentArchive = getArchiveNameForDate(new Date());
      }
      const url = getArchiveUrl(currentArchive);
      try {
        loadingDiv.classList.remove('hidden');
        errorDiv.classList.add('hidden');
        controlsDiv.classList.add('hidden');
        updateProgress(10);
        await Promise.all([loadStandards(), loadStaffData()]);
        loadingDiv.innerHTML = `
          <div class="loading-spinner"></div>
          <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞—Ä—Ö–∏–≤–∞ ${currentArchive}<span class="loading-dots"></span></span>
        `;
        console.log('–ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑:', url);
        const urlWithCacheBust = `${url}?t=${Date.now()}`;
        updateProgress(30);
        const response = await fetch(urlWithCacheBust);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status} - ${response.statusText}`);
        }
        updateProgress(60);
        const data = await response.json();
        if (!Array.isArray(data.records)) {
          throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
        }
        updateProgress(80);
        records = data.records;
        records.forEach(record => {
          const { direction, department } = getDirectionAndDepartment(record['–í–∏–¥ —Ä–∞–±–æ—Ç']);
          record['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] = direction;
          record['–û—Ç–¥–µ–ª'] = department;
        });
        allWorkTypes = [...new Set(records.map(r => r['–í–∏–¥ —Ä–∞–±–æ—Ç']).filter(Boolean))].sort();
        lastUpdatedDiv.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${formatDateTime(new Date())} | –ê—Ä—Ö–∏–≤: ${currentArchive} | –ù–æ—Ä–º–∞—Ç–∏–≤–æ–≤: ${standards.length} | –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${staffData.length}`;
        updateProgress(100);
        setTimeout(() => {
          initUI();
          updateProgress(0);
        }, 500);
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:', err);
        records = createTestData();
        allWorkTypes = [...new Set(records.map(r => r['–í–∏–¥ —Ä–∞–±–æ—Ç']).filter(Boolean))].sort();
        lastUpdatedDiv.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${formatDateTime(new Date())} | –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï | –ù–æ—Ä–º–∞—Ç–∏–≤–æ–≤: ${standards.length} | –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${staffData.length}`;
        errorDiv.textContent = `‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ${err.message}. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.`;
        errorDiv.classList.remove('hidden');
        updateProgress(100);
        setTimeout(() => {
          initUI();
          updateProgress(0);
        }, 500);
      }
    }
    function getArchiveNameForDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      return `${year}-${month}`;
    }
    function getArchiveUrl(archiveName) {
      const encodedName = encodeURIComponent(`${archiveName} fullData.json`);
      return `${window.location.origin}/archive/${encodedName}`;
    }
    function initUI() {
      loadingDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');
      controlsDiv.classList.remove('hidden');
      renderCalendar();
      if (!uiInitialized) {
        setupEventListeners();
        uiInitialized = true;
      }
      const uniqueDates = [...new Set(records.map(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å']))].filter(Boolean).sort();
      if (uniqueDates.length > 0 && !selectedDate) {
        selectedDate = uniqueDates[0];
        renderReport();
      }
    }
    function setupEventListeners() {
      exportExcelBtn.addEventListener('click', exportToExcel);
      prevMonthBtn.addEventListener('click', () => {
        currentMonth.setMonth(currentMonth.getMonth() - 1);
        const targetArchive = getArchiveNameForDate(currentMonth);
        if (currentArchive !== targetArchive) {
          currentArchive = targetArchive;
          selectedDate = '';
          loadData();
        } else {
          renderCalendar();
        }
      });
      nextMonthBtn.addEventListener('click', () => {
        currentMonth.setMonth(currentMonth.getMonth() + 1);
        const targetArchive = getArchiveNameForDate(currentMonth);
        if (currentArchive !== targetArchive) {
          currentArchive = targetArchive;
          selectedDate = '';
          loadData();
        } else {
          renderCalendar();
        }
      });
      setupToggleHandler('combined-toggle', 'combined-content');
      setupToggleHandler('charts-toggle', 'charts-content');
      setupToggleHandler('work-type-charts-toggle', 'work-type-charts-content');
      setupToggleHandler('departments-toggle', 'departments-content');
      setupToggleHandler('work-types-toggle', 'work-types-content');
      window.addEventListener('click', function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      });
    }
    function setupToggleHandler(toggleId, contentId) {
      const toggle = document.getElementById(toggleId);
      const content = document.getElementById(contentId);
      if (toggle && content) {
        toggle.addEventListener('click', function() {
          const icon = this.querySelector('.toggle-icon');
          if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            icon.textContent = '‚ñº';
          } else {
            content.classList.add('hidden');
            icon.textContent = '‚ñ∂';
          }
        });
      }
    }
    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      const monthNames = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
      calendarTitle.textContent = `${monthNames[month]} ${year}`;
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const firstDayOfWeek = firstDay.getDay();
      calendarDaysContainer.innerHTML = '';
      const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
      dayNames.forEach(name => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = name;
        calendarDaysContainer.appendChild(header);
      });
      for (let i = 0; i < (firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1); i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day disabled';
        calendarDaysContainer.appendChild(empty);
      }
      const availableDates = new Set(records.map(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å']));
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${String(day).padStart(2, '0')}.${String(month + 1).padStart(2, '0')}.${year}`;
        const hasData = availableDates.has(dateStr);
        const dayEl = document.createElement('div');
        dayEl.className = `calendar-day${hasData ? ' has-data' : ''}${dateStr === selectedDate ? ' selected' : ''}`;
        dayEl.textContent = day;
        if (hasData) {
          dayEl.addEventListener('click', () => {
            selectedDate = dateStr;
            renderReport();
          });
        } else {
          dayEl.classList.add('disabled');
        }
        calendarDaysContainer.appendChild(dayEl);
      }
      const lastDayOfWeek = lastDay.getDay();
      const remaining = 6 - (lastDayOfWeek === 0 ? 6 : lastDayOfWeek - 1);
      for (let i = 0; i < remaining; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day disabled';
        calendarDaysContainer.appendChild(empty);
      }
    }
    function renderReport() {
      if (!selectedDate) {
        selectedDateDiv.classList.add('hidden');
        hideAllLevels();
        return;
      }
      const allRecords = records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === selectedDate);
      if (allRecords.length === 0) {
        selectedDateDiv.classList.add('hidden');
        hideAllLevels();
        return;
      }
      selectedDateDiv.classList.remove('hidden');
      currentDateSpan.textContent = selectedDate;
      showAllLevels();
      renderLevel1Analytics(allRecords);
      renderLevel2Analytics(allRecords);
      renderLevel3Analytics(allRecords);
    }
    function hideAllLevels() {
      document.getElementById('level-1').classList.add('hidden');
      document.getElementById('level-2').classList.add('hidden');
      document.getElementById('level-3').classList.add('hidden');
    }
    function showAllLevels() {
      document.getElementById('level-1').classList.remove('hidden');
      document.getElementById('level-2').classList.remove('hidden');
      document.getElementById('level-3').classList.remove('hidden');
    }
    function renderLevel1Analytics(allRecords) {
      const responsibleRecords = allRecords.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
      renderCombinedAnalytics(allRecords, responsibleRecords);
      renderCharts(allRecords, responsibleRecords);
      renderWorkTypeCharts(allRecords, responsibleRecords);
    }
    function renderLevel2Analytics(allRecords) {
      const allDepartments = [...new Set(allRecords.map(r => r['–û—Ç–¥–µ–ª']))].filter(Boolean);
      let html = '';
      if (!selectedDepartment) {
        html = `
          <div class="department-selector">
            <h4>üèõÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</h4>
            <div class="department-buttons">
              ${allDepartments.map(dept => `
                <button class="department-btn" onclick="selectDepartment('${dept}')">${dept}</button>
              `).join('')}
            </div>
          </div>
        `;
      } else {
        const departmentRecords = allRecords.filter(r => r['–û—Ç–¥–µ–ª'] === selectedDepartment);
        const responsibleRecords = departmentRecords.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
        let totalUnits = 0, totalTime = 0, totalAmount = 0, totalTasks = 0;
        responsibleRecords.forEach(r => {
          totalUnits += parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          totalTime += parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
          totalTasks++;
        });
        departmentRecords.forEach(r => {
          totalAmount += parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        });
        const normative = calculateNormative(totalUnits, totalTime);
        const costPerUnit = totalUnits > 0 ? totalAmount / totalUnits : 0;
        const totalHours = totalTime / 3600;
        const revenuePerHour = totalHours > 0 ? totalAmount / totalHours : 0;
        const workTypes = [...new Set(departmentRecords.map(r => r['–í–∏–¥ —Ä–∞–±–æ—Ç']))];
        const brigades = [...new Set(responsibleRecords.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))];
        const staffAnalysis = analyzeStaffForRecords(departmentRecords);
        const timesheetTime = calculateTimesheetTime(departmentRecords);
        html = `
          <div style="margin-bottom: 15px;">
            <button class="department-btn active" style="margin-right: 10px;">${selectedDepartment}</button>
            <button class="department-btn" onclick="selectDepartment('')">‚Üê –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –æ—Ç–¥–µ–ª–∞</button>
          </div>
          <div class="analytics-grid">
            <div class="analytics-card">
              <h4>üìä –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h4>
              <div class="analytics-value">${totalUnits}</div>
              <p class="analytics-label">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –µ–¥–∏–Ω–∏—Ü</p>
              <div class="analytics-value">${totalTasks}</div>
              <p class="analytics-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á</p>
              <div class="analytics-value">${brigades.length}</div>
              <p class="analytics-label">–†–∞–±–æ—Ç–∞–ª–æ –±—Ä–∏–≥–∞–¥</p>
            </div>
            <div class="analytics-card">
              <h4>‚ö° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h4>
              <div class="analytics-value">${normative.toFixed(1)}</div>
              <p class="analytics-label">–ù–æ—Ä–º–∞—Ç–∏–≤ (—à—Ç/—á–∞—Å)</p>
              <div class="analytics-value">${formatTime(totalTime)}</div>
              <p class="analytics-label">–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</p>
              <div class="analytics-value">${formatTime(timesheetTime)}</div>
              <p class="analytics-label">–í—Ä–µ–º—è –ø–æ —Ç–∞–±–µ–ª—é</p>
            </div>
            <div class="analytics-card">
              <h4>üí∞ –†–∞—Å—Ö–æ–¥—ã</h4>
              <div class="analytics-value">${formatCurrency(totalAmount)}</div>
              <p class="analytics-label">–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</p>
              <div class="analytics-value">—Ä.${costPerUnit.toFixed(2)}</div>
              <p class="analytics-label">–†–∞—Å—Ö–æ–¥—ã –Ω–∞ 1 –µ–¥.</p>
              <div class="analytics-value">${formatCurrency(revenuePerHour)}</div>
              <p class="analytics-label">–†–∞—Å—Ö–æ–¥—ã –≤ —á–∞—Å</p>
            </div>
            <div class="analytics-card">
              <h4>üë• –ü–µ—Ä—Å–æ–Ω–∞–ª –æ—Ç–¥–µ–ª–∞</h4>
              <div class="analytics-value">${staffAnalysis.total}</div>
              <p class="analytics-label">–í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
              <div class="analytics-value">${staffAnalysis.permanent}</div>
              <p class="analytics-label">–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ</p>
              <div class="analytics-value">${staffAnalysis.hired}</div>
              <p class="analytics-label">–ù–∞–µ–º–Ω—ã–µ</p>
              <div class="analytics-value">${formatTime(staffAnalysis.totalWorkTime)}</div>
              <p class="analytics-label">–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</p>
              <div style="font-size: 11px; color: #666; margin-top: 5px;">
                –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ: ${formatTime(staffAnalysis.permanentWorkTime)}<br>
                –ù–∞–µ–º–Ω—ã–µ: ${formatTime(staffAnalysis.hiredWorkTime)}
              </div>
            </div>
            <div class="analytics-card">
              <h4>üè¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∞</h4>
              <div class="analytics-value">${workTypes.length}</div>
              <p class="analytics-label">–í–∏–¥–æ–≤ —Ä–∞–±–æ—Ç</p>
              <div class="analytics-value">${departmentRecords.length}</div>
              <p class="analytics-label">–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π</p>
            </div>
          </div>
        `;
      }
      document.getElementById('departments-content').innerHTML = html;
    }
    function renderLevel3Analytics(allRecords) {
      const directionStats = {};
      const unclassifiedWorkTypes = new Set();
      allRecords.forEach(record => {
        const direction = record['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        const department = record['–û—Ç–¥–µ–ª'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        const workType = record['–í–∏–¥ —Ä–∞–±–æ—Ç'] || '–ë–µ–∑ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç';
        const productGroup = record['–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞'] || '–í—Å–µ';
        if (direction === '–ù–µ —É–∫–∞–∑–∞–Ω–æ' || department === '–ù–µ —É–∫–∞–∑–∞–Ω–æ') {
          unclassifiedWorkTypes.add(workType);
          return;
        }
        if (!directionStats[direction]) {
          directionStats[direction] = {
            departments: {},
            totalUnits: 0,
            totalTime: 0,
            totalAmount: 0
          };
        }
        if (!directionStats[direction].departments[department]) {
          directionStats[direction].departments[department] = {
            workTypes: {},
            totalUnits: 0,
            totalTime: 0,
            totalAmount: 0
          };
        }
        if (!directionStats[direction].departments[department].workTypes[workType]) {
          directionStats[direction].departments[department].workTypes[workType] = {
            totalUnits: 0,
            totalTime: 0,
            totalAmount: 0,
            tasks: 0,
            responsibleTasks: 0,
            brigades: new Set(),
            productGroups: new Set(),
            standard: getStandardForWork(workType, productGroup),
            records: []
          };
        }
        const workTypeStats = directionStats[direction].departments[department].workTypes[workType];
        workTypeStats.records.push(record);
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          workTypeStats.totalUnits += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          workTypeStats.totalTime += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
          workTypeStats.responsibleTasks++;
          if (record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']) {
            workTypeStats.brigades.add(record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']);
          }
        }
        workTypeStats.totalAmount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        workTypeStats.tasks++;
        if (productGroup && productGroup !== '–í—Å–µ') {
          workTypeStats.productGroups.add(productGroup);
        }
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          directionStats[direction].departments[department].totalUnits += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          directionStats[direction].departments[department].totalTime += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        }
        directionStats[direction].departments[department].totalAmount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          directionStats[direction].totalUnits += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          directionStats[direction].totalTime += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        }
        directionStats[direction].totalAmount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });
      let html = '';
      if (unclassifiedWorkTypes.size > 0) {
        html += `
          <div class="warning-note">
            <strong>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:</strong> –°–ª–µ–¥—É—é—â–∏–µ –≤–∏–¥—ã —Ä–∞–±–æ—Ç –Ω–µ –ø–æ–∫–∞–∑–∞–Ω—ã –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ, 
            —Ç–∞–∫ –∫–∞–∫ —É –Ω–∏—Ö –Ω–µ —É–∫–∞–∑–∞–Ω—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–¥–µ–ª: 
            <strong>${Array.from(unclassifiedWorkTypes).join(', ')}</strong>
          </div>
        `;
      }
      Object.entries(directionStats).forEach(([direction, dirStats]) => {
        html += `
          <div class="direction-group">
            <div class="direction-header" onclick="toggleDirection('${direction}')">
              <h4 class="direction-title">
                <span class="toggle-icon">‚ñ∂</span> ${direction}
                <span style="font-size: 14px; color: #666; margin-left: 10px;">
                  (${dirStats.totalUnits} –µ–¥. | ${formatTime(dirStats.totalTime)} | ${formatCurrency(dirStats.totalAmount)})
                </span>
              </h4>
            </div>
            <div class="direction-content">
        `;
        Object.entries(dirStats.departments).forEach(([department, deptStats]) => {
          html += `
            <div class="department-group">
              <div class="department-subheader" onclick="toggleDepartment('${direction}', '${department}')">
                <h5 class="department-subtitle">
                  <span class="toggle-icon">‚ñ∂</span> ${department}
                  <span style="font-size: 12px; color: #666; margin-left: 10px;">
                    (${deptStats.totalUnits} –µ–¥. | ${formatTime(deptStats.totalTime)} | ${formatCurrency(deptStats.totalAmount)})
                  </span>
                </h5>
              </div>
              <div class="department-content" id="dept-${direction}-${department}">
                <div class="work-types-grid">
          `;
          Object.entries(deptStats.workTypes).forEach(([workType, stats]) => {
            const totalHours = stats.totalTime / 3600;
            const normative = totalHours > 0 ? stats.totalUnits / totalHours : 0;
            const revenuePerHour = totalHours > 0 ? stats.totalAmount / totalHours : 0;
            const costPerUnit = stats.totalUnits > 0 ? stats.totalAmount / stats.totalUnits : 0;
            let performanceClass = 'performance-poor';
            let performanceText = '–ù–∏–∑–∫–∞—è';
            if (stats.standard > 0) {
              const percentage = (normative / stats.standard) * 100;
              if (percentage >= 90) {
                performanceClass = 'performance-good';
                performanceText = '–í—ã—Å–æ–∫–∞—è';
              } else if (percentage >= 70) {
                performanceClass = 'performance-average';
                performanceText = '–°—Ä–µ–¥–Ω—è—è';
              }
              performanceText += ` (${percentage.toFixed(0)}%)`;
            }
            html += `
              <div class="work-type-card" onclick="showWorkTypeDetails('${workType}', '${selectedDate}')">
                <div class="work-type-header">
                  <h4 class="work-type-name">${workType}</h4>
                  <div class="${performanceClass} performance-indicator">
                    ${performanceText}
                  </div>
                </div>
                <div class="work-type-stats">
                  <div class="stat-item">
                    <div class="stat-value">${stats.totalUnits}</div>
                    <div class="stat-label">–ï–¥–∏–Ω–∏—Ü</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">${stats.tasks}</div>
                    <div class="stat-label">–ó–∞–¥–∞—á</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">${stats.brigades.size}</div>
                    <div class="stat-label">–ë—Ä–∏–≥–∞–¥</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">${formatTime(stats.totalTime)}</div>
                    <div class="stat-label">–í—Ä–µ–º—è</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">${normative.toFixed(1)}</div>
                    <div class="stat-label">–ù–æ—Ä–º–∞—Ç–∏–≤</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">${formatCurrency(stats.totalAmount)}</div>
                    <div class="stat-label">–†–∞—Å—Ö–æ–¥—ã</div>
                  </div>
                </div>
                <div style="margin-top: 10px; font-size: 11px; color: #666;">
                  ${stats.standard > 0 ? `–ü–ª–∞–Ω: ${stats.standard} —à—Ç/—á–∞—Å | ` : ''}
                  –†–∞—Å—Ö–æ–¥—ã –Ω–∞ –µ–¥.: —Ä.${costPerUnit.toFixed(2)} | 
                  –†–∞—Å—Ö–æ–¥—ã/—á–∞—Å: ${formatCurrency(revenuePerHour)} | 
                  –ì—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤: ${stats.productGroups.size}
                </div>
              </div>
            `;
          });
          html += `
                </div>
              </div>
            </div>
          `;
        });
        html += `
            </div>
          </div>
        `;
      });
      document.getElementById('work-types-content').innerHTML = html;
    }
    function renderCombinedAnalytics(allRecords, responsibleRecords) {
      let totalUnits = 0, totalTimeSec = 0, totalTasks = 0, totalAmount = 0;
      const uniqueResponsibles = [...new Set(responsibleRecords.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))];
      responsibleRecords.forEach(r => {
        totalUnits += parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        totalTimeSec += parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        totalTasks++;
      });
      allRecords.forEach(r => {
        totalAmount += parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });
      const factNormative = calculateNormative(totalUnits, totalTimeSec);
      const totalHours = totalTimeSec / 3600;
      const avgRevenuePerHour = totalHours > 0 ? totalAmount / totalHours : 0;
      const costPerUnit = totalUnits > 0 ? totalAmount / totalUnits : 0;
      const uniqueWorkTypes = [...new Set(allRecords.map(r => r['–í–∏–¥ —Ä–∞–±–æ—Ç']))].filter(Boolean);
      const uniqueBrigades = [...new Set(responsibleRecords.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))];
      const uniqueDepartments = [...new Set(allRecords.map(r => r['–û—Ç–¥–µ–ª']))].filter(Boolean);
      const staffAnalysis = analyzeStaffForRecords(allRecords);
      const timesheetTime = calculateTimesheetTime(allRecords);
      let html = `
        <div class="analytics-grid">
          <div class="analytics-card">
            <h4>üì¶ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</h4>
            <div class="analytics-value">${totalUnits}</div>
            <p class="analytics-label">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –µ–¥–∏–Ω–∏—Ü</p>
            <div class="analytics-value">${totalTasks}</div>
            <p class="analytics-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á</p>
            <div class="analytics-value">${uniqueBrigades.length}</div>
            <p class="analytics-label">–†–∞–±–æ—Ç–∞–ª–æ –±—Ä–∏–≥–∞–¥</p>
          </div>
          <div class="analytics-card">
            <h4>‚ö° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h4>
            <div class="analytics-value">${factNormative.toFixed(1)}</div>
            <p class="analytics-label">–ù–æ—Ä–º–∞—Ç–∏–≤ (—à—Ç/—á–∞—Å)</p>
            <div class="analytics-value">${formatTime(totalTimeSec)}</div>
            <p class="analytics-label">–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</p>
            <div class="analytics-value">${formatTime(timesheetTime)}</div>
            <p class="analytics-label">–í—Ä–µ–º—è –ø–æ —Ç–∞–±–µ–ª—é</p>
          </div>
          <div class="analytics-card">
            <h4>üí∞ –†–∞—Å—Ö–æ–¥—ã</h4>
            <div class="analytics-value">${formatCurrency(totalAmount)}</div>
            <p class="analytics-label">–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</p>
            <div class="analytics-value">—Ä.${costPerUnit.toFixed(2)}</div>
            <p class="analytics-label">–†–∞—Å—Ö–æ–¥—ã –Ω–∞ 1 –µ–¥.</p>
            <div class="analytics-value">${formatCurrency(avgRevenuePerHour)}</div>
            <p class="analytics-label">–†–∞—Å—Ö–æ–¥—ã –≤ —á–∞—Å</p>
          </div>
          <div class="analytics-card">
            <h4>üë• –ü–µ—Ä—Å–æ–Ω–∞–ª</h4>
            <div class="analytics-value">${staffAnalysis.total}</div>
            <p class="analytics-label">–í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
            <div class="analytics-value">${staffAnalysis.permanent}</div>
            <p class="analytics-label">–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ</p>
            <div class="analytics-value">${staffAnalysis.hired}</div>
            <p class="analytics-label">–ù–∞–µ–º–Ω—ã–µ</p>
            <div class="analytics-value">${formatTime(staffAnalysis.totalWorkTime)}</div>
            <p class="analytics-label">–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</p>
            <div style="font-size: 11px; color: #666; margin-top: 5px;">
              –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ: ${formatTime(staffAnalysis.permanentWorkTime)}<br>
              –ù–∞–µ–º–Ω—ã–µ: ${formatTime(staffAnalysis.hiredWorkTime)}
            </div>
          </div>
          <div class="analytics-card">
            <h4>üè¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∞</h4>
            <div class="analytics-value">${uniqueDepartments.length}</div>
            <p class="analytics-label">–û—Ç–¥–µ–ª–æ–≤</p>
            <div class="analytics-value">${uniqueWorkTypes.length}</div>
            <p class="analytics-label">–í–∏–¥–æ–≤ —Ä–∞–±–æ—Ç</p>
          </div>
        </div>
      `;
      html += renderComparisonAnalytics(selectedDate);
      document.getElementById('combined-content').innerHTML = html;
    }
    function renderCharts(allRecords, responsibleRecords) {
      const workTypeData = {};
      const timeDistribution = {};
      const departmentData = {};
      const costDistribution = {};
      responsibleRecords.forEach(record => {
        const workType = record['–í–∏–¥ —Ä–∞–±–æ—Ç'] || '–ë–µ–∑ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç';
        if (!workTypeData[workType]) {
          workTypeData[workType] = {
            units: 0,
            time: 0,
            amount: 0
          };
        }
        workTypeData[workType].units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        workTypeData[workType].time += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        workTypeData[workType].amount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });
      responsibleRecords.forEach(record => {
        const interval = getHourIntervalForWorkDay(record['–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏'], selectedDate);
        if (!interval) return;
        if (!timeDistribution[interval.key]) {
          timeDistribution[interval.key] = {
            interval: interval,
            units: 0,
            tasks: 0
          };
        }
        timeDistribution[interval.key].units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        timeDistribution[interval.key].tasks++;
      });
      responsibleRecords.forEach(record => {
        const department = record['–û—Ç–¥–µ–ª'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        if (!departmentData[department]) {
          departmentData[department] = {
            units: 0,
            time: 0,
            amount: 0
          };
        }
        departmentData[department].units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        departmentData[department].time += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        departmentData[department].amount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });
      responsibleRecords.forEach(record => {
        const workType = record['–í–∏–¥ —Ä–∞–±–æ—Ç'] || '–ë–µ–∑ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç';
        if (!costDistribution[workType]) {
          costDistribution[workType] = 0;
        }
        costDistribution[workType] += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });
      let html = `
        <div class="charts-grid">
          <div class="chart-container">
            <h4 class="chart-title">üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç</h4>
            <div class="chart-real">
              ${renderWorkTypeChart(workTypeData)}
            </div>
          </div>
          <div class="chart-container">
            <h4 class="chart-title">‚è∞ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫</h4>
            <div class="chart-real">
              ${renderTimeDistributionChart(timeDistribution)}
            </div>
          </div>
          <div class="chart-container">
            <h4 class="chart-title">üè¢ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ç–¥–µ–ª–æ–≤</h4>
            <div class="chart-real">
              ${renderDepartmentChart(departmentData)}
            </div>
          </div>
          <div class="chart-container">
            <h4 class="chart-title">üí∞ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</h4>
            <div class="chart-real">
              ${renderCostDistributionChart(costDistribution)}
            </div>
          </div>
        </div>
      `;
      document.getElementById('charts-content').innerHTML = html;
    }
    function renderWorkTypeCharts(allRecords, responsibleRecords) {
  const workTypeTimeStats = {};
  allRecords.forEach(record => {
    if (!isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) return;
    const workType = record['–í–∏–¥ —Ä–∞–±–æ—Ç'] || '–ë–µ–∑ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç';
    if (!workTypeTimeStats[workType]) {
      workTypeTimeStats[workType] = {
        totalUnits: 0,
        timeIntervals: {}
      };
    }
    workTypeTimeStats[workType].totalUnits += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
  });
  allRecords.forEach(record => {
    if (!isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) return;
    const workType = record['–í–∏–¥ —Ä–∞–±–æ—Ç'] || '–ë–µ–∑ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç';
    const interval = getHourIntervalForWorkDay(record['–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏'], selectedDate);
    if (!interval) return;
    if (!workTypeTimeStats[workType].timeIntervals[interval.key]) {
      workTypeTimeStats[workType].timeIntervals[interval.key] = {
        interval: interval,
        units: 0
      };
    }
    workTypeTimeStats[workType].timeIntervals[interval.key].units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
  });

  let html = '<div class="charts-grid">';
  Object.entries(workTypeTimeStats).forEach(([workType, stats]) => {
    if (stats.totalUnits === 0) return;
    const sortedIntervals = Object.values(stats.timeIntervals).sort((a, b) => a.interval.sortKey - b.interval.sortKey);
    const maxUnits = Math.max(...sortedIntervals.map(timeStat => timeStat.units));

    html += `
      <div class="chart-container">
        <h4 class="chart-title">${chartLabels.workTypes[workType] || workType}</h4>
        <div class="chart-real">
          <div class="chart-bar">
    `;
    sortedIntervals.forEach(timeStat => {
      const heightPercent = maxUnits > 0 ? (timeStat.units / maxUnits) * 100 : 0;
      const percentage = (timeStat.units / stats.totalUnits) * 100;
      html += `
        <div class="chart-bar-item" 
             style="height: ${heightPercent}%; background-color: ${getWorkTypeColor(workType)}"
             title="${timeStat.interval.display}: ${timeStat.units} –µ–¥. (${percentage.toFixed(1)}%)">
        </div>
      `;
    });
    html += `
          </div>
          <!-- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö –ü–û–î–ü–ò–°–ï–ô -->
          <div class="chart-bar-labels" style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 10px; color: #666; text-align: center;">
    `;
    sortedIntervals.forEach(timeStat => {
      const label = timeStat.interval.shortDisplay; // –ò—Å–ø–æ–ª—å–∑—É–µ–º shortDisplay –¥–ª—è —á–∏—Å—Ç–æ–π –º–µ—Ç–∫–∏
      html += `<div style="flex: 1; min-width: 0; word-break: break-all;">${label}</div>`;
    });
    html += `
          </div>
          <div style="text-align: center; font-size: 11px; color: #666; margin-top: 5px;">
            –í—Å–µ–≥–æ: ${stats.totalUnits} –µ–¥.
          </div>
        </div>
      </div>
    `;
  });
  html += '</div>';
  document.getElementById('work-type-charts-content').innerHTML = html;
}
    function renderWorkTypeChart(workTypeData) {
      const sortedWorkTypes = Object.entries(workTypeData)
        .sort((a, b) => b[1].units - a[1].units)
        .slice(0, 8);
      const maxUnits = Math.max(...sortedWorkTypes.map(([_, data]) => data.units));
      let html = '<div class="chart-bar">';
      sortedWorkTypes.forEach(([workType, data]) => {
        const heightPercent = maxUnits > 0 ? (data.units / maxUnits) * 100 : 0;
        const normative = data.time > 0 ? calculateNormative(data.units, data.time) : 0;
        const displayName = chartLabels.workTypes[workType] || workType;
        const shortName = displayName.length > 12 ? displayName.substring(0, 10) + '...' : displayName;
        html += `
          <div class="chart-bar-item" 
               style="height: ${heightPercent}%; background-color: ${getWorkTypeColor(workType)}"
               title="${displayName}: ${data.units} –µ–¥. (${normative.toFixed(1)} —à—Ç/—á–∞—Å)">
          </div>
        `;
      });
      html += '</div><div class="chart-bar-labels">';
      sortedWorkTypes.forEach(([workType, data]) => {
        const displayName = chartLabels.workTypes[workType] || workType;
        const shortName = displayName.length > 12 ? displayName.substring(0, 10) + '...' : displayName;
        html += `<div class="chart-bar-label">${shortName}</div>`;
      });
      html += '</div>';
      return html;
    }
    function renderTimeDistributionChart(timeDistribution) {
  const sortedIntervals = Object.values(timeDistribution)
    .sort((a, b) => a.interval.sortKey - b.interval.sortKey);
  const maxUnits = Math.max(...sortedIntervals.map(stats => stats.units));
  let html = '<div class="chart-bar">';
  sortedIntervals.forEach(stats => {
    const heightPercent = maxUnits > 0 ? (stats.units / maxUnits) * 100 : 0;
    const color = stats.interval.isNight ? '#5c6bc0' : '#2196f3';
    html += `
      <div class="chart-bar-item" 
           style="height: ${heightPercent}%; background-color: ${color}"
           title="${stats.interval.display}: ${stats.units} –µ–¥.">
      </div>
    `;
  });
  html += `
  </div>
  <!-- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö –ü–û–î–ü–ò–°–ï–ô -->
  <div class="chart-bar-labels" style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 10px; color: #666; text-align: center;">
  `;
  sortedIntervals.forEach(stats => {
    const label = stats.interval.shortDisplay; // –ò—Å–ø–æ–ª—å–∑—É–µ–º shortDisplay –¥–ª—è —á–∏—Å—Ç–æ–π –º–µ—Ç–∫–∏
    html += `<div style="flex: 1; min-width: 0; word-break: break-all;">${label}</div>`;
  });
  html += `
  </div>
  `;
  return html;
}
    function renderDepartmentChart(departmentData) {
      const sortedDepartments = Object.entries(departmentData)
        .filter(([dept]) => dept !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ')
        .sort((a, b) => {
          const normativeA = a[1].time > 0 ? calculateNormative(a[1].units, a[1].time) : 0;
          const normativeB = b[1].time > 0 ? calculateNormative(b[1].units, b[1].time) : 0;
          return normativeB - normativeA;
        })
        .slice(0, 6);
      const maxNormative = Math.max(...sortedDepartments.map(([_, data]) => {
        return data.time > 0 ? calculateNormative(data.units, data.time) : 0;
      }));
      let html = '<div class="chart-bar">';
      sortedDepartments.forEach(([department, data]) => {
        const normative = data.time > 0 ? calculateNormative(data.units, data.time) : 0;
        const heightPercent = maxNormative > 0 ? (normative / maxNormative) * 100 : 0;
        const displayName = chartLabels.departments[department] || department;
        const shortName = displayName.length > 10 ? displayName.substring(0, 8) + '...' : displayName;
        html += `
          <div class="chart-bar-item" 
               style="height: ${heightPercent}%; background-color: #4caf50"
               title="${displayName}: ${normative.toFixed(1)} —à—Ç/—á–∞—Å">
          </div>
        `;
      });
      html += '</div><div class="chart-bar-labels">';
      sortedDepartments.forEach(([department, data]) => {
        const displayName = chartLabels.departments[department] || department;
        const shortName = displayName.length > 10 ? displayName.substring(0, 8) + '...' : displayName;
        const normative = data.time > 0 ? calculateNormative(data.units, data.time) : 0;
        html += `<div class="chart-bar-label" title="${normative.toFixed(1)} —à—Ç/—á–∞—Å">${shortName}</div>`;
      });
      html += '</div>';
      return html;
    }
    function renderCostDistributionChart(costDistribution) {
      const sortedCosts = Object.entries(costDistribution)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);
      const totalCost = sortedCosts.reduce((sum, [_, amount]) => sum + amount, 0);
      let html = '<div class="chart-pie">';
      let currentAngle = 0;
      const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
      sortedCosts.forEach(([workType, amount], index) => {
        const percentage = totalCost > 0 ? (amount / totalCost) * 100 : 0;
        const angle = (percentage / 100) * 360;
        const color = colors[index % colors.length];
        const displayName = chartLabels.costDistribution[workType] || workType;
        html += `
          <div style="
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(
              ${color} ${currentAngle}deg ${currentAngle + angle}deg,
              transparent ${currentAngle + angle}deg 360deg
            );
          "></div>
        `;
        currentAngle += angle;
      });
      html += '</div><div class="chart-legend">';
      sortedCosts.forEach(([workType, amount], index) => {
        const percentage = totalCost > 0 ? (amount / totalCost) * 100 : 0;
        const displayName = chartLabels.costDistribution[workType] || workType;
        const shortName = displayName.length > 20 ? displayName.substring(0, 18) + '...' : displayName;
        html += `
          <div class="chart-legend-item">
            <div class="legend-color" style="background-color: ${colors[index % colors.length]}"></div>
            <span>${shortName}</span>
          </div>
        `;
      });
      html += '</div>';
      return html;
    }
    function renderComparisonAnalytics(currentDate) {
      const currentDateObj = parseDate(currentDate);
      const previousDates = [];
      for (let i = 1; i <= 7; i++) {
        const date = new Date(currentDateObj);
        date.setDate(currentDateObj.getDate() - i);
        const dateStr = formatDate(date);
        previousDates.push({ date: dateStr, records: records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === dateStr) });
      }
      const currentDayRecords = records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === currentDate);
      const currentResponsibleRecords = currentDayRecords.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
      let currentUnits = 0, currentTime = 0, currentAmount = 0;
      currentResponsibleRecords.forEach(r => {
        currentUnits += parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        currentTime += parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
      });
      currentDayRecords.forEach(r => {
        currentAmount += parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });
      const currentNormative = calculateNormative(currentUnits, currentTime);
      const currentCostPerUnit = currentUnits > 0 ? currentAmount / currentUnits : 0;
      let html = '<h4 style="margin: 20px 0 15px 0; color: #333;">üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –¥–Ω—è–º–∏</h4><div class="comparison-grid">';
      const previousUnits = previousDates.map(d => {
        const respRecords = d.records.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
        return respRecords.reduce((sum, r) => sum + (parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0), 0);
      }).filter(val => val > 0);
      const avgUnits = previousUnits.length > 0 ? previousUnits.reduce((a, b) => a + b) / previousUnits.length : 0;
      const unitsTrend = currentUnits - avgUnits;
      const unitsPercent = avgUnits > 0 ? ((unitsTrend / avgUnits) * 100).toFixed(1) : 0;
      const unitsIsGood = unitsTrend >= 0;
      html += `
        <div class="comparison-card">
          <h4>üì¶ –ï–¥–∏–Ω–∏—Ü—ã</h4>
          <div class="analytics-value">${currentUnits}</div>
          <p class="analytics-label">–°–µ–≥–æ–¥–Ω—è</p>
          <div class="analytics-value ${unitsIsGood ? 'trend-up' : 'trend-down'}">
            ${unitsIsGood ? '‚Üó' : '‚Üò'} ${Math.abs(unitsPercent)}%
          </div>
          <p class="analytics-label">–°—Ä–µ–¥–Ω–µ–µ: ${avgUnits.toFixed(0)}</p>
        </div>
      `;
      const previousNorms = previousDates.map(d => {
        const respRecords = d.records.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
        const units = respRecords.reduce((sum, r) => sum + (parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0), 0);
        const time = respRecords.reduce((sum, r) => sum + parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']), 0);
        return calculateNormative(units, time);
      }).filter(val => val > 0);
      const avgNorm = previousNorms.length > 0 ? previousNorms.reduce((a, b) => a + b) / previousNorms.length : 0;
      const normTrend = currentNormative - avgNorm;
      const normPercent = avgNorm > 0 ? ((normTrend / avgNorm) * 100).toFixed(1) : 0;
      const normIsGood = normTrend >= 0;
      html += `
        <div class="comparison-card">
          <h4>‚ö° –ù–æ—Ä–º–∞—Ç–∏–≤</h4>
          <div class="analytics-value">${currentNormative.toFixed(1)}</div>
          <p class="analytics-label">–°–µ–≥–æ–¥–Ω—è (—à—Ç/—á–∞—Å)</p>
          <div class="analytics-value ${normIsGood ? 'trend-up' : 'trend-down'}">
            ${normIsGood ? '‚Üó' : '‚Üò'} ${Math.abs(normPercent)}%
          </div>
          <p class="analytics-label">–°—Ä–µ–¥–Ω–µ–µ: ${avgNorm.toFixed(1)}</p>
        </div>
      `;
      const previousAmounts = previousDates.map(d => 
        d.records.reduce((sum, r) => sum + parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']), 0)
      ).filter(val => val > 0);
      const avgAmount = previousAmounts.length > 0 ? previousAmounts.reduce((a, b) => a + b) / previousAmounts.length : 0;
      const amountTrend = currentAmount - avgAmount;
      const amountPercent = avgAmount > 0 ? ((amountTrend / avgAmount) * 100).toFixed(1) : 0;
      const amountIsGood = amountTrend < 0;
      const previousCosts = previousDates.map(d => {
        const respRecords = d.records.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
        const units = respRecords.reduce((sum, r) => sum + (parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0), 0);
        const amount = d.records.reduce((sum, r) => sum + parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']), 0);
        return units > 0 ? amount / units : 0;
      }).filter(val => val > 0);
      const avgCost = previousCosts.length > 0 ? previousCosts.reduce((a, b) => a + b) / previousCosts.length : 0;
      const costTrend = currentCostPerUnit - avgCost;
      const costPercent = avgCost > 0 ? ((costTrend / avgCost) * 100).toFixed(1) : 0;
      const costIsGood = costTrend < 0;
      html += `
        <div class="comparison-card">
          <h4>üí∞ –†–∞—Å—Ö–æ–¥—ã</h4>
          <div class="analytics-value">${formatCurrency(currentAmount)}</div>
          <p class="analytics-label">–°–µ–≥–æ–¥–Ω—è</p>
          <div class="analytics-value ${amountIsGood ? 'trend-up' : 'trend-down'}">
            ${amountIsGood ? '‚Üó' : '‚Üò'} ${Math.abs(amountPercent)}%
          </div>
          <p class="analytics-label">–°—Ä–µ–¥–Ω–µ–µ: ${formatCurrency(avgAmount)}</p>
        </div>
        <div class="comparison-card">
          <h4>üíµ –†–∞—Å—Ö–æ–¥—ã –Ω–∞ –µ–¥.</h4>
          <div class="analytics-value">—Ä.${currentCostPerUnit.toFixed(2)}</div>
          <p class="analytics-label">–°–µ–≥–æ–¥–Ω—è</p>
          <div class="analytics-value ${costIsGood ? 'trend-up' : 'trend-down'}">
            ${costIsGood ? '‚Üó' : '‚Üò'} ${Math.abs(costPercent)}%
          </div>
          <p class="analytics-label">–°—Ä–µ–¥–Ω–µ–µ: —Ä.${avgCost.toFixed(2)}</p>
        </div>
      `;
      html += '</div>';
      return html;
    }
    function toggleDirection(direction) {
      let directionEl = null;
      document.querySelectorAll('.direction-title').forEach(el => {
        if (el.textContent.includes(direction)) {
          directionEl = el.closest('.direction-group');
        }
      });
      if (!directionEl) return;
      const content = directionEl.querySelector('.direction-content');
      const icon = directionEl.querySelector('.toggle-icon');
      if (!content.style.display || content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '‚ñº';
      } else {
        content.style.display = 'none';
        icon.textContent = '‚ñ∂';
      }
    }
    function toggleDepartment(direction, department) {
      const deptContent = document.getElementById(`dept-${direction}-${department}`);
      if (!deptContent) return;
      const departmentEl = deptContent.closest('.department-group');
      const icon = departmentEl.querySelector('.toggle-icon');
      if (!deptContent.style.display || deptContent.style.display === 'none') {
        deptContent.style.display = 'block';
        icon.textContent = '‚ñº';
      } else {
        deptContent.style.display = 'none';
        icon.textContent = '‚ñ∂';
      }
    }
    function selectDepartment(department) {
      selectedDepartment = department;
      const allRecords = records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === selectedDate);
      renderLevel2Analytics(allRecords);
    }
    function showWorkTypeDetails(workType, date) {
      const allRecords = records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === date && r['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType);
      const responsibleRecords = allRecords.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
      let totalUnits = 0, totalTime = 0, totalAmount = 0, totalTasks = 0;
      responsibleRecords.forEach(r => {
        totalUnits += parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        totalTime += parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        totalTasks++;
      });
      allRecords.forEach(r => {
        totalAmount += parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });
      const normative = calculateNormative(totalUnits, totalTime);
      const costPerUnit = totalUnits > 0 ? totalAmount / totalUnits : 0;
      const standard = getStandardForWork(workType);
      const { direction, department } = getDirectionAndDepartment(workType);
      const brigades = [...new Set(responsibleRecords.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))];
      const productGroups = [...new Set(allRecords.map(r => r['–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞']))];
      const supplies = [...new Set(allRecords.map(r => r['–ü–æ—Å—Ç–∞–≤–∫–∞']))];
      let html = `
        <h3>üîç –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –≤–∏–¥—É —Ä–∞–±–æ—Ç: ${workType}</h3>
        <p><strong>–î–∞—Ç–∞:</strong> ${date}</p>
        <p><strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> ${direction} | <strong>–û—Ç–¥–µ–ª:</strong> ${department}</p>
        <div class="analytics-grid" style="margin: 15px 0;">
          <div class="analytics-card">
            <h4>üìä –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h4>
            <div class="analytics-value">${totalUnits}</div>
            <p class="analytics-label">–í—Å–µ–≥–æ –µ–¥–∏–Ω–∏—Ü</p>
            <div class="analytics-value">${totalTasks}</div>
            <p class="analytics-label">–ó–∞–¥–∞—á</p>
            <div class="analytics-value">${brigades.length}</div>
            <p class="analytics-label">–ë—Ä–∏–≥–∞–¥</p>
          </div>
          <div class="analytics-card">
            <h4>‚ö° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h4>
            <div class="analytics-value">${normative.toFixed(1)}</div>
            <p class="analytics-label">–ù–æ—Ä–º–∞—Ç–∏–≤ (—à—Ç/—á–∞—Å)</p>
            <div class="analytics-value">${formatTime(totalTime)}</div>
            <p class="analytics-label">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</p>
            <div class="analytics-value">${(totalTime / 3600).toFixed(1)}</div>
            <p class="analytics-label">–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ —á–∞—Å–æ–≤</p>
          </div>
          <div class="analytics-card>
            <h4>üí∞ –†–∞—Å—Ö–æ–¥—ã</h4>
            <div class="analytics-value">${formatCurrency(totalAmount)}</div>
            <p class="analytics-label">–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</p>
            <div class="analytics-value">—Ä.${costPerUnit.toFixed(2)}</div>
            <p class="analytics-label">–†–∞—Å—Ö–æ–¥—ã –Ω–∞ 1 –µ–¥.</p>
            <div class="analytics-value">${formatCurrency(totalAmount / (totalTime / 3600))}</div>
            <p class="analytics-label">–†–∞—Å—Ö–æ–¥—ã –≤ —á–∞—Å</p>
          </div>
        </div>
        ${standard > 0 ? `
        <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; margin: 15px 0;">
          <h4>üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞</h4>
          <div style="display: flex; align-items: center; gap: 15px;">
            <div style="flex: 1; background: #e0e0e0; border-radius: 10px; height: 20px;">
              <div style="background: #4caf50; height: 100%; border-radius: 10px; width: ${Math.min((normative / standard) * 100, 100)}%;"></div>
            </div>
            <div style="font-weight: bold;">
              ${((normative / standard) * 100).toFixed(1)}%
            </div>
          </div>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            –§–∞–∫—Ç: ${normative.toFixed(1)} —à—Ç/—á–∞—Å | –ü–ª–∞–Ω: ${standard} —à—Ç/—á–∞—Å
          </div>
        </div>
        ` : ''}
        <h4>üë• –†–∞–±–æ—Ç–∞ –±—Ä–∏–≥–∞–¥</h4>
        <div class="grouping-grid">
      `;
      const brigadeStats = {};
      responsibleRecords.forEach(record => {
        const brigade = record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        const supply = record['–ü–æ—Å—Ç–∞–≤–∫–∞'] || '–ë–µ–∑ –ø–æ—Å—Ç–∞–≤–∫–∏';
        if (!brigadeStats[brigade]) {
          brigadeStats[brigade] = {
            units: 0,
            time: 0,
            tasks: 0,
            amount: 0,
            supplies: {}
          };
        }
        brigadeStats[brigade].units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        brigadeStats[brigade].time += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        brigadeStats[brigade].tasks++;
        brigadeStats[brigade].amount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        if (!brigadeStats[brigade].supplies[supply]) {
          brigadeStats[brigade].supplies[supply] = {
            units: 0,
            time: 0,
            helpers: []
          };
        }
        brigadeStats[brigade].supplies[supply].units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        brigadeStats[brigade].supplies[supply].time += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        const supplyRecords = allRecords.filter(r => 
          r['–ü–æ—Å—Ç–∞–≤–∫–∞'] === supply && 
          r['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType &&
          !isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])
        );
        supplyRecords.forEach(helperRecord => {
          if (!brigadeStats[brigade].supplies[supply].helpers.find(h => h.name === helperRecord['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'])) {
            brigadeStats[brigade].supplies[supply].helpers.push({
              name: helperRecord['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'],
              role: helperRecord['–î–æ–ª–∂–Ω–æ—Å—Ç—å'] || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'
            });
          }
        });
      });
      Object.entries(brigadeStats).forEach(([brigade, stats]) => {
        const brigadeNormative = stats.time > 0 ? calculateNormative(stats.units, stats.time) : 0;
        const brigadeCostPerUnit = stats.units > 0 ? stats.amount / stats.units : 0;
        html += `
          <div class="group-card">
            <h5>${brigade}</h5>
            <div class="group-stats">
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.units}</div>
                <div class="group-stat-label">–ï–¥–∏–Ω–∏—Ü</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.tasks}</div>
                <div class="group-stat-label">–ó–∞–¥–∞—á</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${brigadeNormative.toFixed(1)}</div>
                <div class="group-stat-label">–ù–æ—Ä–º–∞—Ç–∏–≤</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">—Ä.${brigadeCostPerUnit.toFixed(2)}</div>
                <div class="group-stat-label">–†–∞—Å—Ö–æ–¥—ã –Ω–∞ –µ–¥.</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${formatTime(stats.time)}</div>
                <div class="group-stat-label">–í—Ä–µ–º—è</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${formatCurrency(stats.amount)}</div>
                <div class="group-stat-label">–†–∞—Å—Ö–æ–¥—ã</div>
              </div>
            </div>
            <div style="margin-top: 10px;">
              <h6>–ü–æ—Å—Ç–∞–≤–∫–∏:</h6>
              ${Object.entries(stats.supplies).map(([supply, supplyData]) => `
                <div class="supply-details-expanded">
                  <div class="supply-header">${supply} (${supplyData.units} –µ–¥. | ${formatTime(supplyData.time)})</div>
                  ${supplyData.helpers.length > 0 ? `
                    <div class="helper-list">
                      <strong>–ü–æ–º–æ—â–Ω–∏–∫–∏:</strong>
                      ${supplyData.helpers.map(helper => `
                        <div class="helper-item">
                          <span class="helper-name">${helper.name}</span>
                          <span class="helper-role">${helper.role}</span>
                        </div>
                      `).join('')}
                    </div>
                  ` : '<div style="font-size: 11px; color: #999;">–ù–µ—Ç –ø–æ–º–æ—â–Ω–∏–∫–æ–≤</div>'}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });
      html += `</div>`;
      document.getElementById('worktype-modal-content').innerHTML = html;
      document.getElementById('worktype-modal').style.display = 'block';
    }
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    function exportToExcel() {
      alert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ');
    }
    document.addEventListener('DOMContentLoaded', function() {
      currentArchive = getArchiveNameForDate(new Date());
      loadData();
    });
  </script>
</body>
</html>
