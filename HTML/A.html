<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      background: #f9f9f9;
      color: #333;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 10px;
    }
    .version {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }
    .last-updated {
      text-align: center;
      font-size: 13px;
      color: #555;
      margin-bottom: 15px;
      font-style: italic;
    }
    .selected-date {
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      color: #1976d2;
      margin: 15px 0;
      padding: 10px;
      background: #e3f2fd;
      border-radius: 6px;
    }
    .calendar-container {
      margin: 15px 0;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .calendar-title {
      font-size: 18px;
      font-weight: bold;
      margin: 0 10px;
      text-align: center;
    }
    .calendar-nav-btn {
      background: #2196f3;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      min-width: 100px;
      text-align: center;
      font-weight: bold;
    }
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .calendar-day-header {
      text-align: center;
      font-weight: bold;
      padding: 8px;
      background: #f0f0f0;
      border-radius: 4px;
    }
    .calendar-day {
      text-align: center;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .calendar-day.has-data {
      background: #2196f3;
      color: white;
    }
    .calendar-day.selected {
      background: #ff9800;
      color: white;
      font-weight: bold;
    }
    .calendar-day.disabled {
      color: #aaa;
      cursor: not-allowed;
    }
    .toggle-icon {
      display: inline-block;
      width: 16px;
      text-align: center;
      margin-right: 6px;
    }
    .hidden {
      display: none;
    }
    .loading {
      text-align: center;
      color: #666;
      padding: 20px;
    }
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ò–ù–î–ò–ö–ê–¢–û–†–ê –ó–ê–ì–†–£–ó–ö–ò */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2196f3;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-progress {
      background: linear-gradient(90deg, #2196f3, #1976d2);
      height: 3px;
      width: 0%;
      transition: width 0.3s ease;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
    }
    
    .loading-dots:after {
      content: '';
      animation: dots 1.5s steps(5, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò */
    .analytics-section {
      margin-top: 20px;
      padding: 20px;
      background: #fff3e0;
      border-radius: 8px;
      border-left: 4px solid #ff9800;
    }
    
    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .analytics-title {
      font-size: 18px;
      font-weight: bold;
      color: #e65100;
      margin: 0;
    }
    
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .analytics-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 3px solid #2196f3;
    }
    
    .analytics-card h4 {
      margin: 0 0 10px 0;
      color: #1976d2;
      font-size: 14px;
    }
    
    .analytics-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin: 5px 0;
    }
    
    .analytics-label {
      font-size: 12px;
      color: #666;
      margin: 0;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –°–†–ê–í–ù–ï–ù–ò–Ø –° –ü–†–ï–î–´–î–£–©–ò–ú–ò –î–ù–Ø–ú–ò */
    .comparison-section {
      margin-top: 20px;
      padding: 20px;
      background: #e8f5e9;
      border-radius: 8px;
      border-left: 4px solid #4caf50;
    }
    
    .comparison-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .comparison-title {
      font-size: 18px;
      font-weight: bold;
      color: #2e7d32;
      margin: 0;
    }
    
    .comparison-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .comparison-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .comparison-card h4 {
      margin: 0 0 10px 0;
      color: #388e3c;
      font-size: 14px;
    }
    
    .trend-up {
      color: #4caf50;
    }
    
    .trend-down {
      color: #f44336;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ü–û –í–†–ï–ú–ï–ù–ò –°–£–¢–û–ö */
    .time-statistics {
      margin-top: 20px;
      padding: 20px;
      background: #f3e5f5;
      border-radius: 8px;
      border-left: 4px solid #9c27b0;
    }
    
    .time-statistics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .time-statistics-title {
      font-size: 18px;
      font-weight: bold;
      color: #7b1fa2;
      margin: 0;
    }
    
    .time-chart {
      margin-top: 15px;
    }
    
    .time-bar {
      display: flex;
      align-items: center;
      margin: 8px 0;
      height: 25px;
    }
    
    .time-label {
      width: 100px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .time-bar-inner {
      flex: 1;
      height: 15px;
      background: #e1bee7;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .time-bar-fill {
      height: 100%;
      border-radius: 8px;
      background: linear-gradient(90deg, #ab47bc, #8e24aa);
    }
    
    .time-value {
      width: 100px;
      text-align: right;
      font-size: 12px;
      font-weight: bold;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ì–†–£–ü–ü–ò–†–û–í–û–ö */
    .grouping-section {
      margin-top: 20px;
      padding: 20px;
      background: #e3f2fd;
      border-radius: 8px;
      border-left: 4px solid #1976d2;
    }
    
    .grouping-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .grouping-title {
      font-size: 18px;
      font-weight: bold;
      color: #0d47a1;
      margin: 0;
    }
    
    .grouping-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .group-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-left: 4px solid #2196f3;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .group-card:hover {
      transform: translateY(-2px);
    }
    
    .group-card h4 {
      margin: 0 0 10px 0;
      color: #1976d2;
      font-size: 14px;
    }
    
    .group-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }
    
    .group-stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 6px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    
    .group-stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    
    .group-stat-label {
      font-size: 10px;
      color: #666;
      text-align: center;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò –ü–û –í–ò–î–ê–ú –†–ê–ë–û–¢ */
    .work-types-analytics {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #17a2b8;
    }
    
    .work-types-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }
    
    .work-types-title {
      font-size: 18px;
      font-weight: bold;
      color: #0c5460;
      margin: 0;
    }
    
    .work-types-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .work-type-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-left: 4px solid #17a2b8;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .work-type-card:hover {
      transform: translateY(-2px);
    }
    
    .work-type-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .work-type-name {
      font-size: 16px;
      font-weight: bold;
      color: #495057;
      margin: 0;
    }
    
    .work-type-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }
    
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    .stat-label {
      font-size: 11px;
      color: #666;
      text-align: center;
    }
    
    .performance-indicator {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
      font-size: 12px;
    }
    
    .performance-good {
      background: #d4edda;
      color: #155724;
    }
    
    .performance-average {
      background: #fff3cd;
      color: #856404;
    }
    
    .performance-poor {
      background: #f8d7da;
      color: #721c24;
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–ò */
    .detail-section {
      margin: 10px 0;
      padding: 15px;
      background: #f1f8e9;
      border-radius: 6px;
      border-left: 3px solid #7cb342;
    }
    
    .hour-group, .brigade-group {
      margin: 10px 0;
      padding: 10px;
      background: #e8f5e8;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .brigade-group {
      background: #f3e5f5;
      margin-left: 20px;
    }
    
    .supply-details {
      margin-left: 40px;
      padding: 8px;
      background: #fff3e0;
      border-radius: 4px;
      margin-top: 5px;
    }

    .night-interval {
      background: #5c6bc0 !important;
      color: white;
    }
  </style>
</head>
<body>
  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
  <div id="loading-progress" class="loading-progress"></div>

  <div class="container">
    <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç</h2>
    <div class="version">v 11.01-2303 <span>üïí</span></div>
    <div class="last-updated" id="last-updated">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ‚Äî</div>

    <div id="selected-date" class="selected-date hidden">
      üìÖ –î–∞–Ω–Ω—ã–µ –∑–∞: <span id="current-date"></span>
    </div>

    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö<span class="loading-dots"></span></span>
    </div>
    <div id="error" class="error hidden"></div>

    <div id="controls" class="hidden">
      <!-- –ö–ê–õ–ï–ù–î–ê–†–¨ -->
      <div class="calendar-container">
        <div class="calendar-header">
          <button class="calendar-nav-btn" id="prev-month">‚óÄ –ù–∞–∑–∞–¥</button>
          <div class="calendar-title" id="calendar-title">–û–∫—Ç—è–±—Ä—å 2025</div>
          <button class="calendar-nav-btn" id="next-month">–í–ø–µ—Ä—ë–¥ ‚ñ∂</button>
        </div>
        <div class="calendar-days" id="calendar-days">
          <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
        </div>
      </div>

      <!-- –£–†–û–í–ï–ù–¨ 1: –†–£–ö–û–í–û–î–ò–¢–ï–õ–¨ –ü–†–ï–î–ü–†–ò–Ø–¢–ò–Ø -->
      <div id="level-1" class="hidden">
        <!-- üìä –û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å -->
        <div id="analytics" class="analytics-section">
          <div class="analytics-header" id="analytics-toggle">
            <h3 class="analytics-title">üìä –û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å</h3>
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div id="analytics-content">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
          </div>
        </div>

        <!-- üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –¥–Ω—è–º–∏ -->
        <div id="comparison" class="comparison-section">
          <div class="comparison-header" id="comparison-toggle">
            <h3 class="comparison-title">üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –¥–Ω—è–º–∏</h3>
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div id="comparison-content">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è -->
          </div>
        </div>

        <!-- ‚è∞ –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ -->
        <div id="time-statistics" class="time-statistics">
          <div class="time-statistics-header" id="time-statistics-toggle">
            <h3 class="time-statistics-title">‚è∞ –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h3>
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div id="time-statistics-content">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ -->
          </div>
        </div>

        <!-- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º -->
        <div id="directions-stats" class="grouping-section">
          <div class="grouping-header" id="directions-toggle">
            <h3 class="grouping-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º</h3>
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div id="directions-content">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º -->
          </div>
        </div>

        <!-- üèõÔ∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º -->
        <div id="departments-stats" class="grouping-section">
          <div class="grouping-header" id="departments-toggle">
            <h3 class="grouping-title">üèõÔ∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º</h3>
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div id="departments-content">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ –æ—Ç–¥–µ–ª–∞–º -->
          </div>
        </div>
      </div>

      <!-- –£–†–û–í–ï–ù–¨ 2: –ù–ê–ß–ê–õ–¨–ù–ò–ö –°–ú–ï–ù–´ -->
      <div id="level-2" class="hidden">
        <div id="directions-analytics" class="grouping-section">
          <div class="grouping-header" id="directions-analytics-toggle">
            <h3 class="grouping-title">üéØ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º (–ù–∞—á–∞–ª—å–Ω–∏–∫ —Å–º–µ–Ω—ã)</h3>
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div id="directions-analytics-content">
            <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º -->
          </div>
        </div>
      </div>

      <!-- –£–†–û–í–ï–ù–¨ 3: –†–£–ö–û–í–û–î–ò–¢–ï–õ–¨ –û–¢–î–ï–õ–ê -->
      <div id="level-3" class="hidden">
        <div id="departments-analytics" class="grouping-section">
          <div class="grouping-header" id="departments-analytics-toggle">
            <h3 class="grouping-title">üëî –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º (–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞)</h3>
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div id="departments-analytics-content">
            <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º -->
          </div>
        </div>
      </div>

      <!-- –£–†–û–í–ï–ù–¨ 4: –ë–†–ò–ì–ê–î–ò–† -->
      <div id="level-4" class="hidden">
        <div id="work-types-analytics" class="work-types-analytics">
          <div class="work-types-header" id="work-types-toggle">
            <h3 class="work-types-title">üîç –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç (–ë—Ä–∏–≥–∞–¥–∏—Ä)</h3>
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div id="work-types-content">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç -->
          </div>
        </div>
      </div>

      <!-- –ö–ù–û–ü–ö–ê –≠–ö–°–ü–û–†–¢–ê -->
      <button id="export-excel" style="margin-top: 20px;">üìä –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
    </div>
  </div>

  <script>
    // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    function parseTime(timeStr) {
      if (!timeStr) return 0;
      const parts = timeStr.split(':').map(Number);
      if (parts.length !== 3) return 0;
      const [h, m, s] = parts;
      return (h || 0) * 3600 + (m || 0) * 60 + (s || 0);
    }

    function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    function parseCurrency(str) {
      if (!str || typeof str !== 'string') return 0;
      let clean = str.trim().replace(/^—Ä\.\s*/i, '');
      clean = clean.replace(',', '.');
      const num = parseFloat(clean);
      return isNaN(num) ? 0 : num;
    }

    function getHourFromTime(timeStr) {
      if (!timeStr) return null;
      const [h] = timeStr.split(':');
      return parseInt(h) || 0;
    }

    function isResponsible(position) {
      return position === '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π' || position === '–û—Ç–≤–µ—Ç—Å–≤–µ–Ω–Ω—ã–π';
    }

    function formatDateTime(date) {
      return new Intl.DateTimeFormat('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      }).format(date);
    }

    function calculateNormative(units, seconds) {
      if (seconds <= 0) return 0;
      const hours = seconds / 3600;
      return units / hours;
    }

    function parseDate(dateStr) {
      const [day, month, year] = dateStr.split('.').map(Number);
      return new Date(year, month - 1, day);
    }

    function formatDate(date) {
      return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
    }

    // === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ê–†–•–ò–í–û–í ===
    function getArchiveNameForDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      return `${year}-${month}`;
    }

    function getArchiveUrl(archiveName) {
      const encodedName = encodeURIComponent(`${archiveName} fullData.json`);
      return `${window.location.origin}/archive/${encodedName}`;
    }

    // === –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ß–ê–°–û–í–´–• –ò–ù–¢–ï–†–í–ê–õ–û–í ===
    function getHourIntervalForWorkDay(timeStr, workDate) {
      if (!timeStr) return null;
      
      const hour = getHourFromTime(timeStr);
      if (hour === null) return null;
      
      if (hour < 9) {
        const nightHour = hour + 24;
        const endHour = nightHour + 1;
        return {
          key: `${String(hour).padStart(2, '0')}-${String(endHour - 24).padStart(2, '0')}`,
          display: `${String(hour).padStart(2, '0')}-${String(endHour - 24).padStart(2, '0')} (–Ω–æ—á—å)`,
          isNight: true,
          sortKey: nightHour
        };
      } else {
        const endHour = hour + 1;
        return {
          key: `${String(hour).padStart(2, '0')}-${String(endHour).padStart(2, '0')}`,
          display: `${String(hour).padStart(2, '0')}-${String(endHour).padStart(2, '0')}`,
          isNight: false,
          sortKey: hour
        };
      }
    }

    // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
    let records = [];
    let standards = [];
    let selectedDate = '';
    let allWorkTypes = [];
    let currentMonth = new Date();
    currentMonth.setDate(1);

    let currentArchive = null;
    let uiInitialized = false;

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const controlsDiv = document.getElementById('controls');
    const selectedDateDiv = document.getElementById('selected-date');
    const currentDateSpan = document.getElementById('current-date');
    const lastUpdatedDiv = document.getElementById('last-updated');
    const exportExcelBtn = document.getElementById('export-excel');
    const calendarTitle = document.getElementById('calendar-title');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const calendarDaysContainer = document.getElementById('calendar-days');
    const loadingProgress = document.getElementById('loading-progress');

    // === –§–£–ù–ö–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò ===
    function updateProgress(percent) {
      if (loadingProgress) {
        loadingProgress.style.width = percent + '%';
      }
    }

    async function loadStandards() {
      const standardsUrl = `${window.location.origin}/archive/standard%20fullData.json`;
      
      try {
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ –∏–∑:', standardsUrl);
        const response = await fetch(`${standardsUrl}?t=${Date.now()}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status} - ${response.statusText}`);
        }
        
        const data = await response.json();
        if (Array.isArray(data.records)) {
          standards = data.records.filter(record => 
            isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å']) && record['–ù–æ—Ä–º–∞—Ç–∏–≤ 1']
          );
          console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤:', standards.length);
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤:', err);
        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã
        standards = [
          {
            "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–í—Ö–æ–¥—è—â–∏–µ",
            "–û—Ç–¥–µ–ª": "–ü—Ä–∏–µ–º–∫–∞",
            "–í–∏–¥ —Ä–∞–±–æ—Ç": "–†–∞–∑–≥—Ä—É–∑–∫–∞",
            "–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞": "–í—Å–µ",
            "–ù–æ—Ä–º–∞—Ç–∏–≤ 1": "120"
          },
          {
            "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–í—Ö–æ–¥—è—â–∏–µ",
            "–û—Ç–¥–µ–ª": "–ü—Ä–∏–µ–º–∫–∞", 
            "–í–∏–¥ —Ä–∞–±–æ—Ç": "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞",
            "–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞": "–í—Å–µ",
            "–ù–æ—Ä–º–∞—Ç–∏–≤ 1": "80"
          },
          {
            "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": "–ò—Å—Ö–æ–¥—è—â–∏–µ",
            "–û—Ç–¥–µ–ª": "–û—Ç–≥—Ä—É–∑–∫–∞",
            "–í–∏–¥ —Ä–∞–±–æ—Ç": "–ü–æ–≥—Ä—É–∑–∫–∞",
            "–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞": "–í—Å–µ",
            "–ù–æ—Ä–º–∞—Ç–∏–≤ 1": "100"
          }
        ];
      }
    }

    function getStandardForWork(workType, productGroup = null) {
      if (productGroup) {
        const specificStandard = standards.find(standard =>
          standard['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType &&
          standard['–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞'] === productGroup
        );
        if (specificStandard) return parseFloat(specificStandard['–ù–æ—Ä–º–∞—Ç–∏–≤ 1']);
      }
      
      const generalStandard = standards.find(standard =>
        standard['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType
      );
      
      return generalStandard ? parseFloat(generalStandard['–ù–æ—Ä–º–∞—Ç–∏–≤ 1']) : 0;
    }

    function getDirectionAndDepartment(workType) {
      const standard = standards.find(s => s['–í–∏–¥ —Ä–∞–±–æ—Ç'] === workType);
      return {
        direction: standard?.['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
        department: standard?.['–û—Ç–¥–µ–ª'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
      };
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    function createTestData() {
      console.log('–°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...');
      const testRecords = [];
      const workTypes = ['–ü–æ–≥—Ä—É–∑–∫–∞', '–†–∞–∑–≥—Ä—É–∑–∫–∞', '–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞', '–£–ø–∞–∫–æ–≤–∫–∞'];
      const employees = ['–ò–≤–∞–Ω–æ–≤ –ò.–ò.', '–ü–µ—Ç—Ä–æ–≤ –ü.–ü.', '–°–∏–¥–æ—Ä–æ–≤ –°.–°.'];
      const productGroups = ['–î–∏—Å–∫–∏', '–®–∏–Ω—ã', '–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã'];
      
      const today = new Date();
      
      for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
        const date = new Date(today);
        date.setDate(today.getDate() - dayOffset);
        const dateStr = formatDate(date);
        
        for (let i = 0; i < 20; i++) {
          const workType = workTypes[i % workTypes.length];
          const { direction, department } = getDirectionAndDepartment(workType);
          
          testRecords.push({
            '–†–∞–±–æ—á–∏–π –¥–µ–Ω—å': dateStr,
            '–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏': `${8 + (i % 10)}:${String(i % 60).padStart(2, '0')}:00`,
            '–í–∏–¥ —Ä–∞–±–æ—Ç': workType,
            '–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞': productGroups[i % productGroups.length],
            '–î–æ–ª–∂–Ω–æ—Å—Ç—å': i % 3 === 0 ? '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π' : '–ü–æ–º–æ—â–Ω–∏–∫',
            '–°–æ—Ç—Ä—É–¥–Ω–∏–∫': employees[i % employees.length],
            '–ü–æ—Å—Ç–∞–≤–∫–∞': `–ü–æ—Å—Ç–∞–≤–∫–∞ ${Math.floor(i / 3) + 1}`,
            '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü': (Math.random() * 100 + 50).toFixed(0),
            '–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è': '01:00:00',
            '–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞': `—Ä.${(Math.random() * 1000 + 500).toFixed(2)}`,
            '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': direction,
            '–û—Ç–¥–µ–ª': department
          });
        }
      }
      
      return testRecords;
    }

    async function loadData() {
      if (!currentArchive) {
        currentArchive = getArchiveNameForDate(new Date());
      }

      const url = getArchiveUrl(currentArchive);
      
      try {
        loadingDiv.classList.remove('hidden');
        errorDiv.classList.add('hidden');
        controlsDiv.classList.add('hidden');
        updateProgress(10);

        await Promise.all([loadStandards()]);

        loadingDiv.innerHTML = `
          <div class="loading-spinner"></div>
          <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞—Ä—Ö–∏–≤–∞ ${currentArchive}<span class="loading-dots"></span></span>
        `;

        console.log('–ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑:', url);
        const urlWithCacheBust = `${url}?t=${Date.now()}`;
        updateProgress(30);
        
        const response = await fetch(urlWithCacheBust);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status} - ${response.statusText}`);
        }
        
        updateProgress(60);
        const data = await response.json();
        
        if (!Array.isArray(data.records)) {
          throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
        }
        
        updateProgress(80);
        records = data.records;
        records.forEach(record => {
          const { direction, department } = getDirectionAndDepartment(record['–í–∏–¥ —Ä–∞–±–æ—Ç']);
          record['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] = direction;
          record['–û—Ç–¥–µ–ª'] = department;
        });
        
        allWorkTypes = [...new Set(records.map(r => r['–í–∏–¥ —Ä–∞–±–æ—Ç']).filter(Boolean))].sort();
        lastUpdatedDiv.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${formatDateTime(new Date())} | –ê—Ä—Ö–∏–≤: ${currentArchive} | –ù–æ—Ä–º–∞—Ç–∏–≤–æ–≤: ${standards.length}`;
        
        updateProgress(100);
        setTimeout(() => {
          initUI();
          updateProgress(0);
        }, 500);
        
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:', err);
        
        records = createTestData();
        allWorkTypes = [...new Set(records.map(r => r['–í–∏–¥ —Ä–∞–±–æ—Ç']).filter(Boolean))].sort();
        lastUpdatedDiv.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${formatDateTime(new Date())} | –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï | –ù–æ—Ä–º–∞—Ç–∏–≤–æ–≤: ${standards.length}`;
        
        errorDiv.textContent = `‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ${err.message}. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.`;
        errorDiv.classList.remove('hidden');
        
        updateProgress(100);
        setTimeout(() => {
          initUI();
          updateProgress(0);
        }, 500);
      }
    }

    // === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    function initUI() {
      loadingDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');
      controlsDiv.classList.remove('hidden');

      renderCalendar();

      if (!uiInitialized) {
        setupEventListeners();
        uiInitialized = true;
      }

      const uniqueDates = [...new Set(records.map(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å']))].filter(Boolean).sort();
      if (uniqueDates.length > 0 && !selectedDate) {
        selectedDate = uniqueDates[0];
        renderReport();
      }
    }

    function setupEventListeners() {
      exportExcelBtn.addEventListener('click', exportToExcel);

      prevMonthBtn.addEventListener('click', () => {
        currentMonth.setMonth(currentMonth.getMonth() - 1);
        const targetArchive = getArchiveNameForDate(currentMonth);
        if (currentArchive !== targetArchive) {
          currentArchive = targetArchive;
          selectedDate = '';
          loadData();
        } else {
          renderCalendar();
        }
      });

      nextMonthBtn.addEventListener('click', () => {
        currentMonth.setMonth(currentMonth.getMonth() + 1);
        const targetArchive = getArchiveNameForDate(currentMonth);
        if (currentArchive !== targetArchive) {
          currentArchive = targetArchive;
          selectedDate = '';
          loadData();
        } else {
          renderCalendar();
        }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Å–µ–∫—Ü–∏–π
      setupToggleHandler('analytics-toggle', 'analytics-content');
      setupToggleHandler('comparison-toggle', 'comparison-content');
      setupToggleHandler('time-statistics-toggle', 'time-statistics-content');
      setupToggleHandler('directions-toggle', 'directions-content');
      setupToggleHandler('departments-toggle', 'departments-content');
      setupToggleHandler('directions-analytics-toggle', 'directions-analytics-content');
      setupToggleHandler('departments-analytics-toggle', 'departments-analytics-content');
      setupToggleHandler('work-types-toggle', 'work-types-content');
    }

    function setupToggleHandler(toggleId, contentId) {
      const toggle = document.getElementById(toggleId);
      const content = document.getElementById(contentId);
      if (toggle && content) {
        toggle.addEventListener('click', function() {
          const icon = this.querySelector('.toggle-icon');
          if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            icon.textContent = '‚ñº';
          } else {
            content.classList.add('hidden');
            icon.textContent = '‚ñ∂';
          }
        });
      }
    }

    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      const monthNames = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
      calendarTitle.textContent = `${monthNames[month]} ${year}`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const firstDayOfWeek = firstDay.getDay();

      calendarDaysContainer.innerHTML = '';
      const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
      dayNames.forEach(name => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = name;
        calendarDaysContainer.appendChild(header);
      });

      for (let i = 0; i < (firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1); i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day disabled';
        calendarDaysContainer.appendChild(empty);
      }

      const availableDates = new Set(records.map(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å']));
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${String(day).padStart(2, '0')}.${String(month + 1).padStart(2, '0')}.${year}`;
        const hasData = availableDates.has(dateStr);
        const dayEl = document.createElement('div');
        dayEl.className = `calendar-day${hasData ? ' has-data' : ''}${dateStr === selectedDate ? ' selected' : ''}`;
        dayEl.textContent = day;
        if (hasData) {
          dayEl.addEventListener('click', () => {
            selectedDate = dateStr;
            renderReport();
          });
        } else {
          dayEl.classList.add('disabled');
        }
        calendarDaysContainer.appendChild(dayEl);
      }

      const lastDayOfWeek = lastDay.getDay();
      const remaining = 6 - (lastDayOfWeek === 0 ? 6 : lastDayOfWeek - 1);
      for (let i = 0; i < remaining; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day disabled';
        calendarDaysContainer.appendChild(empty);
      }
    }

    function renderReport() {
      if (!selectedDate) {
        selectedDateDiv.classList.add('hidden');
        hideAllLevels();
        return;
      }

      const allRecords = records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === selectedDate);
      
      if (allRecords.length === 0) {
        selectedDateDiv.classList.add('hidden');
        hideAllLevels();
        return;
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É
      selectedDateDiv.classList.remove('hidden');
      currentDateSpan.textContent = selectedDate;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —É—Ä–æ–≤–Ω–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
      showAllLevels();

      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –¥–ª—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π
      renderLevel1Analytics(allRecords);
      renderLevel2Analytics(allRecords);
      renderLevel3Analytics(allRecords);
      renderLevel4Analytics(allRecords);
    }

    function hideAllLevels() {
      document.getElementById('level-1').classList.add('hidden');
      document.getElementById('level-2').classList.add('hidden');
      document.getElementById('level-3').classList.add('hidden');
      document.getElementById('level-4').classList.add('hidden');
    }

    function showAllLevels() {
      document.getElementById('level-1').classList.remove('hidden');
      document.getElementById('level-2').classList.remove('hidden');
      document.getElementById('level-3').classList.remove('hidden');
      document.getElementById('level-4').classList.remove('hidden');
    }

    function renderLevel1Analytics(allRecords) {
      const responsibleRecords = allRecords.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
      
      // üìä –û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å
      renderGeneralAnalytics(allRecords, responsibleRecords);
      
      // üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –¥–Ω—è–º–∏
      renderComparisonAnalytics(selectedDate);
      
      // ‚è∞ –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
      renderOverallTimeStatistics(allRecords);
      
      // üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º
      renderDirectionsStatistics(allRecords);
      
      // üèõÔ∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º
      renderDepartmentsStatistics(allRecords);
    }

    function renderGeneralAnalytics(allRecords, responsibleRecords) {
      let totalUnits = 0, totalTimeSec = 0, totalTasks = 0, totalAmount = 0;
      const uniqueResponsibles = [...new Set(responsibleRecords.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))];

      responsibleRecords.forEach(r => {
        totalUnits += parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        totalTimeSec += parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        totalTasks++;
      });

      allRecords.forEach(r => {
        totalAmount += parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });

      const factNormative = calculateNormative(totalUnits, totalTimeSec);
      const totalHours = totalTimeSec / 3600;
      const avgRevenuePerHour = totalHours > 0 ? totalAmount / totalHours : 0;
      const uniqueWorkTypes = [...new Set(allRecords.map(r => r['–í–∏–¥ —Ä–∞–±–æ—Ç']))].filter(Boolean);
      const uniqueBrigades = [...new Set(responsibleRecords.map(r => r['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))];
      const uniqueDirections = [...new Set(allRecords.map(r => r['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']))].filter(Boolean);
      const uniqueDepartments = [...new Set(allRecords.map(r => r['–û—Ç–¥–µ–ª']))].filter(Boolean);
      
      let html = `
        <div class="analytics-grid">
          <div class="analytics-card">
            <h4>üì¶ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</h4>
            <div class="analytics-value">${totalUnits}</div>
            <p class="analytics-label">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –µ–¥–∏–Ω–∏—Ü</p>
            
            <div class="analytics-value">${totalTasks}</div>
            <p class="analytics-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á</p>
          </div>

          <div class="analytics-card">
            <h4>‚ö° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h4>
            <div class="analytics-value">${factNormative.toFixed(1)}</div>
            <p class="analytics-label">–ù–æ—Ä–º–∞—Ç–∏–≤ (—à—Ç/—á–∞—Å)</p>
            
            <div class="analytics-value">${formatTime(totalTimeSec)}</div>
            <p class="analytics-label">–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</p>
          </div>

          <div class="analytics-card">
            <h4>üí∞ –§–∏–Ω–∞–Ω—Å—ã</h4>
            <div class="analytics-value">—Ä.${totalAmount.toFixed(0)}</div>
            <p class="analytics-label">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</p>
            
            <div class="analytics-value">—Ä.${avgRevenuePerHour.toFixed(2)}</div>
            <p class="analytics-label">–í—ã—Ä—É—á–∫–∞ –≤ —á–∞—Å</p>
          </div>

          <div class="analytics-card">
            <h4>üë• –ü–µ—Ä—Å–æ–Ω–∞–ª</h4>
            <div class="analytics-value">${uniqueBrigades.length}</div>
            <p class="analytics-label">–†–∞–±–æ—Ç–∞–ª–æ –±—Ä–∏–≥–∞–¥</p>
            
            <div class="analytics-value">${allRecords.length}</div>
            <p class="analytics-label">–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π</p>
          </div>

          <div class="analytics-card">
            <h4>üè¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∞</h4>
            <div class="analytics-value">${uniqueDirections.length}</div>
            <p class="analytics-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π</p>
            
            <div class="analytics-value">${uniqueDepartments.length}</div>
            <p class="analytics-label">–û—Ç–¥–µ–ª–æ–≤</p>
          </div>

          <div class="analytics-card">
            <h4>üîß –í–∏–¥—ã —Ä–∞–±–æ—Ç</h4>
            <div class="analytics-value">${uniqueWorkTypes.length}</div>
            <p class="analytics-label">–í–∏–¥–æ–≤ —Ä–∞–±–æ—Ç</p>
            
            <div class="analytics-value">-</div>
            <p class="analytics-label">–ì—Ä—É–ø–ø —Ç–æ–≤–∞—Ä–æ–≤</p>
          </div>
        </div>
      `;
      
      document.getElementById('analytics-content').innerHTML = html;
    }

    function renderComparisonAnalytics(currentDate) {
      const currentDateObj = parseDate(currentDate);
      const previousDates = [];
      
      for (let i = 1; i <= 7; i++) {
        const date = new Date(currentDateObj);
        date.setDate(currentDateObj.getDate() - i);
        const dateStr = formatDate(date);
        previousDates.push({ date: dateStr, records: records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === dateStr) });
      }

      const currentDayRecords = records.filter(r => r['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === currentDate);
      const currentResponsibleRecords = currentDayRecords.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
      
      let currentUnits = 0, currentTime = 0, currentAmount = 0;
      currentResponsibleRecords.forEach(r => {
        currentUnits += parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
        currentTime += parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
      });
      currentDayRecords.forEach(r => {
        currentAmount += parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
      });

      const currentNormative = calculateNormative(currentUnits, currentTime);

      let html = '<div class="comparison-grid">';
      
      const previousUnits = previousDates.map(d => {
        const respRecords = d.records.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
        return respRecords.reduce((sum, r) => sum + (parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0), 0);
      }).filter(val => val > 0);
      
      const avgUnits = previousUnits.length > 0 ? previousUnits.reduce((a, b) => a + b) / previousUnits.length : 0;
      const unitsTrend = currentUnits - avgUnits;
      const unitsPercent = avgUnits > 0 ? ((unitsTrend / avgUnits) * 100).toFixed(1) : 0;
      
      html += `
        <div class="comparison-card">
          <h4>üì¶ –ï–¥–∏–Ω–∏—Ü—ã</h4>
          <div class="analytics-value">${currentUnits}</div>
          <p class="analytics-label">–°–µ–≥–æ–¥–Ω—è</p>
          <div class="analytics-value ${unitsTrend >= 0 ? 'trend-up' : 'trend-down'}">
            ${unitsTrend >= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(unitsPercent)}%
          </div>
          <p class="analytics-label">–°—Ä–µ–¥–Ω–µ–µ: ${avgUnits.toFixed(0)}</p>
        </div>
      `;

      const previousNorms = previousDates.map(d => {
        const respRecords = d.records.filter(r => isResponsible(r['–î–æ–ª–∂–Ω–æ—Å—Ç—å']));
        const units = respRecords.reduce((sum, r) => sum + (parseInt(r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0), 0);
        const time = respRecords.reduce((sum, r) => sum + parseTime(r['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']), 0);
        return calculateNormative(units, time);
      }).filter(val => val > 0);
      
      const avgNorm = previousNorms.length > 0 ? previousNorms.reduce((a, b) => a + b) / previousNorms.length : 0;
      const normTrend = currentNormative - avgNorm;
      const normPercent = avgNorm > 0 ? ((normTrend / avgNorm) * 100).toFixed(1) : 0;
      
      html += `
        <div class="comparison-card">
          <h4>‚ö° –ù–æ—Ä–º–∞—Ç–∏–≤</h4>
          <div class="analytics-value">${currentNormative.toFixed(1)}</div>
          <p class="analytics-label">–°–µ–≥–æ–¥–Ω—è (—à—Ç/—á–∞—Å)</p>
          <div class="analytics-value ${normTrend >= 0 ? 'trend-up' : 'trend-down'}">
            ${normTrend >= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(normPercent)}%
          </div>
          <p class="analytics-label">–°—Ä–µ–¥–Ω–µ–µ: ${avgNorm.toFixed(1)}</p>
        </div>
      `;

      const previousAmounts = previousDates.map(d => 
        d.records.reduce((sum, r) => sum + parseCurrency(r['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']), 0)
      ).filter(val => val > 0);
      
      const avgAmount = previousAmounts.length > 0 ? previousAmounts.reduce((a, b) => a + b) / previousAmounts.length : 0;
      const amountTrend = currentAmount - avgAmount;
      const amountPercent = avgAmount > 0 ? ((amountTrend / avgAmount) * 100).toFixed(1) : 0;
      
      html += `
        <div class="comparison-card">
          <h4>üí∞ –í—ã—Ä—É—á–∫–∞</h4>
          <div class="analytics-value">—Ä.${currentAmount.toFixed(0)}</div>
          <p class="analytics-label">–°–µ–≥–æ–¥–Ω—è</p>
          <div class="analytics-value ${amountTrend >= 0 ? 'trend-up' : 'trend-down'}">
            ${amountTrend >= 0 ? '‚Üó' : '‚Üò'} ${Math.abs(amountPercent)}%
          </div>
          <p class="analytics-label">–°—Ä–µ–¥–Ω–µ–µ: —Ä.${avgAmount.toFixed(0)}</p>
        </div>
      `;

      html += '</div>';
      document.getElementById('comparison-content').innerHTML = html;
    }

    function renderOverallTimeStatistics(allRecords) {
      const timeStats = {};
      
      allRecords.forEach(record => {
        const interval = getHourIntervalForWorkDay(record['–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏'], selectedDate);
        if (!interval) return;
        
        if (!timeStats[interval.key]) {
          timeStats[interval.key] = {
            interval: interval,
            units: 0,
            amount: 0,
            tasks: 0,
            time: 0
          };
        }
        
        const stats = timeStats[interval.key];
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          stats.units += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          stats.time += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        }
        stats.amount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        stats.tasks++;
      });

      let html = '<div class="time-chart">';
      
      const sortedIntervals = Object.values(timeStats).sort((a, b) => a.interval.sortKey - b.interval.sortKey);
      const maxUnits = Math.max(...sortedIntervals.map(s => s.units));
      
      sortedIntervals.forEach(stats => {
        const unitsPercent = maxUnits > 0 ? (stats.units / maxUnits) * 100 : 0;
        const normative = stats.time > 0 ? calculateNormative(stats.units, stats.time) : 0;
        
        html += `
          <div class="time-bar">
            <div class="time-label">${stats.interval.display}</div>
            <div class="time-bar-inner">
              <div class="time-bar-fill" style="width: ${unitsPercent}%"></div>
            </div>
            <div class="time-value">
              ${stats.units} –µ–¥.
            </div>
          </div>
          <div style="font-size: 11px; color: #666; margin-left: 100px;">
            –ó–∞–¥–∞—á: ${stats.tasks} | –í—ã—Ä—É—á–∫–∞: —Ä.${stats.amount.toFixed(0)} | –ù–æ—Ä–º–∞—Ç–∏–≤: ${normative.toFixed(1)} —à—Ç/—á–∞—Å
          </div>
        `;
      });
      
      html += '</div>';
      document.getElementById('time-statistics-content').innerHTML = html;
    }

    function renderDirectionsStatistics(allRecords) {
      const directionStats = {};
      
      allRecords.forEach(record => {
        const direction = record['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        if (!directionStats[direction]) {
          directionStats[direction] = {
            totalUnits: 0,
            totalTime: 0,
            totalAmount: 0,
            tasks: 0,
            workTypes: new Set(),
            departments: new Set(),
            brigades: new Set()
          };
        }
        
        const stats = directionStats[direction];
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          stats.totalUnits += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          stats.totalTime += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        }
        stats.totalAmount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        stats.tasks++;
        stats.workTypes.add(record['–í–∏–¥ —Ä–∞–±–æ—Ç']);
        stats.departments.add(record['–û—Ç–¥–µ–ª']);
        if (record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']) {
          stats.brigades.add(record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']);
        }
      });

      let html = '<div class="grouping-grid">';
      
      Object.entries(directionStats).forEach(([direction, stats]) => {
        const totalHours = stats.totalTime / 3600;
        const normative = totalHours > 0 ? stats.totalUnits / totalHours : 0;
        const revenuePerHour = totalHours > 0 ? stats.totalAmount / totalHours : 0;
        
        html += `
          <div class="group-card">
            <h4>${direction}</h4>
            <div class="group-stats">
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.totalUnits}</div>
                <div class="group-stat-label">–ï–¥–∏–Ω–∏—Ü</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.tasks}</div>
                <div class="group-stat-label">–ó–∞–¥–∞—á</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.workTypes.size}</div>
                <div class="group-stat-label">–í–∏–¥–æ–≤ —Ä–∞–±–æ—Ç</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.departments.size}</div>
                <div class="group-stat-label">–û—Ç–¥–µ–ª–æ–≤</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.brigades.size}</div>
                <div class="group-stat-label">–ë—Ä–∏–≥–∞–¥</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${normative.toFixed(1)}</div>
                <div class="group-stat-label">–ù–æ—Ä–º–∞—Ç–∏–≤</div>
              </div>
            </div>
            <div style="margin-top: 8px; font-size: 11px; color: #666;">
              –í—ã—Ä—É—á–∫–∞: —Ä.${stats.totalAmount.toFixed(0)} | –í—ã—Ä—É—á–∫–∞/—á–∞—Å: —Ä.${revenuePerHour.toFixed(2)}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      document.getElementById('directions-content').innerHTML = html;
    }

    function renderDepartmentsStatistics(allRecords) {
      const departmentStats = {};
      
      allRecords.forEach(record => {
        const department = record['–û—Ç–¥–µ–ª'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        if (!departmentStats[department]) {
          departmentStats[department] = {
            totalUnits: 0,
            totalTime: 0,
            totalAmount: 0,
            tasks: 0,
            workTypes: new Set(),
            directions: new Set(),
            brigades: new Set()
          };
        }
        
        const stats = departmentStats[department];
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          stats.totalUnits += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          stats.totalTime += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        }
        stats.totalAmount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        stats.tasks++;
        stats.workTypes.add(record['–í–∏–¥ —Ä–∞–±–æ—Ç']);
        stats.directions.add(record['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']);
        if (record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']) {
          stats.brigades.add(record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']);
        }
      });

      let html = '<div class="grouping-grid">';
      
      Object.entries(departmentStats).forEach(([department, stats]) => {
        const totalHours = stats.totalTime / 3600;
        const normative = totalHours > 0 ? stats.totalUnits / totalHours : 0;
        const revenuePerHour = totalHours > 0 ? stats.totalAmount / totalHours : 0;
        
        html += `
          <div class="group-card">
            <h4>${department}</h4>
            <div class="group-stats">
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.totalUnits}</div>
                <div class="group-stat-label">–ï–¥–∏–Ω–∏—Ü</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.tasks}</div>
                <div class="group-stat-label">–ó–∞–¥–∞—á</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.workTypes.size}</div>
                <div class="group-stat-label">–í–∏–¥–æ–≤ —Ä–∞–±–æ—Ç</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.directions.size}</div>
                <div class="group-stat-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.brigades.size}</div>
                <div class="group-stat-label">–ë—Ä–∏–≥–∞–¥</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${normative.toFixed(1)}</div>
                <div class="group-stat-label">–ù–æ—Ä–º–∞—Ç–∏–≤</div>
              </div>
            </div>
            <div style="margin-top: 8px; font-size: 11px; color: #666;">
              –í—ã—Ä—É—á–∫–∞: —Ä.${stats.totalAmount.toFixed(0)} | –í—ã—Ä—É—á–∫–∞/—á–∞—Å: —Ä.${revenuePerHour.toFixed(2)}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      document.getElementById('departments-content').innerHTML = html;
    }

    function renderLevel2Analytics(allRecords) {
      // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞ —Å–º–µ–Ω—ã
      const directionStats = {};
      
      allRecords.forEach(record => {
        const direction = record['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        if (!directionStats[direction]) {
          directionStats[direction] = {
            totalUnits: 0,
            totalTime: 0,
            totalAmount: 0,
            tasks: 0,
            workTypes: new Set(),
            departments: new Set(),
            brigades: new Set(),
            records: []
          };
        }
        
        const stats = directionStats[direction];
        stats.records.push(record);
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          stats.totalUnits += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          stats.totalTime += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        }
        stats.totalAmount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        stats.tasks++;
        stats.workTypes.add(record['–í–∏–¥ —Ä–∞–±–æ—Ç']);
        stats.departments.add(record['–û—Ç–¥–µ–ª']);
        if (record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']) {
          stats.brigades.add(record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']);
        }
      });

      let html = '<div class="grouping-grid">';
      
      Object.entries(directionStats).forEach(([direction, stats]) => {
        const totalHours = stats.totalTime / 3600;
        const normative = totalHours > 0 ? stats.totalUnits / totalHours : 0;
        const revenuePerHour = totalHours > 0 ? stats.totalAmount / totalHours : 0;
        
        html += `
          <div class="group-card" onclick="showDirectionDetails('${direction}')">
            <h4>üéØ ${direction}</h4>
            <div class="group-stats">
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.totalUnits}</div>
                <div class="group-stat-label">–ï–¥–∏–Ω–∏—Ü</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.tasks}</div>
                <div class="group-stat-label">–ó–∞–¥–∞—á</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.workTypes.size}</div>
                <div class="group-stat-label">–í–∏–¥–æ–≤ —Ä–∞–±–æ—Ç</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.departments.size}</div>
                <div class="group-stat-label">–û—Ç–¥–µ–ª–æ–≤</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.brigades.size}</div>
                <div class="group-stat-label">–ë—Ä–∏–≥–∞–¥</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${normative.toFixed(1)}</div>
                <div class="group-stat-label">–ù–æ—Ä–º–∞—Ç–∏–≤</div>
              </div>
            </div>
            <div style="margin-top: 8px; font-size: 11px; color: #666;">
              –í—ã—Ä—É—á–∫–∞: —Ä.${stats.totalAmount.toFixed(0)} | –í—ã—Ä—É—á–∫–∞/—á–∞—Å: —Ä.${revenuePerHour.toFixed(2)}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      document.getElementById('directions-analytics-content').innerHTML = html;
    }

    function renderLevel3Analytics(allRecords) {
      // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º –¥–ª—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –æ—Ç–¥–µ–ª–∞
      const departmentStats = {};
      
      allRecords.forEach(record => {
        const department = record['–û—Ç–¥–µ–ª'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        if (!departmentStats[department]) {
          departmentStats[department] = {
            totalUnits: 0,
            totalTime: 0,
            totalAmount: 0,
            tasks: 0,
            workTypes: new Set(),
            directions: new Set(),
            brigades: new Set(),
            records: []
          };
        }
        
        const stats = departmentStats[department];
        stats.records.push(record);
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          stats.totalUnits += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          stats.totalTime += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
        }
        stats.totalAmount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        stats.tasks++;
        stats.workTypes.add(record['–í–∏–¥ —Ä–∞–±–æ—Ç']);
        stats.directions.add(record['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']);
        if (record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']) {
          stats.brigades.add(record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']);
        }
      });

      let html = '<div class="grouping-grid">';
      
      Object.entries(departmentStats).forEach(([department, stats]) => {
        const totalHours = stats.totalTime / 3600;
        const normative = totalHours > 0 ? stats.totalUnits / totalHours : 0;
        const revenuePerHour = totalHours > 0 ? stats.totalAmount / totalHours : 0;
        
        html += `
          <div class="group-card" onclick="showDepartmentDetails('${department}')">
            <h4>üëî ${department}</h4>
            <div class="group-stats">
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.totalUnits}</div>
                <div class="group-stat-label">–ï–¥–∏–Ω–∏—Ü</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.tasks}</div>
                <div class="group-stat-label">–ó–∞–¥–∞—á</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.workTypes.size}</div>
                <div class="group-stat-label">–í–∏–¥–æ–≤ —Ä–∞–±–æ—Ç</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.directions.size}</div>
                <div class="group-stat-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${stats.brigades.size}</div>
                <div class="group-stat-label">–ë—Ä–∏–≥–∞–¥</div>
              </div>
              <div class="group-stat-item">
                <div class="group-stat-value">${normative.toFixed(1)}</div>
                <div class="group-stat-label">–ù–æ—Ä–º–∞—Ç–∏–≤</div>
              </div>
            </div>
            <div style="margin-top: 8px; font-size: 11px; color: #666;">
              –í—ã—Ä—É—á–∫–∞: —Ä.${stats.totalAmount.toFixed(0)} | –í—ã—Ä—É—á–∫–∞/—á–∞—Å: —Ä.${revenuePerHour.toFixed(2)}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      document.getElementById('departments-analytics-content').innerHTML = html;
    }

    function renderLevel4Analytics(allRecords) {
      // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç –¥–ª—è –±—Ä–∏–≥–∞–¥–∏—Ä–∞
      const workTypeStats = {};
      
      allRecords.forEach(record => {
        const workType = record['–í–∏–¥ —Ä–∞–±–æ—Ç'] || '–ë–µ–∑ –≤–∏–¥–∞ —Ä–∞–±–æ—Ç';
        const productGroup = record['–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞'] || '–í—Å–µ';
        
        if (!workTypeStats[workType]) {
          workTypeStats[workType] = {
            totalUnits: 0,
            totalTime: 0,
            totalAmount: 0,
            tasks: 0,
            responsibleTasks: 0,
            brigades: new Set(),
            productGroups: new Set(),
            standard: getStandardForWork(workType, productGroup),
            records: []
          };
        }
        
        const stats = workTypeStats[workType];
        stats.records.push(record);
        
        if (isResponsible(record['–î–æ–ª–∂–Ω–æ—Å—Ç—å'])) {
          stats.totalUnits += parseInt(record['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü']) || 0;
          stats.totalTime += parseTime(record['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']);
          stats.responsibleTasks++;
          if (record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']) {
            stats.brigades.add(record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']);
          }
        }
        
        stats.totalAmount += parseCurrency(record['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']);
        stats.tasks++;
        if (productGroup && productGroup !== '–í—Å–µ') {
          stats.productGroups.add(productGroup);
        }
      });

      let html = '';
      
      html += '<div class="work-types-grid">';
      
      Object.entries(workTypeStats).forEach(([workType, stats]) => {
        const totalHours = stats.totalTime / 3600;
        const normative = totalHours > 0 ? stats.totalUnits / totalHours : 0;
        const revenuePerHour = totalHours > 0 ? stats.totalAmount / totalHours : 0;
        const avgRevenuePerTask = stats.tasks > 0 ? stats.totalAmount / stats.tasks : 0;
        
        let performanceClass = 'performance-poor';
        let performanceText = '–ù–∏–∑–∫–∞—è';
        if (stats.standard > 0) {
          const percentage = (normative / stats.standard) * 100;
          if (percentage >= 90) {
            performanceClass = 'performance-good';
            performanceText = '–í—ã—Å–æ–∫–∞—è';
          } else if (percentage >= 70) {
            performanceClass = 'performance-average';
            performanceText = '–°—Ä–µ–¥–Ω—è—è';
          }
          performanceText += ` (${percentage.toFixed(0)}%)`;
        }

        html += `
          <div class="work-type-card" onclick="showWorkTypeDetails('${workType}')">
            <div class="work-type-header">
              <h4 class="work-type-name">${workType}</h4>
              <div class="${performanceClass} performance-indicator">
                ${performanceText}
              </div>
            </div>
            
            <div class="work-type-stats">
              <div class="stat-item">
                <div class="stat-value">${stats.totalUnits}</div>
                <div class="stat-label">–ï–¥–∏–Ω–∏—Ü</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${stats.tasks}</div>
                <div class="stat-label">–ó–∞–¥–∞—á</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${stats.brigades.size}</div>
                <div class="stat-label">–ë—Ä–∏–≥–∞–¥</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${formatTime(stats.totalTime)}</div>
                <div class="stat-label">–í—Ä–µ–º—è</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${normative.toFixed(1)}</div>
                <div class="stat-label">–ù–æ—Ä–º–∞—Ç–∏–≤</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">—Ä.${stats.totalAmount.toFixed(0)}</div>
                <div class="stat-label">–°—É–º–º–∞</div>
              </div>
            </div>
            
            <div style="margin-top: 10px; font-size: 11px; color: #666;">
              ${stats.standard > 0 ? `–ü–ª–∞–Ω: ${stats.standard} —à—Ç/—á–∞—Å | ` : ''}
              –í—ã—Ä—É—á–∫–∞/—á–∞—Å: —Ä.${revenuePerHour.toFixed(2)} | 
              –ì—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤: ${stats.productGroups.size}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      document.getElementById('work-types-content').innerHTML = html;
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏)
    function showDirectionDetails(direction) {
      alert(`–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é: ${direction}\n\n–ó–¥–µ—Å—å –±—É–¥–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ –æ—Ç–¥–µ–ª–∞–º –∏ –≤–∏–¥–∞–º —Ä–∞–±–æ—Ç.`);
    }

    function showDepartmentDetails(department) {
      alert(`–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –æ—Ç–¥–µ–ª—É: ${department}\n\n–ó–¥–µ—Å—å –±—É–¥–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –æ—Ç–¥–µ–ª—É —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ –±—Ä–∏–≥–∞–¥–∞–º –∏ –ø–æ—Å—Ç–∞–≤–∫–∞–º.`);
    }

    function showWorkTypeDetails(workType) {
      alert(`–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –≤–∏–¥—É —Ä–∞–±–æ—Ç: ${workType}\n\n–ó–¥–µ—Å—å –±—É–¥–µ—Ç:\n- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —á–∞—Å–æ–≤—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º\n- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –±—Ä–∏–≥–∞–¥–∞–º\n- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ø–æ—Å—Ç–∞–≤–∫–∞–º\n- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥—Ä—É–ø–ø–∞–º —Ç–æ–≤–∞—Ä–æ–≤`);
    }

    function exportToExcel() {
      alert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ');
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    document.addEventListener('DOMContentLoaded', function() {
      currentArchive = getArchiveNameForDate(new Date());
      loadData();
    });
  </script>
</body>
</html>
