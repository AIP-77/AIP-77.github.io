<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–î–∏–∞–≥—Ä–∞–º–º–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    .controls { margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    label { font-weight: bold; }
    select, button { padding: 6px; font-size: 14px; }
    button { cursor: pointer; }
    .error { color: red; background: #ffecec; padding: 10px; border-radius: 4px; margin: 10px 0; display: none; }
    .version { font-size: 0.85em; color: #555; margin-top: -10px; }
    .debug { font-size: 0.9em; color: #333; background: #f0f0f0; padding: 10px; border-radius: 4px; margin: 10px 0; display: none; }

    /* –¢–∞–±–ª–∏—Ü–∞ */
    .timeline-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border: 1px solid #ddd;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: relative;
      overflow-x: auto;
      max-width: 100%;
    }

    .timeline-header {
      display: grid;
      grid-template-columns: minmax(150px, 1fr) repeat(var(--cols), 1fr);
      background: #f0f0f0;
      border-bottom: 1px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .timeline-header div {
      padding: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 12px;
      white-space: nowrap;
    }

    .timeline-row {
      display: grid;
      grid-template-columns: minmax(150px, 1fr) repeat(var(--cols), 1fr);
      border-bottom: 1px solid #eee;
      position: relative;
      height: 40px;
    }

    .timeline-row > div:first-child {
      padding: 8px;
      font-weight: bold;
      background: #fafafa;
      border-right: 1px solid #eee;
      font-size: 12px;
    }

    .task-block {
      position: absolute;
      top: 0;
      bottom: 0;
      color: white;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      border-radius: 2px;
      box-sizing: border-box;
      cursor: pointer;
      transition: transform 0.2s;
      border: 1px solid rgba(0,0,0,0.3); /* –û–±–≤–æ–¥–∫–∞ */
    }

    .task-block:hover {
      transform: scale(1.05);
      z-index: 10;
    }

    .task-block.conflict {
      background: #ff6b6b !important; /* –ö—Ä–∞—Å–Ω—ã–π –ø—Ä–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–∏ */
      border-color: #cc0000;
    }

    .legend-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border: 1px solid #ddd;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      overflow-x: auto;
    }

    .legend-table th,
    .legend-table td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 12px;
    }

    .legend-table th {
      background: #f0f0f0;
      font-weight: bold;
    }

    .empty { text-align: center; padding: 50px; color: #666; font-style: italic; }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 768px) {
      .controls { flex-direction: column; align-items: stretch; }
      .timeline-header, .timeline-row {
        grid-template-columns: minmax(120px, 1fr) repeat(var(--cols), 1fr);
      }
      .timeline-header div, .timeline-row > div:first-child {
        font-size: 10px;
        padding: 4px;
      }
      .task-block {
        font-size: 10px;
        padding: 0 2px;
      }
      .legend-table th, .legend-table td {
        font-size: 10px;
        padding: 4px;
      }
    }

    /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ */
    .tooltip {
      position: absolute;
      background: #333;
      color: white;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 100;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }
  </style>
</head>
<body>

<h2>–î–∏–∞–≥—Ä–∞–º–º–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
<p class="version">–í–µ—Ä—Å–∏—è: 10.05-2153</p>

<div id="errorMessage" class="error"></div>
<div id="debugInfo" class="debug"></div>

<div class="controls">
  <label for="dateSelect">–î–∞—Ç–∞:</label>
  <select id="dateSelect"><option>‚Äî</option></select>

  <label for="employeeSelect">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
  <select id="employeeSelect"><option>‚Äî</option></select>

  <button onclick="renderTimeline()">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button>
</div>

<div id="timelineContainer" class="timeline-table">
  <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
</div>

<div id="legendContainer" class="legend-table">
  <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
</div>

<div style="margin-top: 10px;">
  <button onclick="clearCacheAndReload()" style="background:#ff9900;color:white;">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –∫—ç—à</button>
</div>

<!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
<div id="tooltip" class="tooltip"></div>

<script>
  let allData = [];
  let currentTasks = [];
  let timePoints = [];

  // –¶–≤–µ—Ç–∞ –¥–ª—è –≤–∏–¥–æ–≤ —Ä–∞–±–æ—Ç (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
  const workTypeColors = {};

  function getColorForWorkType(workType) {
    if (!workTypeColors[workType]) {
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ü–≤–µ—Ç
      const hue = Object.keys(workTypeColors).length * 45 % 360;
      workTypeColors[workType] = `hsl(${hue}, 70%, 50%)`;
    }
    return workTypeColors[workType];
  }

  function showError(msg) {
    const el = document.getElementById('errorMessage');
    el.textContent = "‚ö†Ô∏è " + msg;
    el.style.display = 'block';
    console.error(msg);
  }

  function showDebug(msg) {
    const el = document.getElementById('debugInfo');
    el.textContent = "üîç " + msg;
    el.style.display = 'block';
    console.log(msg);
  }

  function parseDate(dateStr) {
    if (!dateStr) return null;
    const [d, m, y] = dateStr.split('.').map(Number);
    return new Date(y, m - 1, d);
  }

  function timeToMs(timeStr) {
    if (!timeStr || timeStr === "") return null;
    const parts = timeStr.split(':').map(Number);
    let h = parts[0] || 0, m = parts[1] || 0, s = parts[2] || 0;
    return h * 3600000 + m * 60000 + s * 1000;
  }

  function buildDateTime(datePart, timePart) {
    const base = parseDate(datePart);
    if (!base) return null;
    const ms = timeToMs(timePart);
    if (ms === null) return null;
    const result = new Date(base);
    result.setHours(0, 0, 0, 0);
    result.setTime(result.getTime() + ms);
    return result;
  }

  fetch('fullData.json')
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      return res.text();
    })
    .then(text => {
      try {
        const data = JSON.parse(text);
        if (!data.records || !Array.isArray(data.records)) {
          throw new Error('–ù–µ—Ç records[]');
        }
        allData = data.records;
        populateFilters();
        showDebug(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${allData.length}`);
      } catch (e) {
        throw new Error(`JSON –ø–∞—Ä—Å–∏–Ω–≥: ${e.message}`);
      }
    })
    .catch(err => {
      showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ fullData.json: ' + err.message);
      showDebug('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL: https://aip-77.github.io/fullData.json');
    });

  function populateFilters() {
    const dates = [...new Set(allData.map(x => x['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å']))].filter(Boolean).sort();
    const emps = [...new Set(allData.map(x => x['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))].filter(Boolean).sort();

    const ds = document.getElementById('dateSelect');
    ds.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</option>';
    dates.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d; opt.textContent = d;
      ds.appendChild(opt);
    });

    const es = document.getElementById('employeeSelect');
    es.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>';
    emps.forEach(e => {
      const opt = document.createElement('option');
      opt.value = e; opt.textContent = e;
      es.appendChild(opt);
    });

    showDebug(`–ù–∞–π–¥–µ–Ω–æ –¥–∞—Ç: ${dates.length}, —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${emps.length}`);
  }

  function renderTimeline() {
    const date = document.getElementById('dateSelect').value;
    const emp = document.getElementById('employeeSelect').value;
    if (!date || !emp) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
      return;
    }

    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏
    let tasks = allData.filter(x =>
      x['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === date && x['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'] === emp
    );

    currentTasks = tasks;

    if (tasks.length === 0) {
      alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
      return;
    }

    showDebug(`–ù–∞–π–¥–µ–Ω–æ –∑–∞–¥–∞—á: ${tasks.length}`);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
    let minTimeMs = Infinity;
    let maxTimeMs = -Infinity;

    tasks.forEach(task => {
      const start = buildDateTime(date, task['–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏']);
      const dur = task['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è'] || task['–í—Ä–µ–º—è –ø–æ —Ç–∞–±–µ–ª—é'] || '';
      const durMs = timeToMs(dur);

      if (!start || durMs === null) return;

      const startMs = start.getTime() - parseDate(date).getTime();
      const endMs = startMs + durMs;

      minTimeMs = Math.min(minTimeMs, startMs);
      maxTimeMs = Math.max(maxTimeMs, endMs);
    });

    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ 8:00‚Äì20:00
    if (minTimeMs === Infinity) minTimeMs = 8 * 3600000;
    if (maxTimeMs === -Infinity) maxTimeMs = 20 * 3600000;

    // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ —á–∞—Å–∞
    minTimeMs = Math.floor(minTimeMs / 3600000) * 3600000;
    maxTimeMs = Math.ceil(maxTimeMs / 3600000) * 3600000;

    // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 1 —á–∞—Å
    timePoints = [];
    for (let ms = minTimeMs; ms <= maxTimeMs; ms += 3600000) {
      const h = Math.floor(ms / 3600000) % 24;
      const m = Math.floor((ms % 3600000) / 60000);
      timePoints.push({
        label: `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`,
        ms: ms
      });
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫ –≤ CSS
    document.documentElement.style.setProperty('--cols', timePoints.length);

    // –°–æ–∑–¥–∞—ë–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const container = document.getElementById('timelineContainer');
    container.innerHTML = '';

    const header = document.createElement('div');
    header.className = 'timeline-header';
    header.innerHTML = `<div>–í–∏–¥ —Ä–∞–±–æ—Ç</div>` + timePoints.map(tp => `<div>${tp.label}</div>`).join('');
    container.appendChild(header);

    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ "–í–∏–¥ —Ä–∞–±–æ—Ç"
    const grouped = {};
    tasks.forEach(task => {
      // –û–±—ä–µ–¥–∏–Ω—è–µ–º "–†–∞–±–æ—á–∏–π –¥–µ–Ω—å" –∏ "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Ä–∞–±–æ—Ç" –≤ "–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è"
      let key = task['–í–∏–¥ —Ä–∞–±–æ—Ç'];
      if (key === '–†–∞–±–æ—á–∏–π –¥–µ–Ω—å' || key === '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Ä–∞–±–æ—Ç') {
        key = '–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è';
      }
      if (!grouped[key]) grouped[key] = [];
      grouped[key].push(task);
    });

    // –í—ã–≤–æ–¥–∏–º "–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è" –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–æ–π
    if (grouped['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']) {
      renderRow(container, '–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è', grouped['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è'], true, date); // isWorkTime: true
      delete grouped['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è']; // –£–¥–∞–ª—è–µ–º, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
    }

    // –í—ã–≤–æ–¥–∏–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
    Object.keys(grouped).forEach(workType => {
      renderRow(container, workType, grouped[workType], false, date); // isWorkTime: false
    });

    // –°–æ–∑–¥–∞—ë–º –ª–µ–≥–µ–Ω–¥—É
    const legendContainer = document.getElementById('legendContainer');
    legendContainer.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏</th>
            <th>–í–∏–¥ —Ä–∞–±–æ—Ç</th>
            <th>–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è / –í—Ä–µ–º—è –ø–æ —Ç–∞–±–µ–ª—é</th>
            <th>–ü–æ—Å—Ç–∞–≤–∫–∞</th>
            <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
            <th>—Ç–∏–ø —Ç–æ–≤–∞—Ä–∞</th>
            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü</th>
          </tr>
        </thead>
        <tbody>
          ${tasks.map(task => `
            <tr>
              <td>${task['–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏']}</td>
              <td>${task['–í–∏–¥ —Ä–∞–±–æ—Ç']}</td>
              <td>${task['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è'] || task['–í—Ä–µ–º—è –ø–æ —Ç–∞–±–µ–ª—é'] || ''}</td>
              <td>${task['–ü–æ—Å—Ç–∞–≤–∫–∞'] || ''}</td>
              <td>${task['–î–æ–ª–∂–Ω–æ—Å—Ç—å'] || ''}</td>
              <td>${task['—Ç–∏–ø —Ç–æ–≤–∞—Ä–∞'] || ''}</td>
              <td>${task['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü'] || ''}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;

    showDebug(`–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞–¥–∞—á: ${tasks.length}, –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ: ${tasks.length}`);
  }

  function renderRow(container, workType, tasks, isWorkTime, date) {
    const row = document.createElement('div');
    row.className = 'timeline-row';

    // –Ø—á–µ–π–∫–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –≤–∏–¥–∞ —Ä–∞–±–æ—Ç
    const workCell = document.createElement('div');
    workCell.textContent = workType;
    row.appendChild(workCell);

    // –Ø—á–µ–π–∫–∏ —Å –≤—Ä–µ–º–µ–Ω–µ–º
    timePoints.forEach((tp, i) => {
      const cell = document.createElement('div');
      cell.style.position = 'relative';
      cell.style.height = '100%';
      row.appendChild(cell);
    });

    container.appendChild(row);

    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏ –≤ —è—á–µ–π–∫–∏
    tasks.forEach(task => {
      const start = buildDateTime(date, task['–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏']);
      const dur = task['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è'] || task['–í—Ä–µ–º—è –ø–æ —Ç–∞–±–µ–ª—é'] || '';
      const durMs = timeToMs(dur);

      if (!start || durMs === null) {
        console.warn('–ü—Ä–æ–ø—É—â–µ–Ω–∞ –∑–∞–¥–∞—á–∞ (–Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏):', task);
        return;
      }

      const startMs = start.getTime() - parseDate(date).getTime();
      const endMs = startMs + durMs;

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≤ –∫–∞–∫–∏–µ —è—á–µ–π–∫–∏ –ø–æ–ø–∞–¥–∞–µ—Ç –∑–∞–¥–∞—á–∞
      for (let i = 0; i < timePoints.length - 1; i++) {
        const fromMs = timePoints[i].ms;
        const toMs = timePoints[i + 1].ms;

        if (startMs < toMs && endMs > fromMs) {
          // –ó–∞–¥–∞—á–∞ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å —ç—Ç–æ–π —è—á–µ–π–∫–æ–π
          const cell = row.children[i + 1]; // +1 –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–µ—Ä–≤–∞—è —è—á–µ–π–∫–∞ ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ

          const block = document.createElement('div');
          block.className = 'task-block';
          block.textContent = task['–ü–æ—Å—Ç–∞–≤–∫–∞'] || '–ë–µ–∑ –Ω–æ–º–µ—Ä–∞';

          // –¶–≤–µ—Ç –ø–æ —Ç–∏–ø—É —Ä–∞–±–æ—Ç—ã
          let bgColor = getColorForWorkType(workType);

          // –ï—Å–ª–∏ —ç—Ç–æ "–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è" ‚Äî –¥–µ–ª–∞–µ–º –æ—Ç—Ç–µ–Ω–∫–∏
          if (workType === '–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è') {
            if (task['–í–∏–¥ —Ä–∞–±–æ—Ç'] === '–†–∞–±–æ—á–∏–π –¥–µ–Ω—å') {
              bgColor = 'hsl(120, 70%, 60%)'; // —Å–≤–µ—Ç–ª–æ-–∑–µ–ª—ë–Ω—ã–π
            } else if (task['–í–∏–¥ —Ä–∞–±–æ—Ç'] === '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Ä–∞–±–æ—Ç') {
              bgColor = 'hsl(120, 70%, 40%)'; // —Ç—ë–º–Ω–æ-–∑–µ–ª—ë–Ω—ã–π
            }
          }

          block.style.backgroundColor = bgColor;

          // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
          const leftPct = Math.max(0, (startMs - fromMs) / (toMs - fromMs)) * 100;
          const widthPct = Math.min(100, (endMs - startMs) / (toMs - fromMs) * 100);

          block.style.left = `${leftPct}%`;
          block.style.width = `${widthPct}%`;

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï "–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è"
          if (!isWorkTime) {
            checkConflicts(block, startMs, endMs, tasks, date, isWorkTime);
          }

          // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
          block.addEventListener('mouseenter', (e) => {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
              <strong>${task['–í–∏–¥ —Ä–∞–±–æ—Ç']}</strong><br>
              –ü–æ—Å—Ç–∞–≤–∫–∞: ${task['–ü–æ—Å—Ç–∞–≤–∫–∞'] || '‚Äî'}<br>
              –ù–∞—á–∞–ª–æ: ${task['–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏']}<br>
              –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${dur}<br>
              –î–æ–ª–∂–Ω–æ—Å—Ç—å: ${task['–î–æ–ª–∂–Ω–æ—Å—Ç—å'] || '‚Äî'}
            `;
            tooltip.style.opacity = 1;
            tooltip.style.left = `${e.pageX + 10}px`;
            tooltip.style.top = `${e.pageY + 10}px`;
          });

          block.addEventListener('mouseleave', () => {
            document.getElementById('tooltip').style.opacity = 0;
          });

          cell.appendChild(block);
        }
      }
    });
  }

  function checkConflicts(block, startMs, endMs, allTasks, date, isWorkTime) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏
  for (const other of allTasks) {
    if (other === block.task) continue; // –ù–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å —Å–æ–±–æ–π

    const otherStart = buildDateTime(date, other['–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏']);
    const otherDur = other['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è'] || other['–í—Ä–µ–º—è –ø–æ —Ç–∞–±–µ–ª—é'] || '';
    const otherDurMs = timeToMs(otherDur);

    if (!otherStart || otherDurMs === null) continue;

    const otherStartMs = otherStart.getTime() - parseDate(date).getTime();
    const otherEndMs = otherStartMs + otherDurMs;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–∑–æ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1 –º–∏–Ω—É—Ç–∞)
    const gapMs = 60000; // 1 –º–∏–Ω—É—Ç–∞

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å —É—á—ë—Ç–æ–º –∑–∞–∑–æ—Ä–∞
    // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∏ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç—Å—è –∏–ª–∏ —Å—Ç—ã–∫—É—é—Ç—Å—è —Å –∑–∞–∑–æ—Ä–æ–º < 1 –º–∏–Ω—É—Ç—ã ‚Äî —Å—á–∏—Ç–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–º
    if (startMs < otherEndMs + gapMs && endMs > otherStartMs - gapMs) {
      // –ï—Å—Ç—å –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ ‚Äî –ø–æ–¥–∫—Ä–∞—à–∏–≤–∞–µ–º –∫—Ä–∞—Å–Ω—ã–º
      block.classList.add('conflict');
      break; // –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–Ω–æ–≥–æ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
    }
  }
}

  function clearCacheAndReload() {
    location.reload();
  }

  // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–∞—Ç—ã –∏–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
  document.getElementById('dateSelect').addEventListener('change', renderTimeline);
  document.getElementById('employeeSelect').addEventListener('change', renderTimeline);
</script>

</body>
</html>
