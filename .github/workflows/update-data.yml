name: Update and Archive Monthly Data

on:
  schedule:
    - cron: '30 18 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º current.json
      - name: Generate current.json
        run: |
          node scripts/generate-current.mjs
          git add current.json
          if ! git diff --staged --quiet; then
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git commit -m "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ current.json [$(date +'%Y-%m-%d %H:%M')]"
            git push
          else
            echo "current.json –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è"
          fi

      # 2. –ê—Ä—Ö–∏–≤–∞—Ü–∏—è (1-–≥–æ —á–∏—Å–ª–∞)
      - name: Archive previous month if needed
        run: |
          DAY=$(date -u +%d)
          if [ "$DAY" = "01" ]; then
            echo "–°–µ–≥–æ–¥–Ω—è 1-–µ —á–∏—Å–ª–æ ‚Äî –∞—Ä—Ö–∏–≤–∏—Ä—É–µ–º –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü..."
            PREV_MONTH=$(date -u -d "yesterday" +%Y-%m)
            mkdir -p archive
            cp current.json archive/${PREV_MONTH}.json
            git add archive/${PREV_MONTH}.json
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git commit -m "üì¶ –ê—Ä—Ö–∏–≤: ${PREV_MONTH}.json"
            git push
          else
            echo "–ù–µ 1-–µ —á–∏—Å–ª–æ ‚Äî –∞—Ä—Ö–∏–≤–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è."
          fi

      # 3. –ö–æ–ø–∏—Ä—É–µ–º current.json ‚Üí data.json (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
      - name: Update data.json
        run: |
          cp current.json data.json
          git add data.json
          if ! git diff --quiet -- data.json; then
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git commit -m "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö [$(date +'%Y-%m-%d %H:%M')]"
            git push
          fi
