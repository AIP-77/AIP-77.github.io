name: Update and Archive Monthly Data

on:
  schedule:
    - cron: '30 14 * * *'  # –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 01:01 UTC
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 1. –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
      - name: Generate current.json
        run: node scripts/generate-current.mjs

      # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å (–µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è 1-–µ —á–∏—Å–ª–æ)
      - name: Archive previous month if needed
        run: |
          DAY=$(date -u +%d)
          if [ "$DAY" = "01" ]; then
            echo "–°–µ–≥–æ–¥–Ω—è 1-–µ —á–∏—Å–ª–æ ‚Äî –∞—Ä—Ö–∏–≤–∏—Ä—É–µ–º –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü..."
            PREV_MONTH=$(date -u -d "yesterday" +%Y-%m)
            mkdir -p archive
            cp current.json archive/${PREV_MONTH}.json
            git add archive/${PREV_MONTH}.json
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git commit -m "üì¶ –ê—Ä—Ö–∏–≤: ${PREV_MONTH}.json"
            git push
          else
            echo "–ù–µ 1-–µ —á–∏—Å–ª–æ ‚Äî –∞—Ä—Ö–∏–≤–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è."
          fi

      # 3. –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π data.json (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      - name: Update data.json (optional)
        run: |
          # –ù–∞–ø—Ä–∏–º–µ—Ä, data.json = { current: ..., archive: [...] }
          node scripts/build-main-data.mjs
          git add data.json
          if ! git diff --quiet -- data.json; then
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git commit -m "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö"
            git push
          fi
