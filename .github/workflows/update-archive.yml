name: Sync Archive from Google Drive

on:
  schedule:
    - cron: '0 3 * * *'  # 08:00 –ø–æ –ï–ö–ë (UTC+5)
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm init -y --silent
          npm install googleapis@126.0.1

      - name: Sync archive files using Google Drive API
        env:
          SERVICE_ACCOUNT_KEY: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_KEY }}
        run: |
          mkdir -p archive
          node << "EOF"
          const fs = require('fs');
          const { google } = require('googleapis');

          // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
          const filesToDownload = [
            { name: 'standard fullData.json', id: '1Ua_KETb1fVu3PhR6SmxYkWjOOApaZDc5' },
            { name: 'staff fullData.json', id: '1cbHKB7vGBslK52H7EJBT3jhG0yHFrpC8' },
            { name: '2025-09 fullData.json', id: '1qAMfjSXpoeExA-sjTHMZ7_26TBx8ULbO' },
            { name: '2025-10 fullData.json', id: '1ONAxssw3MN_tS-ScPKeGDaIp3ZmPJrdT' },
            { name: '2025-11 fullData.json', id: '1tl89YvvdxAF7GZasSZoPxn6zaZuGTuCt' }
          ];

          async function downloadFile(drive, fileName, fileId) {
            console.log(`üì• –ó–∞–≥—Ä—É–∑–∫–∞: ${fileName}`);
            
            try {
              const response = await drive.files.get({
                fileId: fileId,
                alt: 'media'
              }, { responseType: 'stream' });

              return new Promise((resolve, reject) => {
                const dest = fs.createWriteStream(`archive/${fileName}`);
                response.data
                  .on('end', () => {
                    console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ: ${fileName}`);
                    resolve(true);
                  })
                  .on('error', (err) => {
                    console.error(`‚ùå –û—à–∏–±–∫–∞: ${fileName} - ${err.message}`);
                    reject(err);
                  })
                  .pipe(dest);
              });
            } catch (err) {
              console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${fileName}:`, err.message);
              return false;
            }
          }

          async function main() {
            try {
              // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
              const serviceAccountKey = JSON.parse(process.env.SERVICE_ACCOUNT_KEY);
              const auth = new google.auth.GoogleAuth({
                credentials: serviceAccountKey,
                scopes: ['https://www.googleapis.com/auth/drive.readonly'],
              });

              const drive = google.drive({ version: 'v3', auth });

              console.log('üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
              console.log(`üìã –§–∞–π–ª–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏: ${filesToDownload.length}`);

              let successCount = 0;
              const failedFiles = [];

              for (const file of filesToDownload) {
                try {
                  const success = await downloadFile(drive, file.name, file.id);
                  if (success) {
                    successCount++;
                  } else {
                    failedFiles.push(file.name);
                  }
                  // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                  await new Promise(r => setTimeout(r, 1000));
                } catch (err) {
                  console.error(`üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è ${file.name}:`, err.message);
                  failedFiles.push(file.name);
                }
              }

              console.log('\nüìä –ò—Ç–æ–≥–∏ –∑–∞–≥—Ä—É–∑–∫–∏:');
              console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ: ${successCount}/${filesToDownload.length}`);
              if (failedFiles.length > 0) {
                console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å: ${failedFiles.join(', ')}`);
                process.exit(1);
              }

            } catch (err) {
              console.error('üí• –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', err.message);
              process.exit(1);
            }
          }

          main().catch(console.error);
          EOF

      - name: Check downloaded files
        run: |
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ archive:"
          ls -la archive/
          echo ""
          echo "üìä –†–∞–∑–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤:"
          for file in archive/*; do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file")
              echo "  $(basename "$file"): $size bytes"
            fi
          done

      - name: Generate new archives from Google Sheets
        run: node scripts/generate-Archive.mjs

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add archive/ fullData.json
          
          if ! git diff --staged --quiet; then
            git commit -m "üîÑ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö [$(date +'%Y-%m-%d %H:%M')]"
            git push
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
          else
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          fi
