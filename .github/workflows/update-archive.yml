name: Sync Archive from Google Drive

on:
  schedule:
    - cron: '0 3 * * *'  # 08:00 –ø–æ –ï–ö–ë (UTC+5)
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm init -y --silent
          npm install node-fetch@2

      - name: Sync archive files from Google Drive
        run: |
          mkdir -p archive
          node << "EOF"
          const fs = require('fs');
          const { default: fetch } = require('node-fetch');

          // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
          const archiveFiles = `
            standard fullData.json:1Ua_KETb1fVu3PhR6SmxYkWjOOApaZDc5
            staff fullData.json:1cbHKB7vGBslK52H7EJBT3jhG0yHFrpC8
            2025-09 fullData.json:1qAMfjSXpoeExA-sjTHMZ7_26TBx8ULbO
            2025-10 fullData.json:1ONAxssw3MN_tS-ScPKeGDaIp3ZmPJrdT
            2025-11 fullData.json:1tl89YvvdxAF7GZasSZoPxn6zaZuGTuCt
          `;

          const archiveList = archiveFiles
            .split('\n')
            .map(line => line.trim())
            .filter(line => line && !line.startsWith('#'))
            .map(line => {
              const [name, id] = line.split(':').map(part => part.trim());
              return { name, id };
            })
            .filter(file => file.name && file.id);

          console.log('üìã –§–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏:');
          archiveList.forEach(file => console.log(`  - ${file.name}: ${file.id}`));
          console.log(`–í—Å–µ–≥–æ: ${archiveList.length} —Ñ–∞–π–ª–æ–≤\n`);

          async function downloadFile(fileName, fileId) {
            console.log(`üì• –ó–∞–≥—Ä—É–∑–∫–∞: ${fileName} (ID: ${fileId})`);
            
            // –ú–µ—Ç–æ–¥ 1: –ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
            const url = `https://drive.google.com/uc?export=download&id=${fileId}&confirm=t`;
            
            try {
              const response = await fetch(url);
              
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }

              const content = await response.text();
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ JSON
              if (content.trim().startsWith('{') || content.trim().startsWith('[')) {
                fs.writeFileSync(`archive/${fileName}`, content, 'utf8');
                console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ: ${fileName} (${content.length} –±–∞–π—Ç)`);
                return true;
              } else {
                console.log(`‚ùå –ü–æ–ª—É—á–µ–Ω –Ω–µ-JSON –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è ${fileName}`);
                console.log(`–ü–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤: "${content.substring(0, 10)}..."`);
                return false;
              }
            } catch (err) {
              console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${fileName}:`, err.message);
              return false;
            }
          }

          async function main() {
            let successCount = 0;
            let failedFiles = [];

            for (const file of archiveList) {
              const success = await downloadFile(file.name, file.id);
              if (success) {
                successCount++;
              } else {
                failedFiles.push(file.name);
              }
              // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
              await new Promise(r => setTimeout(r, 1000));
            }

            console.log('\nüìä –ò—Ç–æ–≥–∏ –∑–∞–≥—Ä—É–∑–∫–∏:');
            console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ: ${successCount}/${archiveList.length}`);
            if (failedFiles.length > 0) {
              console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å: ${failedFiles.join(', ')}`);
            }
          }

          main().catch(console.error);
          EOF

      - name: Check what was downloaded
        run: |
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ archive:"
          ls -la archive/
          echo ""
          echo "üìä –†–∞–∑–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤:"
          du -h archive/* || true

      - name: Generate new archives from Google Sheets
        run: node scripts/generate-Archive.mjs

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add archive/ fullData.json
          
          if ! git diff --staged --quiet; then
            git commit -m "üîÑ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö [$(date +'%Y-%m-%d %H:%M')]"
            git push
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
          else
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          fi
