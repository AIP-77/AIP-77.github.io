name: Sync Archive from Google Drive

on:
  schedule:
    - cron: '0 3 * * *'  # 06:00 –ø–æ –ï–ö–ë (UTC+5)
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # ‚úÖ –£–±—Ä–∞–ª–∏ cache, —Ç–∞–∫ –∫–∞–∫ –Ω–µ—Ç package-lock.json

      - name: Install dependencies
        run: |
          npm init -y --silent
          npm install node-fetch@2

      - name: Sync archive files from Google Drive
        env:
          ARCHIVE_FILES: |
            standard fullData.json:1Ua_KETb1fVu3PhR6SmxYkWjOOApaZDc5
            staff fullData.json:1cbHKB7vGBslK52H7EJBT3jhG0yHFrpC8
            2025-09 fullData.json:1qAMfjSXpoeExA-sjTHMZ7_26TBx8ULbO
            2025-10 fullData.json:1ONAxssw3MN_tS-ScPKeGDaIp3ZmPJrdT
            2025-11 fullData.json:1tl89YvvdxAF7GZasSZoPxn6zaZuGTuCt
        run: |
          mkdir -p archive
          node <<'EOF'
          const fs = require('fs');
          const { default: fetch } = require('node-fetch');

          const archiveList = process.env.ARCHIVE_FILES
            .split('\n')
            .map(line => line.trim())
            .filter(line => line && !line.startsWith('#'))
            .map(line => {
              const [name, id] = line.split(':').map(part => part.trim());
              return { name, id };
            })
            .filter(file => file.name && file.id);

          console.log('–ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏:', archiveList.length);

          async function downloadFile(fileName, fileId) {
            console.log(`üì• –ó–∞–≥—Ä—É–∑–∫–∞: ${fileName}`);
            
            const url = `https://drive.google.com/uc?export=download&id=${fileId}`;
            try {
              const response = await fetch(url);
              
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }

              const content = await response.text();
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ JSON, –∞ –Ω–µ HTML-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
              if (content.trim().startsWith('{') || content.trim().startsWith('[')) {
                fs.writeFileSync(`archive/${fileName}`, content, 'utf8');
                console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ: ${fileName} (${content.length} –±–∞–π—Ç)`);
                return true;
              } else {
                // –ï—Å–ª–∏ —ç—Ç–æ HTML, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
                console.log(`‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω HTML –¥–ª—è ${fileName}, –ø—Ä–æ–±—É–µ–º –æ–±–æ–π—Ç–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ...`);
                
                // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥: –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥—Ä—É–≥–æ–π endpoint
                const directUrl = `https://drive.google.com/uc?export=download&id=${fileId}&confirm=t`;
                const directResponse = await fetch(directUrl);
                
                if (directResponse.ok) {
                  const directContent = await directResponse.text();
                  if (directContent.trim().startsWith('{') || directContent.trim().startsWith('[')) {
                    fs.writeFileSync(`archive/${fileName}`, directContent, 'utf8');
                    console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ (—á–µ—Ä–µ–∑ direct): ${fileName}`);
                    return true;
                  }
                }
                
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å JSON —Ñ–∞–π–ª');
              }
            } catch (err) {
              console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${fileName}:`, err.message);
              return false;
            }
          }

          async function main() {
            let successCount = 0;
            for (const file of archiveList) {
              const success = await downloadFile(file.name, file.id);
              if (success) successCount++;
              // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
              await new Promise(r => setTimeout(r, 2000));
            }
            console.log(`üéØ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${successCount}/${archiveList.length} —Ñ–∞–π–ª–æ–≤`);
          }

          main().catch(console.error);
          EOF

      - name: Generate new archives from Google Sheets
        run: node scripts/generate-Archive.mjs

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add archive/ fullData.json
          
          if ! git diff --staged --quiet; then
            git commit -m "üîÑ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö [$(date +'%Y-%m-%d %H:%M')]"
            git push
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
          else
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          fi
