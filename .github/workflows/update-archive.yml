name: Sync Archive from Google Drive

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm init -y --silent
          npm install node-fetch@2

      - name: Download files using curl (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
        env:
          ARCHIVE_FILES: |
           2025-10 fullData.json:1ONAxssw3MN_tS-ScPKeGDaIp3ZmPJrdT
            
        run: |
          mkdir -p archive
          echo "$ARCHIVE_FILES" | while IFS= read -r line; do
            line=$(echo "$line" | tr -d '\r' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            if [[ -n "$line" && ! "$line" =~ ^# ]]; then
              filename=$(echo "$line" | cut -d':' -f1)
              fileid=$(echo "$line" | cut -d':' -f2)
              echo "üì• –ó–∞–≥—Ä—É–∑–∫–∞: $filename"
              
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º curl –¥–ª—è –æ–±—Ö–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
              curl -L "https://drive.google.com/uc?export=download&id=$fileid&confirm=t" \
                -o "archive/$filename" \
                --retry 3 \
                --max-time 30
              
              if [[ $? -eq 0 && -s "archive/$filename" ]]; then
                echo "‚úÖ –£—Å–ø–µ—à–Ω–æ: $filename"
              else
                echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: $filename"
                rm -f "archive/$filename" 2>/dev/null
              fi
              
              sleep 2
            fi
          done

      - name: Generate new archives from Google Sheets
        run: node scripts/generate-Archive.mjs

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add archive/ fullData.json
          if ! git diff --staged --quiet; then
            git commit -m "üîÑ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö [$(date +'%Y-%m-%d %H:%M')]"
            git push
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
          else
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          fi
