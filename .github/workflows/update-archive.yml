name: Sync Archive from Google Drive

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download files with proper cookies
        run: |
          mkdir -p archive
          
          # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
          download_file() {
            local name=$1
            local id=$2
            echo "üì• –ó–∞–≥—Ä—É–∑–∫–∞: $name"
            
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∫—É–∫
            local COOKIE_FILE=$(mktemp)
            
            # –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É–∫ –∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            curl -L -c "$COOKIE_FILE" \
              "https://drive.google.com/uc?export=download&id=$id" \
              --silent --retry 3 > /dev/null
              
            # –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å —Å –∫—É–∫–∞–º–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
            curl -L -b "$COOKIE_FILE" \
              "https://drive.google.com/uc?export=download&id=$id&confirm=t" \
              -o "archive/$name" \
              --retry 3 \
              --max-time 60
              
            local result=$?
            rm -f "$COOKIE_FILE"
            
            if [ $result -eq 0 ] && [ -s "archive/$name" ]; then
              local size=$(wc -c < "archive/$name")
              echo "‚úÖ –£—Å–ø–µ—à–Ω–æ: $name ($size bytes)"
              return 0
            else
              echo "‚ùå –û—à–∏–±–∫–∞: $name"
              rm -f "archive/$name"
              return 1
            fi
          }

          # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –ø–æ –æ–¥–Ω–æ–º—É
          download_file "standard fullData.json" "1Ua_KETb1fVu3PhR6SmxYkWjOOApaZDc5"
          sleep 2
          download_file "staff fullData.json" "1cbHKB7vGBslK52H7EJBT3jhG0yHFrpC8"
          sleep 2
          download_file "2025-09 fullData.json" "1qAMfjSXpoeExA-sjTHMZ7_26TBx8ULbO"
          sleep 2
          download_file "2025-10 fullData.json" "1ONAxssw3MN_tS-ScPKeGDaIp3ZmPJrdT"
          sleep 2
          download_file "2025-11 fullData.json" "1tl89YvvdxAF7GZasSZoPxn6zaZuGTuCt"

      - name: Generate new archives from Google Sheets
        run: node scripts/generate-Archive.mjs

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add archive/ fullData.json
          if ! git diff --staged --quiet; then
            git commit -m "üîÑ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö [$(date +'%Y-%m-%d %H:%M')]"
            git push
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
          else
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          fi
