<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ê–¥–º–∏–Ω–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --tg-bg-color: #f0f2f5;
      --tg-text-color: #1c1e21;
      --tg-hint-color: #999;
      --tg-link-color: #d71923;
      --tg-button-color: #1a8cd8;
      --tg-button-text-color: #ffffff;
      --card-bg: #ffffff;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--tg-bg-color);
      color: var(--tg-text-color);
      min-height: 100vh;
    }
    .container { max-width: 600px; margin: 0 auto; }
    .card { 
      background: var(--card-bg); 
      border-radius: 12px; 
      padding: 18px; 
      margin-bottom: 14px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }
    h1 { margin: 0 0 10px 0; color: var(--tg-link-color); }
    h2, h3 { margin: 0 0 8px 0; color: var(--tg-link-color); }
    .loading { text-align: center; padding: 20px; color: var(--tg-hint-color); font-size: 16px; }
    .spinner { 
      width: 40px; 
      height: 40px; 
      border: 4px solid #e0e0e0; 
      border-top: 4px solid var(--tg-link-color); 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
      margin: 20px auto; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      color: #e53935; 
      text-align: center; 
      padding: 20px; 
      background: #ffebee; 
      border-radius: 8px; 
      margin: 16px 0; 
    }
    .hidden { display: none !important; }
    .calendar { 
      display: grid; 
      gap: 4px; 
      margin: 10px 0; 
      grid-template-columns: repeat(7, 1fr); 
    }
    .day { 
      text-align: center; 
      padding: 6px; 
      font-size: 14px; 
      border-radius: 4px; 
      color: var(--tg-text-color); 
      cursor: pointer; 
    }
    .day.available { 
      background: var(--tg-link-color); 
      color: var(--tg-button-text-color); 
      font-weight: bold; 
    }
    .day:hover { 
      background: #e0e0e0; 
    }
    .footer { 
      text-align: center; 
      margin-top: 30px; 
      color: var(--tg-hint-color); 
      font-size: 13px; 
    }
    .month-selector { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin: 10px 0; 
    }
    .month-selector button { 
      background: var(--tg-button-color); 
      color: var(--tg-button-text-color); 
      border: none; 
      padding: 8px 12px; 
      border-radius: 6px; 
      cursor: pointer; 
    }
    .month-selector span { font-weight: bold; }

    /* === UX –£–õ–£–ß–®–ï–ù–ò–Ø === */
    .banner {
      padding: 12px;
      margin: 12px 0;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
      display: none;
    }
    .banner.show {
      display: block;
    }
    .banner.info { background: #e3f2fd; color: #1565c0; }
    .banner.error { background: #ffebee; color: #c62828; }
    .banner.success { background: #e8f5e9; color: #2e7d32; }

    .last-update {
      font-size: 13px;
      color: var(--tg-hint-color);
      margin-top: 8px;
    }

    .refresh-btn {
      background: var(--tg-button-color);
      color: var(--tg-button-text-color);
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      display: inline-block;
    }
    .refresh-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã */
    .fade {
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    .fade.hidden {
      opacity: 0;
    }
    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 16px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="back-btn" onclick="window.location.href = 'index.html'">‚Üê –ù–∞–∑–∞–¥ –∫ –æ—Ç—á—ë—Ç–∞–º</button>
    <h1>üë®‚Äçüíª –ê–¥–º–∏–Ω–∫–∞ (–û—Ç–¥–µ–ª—ã)</h1>
    <div id="banner" class="banner"></div>

    <div class="card">
      <label for="departmentSelect">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª:</label>
      <select id="departmentSelect" style="width:100%; padding:8px; margin:10px 0; border-radius:6px; border:1px solid #ccc;">
        <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª ‚Äî</option>
      </select>
    </div>

    <!-- –î–∞–Ω–Ω—ã–µ –ø–æ –æ—Ç–¥–µ–ª—É -->
    <div id="department-report" class="hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2>üìä –û—Ç—á—ë—Ç –ø–æ –æ—Ç–¥–µ–ª—É: <span id="dept-name">‚Äî</span></h2>
        </div>
        <p id="dept-last-update" class="last-update">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ‚Äî</p>
        <div id="dept-data-loading" class="loading">
          <div class="spinner"></div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–¥–µ–ª–∞...</p>
        </div>
        <div id="dept-data-content" class="hidden fade">
          <p id="dept-report-date">–û—Ç—á—ë—Ç –Ω–∞ –¥–∞—Ç—É: ‚Äî</p>
          <p id="dept-attendance">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏: ‚Äî</p>
          <p id="dept-attendance-percent">üìä –ü—Ä–æ—Ü–µ–Ω—Ç —è–≤–∫–∏: ‚Äî</p>
          <h3>üë• –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:</h3>
          <pre id="dept-employees-list" style="white-space:pre-wrap;font-family:monospace;"></pre>
          <p id="dept-avg-efficiency">üìä –°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã: ‚Äî</p>
        </div>
      </div>

      <div class="card">
        <h2>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç–¥–µ–ª–∞</h2>
        <div id="dept-calendar-loading" class="loading">
          <div class="spinner"></div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è...</p>
        </div>
        <div id="dept-calendar-content" class="hidden">
          <div class="month-selector">
            <button id="dept-prevMonth">‚óÄ</button>
            <span id="dept-currentMonth">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            <button id="dept-nextMonth">‚ñ∂</button>
          </div>
          <div class="calendar" id="dept-calendar"></div>
        </div>
      </div>
    </div>

    <div class="footer">–°–∏—Å—Ç–µ–º–∞ –º–∞–ª–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ AIP ‚Ä¢ ¬© 09.2025</div>
  </div>

  <script>
    let chatId = null;
    let allUserData = null;
    let calendarCache = null;
    let currentManagerDepartment = null;

    const departmentSelect = document.getElementById('departmentSelect');
    const departmentReport = document.getElementById('department-report');
    const banner = document.getElementById('banner');

    const deptDataLoading = document.getElementById('dept-data-loading');
    const deptDataContent = document.getElementById('dept-data-content');
    const deptCalendarLoading = document.getElementById('dept-calendar-loading');
    const deptCalendarContent = document.getElementById('dept-calendar-content');
    const deptPrevMonthBtn = document.getElementById('dept-prevMonth');
    const deptNextMonthBtn = document.getElementById('dept-nextMonth');
    const deptCurrentMonthSpan = document.getElementById('dept-currentMonth');
    const deptCalendar = document.getElementById('dept-calendar');

    const deptNameSpan = document.getElementById('dept-name');
    const deptLastUpdate = document.getElementById('dept-last-update');

    let deptAvailableMonths = [];
    let deptCurrentMonthIndex = 0;

    async function init() {
      try {
        if (!window.Telegram?.WebApp) {
          alert('–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –∞–¥–º–∏–Ω–∫–µ');
          return;
        }

        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        applyTelegramTheme();

        const user = Telegram.WebApp.initDataUnsafe.user;
        if (!user?.id) throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        chatId = String(user.id);

        const currentRes = await fetch('current.json');
        if (!currentRes.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å current.json');
        allUserData = await currentRes.json();

        const cacheRes = await fetch('calendar-cache.json');
        if (!cacheRes.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å calendar-cache.json');
        calendarCache = await cacheRes.json();

        fillDepartmentSelector();
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∫–∏:', err);
        document.body.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${err.message}</div>`;
      }
    }

    function applyTelegramTheme() {
      if (!window.Telegram?.WebApp) return;
      const theme = Telegram.WebApp.themeParams;
      const root = document.documentElement;
      root.style.setProperty('--tg-bg-color', theme.bg_color || '#f0f2f5');
      root.style.setProperty('--tg-text-color', theme.text_color || '#1c1e21');
      root.style.setProperty('--tg-hint-color', theme.hint_color || '#999999');
      root.style.setProperty('--tg-link-color', theme.link_color || '#d71923');
      root.style.setProperty('--tg-button-color', theme.button_color || '#1a8cd8');
      root.style.setProperty('--tg-button-text-color', theme.button_text_color || '#ffffff');
      root.style.setProperty('--card-bg', theme.bg_color && parseInt(theme.bg_color.replace('#', ''), 16) < 0xffffff/2 ? '#333' : '#ffffff');
    }

    function fillDepartmentSelector() {
      departmentSelect.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª ‚Äî</option>';

      const departments = new Set();
      Object.values(allUserData).forEach(user => {
        if (user.department) departments.add(user.department);
      });

      const sortedDepts = Array.from(departments).sort();
      sortedDepts.forEach(dept => {
        const opt = document.createElement('option');
        opt.value = dept;
        opt.textContent = dept;
        departmentSelect.appendChild(opt);
      });
    }

    departmentSelect.addEventListener('change', function () {
      const selectedDept = this.value;
      if (selectedDept) {
        currentManagerDepartment = selectedDept;
        renderDepartmentReport(currentManagerDepartment);
      } else {
        departmentReport.classList.add('hidden');
      }
    });

    function renderDepartmentReport(departmentName) {
      currentManagerDepartment = departmentName;
      deptNameSpan.textContent = departmentName;

      const employeesInDept = Object.values(allUserData).filter(user => user.department === departmentName);
      if (employeesInDept.length === 0) {
        deptDataLoading.innerHTML = '<p style="text-align:center;color:#e53935;">–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –æ—Ç–¥–µ–ª–µ</p>';
        deptDataLoading.classList.remove('hidden');
        deptDataContent.classList.add('hidden');
        renderDepartmentCalendar(departmentName);
        return;
      }

      // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∞—Ç—É
      let latestDate = null;
      for (const emp of employeesInDept) {
        if (emp.records?.length) {
          const lastRec = emp.records[0];
          if (!latestDate || lastRec.date > latestDate) {
            latestDate = lastRec.date;
          }
        }
      }

      if (latestDate) {
        renderDepartmentReportForDate(departmentName, latestDate);
      } else {
        deptDataLoading.innerHTML = '<p style="text-align:center;color:#e53935;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥</p>';
        deptDataLoading.classList.remove('hidden');
        deptDataContent.classList.add('hidden');
      }

      renderDepartmentCalendar(departmentName);
      departmentReport.classList.remove('hidden');
    }

    async function renderDepartmentReportForDate(departmentName, dateStr) {
      let staff = {};
      try {
        const staffRes = await fetch('staff.json');
        if (staffRes.ok) staff = await staffRes.json();
      } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å staff.json:', e);
      }

      const staffIds = staff[departmentName] || [];
      const allUsersInDept = Object.entries(allUserData).filter(([id, user]) => user.department === departmentName);

      const staffUsers = staffIds.map(id => ({ id, data: allUserData[id] || { name: '–ë–µ–∑ –∏–º–µ–Ω–∏' } }));
      const presentUsers = allUsersInDept.map(([id, data]) => ({ id, data }));

      const allEmployees = [...staffUsers];
      const staffIdSet = new Set(staffIds);
      presentUsers.forEach(emp => {
        if (!staffIdSet.has(emp.id)) allEmployees.push(emp);
      });

      let presentCount = 0;
      const presentLines = [];
      const absentLines = [];

      for (const { id, data } of allEmployees) {
        const record = data.records?.find(r => r.date === dateStr);
        const name = data.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';

        if (record) {
          presentCount++;
          const worked = record.worked || '00:00';
          const planned = record.planned || '08:00';
          const efficiency = record.efficiency ? record.efficiency.replace('%', '') : '0';
          const pay = record.payDay || '0,00 ‚ÇΩ';

          let formattedPay = pay;
          if (typeof pay === 'string') {
            const cleanPay = pay.replace(/[^\d,.-]/g, '').replace(',', '.');
            const num = parseFloat(cleanPay);
            if (!isNaN(num)) {
              formattedPay = num.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB', minimumFractionDigits: 2 });
            }
          }

          const effNum = parseFloat(efficiency.replace(',', '.')) || 0;
          let effColor = '';
          if (effNum > 100) effColor = 'color:green;';
          else if (effNum < 70) effColor = 'color:#e53935;';

          const line = `<span style="font-weight:bold;">${name}</span> - ${worked} / ${planned} <span style="${effColor}">(${efficiency}%)</span> ${formattedPay}`;
          presentLines.push(line);
        } else {
          const line = `<span style="font-weight:bold; color:#e53935;">${name} - ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª</span>`;
          absentLines.push(line);
        }
      }

      const totalStaff = allEmployees.length;
      const absentCount = totalStaff - presentCount;
      const attendancePercent = totalStaff > 0 ? ((presentCount / totalStaff) * 100).toFixed(1) : '0';

      const [day, month, year] = dateStr.split('.').map(Number);
      const dateObj = new Date(year, month - 1, day);
      const days = ['–≤—Å', '–ø–Ω', '–≤—Ç', '—Å—Ä', '—á—Ç', '–ø—Ç', '—Å–±'];
      const dayName = days[dateObj.getDay()];
      const months = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è', '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];
      const formattedDate = `${dayName}, ${day} ${months[month - 1]} ${year}`;

      document.getElementById('dept-report-date').textContent = `–û—Ç—á—ë—Ç –Ω–∞ –¥–∞—Ç—É - ${formattedDate}`;
      document.getElementById('dept-attendance').textContent = `–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ - ${totalStaff} —á–µ–ª.\n–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç - ${absentCount} —á–µ–ª.`;
      document.getElementById('dept-attendance-percent').textContent = `üìä –ü—Ä–æ—Ü–µ–Ω—Ç —è–≤–∫–∏: ${presentCount} –∏–∑ ${totalStaff} (${attendancePercent}%)`;

      const allLines = [
        ...absentLines,
        absentLines.length > 0 ? '<hr style="border:0; border-top:1px solid #ddd; margin:10px 0;">' : '',
        ...presentLines
      ];
      document.getElementById('dept-employees-list').innerHTML = allLines.join('<br>');

      const validRecords = presentLines.length;
      const totalEfficiency = presentLines.reduce((sum, line) => {
        const match = line.match(/\((\d+,\d+)%\)/);
        if (match) {
          const eff = parseFloat(match[1].replace(',', '.'));
          return sum + eff;
        }
        return sum;
      }, 0);
      const avgEfficiency = validRecords > 0 ? (totalEfficiency / validRecords).toFixed(2).replace('.', ',') : '0,00';
      document.getElementById('dept-avg-efficiency').textContent = `üìä –°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã: ${avgEfficiency}%`;

      deptDataLoading.classList.add('hidden');
      deptDataContent.classList.remove('hidden');
      deptLastUpdate.textContent = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}`;
    }

    function renderDepartmentCalendar(departmentName) {
      deptCalendarLoading.classList.remove('hidden');
      deptCalendarContent.classList.add('hidden');

      const allDates = new Set();
      const employeesInDept = Object.values(allUserData).filter(user => user.department === departmentName);
      for (const emp of employeesInDept) {
        if (emp.records?.length) {
          for (const rec of emp.records) {
            if (rec.date) allDates.add(rec.date);
          }
        }
      }

      if (allDates.size === 0) {
        deptCalendarLoading.innerHTML = '<p style="text-align:center;color:var(--tg-hint-color);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        return;
      }

      const monthMap = {};
      for (const dateStr of allDates) {
        const [d, m, y] = dateStr.split('.').map(Number);
        const monthKey = `${y}-${String(m).padStart(2, '0')}`;
        if (!monthMap[monthKey]) monthMap[monthKey] = [];
        monthMap[monthKey].push(dateStr);
      }

      deptAvailableMonths = Object.keys(monthMap).sort((a, b) => {
        const [y1, m1] = a.split('-').map(Number);
        const [y2, m2] = b.split('-').map(Number);
        return y2 - y1 || m2 - m1;
      });

      if (deptAvailableMonths.length === 0) {
        deptCalendarLoading.innerHTML = '<p style="text-align:center;color:var(--tg-hint-color);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        return;
      }

      deptCurrentMonthIndex = 0;
      const [yearStr, monthStr] = deptAvailableMonths[deptCurrentMonthIndex].split('-');
      const year = Number(yearStr);
      const month = Number(monthStr);
      const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
      deptCurrentMonthSpan.textContent = `${monthNames[month - 1]} ${year}`;
      deptPrevMonthBtn.disabled = deptCurrentMonthIndex === deptAvailableMonths.length - 1;
      deptNextMonthBtn.disabled = deptCurrentMonthIndex === 0;

      renderDeptCalendarGrid(year, month, monthMap[deptAvailableMonths[deptCurrentMonthIndex]]);
    }

    function renderDeptCalendarGrid(year, monthNum, datesArray) {
      deptCalendar.innerHTML = '';

      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –¥–Ω—è–º–∏ –Ω–µ–¥–µ–ª–∏
      const headerRow = document.createElement('div');
      headerRow.style.display = 'grid';
      headerRow.style.gridTemplateColumns = 'repeat(7, 1fr)';
      headerRow.style.gap = '4px';
      headerRow.style.padding = '8px 0';
      headerRow.style.backgroundColor = '#f0f0f0';
      headerRow.style.borderBottom = '1px solid #ddd';

      const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
      dayNames.forEach(day => {
        const el = document.createElement('div');
        el.textContent = day;
        el.style.fontWeight = 'bold';
        el.style.textAlign = 'center';
        el.style.padding = '6px';
        headerRow.appendChild(el);
      });
      deptCalendar.appendChild(headerRow);

      // –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞
      const firstDay = new Date(year, monthNum - 1, 1);
      const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
      const lastDayNum = new Date(year, monthNum, 0).getDate();

      const availableDays = new Set();
      if (datesArray && Array.isArray(datesArray)) {
        datesArray.forEach(dateStr => {
          const day = dateStr.split('.')[0];
          availableDays.add(day);
        });
      }

      // –°–æ–∑–¥–∞—ë–º —Å—Ç—Ä–æ–∫–∏ –ø–æ 7 –¥–Ω–µ–π
      let row = document.createElement('div');
      row.style.display = 'grid';
      row.style.gridTemplateColumns = 'repeat(7, 1fr)';
      row.style.gap = '4px';
      row.style.padding = '4px 0';

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—É—Å—Ç—ã–º–∏ —è—á–µ–π–∫–∞–º–∏ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞
      for (let i = 0; i < startDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.style.height = '36px';
        emptyCell.style.backgroundColor = '#fff';
        row.appendChild(emptyCell);
      }

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–Ω–∏ –º–µ—Å—è—Ü–∞
      for (let day = 1; day <= lastDayNum; day++) {
        const cell = document.createElement('div');
        cell.textContent = day;
        cell.style.height = '36px';
        cell.style.textAlign = 'center';
        cell.style.padding = '6px';
        cell.style.fontSize = '14px';
        cell.style.cursor = 'pointer';

        const dayStr = String(day).padStart(2, '0');
        if (availableDays.has(dayStr)) {
          cell.style.backgroundColor = '#1a8cd8';
          cell.style.color = 'white';
          cell.style.fontWeight = 'bold';
          cell.title = '–ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ';
          cell.addEventListener('click', () => loadDepartmentRecordByDate(year, monthNum, day));
        } else {
          cell.style.backgroundColor = '#f5f5f5';
          cell.style.color = '#666';
          cell.style.fontWeight = 'normal';
        }

        row.appendChild(cell);

        // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
        if ((day + startDay) % 7 === 0 || day === lastDayNum) {
          deptCalendar.appendChild(row);
          row = document.createElement('div');
          row.style.display = 'grid';
          row.style.gridTemplateColumns = 'repeat(7, 1fr)';
          row.style.gap = '4px';
          row.style.padding = '4px 0';
        }
      }

      // –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞ –Ω–µ–ø–æ–ª–Ω–∞—è ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —è—á–µ–π–∫–∏ –ø—É—Å—Ç—ã–º–∏
      const remainingCells = 7 - ((lastDayNum + startDay) % 7);
      if (remainingCells > 0 && remainingCells < 7) {
        for (let i = 0; i < remainingCells; i++) {
          const emptyCell = document.createElement('div');
          emptyCell.style.height = '36px';
          emptyCell.style.backgroundColor = '#fff';
          row.appendChild(emptyCell);
        }
        deptCalendar.appendChild(row);
      }

      deptCalendarLoading.classList.add('hidden');
      deptCalendarContent.classList.remove('hidden');
    }

    function loadDepartmentRecordByDate(year, month, day) {
      const dateStr = `${String(day).padStart(2, '0')}.${String(month).padStart(2, '0')}.${year}`;
      renderDepartmentReportForDate(currentManagerDepartment, dateStr);
    }

    deptPrevMonthBtn.addEventListener('click', () => {
      if (deptCurrentMonthIndex < deptAvailableMonths.length - 1) {
        deptCurrentMonthIndex++;
        const [yearStr, monthStr] = deptAvailableMonths[deptCurrentMonthIndex].split('-');
        const year = Number(yearStr);
        const month = Number(monthStr);
        deptCurrentMonthSpan.textContent = `${monthNames[month - 1]} ${year}`;
        deptPrevMonthBtn.disabled = deptCurrentMonthIndex === deptAvailableMonths.length - 1;
        deptNextMonthBtn.disabled = deptCurrentMonthIndex === 0;
        const dates = {};
        const deptKey = deptAvailableMonths[deptCurrentMonthIndex];
        const employeesInDept = Object.values(allUserData).filter(user => user.department === currentManagerDepartment);
        employeesInDept.forEach(emp => {
          emp.records?.forEach(rec => {
            const [d, m, y] = rec.date.split('.').map(Number);
            const key = `${y}-${String(m).padStart(2, '0')}`;
            if (key === deptKey) {
              if (!dates[deptKey]) dates[deptKey] = [];
              dates[deptKey].push(rec.date);
            }
          });
        });
        renderDeptCalendarGrid(year, month, dates[deptKey] || []);
      }
    });

    deptNextMonthBtn.addEventListener('click', () => {
      if (deptCurrentMonthIndex > 0) {
        deptCurrentMonthIndex--;
        const [yearStr, monthStr] = deptAvailableMonths[deptCurrentMonthIndex].split('-');
        const year = Number(yearStr);
        const month = Number(monthStr);
        deptCurrentMonthSpan.textContent = `${monthNames[month - 1]} ${year}`;
        deptPrevMonthBtn.disabled = deptCurrentMonthIndex === deptAvailableMonths.length - 1;
        deptNextMonthBtn.disabled = deptCurrentMonthIndex === 0;
        const dates = {};
        const deptKey = deptAvailableMonths[deptCurrentMonthIndex];
        const employeesInDept = Object.values(allUserData).filter(user => user.department === currentManagerDepartment);
        employeesInDept.forEach(emp => {
          emp.records?.forEach(rec => {
            const [d, m, y] = rec.date.split('.').map(Number);
            const key = `${y}-${String(m).padStart(2, '0')}`;
            if (key === deptKey) {
              if (!dates[deptKey]) dates[deptKey] = [];
              dates[deptKey].push(rec.date);
            }
          });
        });
        renderDeptCalendarGrid(year, month, dates[deptKey] || []);
      }
    });

    function showBanner(message, type = 'info', duration = 5000) {
      banner.textContent = message;
      banner.className = `banner show ${type}`;
      if (duration > 0) {
        setTimeout(() => {
          banner.classList.remove('show');
        }, duration);
      }
    }

    function showError(msg) {
      document.body.innerHTML = `<div class="error">${msg}</div>`;
    }

    window.onload = init;
  </script>
</body>
</html>
