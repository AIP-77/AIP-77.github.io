<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–î–∏–∞–≥—Ä–∞–º–º–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏</title>

  <!-- Frapp√© Gantt v0.6.3 ‚Äî —á–µ—Ä–µ–∑ jsDelivr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.3/dist/frappe-gantt.css">
  <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.3/dist/frappe-gantt.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    .controls { margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    label { font-weight: bold; }
    select, button { padding: 6px; font-size: 14px; }
    button { cursor: pointer; }
    #gantt-container {
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      min-height: 300px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<h2>1–î–∏–∞–≥—Ä–∞–º–º–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>

<div class="controls">
  <label for="dateSelect">–î–∞—Ç–∞:</label>
  <select id="dateSelect"></select>

  <label for="employeeSelect">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
  <select id="employeeSelect"></select>

  <button onclick="renderGantt()">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button>
</div>

<div id="gantt-container"></div>

<script>
  let allData = [];

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  function parseDate(dateStr) {
    const [d, m, y] = dateStr.split('.').map(Number);
    return new Date(y, m - 1, d);
  }

  function timeToMs(timeStr) {
    if (!timeStr || timeStr === "") return null;
    const [h, m, s] = timeStr.split(':').map(Number);
    return (h || 0) * 3600000 + (m || 0) * 60000 + (s || 0) * 1000;
  }

  function buildDateTime(datePart, timePart) {
    const date = parseDate(datePart);
    const ms = timeToMs(timePart);
    if (ms === null) return null;
    date.setHours(0, 0, 0, 0);
    date.setTime(date.getTime() + ms);
    return date;
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  fetch('fullData.json')
    .then(res => {
      if (!res.ok) throw new Error('fullData.json –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return res.json();
    })
    .then(data => {
      allData = data.records || [];
      populateFilters();
    })
    .catch(err => {
      console.error('–û—à–∏–±–∫–∞:', err);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å fullData.json\n' + err.message);
    });

  function populateFilters() {
    const dates = [...new Set(allData.map(x => x['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å']))].sort();
    const emps = [...new Set(allData.map(x => x['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']))].sort();

    const ds = document.getElementById('dateSelect');
    dates.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d; opt.textContent = d;
      ds.appendChild(opt);
    });

    const es = document.getElementById('employeeSelect');
    emps.forEach(e => {
      const opt = document.createElement('option');
      opt.value = e; opt.textContent = e;
      es.appendChild(opt);
    });
  }

  function renderGantt() {
    // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê
    if (typeof Gantt === 'undefined') {
      alert('–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Gantt –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞.');
      console.error('Gantt is not defined. Script may have failed to load.');
      return;
    }

    const date = document.getElementById('dateSelect').value;
    const emp = document.getElementById('employeeSelect').value;

    const filtered = allData.filter(x =>
      x['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === date && x['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'] === emp
    );

    if (filtered.length === 0) {
      alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
      return;
    }

    const tasks = filtered.map((item, i) => {
      const start = buildDateTime(date, item['–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏']);
      const dur = item['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è'] || item['–í—Ä–µ–º—è –ø–æ —Ç–∞–±–µ–ª—é'] || '';
      const durMs = timeToMs(dur);

      if (!start || durMs === null) {
        console.warn('–ü—Ä–æ–ø—É—â–µ–Ω–∞ –∑–∞–¥–∞—á–∞:', item);
        return null;
      }

      const end = new Date(start.getTime() + durMs);

      return {
        id: `task-${i}`,
        name: `${item['–í–∏–¥ —Ä–∞–±–æ—Ç']} (${item['–ü–æ—Å—Ç–∞–≤–∫–∞']})`,
        start: start.toISOString().slice(0, 19).replace('T', ' '),
        end: end.toISOString().slice(0, 19).replace('T', ' '),
        progress: 100,
        dependencies: ''
      };
    }).filter(Boolean);

    if (tasks.length === 0) {
      alert('–ù–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–∞–¥–∞—á –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
      return;
    }

    // –û—á–∏—Å—Ç–∫–∞
    const container = document.getElementById('gantt-container');
    container.innerHTML = '';

    // –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã
    try {
      const gantt = new Gantt("#gantt-container", tasks, {
        view_mode: 'Hour',
        bar_height: 24,
        padding: 20,
        date_format: 'YYYY-MM-DD HH:mm:ss'
      });
      window.currentGantt = gantt;
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Gantt:', err);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É: ' + err.message);
    }
  }
</script>

</body>
</html>
