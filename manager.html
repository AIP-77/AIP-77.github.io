<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Диаграмма занятости</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-timeline@0.5.0"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    .controls {
      margin-bottom: 20px;
    }
    label {
      display: inline-block;
      margin-right: 10px;
    }
    select, input {
      padding: 6px;
      margin-right: 15px;
    }
    canvas {
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<h2>Диаграмма занятости сотрудника</h2>

<div class="controls">
  <label for="dateSelect">Дата:</label>
  <select id="dateSelect"></select>

  <label for="employeeSelect">Сотрудник:</label>
  <select id="employeeSelect"></select>

  <button onclick="renderGantt()">Построить</button>
</div>

<canvas id="ganttChart" height="150"></canvas>

<script>
  let allData = [];

  // Функция для парсинга времени вида "чч:мм:сс" → миллисекунды с начала дня
  function parseTime(timeStr) {
    if (!timeStr || timeStr === "") return null;
    const [h, m, s] = timeStr.split(':').map(Number);
    return h * 3600000 + m * 60000 + s * 1000;
  }

  // Функция для сложения времени начала и продолжительности
  function addDuration(startTimeStr, durationStr) {
    const startMs = parseTime(startTimeStr);
    const durMs = parseTime(durationStr);
    if (startMs === null || durMs === null) return null;
    return startMs + durMs;
  }

  // Загрузка данных
  fetch('fullData.json')
    .then(res => res.json())
    .then(data => {
      allData = data.records;
      populateFilters();
    })
    .catch(err => {
      console.error('Ошибка загрузки данных:', err);
      alert('Не удалось загрузить данные');
    });

  // Заполнение выпадающих списков
  function populateFilters() {
    const dateSet = new Set();
    const employeeSet = new Set();

    allData.forEach(item => {
      dateSet.add(item['Рабочий день']);
      employeeSet.add(item['Сотрудник']);
    });

    const dateSelect = document.getElementById('dateSelect');
    dateSet.forEach(date => {
      const opt = document.createElement('option');
      opt.value = date;
      opt.textContent = date;
      dateSelect.appendChild(opt);
    });

    const empSelect = document.getElementById('employeeSelect');
    employeeSet.forEach(emp => {
      const opt = document.createElement('option');
      opt.value = emp;
      opt.textContent = emp;
      empSelect.appendChild(opt);
    });
  }

  // Отрисовка диаграммы
  function renderGantt() {
    const selectedDate = document.getElementById('dateSelect').value;
    const selectedEmployee = document.getElementById('employeeSelect').value;

    const filtered = allData.filter(item =>
      item['Рабочий день'] === selectedDate &&
      item['Сотрудник'] === selectedEmployee
    );

    if (filtered.length === 0) {
      alert('Нет данных для выбранной даты и сотрудника');
      return;
    }

    const tasks = filtered.map(item => {
      const start = parseTime(item['Начало задачи']);
      const durationFromWorkTime = item['Рабочее время'] && item['Рабочее время'] !== "" ? item['Рабочее время'] : null;
      const durationFromTabel = item['Время по табелю'] && item['Время по табелю'] !== "" ? item['Время по табелю'] : null;
      const duration = durationFromWorkTime || durationFromTabel;

      if (start === null || duration === null) {
        console.warn('Пропущена задача из-за отсутствия времени:', item);
        return null;
      }

      const end = addDuration(item['Начало задачи'], duration);
      const label = `${item['Вид работ']} (${item['Поставка']})`;

      return {
        label: label,
        start: start,
        end: end
      };
    }).filter(Boolean); // убираем null

    if (tasks.length === 0) {
      alert('Нет корректных задач для отображения');
      return;
    }

    const ctx = document.getElementById('ganttChart').getContext('2d');

    // Уничтожаем предыдущий график, если есть
    if (window.myGanttChart) {
      window.myGanttChart.destroy();
    }

    window.myGanttChart = new Chart(ctx, {
      type: 'timeline',
      data: {
        datasets: [{
          label: 'Задачи',
          data: tasks,
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'time',
            time: {
              parser: 'HH:mm:ss',
              unit: 'hour',
              displayFormats: {
                hour: 'HH:mm'
              }
            },
            title: {
              display: true,
              text: 'Время'
            }
          },
          y: {
            ticks: {
              autoSkip: false
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const task = context.raw;
                const start = new Date(task.start);
                const end = new Date(task.end);
                const durationMs = task.end - task.start;
                const durHours = Math.floor(durationMs / 3600000);
                const durMins = Math.floor((durationMs % 3600000) / 60000);
                const durSecs = Math.floor((durationMs % 60000) / 1000);
                const durStr = `${String(durHours).padStart(2, '0')}:${String(durMins).padStart(2, '0')}:${String(durSecs).padStart(2, '0')}`;
                return [
                  `Начало: ${start.toTimeString().slice(0, 8)}`,
                  `Окончание: ${end.toTimeString().slice(0, 8)}`,
                  `Продолжительность: ${durStr}`
                ];
              }
            }
          }
        }
      }
    });
  }
</script>

</body>
</html>
