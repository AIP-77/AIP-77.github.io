<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Статистика работ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      background: #f9f9f9;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
    }
    select, button {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .mode-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .mode-toggle button {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      background: #fff;
    }
    .mode-toggle button.active {
      background: #e3f2fd;
      border-color: #2196f3;
      color: #1976d2;
      font-weight: bold;
    }
    .report {
      margin-top: 20px;
      padding: 15px;
      background: #f0f8ff;
      border-radius: 6px;
    }
    .report h3 {
      margin-top: 0;
    }
    .report-item {
      margin: 8px 0;
    }
    .hourly-group {
      margin: 12px 0;
      padding: 10px;
      background: #e3f2fd;
      border-radius: 4px;
    }
    .hourly-subitem {
      margin-left: 20px;
      padding: 5px 0;
    }
    .hidden {
      display: none;
    }
    .loading {
      text-align: center;
      color: #666;
    }
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Статистика работ</h2>
    <h3>v 10.09-1558</h3>
    <div id="loading" class="loading">Загрузка данных...</div>
    <div id="error" class="error hidden"></div>

    <div id="controls" class="hidden">
      <label for="date-select">Выберите день:</label>
      <select id="date-select"></select>

      <label for="work-type-select">Выберите виды работ:</label>
      <select id="work-type-select" multiple size="5">
        <!-- Заполняется динамически -->
      </select>
      <button id="select-all">Выбрать все</button>
      <button id="clear-all">Очистить выбор</button>

      <label>Режим отображения:</label>
      <div class="mode-toggle">
        <button id="mode-shift">За смену</button>
        <button id="mode-hourly">По часам</button>
        <button id="mode-hourly-detail">Детализация по часам</button>
      </div>

      <div id="report" class="report hidden"></div>
    </div>
  </div>

<script>
  const DATA_URL = 'https://raw.githubusercontent.com/AIP-77/AIP-77.github.io/refs/heads/main/fullData.json';

  function parseTime(timeStr) {
    if (!timeStr) return 0;
    const parts = timeStr.split(':').map(Number);
    if (parts.length !== 3) return 0;
    const [h, m, s] = parts;
    return (h || 0) * 3600 + (m || 0) * 60 + (s || 0);
  }

  function formatTime(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
  }

  function parseCurrency(str) {
    if (!str || typeof str !== 'string') return 0;
    let clean = str.trim().replace(/^р\.\s*/i, '');
    clean = clean.replace(',', '.');
    const num = parseFloat(clean);
    return isNaN(num) ? 0 : num;
  }

  function getHourFromTime(timeStr) {
    if (!timeStr) return null;
    const [h] = timeStr.split(':');
    return parseInt(h) || 0;
  }

  function isResponsible(position) {
    return position === 'Ответственный' || position === 'Ответсвенный';
  }

  let records = [];
  let selectedDate = '';
  let selectedWorkTypes = new Set();
  let mode = 'shift';

  const loadingDiv = document.getElementById('loading');
  const errorDiv = document.getElementById('error');
  const controlsDiv = document.getElementById('controls');
  const dateSelect = document.getElementById('date-select');
  const workTypeSelect = document.getElementById('work-type-select');
  const selectAllBtn = document.getElementById('select-all');
  const clearAllBtn = document.getElementById('clear-all');
  const modeShiftBtn = document.getElementById('mode-shift');
  const modeHourlyBtn = document.getElementById('mode-hourly');
  const modeHourlyDetailBtn = document.getElementById('mode-hourly-detail');
  const reportDiv = document.getElementById('report');

  async function loadData() {
    try {
      const response = await fetch(DATA_URL);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      if (!Array.isArray(data.records)) throw new Error('Неверный формат данных: records не массив');
      records = data.records;
      initUI();
    } catch (err) {
      console.error('Ошибка загрузки данных:', err);
      loadingDiv.classList.add('hidden');
      errorDiv.textContent = `Не удалось загрузить данные: ${err.message}`;
      errorDiv.classList.remove('hidden');
    }
  }

  function initUI() {
    loadingDiv.classList.add('hidden');
    errorDiv.classList.add('hidden');
    controlsDiv.classList.remove('hidden');

    const uniqueDates = [...new Set(records.map(r => r['Рабочий день']))].filter(Boolean).sort();
    const uniqueWorkTypes = [...new Set(records.map(r => r['Вид работ']))].filter(Boolean).sort();

    if (uniqueDates.length === 0) {
      errorDiv.textContent = 'Нет данных о рабочих днях';
      errorDiv.classList.remove('hidden');
      return;
    }

    dateSelect.innerHTML = '';
    uniqueDates.forEach(date => {
      const opt = document.createElement('option');
      opt.value = date;
      opt.textContent = date;
      dateSelect.appendChild(opt);
    });

    workTypeSelect.innerHTML = '';
    uniqueWorkTypes.forEach(type => {
      const opt = document.createElement('option');
      opt.value = type;
      opt.textContent = type;
      workTypeSelect.appendChild(opt);
    });

    selectedDate = uniqueDates[0];
    dateSelect.value = selectedDate;

    dateSelect.addEventListener('change', () => {
      selectedDate = dateSelect.value;
      renderReport();
    });

    workTypeSelect.addEventListener('change', () => {
      selectedWorkTypes.clear();
      Array.from(workTypeSelect.selectedOptions).forEach(opt => {
        selectedWorkTypes.add(opt.value);
      });
      renderReport();
    });

    selectAllBtn.addEventListener('click', () => {
      Array.from(workTypeSelect.options).forEach(opt => opt.selected = true);
      selectedWorkTypes = new Set(Array.from(workTypeSelect.selectedOptions).map(o => o.value));
      renderReport();
    });

    clearAllBtn.addEventListener('click', () => {
      Array.from(workTypeSelect.options).forEach(opt => opt.selected = false);
      selectedWorkTypes.clear();
      renderReport();
    });

    const updateModeButtons = () => {
      modeShiftBtn.classList.toggle('active', mode === 'shift');
      modeHourlyBtn.classList.toggle('active', mode === 'hourly');
      modeHourlyDetailBtn.classList.toggle('active', mode === 'hourly-detail');
    };

    modeShiftBtn.addEventListener('click', () => {
      mode = 'shift';
      updateModeButtons();
      renderReport();
    });
    modeHourlyBtn.addEventListener('click', () => {
      mode = 'hourly';
      updateModeButtons();
      renderReport();
    });
    modeHourlyDetailBtn.addEventListener('click', () => {
      mode = 'hourly-detail';
      updateModeButtons();
      renderReport();
    });

    updateModeButtons();
    renderReport();
  }

  function renderReport() {
    if (!selectedDate || selectedWorkTypes.size === 0) {
      reportDiv.classList.add('hidden');
      return;
    }

    // Все записи за выбранный день и виды работ
    const allRecords = records.filter(r =>
      r['Рабочий день'] === selectedDate &&
      selectedWorkTypes.has(r['Вид работ'])
    );

    // Только ответственные — для итогов по единицам, времени, количеству задач
    const responsibleRecords = allRecords.filter(r => isResponsible(r['Должность']));

    if (allRecords.length === 0) {
      reportDiv.innerHTML = '<p>Нет данных по выбранным критериям.</p>';
      reportDiv.classList.remove('hidden');
      return;
    }

    let html = `<h3>Отчёт за ${selectedDate}</h3>`;

    if (mode === 'shift') {
      // Итоги за смену
      let totalUnits = 0;
      let totalTimeSec = 0;
      let totalTasks = 0;
      let totalAmount = 0; // ← включает ВСЕХ (и Сотрудников)

      responsibleRecords.forEach(r => {
        totalUnits += parseInt(r['Количество единиц']) || 0;
        totalTimeSec += parseTime(r['Рабочее время']);
        totalTasks++;
      });

      allRecords.forEach(r => {
        totalAmount += parseCurrency(r['Расчетная сумма']);
      });

      html += `
        <div class="report-item"><strong>Всего задач:</strong> ${totalTasks}</div>
        <div class="report-item"><strong>Всего единиц:</strong> ${totalUnits}</div>
        <div class="report-item"><strong>Общая сумма:</strong> р.${totalAmount.toFixed(2)}</div>
        <div class="report-item"><strong>Общее время:</strong> ${formatTime(totalTimeSec)}</div>
        <div class="report-item"><strong>Средняя расценка:</strong> р.${(totalAmount / (totalUnits || 1)).toFixed(2)} за ед.</div>
      `;
    } else if (mode === 'hourly' || mode === 'hourly-detail') {
      // Группировка по часам
      const hourlyGroups = {};

      // Проходим по ВСЕМ записям, чтобы собрать данные по часам
      allRecords.forEach(r => {
        const hour = getHourFromTime(r['Начало задачи']);
        if (hour === null) return;

        const key = `${hour.toString().padStart(2, '0')}-${(hour + 1).toString().padStart(2, '0')}`;
        if (!hourlyGroups[key]) {
          hourlyGroups[key] = {
            hours: key,
            // Итоги по ответственным
            responsibleCount: 0,
            responsibleUnits: 0,
            responsibleTimeSec: 0,
            // Сумма — от всех
            totalAmount: 0,
            // Все сотрудники для детализации
            employees: []
          };
        }

        const group = hourlyGroups[key];

        // Сумма от всех
        group.totalAmount += parseCurrency(r['Расчетная сумма']);

        // Если ответственный — учитываем в итогах
        if (isResponsible(r['Должность'])) {
          group.responsibleCount++;
          group.responsibleUnits += parseInt(r['Количество единиц']) || 0;
          group.responsibleTimeSec += parseTime(r['Рабочее время']);
        }

        // Для детализации — добавляем всех
        if (mode === 'hourly-detail') {
          group.employees.push({
            name: r['Сотрудник'],
            position: r['Должность'],
            units: parseInt(r['Количество единиц']) || 0,
            amount: parseCurrency(r['Расчетная сумма']),
            timeSec: parseTime(r['Рабочее время'])
          });
        }
      });

      const sortedHours = Object.keys(hourlyGroups).sort();

      html += `<p><em>Режим "${mode === 'hourly' ? 'По часам' : 'Детализация по часам'}"</em></p>`;

      sortedHours.forEach(hourKey => {
        const g = hourlyGroups[hourKey];
        html += `
          <div class="hourly-group">
            <strong>Часовой интервал: ${hourKey}</strong>
            <div class="report-item">Количество задач: ${g.responsibleCount}</div>
            <div class="report-item">Единиц: ${g.responsibleUnits}</div>
            <div class="report-item">Сумма: р.${g.totalAmount.toFixed(2)}</div>
            <div class="report-item">Время: ${formatTime(g.responsibleTimeSec)}</div>
        `;

        if (mode === 'hourly-detail') {
          html += `<div class="report-item"><strong>По сотрудникам:</strong></div>`;
          g.employees.forEach(emp => {
            const posLabel = emp.position === 'Сотрудник' ? 'Сотрудник' : 'Ответственный';
            html += `
              <div class="hourly-subitem">
                <span>${emp.name} (${posLabel})</span> — 
                <span>ед.: ${emp.units}</span>, 
                <span>сумма: р.${emp.amount.toFixed(2)}</span>, 
                <span>время: ${formatTime(emp.timeSec)}</span>
              </div>
            `;
          });
        }

        html += `</div>`;
      });
    }

    reportDiv.innerHTML = html;
    reportDiv.classList.remove('hidden');
  }

  loadData();
</script>
</body>
</html>
