<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Диаграмма занятости сотрудника</title>

  <!-- Frappé Gantt v0.6.3 — работает с глобальным Gantt -->
  <link rel="stylesheet" href="https://unpkg.com/frappe-gantt@0.6.3/dist/frappe-gantt.css">
  <script src="https://unpkg.com/frappe-gantt@0.6.3/dist/frappe-gantt.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    label {
      font-weight: bold;
    }
    select, input, button {
      padding: 6px;
      font-size: 14px;
    }
    button {
      cursor: pointer;
    }
    #gantt-container {
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      min-height: 300px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<h2>Диаграмма занятости сотрудника</h2>

<div class="controls">
  <label for="dateSelect">Дата:</label>
  <select id="dateSelect"></select>

  <label for="employeeSelect">Сотрудник:</label>
  <select id="employeeSelect"></select>

  <button onclick="renderGantt()">Построить</button>
</div>

<div id="gantt-container"></div>

<script>
  let allData = [];

  // Преобразуем "30.09.2025" → Date
  function parseDate(dateStr) {
    const [day, month, year] = dateStr.split('.').map(Number);
    return new Date(year, month - 1, day); // month is 0-based
  }

  // Парсинг времени "ч:мм:сс" → миллисекунды с начала дня
  function parseTimeMs(timeStr) {
    if (!timeStr || timeStr === "") return null;
    const parts = timeStr.split(':').map(Number);
    let h = parts[0], m = parts[1] || 0, s = parts[2] || 0;
    return h * 3600000 + m * 60000 + s * 1000;
  }

  // Создаём полную дату: дата + время
  function buildDateTime(dateStr, timeStr) {
    if (!timeStr) return null;
    const baseDate = parseDate(dateStr);
    const timeMs = parseTimeMs(timeStr);
    if (timeMs === null) return null;
    const result = new Date(baseDate);
    result.setHours(0, 0, 0, 0); // сброс времени
    result.setTime(result.getTime() + timeMs);
    return result;
  }

  // Загрузка данных
  fetch('fullData.json')
    .then(res => res.json())
    .then(data => {
      allData = data.records;
      populateFilters();
    })
    .catch(err => {
      console.error('Ошибка загрузки данных:', err);
      alert('Не удалось загрузить fullData.json');
    });

  function populateFilters() {
    const dates = [...new Set(allData.map(d => d['Рабочий день']))].sort();
    const employees = [...new Set(allData.map(d => d['Сотрудник']))].sort();

    const dateSel = document.getElementById('dateSelect');
    dates.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d;
      opt.textContent = d;
      dateSel.appendChild(opt);
    });

    const empSel = document.getElementById('employeeSelect');
    employees.forEach(e => {
      const opt = document.createElement('option');
      opt.value = e;
      opt.textContent = e;
      empSel.appendChild(opt);
    });
  }

  function renderGantt() {
    const date = document.getElementById('dateSelect').value;
    const emp = document.getElementById('employeeSelect').value;

    const tasksRaw = allData.filter(item =>
      item['Рабочий день'] === date &&
      item['Сотрудник'] === emp
    );

    if (tasksRaw.length === 0) {
      alert('Нет данных');
      return;
    }

    const tasks = tasksRaw.map((item, i) => {
      const start = buildDateTime(date, item['Начало задачи']);
      const durationStr = item['Рабочее время'] || item['Время по табелю'] || '';
      const durationMs = parseTimeMs(durationStr);

      if (!start || durationMs === null) {
        console.warn('Пропущена задача:', item);
        return null;
      }

      const end = new Date(start.getTime() + durationMs);

      return {
        id: `t${i}`,
        name: `${item['Вид работ']} (${item['Поставка']})`,
        start: start.toISOString().slice(0, 19).replace('T', ' '),
        end: end.toISOString().slice(0, 19).replace('T', ' '),
        progress: 100,
        dependencies: ''
      };
    }).filter(Boolean);

    if (tasks.length === 0) {
      alert('Нет корректных задач');
      return;
    }

    // Очистка
    const container = document.getElementById('gantt-container');
    container.innerHTML = '';

    // Создание диаграммы
    const gantt = new Gantt("#gantt-container", tasks, {
      view_mode: 'Hour',
      bar_height: 24,
      padding: 20,
      date_format: 'YYYY-MM-DD HH:mm:ss',
      custom_popup_html: function(task) {
        const start = new Date(task.start.replace(' ', 'T'));
        const end = new Date(task.end.replace(' ', 'T'));
        const durationMin = Math.round((end - start) / 60000);
        return `
          <div style="padding:10px;">
            <strong>${task.name}</strong><br>
            Начало: ${start.toLocaleTimeString()}<br>
            Окончание: ${end.toLocaleTimeString()}<br>
            Длительность: ${durationMin} мин.
          </div>
        `;
      }
    });

    window.currentGantt = gantt;
  }
</script>

</body>
</html>
