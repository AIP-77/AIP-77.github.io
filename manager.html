<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Диаграмма занятости сотрудника</title>

  <!-- Frappé Gantt CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.7.0/dist/frappe-gantt.min.css">

  <!-- Frappé Gantt JS -->
  <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.7.0/dist/frappe-gantt.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
    }
    label {
      font-weight: bold;
    }
    select, input {
      padding: 6px;
      font-size: 14px;
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
    }
    #gantt-container {
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      min-height: 300px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<h2>Диаграмма занятости сотрудника</h2>

<div class="controls">
  <label for="dateSelect">Дата:</label>
  <select id="dateSelect"></select>

  <label for="employeeSelect">Сотрудник:</label>
  <select id="employeeSelect"></select>

  <button onclick="renderGantt()">Построить</button>
</div>

<div id="gantt-container"></div>

<script>
  let allData = [];

  // Парсинг времени "чч:мм:сс" → Date объект (в пределах одного дня)
  function parseTimeToDateTime(dateStr, timeStr) {
    if (!timeStr || timeStr === "") return null;
    const [h, m, s] = timeStr.split(':').map(Number);
    const date = new Date(dateStr); // например, "30.09.2025"
    date.setHours(h, m, s, 0);
    return date;
  }

  // Получение конца задачи
  function getTaskEnd(startDateStr, durationStr) {
    if (!durationStr || durationStr === "") return null;
    const start = parseTimeToDateTime(startDateStr, startDateStr); // используем дату из "Рабочий день"
    const [h, m, s] = durationStr.split(':').map(Number);
    const end = new Date(start);
    end.setHours(end.getHours() + h, end.getMinutes() + m, end.getSeconds() + s);
    return end;
  }

  // Загрузка данных
  fetch('fullData.json')
    .then(res => res.json())
    .then(data => {
      allData = data.records;
      populateFilters();
    })
    .catch(err => {
      console.error('Ошибка загрузки данных:', err);
      alert('Не удалось загрузить данные');
    });

  // Заполнение выпадающих списков
  function populateFilters() {
    const dateSet = new Set();
    const employeeSet = new Set();

    allData.forEach(item => {
      dateSet.add(item['Рабочий день']);
      employeeSet.add(item['Сотрудник']);
    });

    const dateSelect = document.getElementById('dateSelect');
    dateSet.forEach(date => {
      const opt = document.createElement('option');
      opt.value = date;
      opt.textContent = date;
      dateSelect.appendChild(opt);
    });

    const empSelect = document.getElementById('employeeSelect');
    employeeSet.forEach(emp => {
      const opt = document.createElement('option');
      opt.value = emp;
      opt.textContent = emp;
      empSelect.appendChild(opt);
    });
  }

  // Отрисовка диаграммы
  function renderGantt() {
    const selectedDate = document.getElementById('dateSelect').value;
    const selectedEmployee = document.getElementById('employeeSelect').value;

    const filtered = allData.filter(item =>
      item['Рабочий день'] === selectedDate &&
      item['Сотрудник'] === selectedEmployee
    );

    if (filtered.length === 0) {
      alert('Нет данных для выбранной даты и сотрудника');
      return;
    }

    // Преобразуем в формат Frappé Gantt
    const tasks = filtered.map((item, index) => {
      const start = parseTimeToDateTime(selectedDate, item['Начало задачи']);
      const durationFromWorkTime = item['Рабочее время'] && item['Рабочее время'] !== "" ? item['Рабочее время'] : null;
      const durationFromTabel = item['Время по табелю'] && item['Время по табелю'] !== "" ? item['Время по табелю'] : null;
      const duration = durationFromWorkTime || durationFromTabel;

      if (!start || !duration) {
        console.warn('Пропущена задача из-за отсутствия времени:', item);
        return null;
      }

      const end = getTaskEnd(selectedDate, duration);

      return {
        id: `task-${index}`,
        name: `${item['Вид работ']} (${item['Поставка']})`,
        start: start,
        end: end,
        progress: 100, // можно сделать динамическим, если нужно
        dependencies: '', // не используется
        custom_class: 'task-' + index % 5 // простой способ разного цвета
      };
    }).filter(Boolean); // убираем null

    if (tasks.length === 0) {
      alert('Нет корректных задач для отображения');
      return;
    }

    // Очистка контейнера
    const container = document.getElementById('gantt-container');
    container.innerHTML = '';

    // Создание диаграммы
    const gantt = new Gantt("#gantt-container", tasks, {
      header_height: 50,
      column_width: 30,
      step: 24, // шаг в часах (можно изменить на 1 для минут)
      view_mode: 'Hour', // или 'Day', 'Week'
      bar_height: 20,
      bar_corner_radius: 3,
      arrow_curve: 5,
      padding: 18,
      date_format: 'DD.MM.YYYY HH:mm:ss',
      custom_popup_html: function(task) {
        return `
          <div class="details">
            <strong>${task.name}</strong><br>
            Начало: ${task.start.toLocaleString()}<br>
            Окончание: ${task.end.toLocaleString()}<br>
            Продолжительность: ${(task.end - task.start) / 60000} мин.
          </div>
        `;
      },
      on_click: function(task) {
        console.log('Clicked:', task);
      }
    });

    // Сохраняем ссылку на объект, если нужно будет обновлять
    window.currentGantt = gantt;
  }
</script>

</body>
</html>
