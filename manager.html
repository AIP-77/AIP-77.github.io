<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --tg-bg-color: #f0f2f5;
      --tg-text-color: #1c1e21;
      --tg-hint-color: #999;
      --tg-link-color: #d71923;
      --tg-button-color: #1a8cd8;
      --tg-button-text-color: #ffffff;
      --card-bg: #ffffff;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--tg-bg-color);
      color: var(--tg-text-color);
      min-height: 100vh;
    }
    .container { max-width: 600px; margin: 0 auto; }
    .card { 
      background: var(--card-bg); 
      border-radius: 12px; 
      padding: 18px; 
      margin-bottom: 14px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }
    h1 { margin: 0 0 10px 0; color: var(--tg-link-color); }
    h2, h3 { margin: 0 0 8px 0; color: var(--tg-link-color); }
    h5 { margin: 0 0 6px 0; color: var(--tg-link-color); }
    .tabs { display: flex; margin-bottom: 16px; border-bottom: 1px solid var(--tg-hint-color); }
    .tab { padding: 10px 16px; cursor: pointer; font-weight: 600; color: var(--tg-hint-color); }
    .tab.active { color: var(--tg-link-color); border-bottom: 2px solid var(--tg-link-color); }
    .loading { text-align: center; padding: 20px; color: var(--tg-hint-color); font-size: 16px; }
    .spinner { 
      width: 40px; 
      height: 40px; 
      border: 4px solid #e0e0e0; 
      border-top: 4px solid var(--tg-link-color); 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
      margin: 20px auto; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      color: #e53935; 
      text-align: center; 
      padding: 20px; 
      background: #ffebee; 
      border-radius: 8px; 
      margin: 16px 0; 
    }
    .hidden { display: none !important; }
    .calendar { 
      display: grid; 
      gap: 4px; 
      margin: 10px 0; 
      grid-template-columns: repeat(7, 1fr); 
    }
    .day { 
      text-align: center; 
      padding: 6px 0; 
      font-size: 12px; 
      border-radius: 4px; 
      color: var(--tg-text-color); 
      cursor: pointer; 
    }
    .day.available { 
      background: var(--tg-link-color); 
      color: var(--tg-button-text-color); 
      font-weight: bold; 
    }
    .day:hover { 
      background: #e0e0e0; 
    }
    .footer { 
      text-align: center; 
      margin-top: 30px; 
      color: var(--tg-hint-color); 
      font-size: 13px; 
    }
    .month-selector { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin: 10px 0; 
    }
    .month-selector button { 
      background: var(--tg-button-color); 
      color: var(--tg-button-text-color); 
      border: none; 
      padding: 8px 12px; 
      border-radius: 6px; 
      cursor: pointer; 
    }
    .month-selector span { font-weight: bold; }
    .banner {
      padding: 12px;
      margin: 12px 0;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
      display: none;
    }
    .banner.show {
      display: block;
    }
    .banner.info { background: #e3f2fd; color: #1565c0; }
    .banner.error { background: #ffebee; color: #c62828; }
    .banner.success { background: #e8f5e9; color: #2e7d32; }
    .last-update {
      font-size: 13px;
      color: var(--tg-hint-color);
      margin-top: 8px;
    }
    .refresh-btn {
      background: var(--tg-button-color);
      color: var(--tg-button-text-color);
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      display: inline-block;
    }
    .refresh-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .fade {
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    .fade.hidden {
      opacity: 0;
    }
    .clear-cache-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      margin: 10px 0;
      display: block;
      width: 100%;
      text-align: center;
    }
    .clear-cache-btn:hover {
      background: #c82333;
    }
    .version-info {
      font-size: 12px;
      color: var(--tg-hint-color);
      margin: 5px 0;
      text-align: center;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∑–∞–¥–∞—á */
    .task-group {
      margin-bottom: 12px;
      border: 1px solid var(--tg-hint-color);
      border-radius: 8px;
      overflow: hidden;
    }
    .task-group-header {
      background: var(--card-bg);
      padding: 12px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      border-bottom: 1px solid var(--tg-hint-color);
    }
    .task-group-header:hover {
      background: var(--tg-bg-color);
    }
    .task-group-content {
      background: var(--card-bg);
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .task-group.expanded .task-group-content {
      max-height: 1000px;
    }
    .task-item {
      padding: 10px 12px;
      border-bottom: 1px solid var(--tg-hint-color);
      font-size: 14px;
    }
    .task-item:last-child {
      border-bottom: none;
    }
    .task-group-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 13px;
      color: var(--tg-text-color);
      margin-top: 6px;
    }
    .task-group-summary-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .expand-icon {
      transition: transform 0.3s ease;
      font-size: 12px;
      color: var(--tg-text-color);
    }
    .task-group.expanded .expand-icon {
      transform: rotate(180deg);
    }
    .task-total {
      font-weight: bold;
      color: var(--tg-link-color);
      background: var(--tg-bg-color);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
      border: 1px solid var(--tg-hint-color);
    }
    .task-detail-row {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 13px;
    }
    .task-time-info {
      color: var(--tg-text-color);
      font-size: 12px;
      margin-top: 2px;
    }
    .task-payment-info {
      display: flex;
      gap: 12px;
      color: var(--tg-text-color);
    }
    .seasonal-bonus {
      color: #28a745;
      font-weight: 500;
    }
    .task-start-time {
      background: var(--tg-button-color);
      color: var(--tg-button-text-color);
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
    <div id="version-info" class="version-info">
      (üõ† V.11.01-2330 üõ†)
    </div>

    <div id="banner" class="banner"></div>

    <div class="tabs">
      <div id="tab-employee" class="tab active">–ú–æ–π –æ—Ç—á—ë—Ç</div>
      <div id="tab-info" class="tab hidden">‚Ñπ –ù–æ—Ä–º–∞—Ç–∏–≤—ã</div>
      <div id="tab-manager" class="tab hidden">–û—Ç–¥–µ–ª</div>
      <div id="tab-statistics" class="tab hidden">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div id="tab-admin" class="tab hidden">üë®‚Äçüíª –ê–¥–º–∏–Ω–∫–∞</div>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>
    <div id="error" class="error hidden"></div>

    <!-- –í–∫–ª–∞–¥–∫–∞ "–ú–æ–π –æ—Ç—á—ë—Ç" -->
    <div id="employee-view" class="hidden">
      <div class="card">
        <h2>üë∑‚Äç‚ôÇÔ∏è –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç</h2>
        <p id="last-update" class="last-update">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ‚Äî</p>
        <button id="refreshBtn" class="refresh-btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <h5>(üõ† –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä üõ†)</h5>
        <div id="main-data-loading" class="loading">
          <div class="spinner"></div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>
        <div id="main-data-content" class="hidden fade">
          <p><span class="label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</span> <span id="name">‚Äî</span></p>
          <p><span class="label">–û—Ç–¥–µ–ª:</span> <span id="department">‚Äî</span></p>
          <p><span class="label">–î–∞—Ç–∞:</span> <span id="date">‚Äî</span></p>
          <p><span class="label">–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ:</span> <span id="worked">‚Äî</span></p>
          <p><span class="label">–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è:</span> <span id="planned">‚Äî</span></p>
          <p><span class="label">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</span> <span id="efficiency">‚Äî</span></p>
          <p><span class="label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ –¥–µ–Ω—å:</span> <span id="pay-day">‚Äî</span></p>
          <p><span class="label">–ò–∑ –Ω–∏—Ö —Å–µ–∑–æ–Ω–Ω–∞—è –¥–æ–ø–ª–∞—Ç–∞:</span> <span id="xisBonusDay">‚Äî</span></p>
          <p><span class="label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ –º–µ—Å—è—Ü:</span> <span id="pay-month">‚Äî</span></p>
        </div>
      </div>
      <h5>üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é —Å 10 –¥–æ 11, —Å 12 –¥–æ 13 –∏ —Å 14 –¥–æ 15, –µ—Å–ª–∏ –∑–∞–º–µ—Ç–∏–ª–∏ –Ω–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ —Å–æ–æ–±—à–∏—Ç–µ –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é</h5>
      <div class="card">
        <h2>üìã –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á</h2>
        <div id="details-loading" class="loading">
          <div class="spinner"></div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏...</p>
        </div>
        <div id="details-content" class="hidden fade">
          <div id="tasks-grouped"></div>
        </div>
      </div>
      
      <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ -->
      <div class="card">
        <h2>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</h2>
        <div id="calendar-loading" class="loading">
          <div class="spinner"></div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è...</p>
        </div>
        <div id="calendar-content" class="hidden">
          <div class="month-selector">
            <button id="prevMonth">‚óÄ</button>
            <span id="currentMonth">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            <button id="nextMonth">‚ñ∂</button>
          </div>
          <div class="calendar" id="calendar"></div>
        </div>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ "–û—Ç–¥–µ–ª" -->
    <div id="manager-view" class="hidden">
      <div id="department-selector" class="card hidden">
        <h2>üë®‚Äçüíº –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</h2>
        <select id="departmentSelect" style="width:100%; padding:8px; margin:10px 0; border-radius:6px; border:1px solid #ccc;">
          <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª ‚Äî</option>
        </select>
      </div>
      <div id="department-report" class="hidden">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2>üìä –û—Ç—á—ë—Ç –ø–æ –æ—Ç–¥–µ–ª—É: <span id="dept-name">‚Äî</span></h2>
            <button id="change-department-btn" class="refresh-btn" style="padding:6px 12px;font-size:12px;">–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –æ—Ç–¥–µ–ª</button>
          </div>
          <p id="dept-last-update" class="last-update">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ‚Äî</p>
          <div id="dept-data-loading" class="loading">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–¥–µ–ª–∞...</p>
          </div>
          <div id="dept-data-content" class="hidden fade">
            <p id="dept-report-date">–û—Ç—á—ë—Ç –Ω–∞ –¥–∞—Ç—É: ‚Äî</p>
            <p id="dept-attendance">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏: ‚Äî</p>
            <p id="dept-attendance-percent">üìä –ü—Ä–æ—Ü–µ–Ω—Ç —è–≤–∫–∏: ‚Äî</p>
            <h3>üë• –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:</h3>
            <pre id="dept-employees-list" style="white-space:pre-wrap;font-family:monospace;"></pre>
            <p id="dept-avg-efficiency">üìä –°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã: ‚Äî</p>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">–°–∏—Å—Ç–µ–º–∞ –º–∞–ª–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ AIP ‚Ä¢ ¬© 09.2025</div>
  </div>
  
  <!-- –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ -->
  <button id="clearCacheBtn" class="clear-cache-btn">üóë –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
  
  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
    const DATA_SOURCES = {
      staff: 'https://AIP-77.github.io/archive/staff%20fullData.json',
      monthlyData: (year, month) => `https://AIP-77.github.io/archive/${year}-${month.toString().padStart(2, '0')}%20fullData.json`
    };

    let chatId = null;
    let isManager = false;
    let isAdmin = false;
    let currentUserData = null;
    let currentRecord = null;
    let currentMonthData = null;
    let managedDepartments = [];
    let currentManagerDepartment = null;
    let dataLastUpdated = null;
    let availableMonths = [];
    let currentMonthIndex = 0;

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const employeeView = document.getElementById('employee-view');
    const managerView = document.getElementById('manager-view');
    const banner = document.getElementById('banner');
    const versionInfo = document.getElementById('version-info');
    const tasksGrouped = document.getElementById('tasks-grouped');

    const tabEmployee = document.getElementById('tab-employee');
    const tabManager = document.getElementById('tab-manager');
    const tabInfo = document.getElementById('tab-info');
    const tabAdmin = document.getElementById('tab-admin');
    const tabStatistics = document.getElementById('tab-statistics');

    const mainDataLoading = document.getElementById('main-data-loading');
    const mainDataContent = document.getElementById('main-data-content');
    const detailsLoading = document.getElementById('details-loading');
    const detailsContent = document.getElementById('details-content');
    const calendarLoading = document.getElementById('calendar-loading');
    const calendarContent = document.getElementById('calendar-content');

    const refreshBtn = document.getElementById('refreshBtn');
    const clearCacheBtn = document.getElementById('clearCacheBtn');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const currentMonthSpan = document.getElementById('currentMonth');
    const calendar = document.getElementById('calendar');

    // === –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –†–ê–°–ß–ï–¢–ê ===
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ä—É—Å—Å–∫–∏—Ö —á–∏—Å–ª–æ–≤—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–±–µ–ª–æ–≤
    function parseRussianNumber(numberStr) {
        if (!numberStr || numberStr === '0,00 ‚ÇΩ' || numberStr === '—Ä.0,00') return 0;
        
        // –£–±–∏—Ä–∞–µ–º –≤–∞–ª—é—Ç—É –∏ –ø—Ä–æ–±–µ–ª—ã —Ç—ã—Å—è—á, –∑–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É
        const cleanStr = numberStr
            .replace(/[^\d,\s]/g, '') // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ-—Ü–∏—Ñ—Ä—ã, –∫—Ä–æ–º–µ –∑–∞–ø—è—Ç—ã—Ö –∏ –ø—Ä–æ–±–µ–ª–æ–≤
            .replace(/\s/g, '') // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã (—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ —Ç—ã—Å—è—á)
            .replace(',', '.'); // –ó–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É
        
        const result = parseFloat(cleanStr);
        return isNaN(result) ? 0 : result;
    }

    // –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ –¥–µ–Ω—å = —Å—É–º–º–∞ –≤—Å–µ—Ö "–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞" + —Å—É–º–º–∞ –≤—Å–µ—Ö "–î–æ–ø–ª–∞—Ç–∞ XIS"
    function calculateDayPay(tasks) {
        let total = 0;
        tasks.forEach(task => {
            const calculatedPay = parseRussianNumber(task['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞'] || '0');
            const xisBonus = parseRussianNumber(task['–î–æ–ø–ª–∞—Ç–∞ XIS'] || '0');
            total += (calculatedPay + xisBonus);
        });
        return total;
    }

    // –°–µ–∑–æ–Ω–Ω–∞—è –¥–æ–ø–ª–∞—Ç–∞ = —Å—É–º–º–∞ –≤—Å–µ—Ö "–î–æ–ø–ª–∞—Ç–∞ XIS"
    function calculateXisBonus(tasks) {
        let total = 0;
        tasks.forEach(task => {
            const xisBonus = parseRussianNumber(task['–î–æ–ø–ª–∞—Ç–∞ XIS'] || '0');
            total += xisBonus;
        });
        return total;
    }

    // –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ –º–µ—Å—è—Ü = —Å—É–º–º–∞ –≤—Å–µ—Ö "–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞" –∑–∞ –º–µ—Å—è—Ü + —Å—É–º–º–∞ –≤—Å–µ—Ö "–î–æ–ø–ª–∞—Ç–∞ XIS" –∑–∞ –º–µ—Å—è—Ü
    function calculateMonthlyPay(tasksByDate) {
        let total = 0;
        Object.values(tasksByDate).forEach(tasks => {
            tasks.forEach(task => {
                const calculatedPay = parseRussianNumber(task['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞'] || '0');
                const xisBonus = parseRussianNumber(task['–î–æ–ø–ª–∞—Ç–∞ XIS'] || '0');
                total += (calculatedPay + xisBonus);
            });
        });
        return total;
    }

    // === –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ì–†–£–ü–ü–ò–†–û–í–ö–ò –ó–ê–î–ê–ß ===
    function groupTasksByType(tasks) {
        const groups = {};
        
        tasks.forEach(task => {
            const workType = task['–í–∏–¥ —Ä–∞–±–æ—Ç'] || '–î—Ä—É–≥–∏–µ –≤–∏–¥—ã —Ä–∞–±–æ—Ç';
            if (!groups[workType]) {
                groups[workType] = {
                    tasks: [],
                    totalCount: 0,
                    totalTime: 0,
                    totalPay: 0,
                    totalXisBonus: 0
                };
            }
            
            const count = parseFloat(task['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü'] || '0');
            const time = task['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è'] || '00:00';
            const pay = parseRussianNumber(task['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞'] || '0');
            const xisBonus = parseRussianNumber(task['–î–æ–ø–ª–∞—Ç–∞ XIS'] || '0');
            const startTime = task['–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏'] || '--:--';
            
            groups[workType].tasks.push({
                count: count,
                time: time,
                pay: pay,
                xisBonus: xisBonus,
                startTime: startTime,
                calculatedPay: task['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞'] || '0,00 ‚ÇΩ',
                calculatedXisBonus: task['–î–æ–ø–ª–∞—Ç–∞ XIS'] || '0,00 ‚ÇΩ'
            });
            
            groups[workType].totalCount += count;
            groups[workType].totalTime += timeToSeconds(time);
            groups[workType].totalPay += (pay + xisBonus);
            groups[workType].totalXisBonus += xisBonus;
        });
        
        return groups;
    }

    // === –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ì–†–£–ü–ü–ò–†–û–í–ê–ù–ù–´–• –ó–ê–î–ê–ß ===
    function renderGroupedTasks(tasks) {
        if (!tasks || tasks.length === 0) {
            tasksGrouped.innerHTML = '<p style="text-align:center;color:var(--tg-hint-color);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
            return;
        }

        const groups = groupTasksByType(tasks);
        let html = '';

        Object.keys(groups).sort().forEach(workType => {
            const group = groups[workType];
            const totalTimeFormatted = secondsToTime(group.totalTime);
            const totalPayFormatted = formatCurrency(group.totalPay);
            const totalXisBonusFormatted = formatCurrency(group.totalXisBonus);
            
            html += `
                <div class="task-group">
                    <div class="task-group-header" onclick="toggleTaskGroup(this)">
                        <div style="flex: 1;">
                            <div>${workType}</div>
                            <div class="task-group-summary">
                                <div class="task-group-summary-item">
                                    <span>üìä</span>
                                    <span>${group.totalCount.toFixed(2)} –µ–¥.</span>
                                </div>
                                <div class="task-group-summary-item">
                                    <span>‚è±Ô∏è</span>
                                    <span>${totalTimeFormatted}</span>
                                </div>
                                <div class="task-group-summary-item">
                                    <span>üí∞</span>
                                    <span class="task-total">${totalPayFormatted}</span>
                                </div>
                                ${group.totalXisBonus > 0 ? `
                                <div class="task-group-summary-item">
                                    <span>üéÅ</span>
                                    <span class="seasonal-bonus">${totalXisBonusFormatted}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="expand-icon">‚ñº</div>
                    </div>
                    <div class="task-group-content">
            `;
            
            group.tasks.forEach((task, index) => {
                html += `
                    <div class="task-item">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div><strong>${task.count.toFixed(2)} –µ–¥.</strong></div>
                                <div class="task-time-info">
                                    <span class="task-start-time">–ù–∞—á–∞–ª–æ: ${task.startTime}</span>
                                    <span> | –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: ${task.time}</span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div class="task-payment-info">
                                    <span>${task.calculatedPay}</span>
                                    ${task.xisBonus > 0 ? `<span class="seasonal-bonus">${task.calculatedXisBonus}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        });

        tasksGrouped.innerHTML = html;
    }

    // === –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –ì–†–£–ü–ü ===
    function toggleTaskGroup(header) {
        const group = header.parentElement;
        group.classList.toggle('expanded');
    }

    // === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ö–ê–õ–ï–ù–î–ê–†–Ø ===
    async function loadCalendarData() {
        try {
            calendarLoading.classList.remove('hidden');
            calendarContent.classList.add('hidden');

            // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Å—è—Ü–µ–≤
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            
            // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–µ—Å—è—Ü–µ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤
            availableMonths = [];
            for (let i = 5; i >= 0; i--) {
                const date = new Date(currentYear, currentMonth - 1 - i, 1);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const monthKey = `${year}-${month.toString().padStart(2, '0')}`;
                availableMonths.push(monthKey);
            }

            if (availableMonths.length === 0) {
                calendarLoading.innerHTML = '<p style="text-align:center;color:var(--tg-hint-color);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                return;
            }

            currentMonthIndex = availableMonths.length - 1; // –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
            await renderCalendarForMonth(availableMonths[currentMonthIndex]);
            
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', err);
            calendarLoading.innerHTML = '<p style="text-align:center;color:#e53935;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è</p>';
        }
    }

    async function renderCalendarForMonth(monthKey) {
        try {
            const [yearStr, monthStr] = monthKey.split('-');
            const year = Number(yearStr);
            const month = Number(monthStr);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü
            const monthData = await fetchData(DATA_SOURCES.monthlyData(year, month));
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—ã, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            const userDates = new Set();
            if (monthData && monthData.records) {
                monthData.records.forEach(record => {
                    if (record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'] === currentUserData.name && record['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å']) {
                        userDates.add(record['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å']);
                    }
                });
            }

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            renderCalendarGrid(year, month, userDates);
            
            const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
            currentMonthSpan.textContent = `${monthNames[month - 1]} ${year}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
            prevMonthBtn.disabled = currentMonthIndex === 0;
            nextMonthBtn.disabled = currentMonthIndex === availableMonths.length - 1;

            calendarLoading.classList.add('hidden');
            calendarContent.classList.remove('hidden');
            
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', err);
            calendarLoading.innerHTML = '<p style="text-align:center;color:#e53935;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
        }
    }

    function renderCalendarGrid(year, monthNum, userDates) {
        calendar.innerHTML = '';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
        const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
        dayNames.forEach(day => {
            const el = document.createElement('div');
            el.textContent = day;
            el.style.fontWeight = 'bold';
            el.style.backgroundColor = 'var(--tg-bg-color)';
            el.style.padding = '6px 0';
            el.style.borderRadius = '6px';
            el.style.textAlign = 'center';
            calendar.appendChild(el);
        });

        const firstDay = new Date(year, monthNum - 1, 1);
        const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
        const lastDayNum = new Date(year, monthNum, 0).getDate();

        // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞ –º–µ—Å—è—Ü–∞
        for (let i = 0; i < startDay; i++) {
            calendar.appendChild(document.createElement('div'));
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ –º–µ—Å—è—Ü–∞
        for (let day = 1; day <= lastDayNum; day++) {
            const el = document.createElement('div');
            el.className = 'day';
            el.textContent = day;
            el.style.padding = '8px 0';
            el.style.borderRadius = '6px';
            el.style.fontSize = '14px';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å
            const dayStr = String(day).padStart(2, '0');
            const monthStr = String(monthNum).padStart(2, '0');
            const dateStr = `${dayStr}.${monthStr}.${year}`;
            
            if (userDates.has(dateStr)) {
                el.classList.add('available');
                el.title = '–ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å';
                el.addEventListener('click', () => loadRecordByDate(year, monthNum, day));
            } else {
                el.style.color = 'var(--tg-hint-color)';
                el.style.cursor = 'default';
            }
            
            calendar.appendChild(el);
        }
    }

    async function loadRecordByDate(year, month, day) {
        try {
            const dateStr = `${String(day).padStart(2, '0')}.${String(month).padStart(2, '0')}.${year}`;
            const monthKey = `${year}-${String(month).padStart(2, '0')}`;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü
            const monthData = await fetchData(DATA_SOURCES.monthlyData(year, month));
            
            // –ù–∞—Ö–æ–¥–∏–º –∑–∞–¥–∞—á–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É
            const userTasks = monthData.records.filter(record => 
                record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'] === currentUserData.name && record['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'] === dateStr
            );

            if (userTasks.length === 0) {
                showBanner(`–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ ${dateStr}`, 'info', 3000);
                return;
            }

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∑–∞—Ä–∞–±–æ—Ç–∫–∞ –∑–∞ –º–µ—Å—è—Ü
            const allUserTasksInMonth = monthData.records.filter(record => 
                record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'] === currentUserData.name
            );

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ –¥–∞—Ç–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Å—è—á–Ω–æ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∫–∞
            const tasksByDate = {};
            allUserTasksInMonth.forEach(task => {
                const taskDate = task['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'];
                if (!tasksByDate[taskDate]) tasksByDate[taskDate] = [];
                tasksByDate[taskDate].push(task);
            });

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
            const workedTime = calculateTotalTime(userTasks, '–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è');
            const plannedTime = calculateTotalTime(userTasks, '–í—Ä–µ–º—è –ø–æ —Ç–∞–±–µ–ª—é');
            const dayPay = calculateDayPay(userTasks);
            const xisBonus = calculateXisBonus(userTasks);
            const monthlyPay = calculateMonthlyPay(tasksByDate); // –ó–∞—Ä–∞–±–æ—Ç–æ–∫ –∑–∞ –í–´–ë–†–ê–ù–ù–´–ô –º–µ—Å—è—Ü
            const efficiency = calculateEfficiency(workedTime, plannedTime);

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            document.getElementById('date').textContent = dateStr;
            document.getElementById('worked').textContent = workedTime;
            document.getElementById('planned').textContent = plannedTime;
            document.getElementById('efficiency').textContent = efficiency + '%';
            document.getElementById('pay-day').textContent = formatCurrency(dayPay);
            document.getElementById('xisBonusDay').textContent = formatCurrency(xisBonus);
            document.getElementById('pay-month').textContent = formatCurrency(monthlyPay);

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é
            renderGroupedTasks(userTasks);
            
            showBanner(`–î–∞–Ω–Ω—ã–µ –∑–∞ ${dateStr} –∑–∞–≥—Ä—É–∂–µ–Ω—ã`, 'success', 3000);
            
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–∞—Ç–µ:', err);
            showBanner(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${err.message}`, 'error', 5000);
        }
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    async function init() {
      try {
        if (!window.Telegram?.WebApp) {
          enableTestMode();
          return;
        }

        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        applyTelegramTheme();

        const user = Telegram.WebApp.initDataUnsafe.user;
        if (!user?.id) throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        chatId = String(user.id);

        await loadUserData();
        
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', err);
        loading.classList.add('hidden');
        showError('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    async function loadUserData() {
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        const staffData = await fetchData(DATA_SOURCES.staff);
        
        // === –î–û–ë–ê–í–õ–ï–ù–û –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø ===
        // –ï—Å–ª–∏ chatId –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Telegram WebApp, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é
        if (!chatId || chatId === 'undefined') {
            const manualChatId = prompt('–í–≤–µ–¥–∏—Ç–µ Telegram ID –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', '5702919259');
            if (manualChatId) {
                chatId = manualChatId;
            } else {
                throw new Error('Telegram ID –Ω–µ —É–∫–∞–∑–∞–Ω');
            }
        }
        // === –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ===
        
        // –ù–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userRecord = staffData.records.find(record => 
            String(record['Telegram ID']) === chatId
        );

        if (!userRecord) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ ID –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const availableIds = staffData.records
                .map(record => `${record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']} - ${record['Telegram ID']}`)
                .join('\n');
            
            const newId = prompt(
                `–í–∞—à ID (${chatId}) –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ.\n\n–î–æ—Å—Ç—É–ø–Ω—ã–µ ID:\n${availableIds}\n\n–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Telegram ID:`,
                '5702919259'
            );
            
            if (newId) {
                chatId = newId;
                // –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–∏—Å–∫ —Å –Ω–æ–≤—ã–º ID
                const newUserRecord = staffData.records.find(record => 
                    String(record['Telegram ID']) === chatId
                );
                
                if (!newUserRecord) {
                    throw new Error('–£–∫–∞–∑–∞–Ω–Ω—ã–π Telegram ID —Ç–∞–∫–∂–µ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ');
                }
                
                userRecord = newUserRecord;
            } else {
                throw new Error('Telegram ID –Ω–µ —É–∫–∞–∑–∞–Ω');
            }
        }

        currentUserData = {
            name: userRecord['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'],
            department: userRecord['–û—Ç–¥–µ–ª'],
            role: userRecord['–†–æ–ª—å'],
            managedDepartments: userRecord['–†—É–∫–æ–≤–æ–¥–∏—Ç –æ—Ç–¥–µ–ª–æ–º'] ? [userRecord['–†—É–∫–æ–≤–æ–¥–∏—Ç –æ—Ç–¥–µ–ª–æ–º']] : []
        };

        isManager = ['–º–µ–Ω–µ–¥–∂–µ—Ä', '—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å', '–∞–¥–º–∏–Ω'].includes(currentUserData.role.toLowerCase());
        isAdmin = currentUserData.role.toLowerCase() === '–∞–¥–º–∏–Ω';
        managedDepartments = currentUserData.managedDepartments;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        
        currentMonthData = await fetchData(DATA_SOURCES.monthlyData(currentYear, currentMonth));
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        dataLastUpdated = currentMonthData.lastUpdated;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ—Ä—Å–∏–∏ —Å –¥–∞—Ç–æ–π –¥–∞–Ω–Ω—ã—Ö
        updateVersionInfo();
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
        await generatePersonalReport();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        await loadCalendarData();

        renderUI();
        loading.classList.add('hidden');
        
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err);
        throw err;
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–µ—Ä—Å–∏–∏ —Å –¥–∞—Ç–æ–π –¥–∞–Ω–Ω—ã—Ö
    function updateVersionInfo() {
      if (!dataLastUpdated) {
        versionInfo.textContent = '(üõ† V.11.01-–ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö üõ†)';
        return;
      }

      try {
        const updateDate = new Date(dataLastUpdated);
        const formattedDate = updateDate.toLocaleDateString('ru-RU', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
        const formattedTime = updateDate.toLocaleTimeString('ru-RU', {
          hour: '2-digit',
          minute: '2-digit'
        });

        versionInfo.innerHTML = `(üõ† V.11.01-–ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö | –î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã –Ω–∞: ${formattedDate} ${formattedTime} üõ†)`;
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã:', err);
        versionInfo.textContent = '(üõ† V.11.01-–ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö üõ†)';
      }
    }

    async function generatePersonalReport() {
      if (!currentMonthData || !currentUserData) return;

      const userTasks = currentMonthData.records.filter(record => 
        record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'] === currentUserData.name
      );

      if (userTasks.length === 0) {
        showBanner('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–¥–∞—á–∞—Ö –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü', 'info');
        return;
      }

      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ –¥–∞—Ç–µ
      const tasksByDate = {};
      userTasks.forEach(task => {
        const date = task['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'];
        if (!tasksByDate[date]) tasksByDate[date] = [];
        tasksByDate[date].push(task);
      });

      // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∞—Ç—É —Å –∑–∞–¥–∞—á–∞–º–∏
      const dates = Object.keys(tasksByDate).sort((a, b) => {
        const [d1, m1, y1] = a.split('.').map(Number);
        const [d2, m2, y2] = b.split('.').map(Number);
        return new Date(y2, m2 - 1, d2) - new Date(y1, m1 - 1, d1);
      });

      if (dates.length === 0) return;

      const latestDate = dates[0];
      const latestTasks = tasksByDate[latestDate];

      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
      const workedTime = calculateTotalTime(latestTasks, '–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è');
      const plannedTime = calculateTotalTime(latestTasks, '–í—Ä–µ–º—è –ø–æ —Ç–∞–±–µ–ª—é');
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –†–ê–°–ß–ï–¢–´ –ó–ê–†–ê–ë–û–¢–ö–ê
      const dayPay = calculateDayPay(latestTasks); // "–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞" + "–î–æ–ø–ª–∞—Ç–∞ XIS" –∑–∞ –¥–µ–Ω—å
      const xisBonus = calculateXisBonus(latestTasks); // –¢–æ–ª—å–∫–æ "–î–æ–ø–ª–∞—Ç–∞ XIS" –∑–∞ –¥–µ–Ω—å
      const monthlyPay = calculateMonthlyPay(tasksByDate); // "–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞" + "–î–æ–ø–ª–∞—Ç–∞ XIS" –∑–∞ –º–µ—Å—è—Ü
      
      const efficiency = calculateEfficiency(workedTime, plannedTime);

      // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å
      currentRecord = {
        date: latestDate,
        worked: workedTime,
        planned: plannedTime,
        efficiency: efficiency + '%',
        payDay: formatCurrency(dayPay), // –û–±—â–∏–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫ –∑–∞ –¥–µ–Ω—å
        xisBonusDay: formatCurrency(xisBonus), // –¢–æ–ª—å–∫–æ —Å–µ–∑–æ–Ω–Ω–∞—è –¥–æ–ø–ª–∞—Ç–∞
        payMonth: formatCurrency(monthlyPay), // –û–±—â–∏–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫ –∑–∞ –º–µ—Å—è—Ü
        details: latestTasks
      };

      // –û–±–Ω–æ–≤–ª—è–µ–º UI
      updateMainData();
      updateDetails();
    }

    function calculateTotalTime(tasks, fieldName) {
      let totalSeconds = 0;
      
      tasks.forEach(task => {
        const timeValue = task[fieldName];
        if (timeValue) {
          totalSeconds += timeToSeconds(timeValue);
        }
      });

      return secondsToTime(totalSeconds);
    }

    function calculateEfficiency(worked, planned) {
      const workedSec = timeToSeconds(worked);
      const plannedSec = timeToSeconds(planned);
      
      if (plannedSec === 0) return 0;
      
      // –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å = (–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è / –í—Ä–µ–º—è –ø–æ —Ç–∞–±–µ–ª—é) * 100
      const efficiency = (workedSec / plannedSec) * 100;
      return Math.round(efficiency * 100) / 100; // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 2 –∑–Ω–∞–∫–æ–≤
    }

    function updateDetails() {
      if (!currentRecord?.details) {
        tasksGrouped.innerHTML = '<p style="text-align:center;color:var(--tg-hint-color);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        return;
      }

      renderGroupedTasks(currentRecord.details);
      detailsLoading.classList.add('hidden');
      detailsContent.classList.remove('hidden');
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
    function timeToSeconds(timeStr) {
      if (!timeStr) return 0;
      
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤—Ä–µ–º–µ–Ω–∏: "4:00:00", "4:00", "04:00:00"
      const parts = timeStr.split(':').map(Number);
      
      if (parts.length === 3) {
        // –§–æ—Ä–º–∞—Ç –ß–ß:–ú–ú:–°–°
        return parts[0] * 3600 + parts[1] * 60 + parts[2];
      } else if (parts.length === 2) {
        // –§–æ—Ä–º–∞—Ç –ß–ß:–ú–ú
        return parts[0] * 3600 + parts[1] * 60;
      } else if (parts.length === 1) {
        // –¢–æ–ª—å–∫–æ —á–∞—Å—ã
        return parts[0] * 3600;
      }
      
      return 0;
    }

    function secondsToTime(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      
      // –ë–µ–∑ —Å–µ–∫—É–Ω–¥, –∫–∞–∫ –ø—Ä–æ—Å–∏–ª–∏
      return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    }

    function formatCurrency(amount) {
      return amount.toLocaleString('ru-RU', { 
        style: 'currency', 
        currency: 'RUB', 
        minimumFractionDigits: 2,
        maximumFractionDigits: 2 
      });
    }

    function updateMainData() {
      if (!currentUserData || !currentRecord) return;

      document.getElementById('name').textContent = currentUserData.name;
      document.getElementById('department').textContent = currentUserData.department;
      document.getElementById('date').textContent = currentRecord.date;
      document.getElementById('worked').textContent = currentRecord.worked;
      document.getElementById('planned').textContent = currentRecord.planned;
      document.getElementById('efficiency').textContent = currentRecord.efficiency;
      document.getElementById('pay-day').textContent = currentRecord.payDay;
      document.getElementById('xisBonusDay').textContent = currentRecord.xisBonusDay;
      document.getElementById('pay-month').textContent = currentRecord.payMonth;

      mainDataLoading.classList.add('hidden');
      mainDataContent.classList.remove('hidden');
    }

    function renderUI() {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤–∫–ª–∞–¥–∫–∏
      if (isManager) {
        tabManager.classList.remove('hidden');
      }
      if (isAdmin) {
        tabAdmin.classList.remove('hidden');
      }

      employeeView.classList.remove('hidden');
      updateLastUpdate();

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫—É –æ—Ç–¥–µ–ª–∞ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
      if (isManager) {
        initializeManagerView();
      }
    }

    async function initializeManagerView() {
      if (!isManager) return;

      try {
        const staffData = await fetchData(DATA_SOURCES.staff);
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ç–¥–µ–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–º–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        const departments = new Set();
        staffData.records.forEach(record => {
          if (managedDepartments.includes(record['–†—É–∫–æ–≤–æ–¥–∏—Ç –æ—Ç–¥–µ–ª–æ–º']) || 
              (currentUserData.managedDepartments.includes(record['–û—Ç–¥–µ–ª']) && isManager)) {
            departments.add(record['–û—Ç–¥–µ–ª']);
          }
        });

        managedDepartments = Array.from(departments);

        if (managedDepartments.length > 0) {
          renderDepartmentSelector();
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ manager view:', err);
      }
    }

    function renderDepartmentSelector() {
      departmentSelect.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª ‚Äî</option>';
      managedDepartments.forEach(dept => {
        const opt = document.createElement('option');
        opt.value = dept;
        opt.textContent = dept;
        departmentSelect.appendChild(opt);
      });

      departmentSelector.classList.remove('hidden');
    }

    // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    async function fetchData(url) {
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status}`);
        return await response.json();
      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ ${url}:`, error);
        throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ${error.message}`);
      }
    }

    function showError(msg) {
      loading.classList.add('hidden');
      error.textContent = msg;
      error.classList.remove('hidden');
    }

    function showBanner(message, type = 'info', duration = 5000) {
      banner.textContent = message;
      banner.className = `banner show ${type}`;
      if (duration > 0) setTimeout(() => banner.classList.remove('show'), duration);
    }

    function applyTelegramTheme() {
      if (!window.Telegram?.WebApp) return;
      const theme = Telegram.WebApp.themeParams;
      const root = document.documentElement;
      root.style.setProperty('--tg-bg-color', theme.bg_color || '#f0f2f5');
      root.style.setProperty('--tg-text-color', theme.text_color || '#1c1e21');
      root.style.setProperty('--tg-hint-color', theme.hint_color || '#999999');
      root.style.setProperty('--tg-link-color', theme.link_color || '#d71923');
      root.style.setProperty('--tg-button-color', theme.button_color || '#1a8cd8');
      root.style.setProperty('--tg-button-text-color', theme.button_text_color || '#ffffff');
      root.style.setProperty('--card-bg', theme.bg_color && parseInt(theme.bg_color.replace('#', ''), 16) < 0xffffff/2 ? '#333' : '#ffffff');
    }

    function updateLastUpdate() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      document.getElementById('last-update').textContent = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${timeStr}`;
    }

    function enableTestMode() {
      chatId = '5702919259'; // –¢–µ—Å—Ç–æ–≤—ã–π ID
      setTimeout(async () => {
        try {
          await loadUserData();
        } catch (err) {
          showError('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞: ' + err.message);
        }
      }, 1000);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    prevMonthBtn.addEventListener('click', async () => {
      if (currentMonthIndex > 0) {
        currentMonthIndex--;
        await renderCalendarForMonth(availableMonths[currentMonthIndex]);
      }
    });

    nextMonthBtn.addEventListener('click', async () => {
      if (currentMonthIndex < availableMonths.length - 1) {
        currentMonthIndex++;
        await renderCalendarForMonth(availableMonths[currentMonthIndex]);
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    refreshBtn.addEventListener('click', async () => {
      refreshBtn.disabled = true;
      refreshBtn.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
      
      try {
        await loadUserData();
        showBanner('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success', 3000);
      } catch (err) {
        showBanner('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + err.message, 'error', 5000);
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
      }
    });

    clearCacheBtn.addEventListener('click', () => {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à?')) {
        localStorage.clear();
        showBanner('–ö—ç—à –æ—á–∏—â–µ–Ω', 'success', 2000);
        setTimeout(() => location.reload(), 1500);
      }
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    tabEmployee.addEventListener('click', () => switchTab('employee'));
    tabManager.addEventListener('click', () => switchTab('manager'));
    tabAdmin.addEventListener('click', () => {
      if (isAdmin) window.location.href = 'admin.html';
    });
    tabStatistics.addEventListener('click', () => {
      if (isManager || isAdmin) {
        window.location.href = 'HTML/statistics.html';
      }
    });

    function switchTab(tabName) {
      // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
      employeeView.classList.add('hidden');
      managerView.classList.add('hidden');
      
      // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      
      // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
      if (tabName === 'employee') {
        employeeView.classList.remove('hidden');
        tabEmployee.classList.add('active');
      } else if (tabName === 'manager' && isManager) {
        managerView.classList.remove('hidden');
        tabManager.classList.add('active');
      }
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      showError(`–û—à–∏–±–∫–∞: ${event.message}`);
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      showError(`–û—à–∏–±–∫–∞: ${event.reason}`);
    });

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    window.onload = init;
  </script>
</body>
</html>
