<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --tg-bg-color: #f0f2f5;
      --tg-text-color: #1c1e21;
      --tg-hint-color: #999;
      --tg-link-color: #d71923;
      --tg-button-color: #1a8cd8;
      --tg-button-text-color: #ffffff;
      --card-bg: #ffffff;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--tg-bg-color);
      color: var(--tg-text-color);
      min-height: 100vh;
    }
    .container { max-width: 600px; margin: 0 auto; }
    .card { 
      background: var(--card-bg); 
      border-radius: 12px; 
      padding: 18px; 
      margin-bottom: 14px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }
    h1 { margin: 0 0 10px 0; color: var(--tg-link-color); }
    h2, h3 { margin: 0 0 8px 0; color: var(--tg-link-color); }
    h5 { margin: 0 0 6px 0; color: var(--tg-link-color); }
    .tabs { display: flex; margin-bottom: 16px; border-bottom: 1px solid var(--tg-hint-color); }
    .tab { padding: 10px 16px; cursor: pointer; font-weight: 600; color: var(--tg-hint-color); }
    .tab.active { color: var(--tg-link-color); border-bottom: 2px solid var(--tg-link-color); }
    .loading { text-align: center; padding: 20px; color: var(--tg-hint-color); font-size: 16px; }
    .spinner { 
      width: 40px; 
      height: 40px; 
      border: 4px solid #e0e0e0; 
      border-top: 4px solid var(--tg-link-color); 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
      margin: 20px auto; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    .error { 
      color: #e53935; 
      text-align: center; 
      padding: 20px; 
      background: #ffebee; 
      border-radius: 8px; 
      margin: 16px 0; 
    }
    .hidden { display: none !important; }
    .calendar { 
      display: grid; 
      gap: 4px; 
      margin: 10px 0; 
      grid-template-columns: repeat(7, 1fr); 
    }
    .day { 
      text-align: center; 
      padding: 6px 0; 
      font-size: 12px; 
      border-radius: 4px; 
      color: var(--tg-text-color); 
      cursor: pointer; 
    }
    .day.available { 
      background: var(--tg-link-color); 
      color: var(--tg-button-text-color); 
      font-weight: bold; 
    }
    .day:hover { 
      background: #e0e0e0; 
    }
    .footer { 
      text-align: center; 
      margin-top: 30px; 
      color: var(--tg-hint-color); 
      font-size: 13px; 
    }
    .month-selector { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin: 10px 0; 
    }
    .month-selector button { 
      background: var(--tg-button-color); 
      color: var(--tg-button-text-color); 
      border: none; 
      padding: 8px 12px; 
      border-radius: 6px; 
      cursor: pointer; 
    }
    .month-selector span { font-weight: bold; }
    .banner {
      padding: 12px;
      margin: 12px 0;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
      display: none;
    }
    .banner.show {
      display: block;
    }
    .banner.info { background: #e3f2fd; color: #1565c0; }
    .banner.error { background: #ffebee; color: #c62828; }
    .banner.success { background: #e8f5e9; color: #2e7d32; }
    .last-update {
      font-size: 13px;
      color: var(--tg-hint-color);
      margin-top: 8px;
    }
    .refresh-btn {
      background: var(--tg-button-color);
      color: var(--tg-button-text-color);
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      display: inline-block;
    }
    .refresh-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .fade {
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    .fade.hidden {
      opacity: 0;
    }
    .clear-cache-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      margin: 10px 0;
      display: block;
      width: 100%;
      text-align: center;
    }
    .clear-cache-btn:hover {
      background: #c82333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
    <h4>(üõ† V.11.01-–ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö 1233 üõ†)</h4>

    <div id="banner" class="banner"></div>

    <div class="tabs">
      <div id="tab-employee" class="tab active">–ú–æ–π –æ—Ç—á—ë—Ç</div>
      <div id="tab-info" class="tab hidden">‚Ñπ –ù–æ—Ä–º–∞—Ç–∏–≤—ã</div>
      <div id="tab-manager" class="tab hidden">–û—Ç–¥–µ–ª</div>
      <div id="tab-statistics" class="tab hidden">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div id="tab-admin" class="tab hidden">üë®‚Äçüíª –ê–¥–º–∏–Ω–∫–∞</div>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>
    <div id="error" class="error hidden"></div>

    <!-- –í–∫–ª–∞–¥–∫–∞ "–ú–æ–π –æ—Ç—á—ë—Ç" -->
    <div id="employee-view" class="hidden">
      <div class="card">
        <h2>üë∑‚Äç‚ôÇÔ∏è –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç</h2>
        <p id="last-update" class="last-update">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ‚Äî</p>
        <button id="refreshBtn" class="refresh-btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <h5>(üõ† –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä üõ†)</h5>
        <div id="main-data-loading" class="loading">
          <div class="spinner"></div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>
        <div id="main-data-content" class="hidden fade">
          <p><span class="label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</span> <span id="name">‚Äî</span></p>
          <p><span class="label">–û—Ç–¥–µ–ª:</span> <span id="department">‚Äî</span></p>
          <p><span class="label">–î–∞—Ç–∞:</span> <span id="date">‚Äî</span></p>
          <p><span class="label">–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ:</span> <span id="worked">‚Äî</span></p>
          <p><span class="label">–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è:</span> <span id="planned">‚Äî</span></p>
          <p><span class="label">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</span> <span id="efficiency">‚Äî</span></p>
          <p><span class="label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ –¥–µ–Ω—å:</span> <span id="pay-day">‚Äî</span></p>
          <p><span class="label">–ò–∑ –Ω–∏—Ö —Å–µ–∑–æ–Ω–Ω–∞—è –¥–æ–ø–ª–∞—Ç–∞:</span> <span id="xisBonusDay">‚Äî</span></p>
          <p><span class="label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ –º–µ—Å—è—Ü:</span> <span id="pay-month">‚Äî</span></p>
        </div>
      </div>
      <h5>üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é —Å 10 –¥–æ 11, —Å 12 –¥–æ 13 –∏ —Å 14 –¥–æ 15, –µ—Å–ª–∏ –∑–∞–º–µ—Ç–∏–ª–∏ –Ω–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ —Å–æ–æ–±—à–∏—Ç–µ –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é</h5>
      <div class="card">
        <h2>üìã –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á</h2>
        <div id="details-loading" class="loading">
          <div class="spinner"></div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏...</p>
        </div>
        <div id="details-content" class="hidden fade">
          <pre id="details">–ó–∞–≥—Ä—É–∑–∫–∞...</pre>
        </div>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ "–û—Ç–¥–µ–ª" -->
    <div id="manager-view" class="hidden">
      <div id="department-selector" class="card hidden">
        <h2>üë®‚Äçüíº –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</h2>
        <select id="departmentSelect" style="width:100%; padding:8px; margin:10px 0; border-radius:6px; border:1px solid #ccc;">
          <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª ‚Äî</option>
        </select>
      </div>
      <div id="department-report" class="hidden">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2>üìä –û—Ç—á—ë—Ç –ø–æ –æ—Ç–¥–µ–ª—É: <span id="dept-name">‚Äî</span></h2>
            <button id="change-department-btn" class="refresh-btn" style="padding:6px 12px;font-size:12px;">–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –æ—Ç–¥–µ–ª</button>
          </div>
          <p id="dept-last-update" class="last-update">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ‚Äî</p>
          <div id="dept-data-loading" class="loading">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–¥–µ–ª–∞...</p>
          </div>
          <div id="dept-data-content" class="hidden fade">
            <p id="dept-report-date">–û—Ç—á—ë—Ç –Ω–∞ –¥–∞—Ç—É: ‚Äî</p>
            <p id="dept-attendance">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏: ‚Äî</p>
            <p id="dept-attendance-percent">üìä –ü—Ä–æ—Ü–µ–Ω—Ç —è–≤–∫–∏: ‚Äî</p>
            <h3>üë• –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:</h3>
            <pre id="dept-employees-list" style="white-space:pre-wrap;font-family:monospace;"></pre>
            <p id="dept-avg-efficiency">üìä –°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã: ‚Äî</p>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">–°–∏—Å—Ç–µ–º–∞ –º–∞–ª–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ AIP ‚Ä¢ ¬© 09.2025</div>
  </div>
  
  <!-- –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ -->
  <button id="clearCacheBtn" class="clear-cache-btn">üóë –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
  
  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
    const DATA_SOURCES = {
      staff: 'https://AIP-77.github.io/archive/staff%20fullData.json',
      monthlyData: (year, month) => `https://AIP-77.github.io/archive/${year}-${month.toString().padStart(2, '0')}%20fullData.json`
    };

    let chatId = null;
    let isManager = false;
    let isAdmin = false;
    let currentUserData = null;
    let currentRecord = null;
    let currentMonthData = null;
    let managedDepartments = [];
    let currentManagerDepartment = null;

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const employeeView = document.getElementById('employee-view');
    const managerView = document.getElementById('manager-view');
    const banner = document.getElementById('banner');

    const tabEmployee = document.getElementById('tab-employee');
    const tabManager = document.getElementById('tab-manager');
    const tabInfo = document.getElementById('tab-info');
    const tabAdmin = document.getElementById('tab-admin');
    const tabStatistics = document.getElementById('tab-statistics');

    const mainDataLoading = document.getElementById('main-data-loading');
    const mainDataContent = document.getElementById('main-data-content');
    const detailsLoading = document.getElementById('details-loading');
    const detailsContent = document.getElementById('details-content');

    const refreshBtn = document.getElementById('refreshBtn');
    const clearCacheBtn = document.getElementById('clearCacheBtn');

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    async function init() {
      try {
        if (!window.Telegram?.WebApp) {
          enableTestMode();
          return;
        }

        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        applyTelegramTheme();

        const user = Telegram.WebApp.initDataUnsafe.user;
        if (!user?.id) throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        chatId = String(user.id);

        await loadUserData();
        
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', err);
        loading.classList.add('hidden');
        showError('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    async function loadUserData() {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        const staffData = await fetchData(DATA_SOURCES.staff);
        
        // –ù–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userRecord = staffData.records.find(record => 
          String(record['Telegram ID']) === chatId
        );

        if (!userRecord) {
          throw new Error('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ');
        }

        currentUserData = {
          name: userRecord['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'],
          department: userRecord['–û—Ç–¥–µ–ª'],
          role: userRecord['–†–æ–ª—å'],
          managedDepartments: userRecord['–†—É–∫–æ–≤–æ–¥–∏—Ç –æ—Ç–¥–µ–ª–æ–º'] ? [userRecord['–†—É–∫–æ–≤–æ–¥–∏—Ç –æ—Ç–¥–µ–ª–æ–º']] : []
        };

        isManager = ['–º–µ–Ω–µ–¥–∂–µ—Ä', '—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å', '–∞–¥–º–∏–Ω'].includes(currentUserData.role.toLowerCase());
        isAdmin = currentUserData.role.toLowerCase() === '–∞–¥–º–∏–Ω';
        managedDepartments = currentUserData.managedDepartments;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        
        currentMonthData = await fetchData(DATA_SOURCES.monthlyData(currentYear, currentMonth));
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
        await generatePersonalReport();

        renderUI();
        loading.classList.add('hidden');
        
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err);
        throw err;
      }
    }

    async function generatePersonalReport() {
      if (!currentMonthData || !currentUserData) return;

      const userTasks = currentMonthData.records.filter(record => 
        record['–°–æ—Ç—Ä—É–¥–Ω–∏–∫'] === currentUserData.name
      );

      if (userTasks.length === 0) {
        showBanner('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–¥–∞—á–∞—Ö –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü', 'info');
        return;
      }

      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ –¥–∞—Ç–µ
      const tasksByDate = {};
      userTasks.forEach(task => {
        const date = task['–†–∞–±–æ—á–∏–π –¥–µ–Ω—å'];
        if (!tasksByDate[date]) tasksByDate[date] = [];
        tasksByDate[date].push(task);
      });

      // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∞—Ç—É —Å –∑–∞–¥–∞—á–∞–º–∏
      const dates = Object.keys(tasksByDate).sort((a, b) => {
        const [d1, m1, y1] = a.split('.').map(Number);
        const [d2, m2, y2] = b.split('.').map(Number);
        return new Date(y2, m2 - 1, d2) - new Date(y1, m1 - 1, d1);
      });

      if (dates.length === 0) return;

      const latestDate = dates[0];
      const latestTasks = tasksByDate[latestDate];

      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
      const workedTime = calculateTotalTime(latestTasks, '–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è');
      const plannedTime = calculateTotalTime(latestTasks, '–í—Ä–µ–º—è –ø–æ —Ç–∞–±–µ–ª—é');
      const totalPay = calculateTotalPay(latestTasks);
      const xisBonus = calculateXisBonus(latestTasks);
      const efficiency = calculateEfficiency(workedTime, plannedTime);
      const monthlyPay = calculateMonthlyPay(tasksByDate);

      // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å
      currentRecord = {
        date: latestDate,
        worked: workedTime,
        planned: plannedTime,
        efficiency: efficiency + '%',
        payDay: formatCurrency(totalPay),
        xisBonusDay: formatCurrency(xisBonus),
        payMonth: formatCurrency(monthlyPay),
        details: formatTaskDetails(latestTasks)
      };

      // –û–±–Ω–æ–≤–ª—è–µ–º UI
      updateMainData();
      updateDetails();
    }

    function calculateTotalTime(tasks, fieldName) {
      let totalSeconds = 0;
      
      tasks.forEach(task => {
        const timeValue = task[fieldName];
        if (timeValue) {
          totalSeconds += timeToSeconds(timeValue);
        }
      });

      return secondsToTime(totalSeconds);
    }

    function calculateTotalPay(tasks) {
      const calculatedSum = tasks.reduce((total, task) => {
        const pay = parseFloat(task['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞']?.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
        return total + pay;
      }, 0);

      const xisBonus = tasks.reduce((total, task) => {
        const bonus = parseFloat(task['–î–æ–ø–ª–∞—Ç–∞ XIS']?.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
        return total + bonus;
      }, 0);

      return calculatedSum + xisBonus;
    }

    function calculateXisBonus(tasks) {
      return tasks.reduce((total, task) => {
        const bonus = parseFloat(task['–î–æ–ø–ª–∞—Ç–∞ XIS']?.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
        return total + bonus;
      }, 0);
    }

    function calculateEfficiency(worked, planned) {
      const workedSec = timeToSeconds(worked);
      const plannedSec = timeToSeconds(planned);
      
      if (plannedSec === 0) return 0;
      
      // –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å = (–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è / –í—Ä–µ–º—è –ø–æ —Ç–∞–±–µ–ª—é) * 100
      const efficiency = (workedSec / plannedSec) * 100;
      return Math.round(efficiency * 100) / 100; // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 2 –∑–Ω–∞–∫–æ–≤
    }

    function calculateMonthlyPay(tasksByDate) {
      let total = 0;
      Object.values(tasksByDate).forEach(tasks => {
        total += calculateTotalPay(tasks);
      });
      return total;
    }

    function formatTaskDetails(tasks) {
      return tasks.map(task => ({
        work: task['–í–∏–¥ —Ä–∞–±–æ—Ç'] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
        count: task['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü'] || '0',
        time: task['–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è'] || '00:00',
        pay: task['–†–∞—Å—á–µ—Ç–Ω–∞—è —Å—É–º–º–∞'] || '0,00 ‚ÇΩ',
        xisBonus: task['–î–æ–ø–ª–∞—Ç–∞ XIS'] || '0,00 ‚ÇΩ'
      }));
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
    function timeToSeconds(timeStr) {
      if (!timeStr) return 0;
      
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤—Ä–µ–º–µ–Ω–∏: "4:00:00", "4:00", "04:00:00"
      const parts = timeStr.split(':').map(Number);
      
      if (parts.length === 3) {
        // –§–æ—Ä–º–∞—Ç –ß–ß:–ú–ú:–°–°
        return parts[0] * 3600 + parts[1] * 60 + parts[2];
      } else if (parts.length === 2) {
        // –§–æ—Ä–º–∞—Ç –ß–ß:–ú–ú
        return parts[0] * 3600 + parts[1] * 60;
      } else if (parts.length === 1) {
        // –¢–æ–ª—å–∫–æ —á–∞—Å—ã
        return parts[0] * 3600;
      }
      
      return 0;
    }

    function secondsToTime(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      if (secs > 0) {
        return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      } else {
        return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
      }
    }

    function formatCurrency(amount) {
      return amount.toLocaleString('ru-RU', { 
        style: 'currency', 
        currency: 'RUB', 
        minimumFractionDigits: 2,
        maximumFractionDigits: 2 
      });
    }

    function updateMainData() {
      if (!currentUserData || !currentRecord) return;

      document.getElementById('name').textContent = currentUserData.name;
      document.getElementById('department').textContent = currentUserData.department;
      document.getElementById('date').textContent = currentRecord.date;
      document.getElementById('worked').textContent = currentRecord.worked;
      document.getElementById('planned').textContent = currentRecord.planned;
      document.getElementById('efficiency').textContent = currentRecord.efficiency;
      document.getElementById('pay-day').textContent = currentRecord.payDay;
      document.getElementById('xisBonusDay').textContent = currentRecord.xisBonusDay;
      document.getElementById('pay-month').textContent = currentRecord.payMonth;

      mainDataLoading.classList.add('hidden');
      mainDataContent.classList.remove('hidden');
    }

    function updateDetails() {
      if (!currentRecord?.details) {
        document.getElementById('details').textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        return;
      }

      const text = currentRecord.details.map(item => {
        return `${item.work} (${item.count}): ${item.time}, ${item.pay}, –°–µ–∑–æ–Ω–Ω–∞—è –¥–æ–ø–ª–∞—Ç–∞: ${item.xisBonus}`;
      }).join('\n');

      document.getElementById('details').textContent = text;
      detailsLoading.classList.add('hidden');
      detailsContent.classList.remove('hidden');
    }

    function renderUI() {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤–∫–ª–∞–¥–∫–∏
      if (isManager) {
        tabManager.classList.remove('hidden');
      }
      if (isAdmin) {
        tabAdmin.classList.remove('hidden');
      }

      employeeView.classList.remove('hidden');
      updateLastUpdate();

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫—É –æ—Ç–¥–µ–ª–∞ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
      if (isManager) {
        initializeManagerView();
      }
    }

    async function initializeManagerView() {
      if (!isManager) return;

      try {
        const staffData = await fetchData(DATA_SOURCES.staff);
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ç–¥–µ–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–º–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        const departments = new Set();
        staffData.records.forEach(record => {
          if (managedDepartments.includes(record['–†—É–∫–æ–≤–æ–¥–∏—Ç –æ—Ç–¥–µ–ª–æ–º']) || 
              (currentUserData.managedDepartments.includes(record['–û—Ç–¥–µ–ª']) && isManager)) {
            departments.add(record['–û—Ç–¥–µ–ª']);
          }
        });

        managedDepartments = Array.from(departments);

        if (managedDepartments.length > 0) {
          renderDepartmentSelector();
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ manager view:', err);
      }
    }

    function renderDepartmentSelector() {
      departmentSelect.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª ‚Äî</option>';
      managedDepartments.forEach(dept => {
        const opt = document.createElement('option');
        opt.value = dept;
        opt.textContent = dept;
        departmentSelect.appendChild(opt);
      });

      departmentSelector.classList.remove('hidden');
    }

    // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    async function fetchData(url) {
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status}`);
        return await response.json();
      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ ${url}:`, error);
        throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ${error.message}`);
      }
    }

    function showError(msg) {
      loading.classList.add('hidden');
      error.textContent = msg;
      error.classList.remove('hidden');
    }

    function showBanner(message, type = 'info', duration = 5000) {
      banner.textContent = message;
      banner.className = `banner show ${type}`;
      if (duration > 0) setTimeout(() => banner.classList.remove('show'), duration);
    }

    function applyTelegramTheme() {
      if (!window.Telegram?.WebApp) return;
      const theme = Telegram.WebApp.themeParams;
      const root = document.documentElement;
      root.style.setProperty('--tg-bg-color', theme.bg_color || '#f0f2f5');
      root.style.setProperty('--tg-text-color', theme.text_color || '#1c1e21');
      root.style.setProperty('--tg-hint-color', theme.hint_color || '#999999');
      root.style.setProperty('--tg-link-color', theme.link_color || '#d71923');
      root.style.setProperty('--tg-button-color', theme.button_color || '#1a8cd8');
      root.style.setProperty('--tg-button-text-color', theme.button_text_color || '#ffffff');
      root.style.setProperty('--card-bg', theme.bg_color && parseInt(theme.bg_color.replace('#', ''), 16) < 0xffffff/2 ? '#333' : '#ffffff');
    }

    function updateLastUpdate() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      document.getElementById('last-update').textContent = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${timeStr}`;
    }

    function enableTestMode() {
      chatId = '5702919259'; // –¢–µ—Å—Ç–æ–≤—ã–π ID
      setTimeout(async () => {
        try {
          await loadUserData();
        } catch (err) {
          showError('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞: ' + err.message);
        }
      }, 1000);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    refreshBtn.addEventListener('click', async () => {
      refreshBtn.disabled = true;
      refreshBtn.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
      
      try {
        await loadUserData();
        showBanner('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success', 3000);
      } catch (err) {
        showBanner('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + err.message, 'error', 5000);
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
      }
    });

    clearCacheBtn.addEventListener('click', () => {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à?')) {
        localStorage.clear();
        showBanner('–ö—ç—à –æ—á–∏—â–µ–Ω', 'success', 2000);
        setTimeout(() => location.reload(), 1500);
      }
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    tabEmployee.addEventListener('click', () => switchTab('employee'));
    tabManager.addEventListener('click', () => switchTab('manager'));
    tabAdmin.addEventListener('click', () => {
      if (isAdmin) window.location.href = 'admin.html';
    });
    tabStatistics.addEventListener('click', () => {
      if (isManager || isAdmin) {
        window.location.href = 'HTML/statistics.html';
      }
    });

    function switchTab(tabName) {
      // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
      employeeView.classList.add('hidden');
      managerView.classList.add('hidden');
      
      // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      
      // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
      if (tabName === 'employee') {
        employeeView.classList.remove('hidden');
        tabEmployee.classList.add('active');
      } else if (tabName === 'manager' && isManager) {
        managerView.classList.remove('hidden');
        tabManager.classList.add('active');
      }
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      showError(`–û—à–∏–±–∫–∞: ${event.message}`);
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      showError(`–û—à–∏–±–∫–∞: ${event.reason}`);
    });

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    window.onload = init;
  </script>
</body>
</html>
